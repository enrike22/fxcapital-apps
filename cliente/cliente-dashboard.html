<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FX | CAPITAL R.L. — Panel Cliente</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0b0c; --card:#141416; --muted:#8e9096; --text:#fff;
      --brand:#2d66ff; --brand-600:#244fe0; --ok:#18b689; --danger:#ff5a6a;
      --ring:0 0 0 3px rgba(45,102,255,.25);
      --radius:14px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#0b0b0c;color:var(--text)}
    .wrap{max-width:1100px;margin:40px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand h1{font-size:32px;margin:0;font-weight:800;letter-spacing:.2px}
    .muted{color:var(--muted)}
    .btn{appearance:none;border:0;background:#fff;color:#000;font-weight:700;padding:12px 18px;border-radius:999px;cursor:pointer}
    .btn:focus{outline:none;box-shadow:var(--ring)}
    .btn-outline{background:transparent;color:#fff;border:1px solid #30323a}
    .card{background:#15161b;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:1fr 1fr}
    @media (max-width:880px){.grid-2{grid-template-columns:1fr}}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;background:#181a20;border:1px solid #2a2d35;color:#cfd2da;font-size:12px}
    .h2{font-size:22px;margin:0 0 12px 0}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:14px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .table th{color:#b9bcc6;font-weight:600;text-align:left}
    .row{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
    .input, select, textarea{width:100%;background:#0f1014;border:1px solid #2b2e35;color:#fff;border-radius:12px;padding:12px 14px;font:inherit}
    textarea{min-height:120px;resize:vertical}
    .pill-tabs{display:flex;gap:12px}
    .pill{flex:1;cursor:pointer;border:1px solid #2b2e35;border-radius:14px;padding:14px;background:#0f1014}
    .pill.active{border-color:#2d66ff; box-shadow:0 0 0 2px rgba(45,102,255,.25) inset}
    .pill h4{margin:0 0 6px;font-size:14px}
    .pill p{margin:0;color:#aab0bd;font-size:12px}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{width:min(760px,100%);background:#15161b;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px 18px 16px}
    .modal header{margin:0 0 8px}
    .modal h3{margin:0;font-size:22px}
    .x{background:transparent;border:0;color:#c9ccd6;cursor:pointer;font-size:18px;border-radius:8px}
    .x:hover{color:#fff}
    /* Switch */
    .switch{--w:44px; --h:26px; --pad:3px; position:relative; display:inline-flex; align-items:center; gap:10px; cursor:pointer; user-select:none}
    .switch input{display:none}
    .switch .track{width:var(--w); height:var(--h); background:#2b2e35; border-radius:999px; position:relative; transition:.22s all}
    .switch .thumb{width:calc(var(--h) - var(--pad)*2); height:calc(var(--h) - var(--pad)*2); background:#fff; border-radius:50%; position:absolute; top:var(--pad); left:var(--pad); transition:.22s transform}
    .switch input:checked + .track{background:#2d66ff}
    .switch input:checked + .track .thumb{transform:translateX(calc(var(--w) - var(--h)))}
    .switch .txt{color:#d6dae3}
    .helper{color:#a9afbc;font-size:12px}
    .note{color:#a9afbc;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>FX | CAPITAL R.L. — <span class="muted">Panel del Cliente</span></h1>
      </div>
      <button id="logoutBtn" class="btn btn-outline">Cerrar sesión</button>
    </header>

    <!-- Mi cuenta -->
    <section class="card">
      <h2 class="h2">Mi cuenta</h2>
      <div class="grid grid-2">
        <div>
          <div class="row">
            <span class="tag">Nombre</span>
            <div id="acc_name" class="tag" style="background:#101116;color:#fff;border-color:#23252b">—</div>
          </div>
          <div class="row">
            <span class="tag">Cuenta (ID)</span>
            <div id="acc_id" class="tag" style="background:#101116;color:#fff;border-color:#23252b">—</div>
          </div>
          <button id="openWithdraw" class="btn" style="margin-top:12px">Solicitar retiro</button>
        </div>
        <div>
          <div class="row">
            <span class="tag">Plan</span>
            <div id="acc_plan" class="tag" style="background:#101116;color:#fff;border-color:#23252b">—</div>
            <span class="tag">Moneda</span>
            <div id="acc_currency" class="tag" style="background:#101116;color:#fff;border-color:#23252b">—</div>
          </div>
          <div class="row" style="margin-top:10px">
            <span class="tag">Período (meses)</span>
            <div id="acc_months" class="tag" style="background:#101116;color:#fff;border-color:#23252b">—</div>
            <span class="tag">Capital</span>
            <div id="acc_capital" class="tag" style="background:#101116;color:#fff;border-color:#23252b">Q 0.00</div>
            <span class="tag">Interés total del período</span>
            <div id="acc_interest_total" class="tag" style="background:#101116;color:#fff;border-color:#23252b">Q 0.00</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Resultados del mes -->
    <section class="card" style="margin-top:18px">
      <h2 class="h2">Resultados del mes</h2>
      <div class="note" id="period_note">—</div>
      <table class="table" style="margin-top:10px">
        <thead><tr><th>Viernes</th><th>Interés semanal</th></tr></thead>
        <tbody id="weeks_tbody"><tr><td>—</td><td>—</td></tr></tbody>
        <tfoot><tr><th>Total mes</th><th id="weeks_total">—</th></tr></tfoot>
      </table>
      <div class="helper" id="close_note" style="margin-top:8px"></div>
    </section>

    <!-- Simulador (6 meses) -->
    <section class="card" style="margin-top:18px">
      <h2 class="h2">Simulador de crecimiento</h2>
      <div class="helper">Interés simple por <b>6 meses</b>, con plan asignado automáticamente por monto.</div>
      <div class="grid grid-2" style="margin-top:12px">
        <div>
          <label class="helper">Capital a simular (Q)</label>
          <input id="sim_amount" class="input" inputmode="numeric" placeholder="Ej. 40,000" />
        </div>
        <div>
          <label class="helper">Plan asignado (auto)</label>
          <input id="sim_plan" class="input" disabled />
        </div>
      </div>
      <div style="margin-top:12px">
        <table class="table">
          <thead><tr><th>Mes</th><th>Interés del mes</th></tr></thead>
          <tbody id="sim_tbody"><tr><td>1</td><td>—</td></tr></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Modal retiro -->
  <div class="modal-backdrop" id="wd_backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wd_title">
      <header>
        <h3 id="wd_title">Solicitud de retiro</h3>
        <button class="x" id="wd_close" aria-label="Cerrar">✕</button>
      </header>
      <div class="pill-tabs" id="wd_types">
        <div class="pill active" data-type="early">
          <h4>Antes de tiempo</h4>
          <p>Aplicará una penalización del 10%.</p>
        </div>
        <div class="pill" data-type="health">
          <h4>Causas de salud</h4>
          <p>Exento de penalización.</p>
        </div>
      </div>

      <div class="grid grid-2" style="margin-top:14px">
        <div>
          <label class="helper">Monto a retirar (Q)</label>
          <input id="wd_amount" class="input" placeholder="Ej. 5,000" inputmode="numeric">
          <div class="helper" style="margin-top:6px">Si el retiro es parcial, debe permanecer al menos <b>Q 2,000</b>.</div>

          <label class="switch" style="margin-top:12px" id="wd_switch">
            <input id="wd_all" type="checkbox">
            <span class="track"><span class="thumb"></span></span>
            <span class="txt">Retirar todo mi capital</span>
          </label>
        </div>
        <div>
          <label class="helper">Motivo</label>
          <textarea id="wd_reason" placeholder="Explique brevemente el motivo…"></textarea>
        </div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:12px">
        <button id="wd_submit" class="btn" style="flex:1">Enviar solicitud</button>
        <button id="wd_cancel" class="btn btn-outline">Cancelar</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    // ========= CONFIG =========
    const SUPABASE_URL = 'https://czvpehbubfrinutztnwh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });
    const LOGIN_PATH = '/cliente-login.html';
    const DASH_PATH  = '/cliente-dashboard.html';

    const fmtQ = v => `Q ${Number(v||0).toLocaleString('es-GT', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    const $ = sel => document.querySelector(sel);

    let account = null, user = null;

    // Gate de sesión: si no hay sesión → login
    (async () => {
      const { data:{ session } } = await sb.auth.getSession();
      if (!session) { window.location.replace(LOGIN_PATH); return; }
      user = session.user;
      await loadAccount();
      renderAccount();
      renderWeekly();
      setupUI();
    })();

    // Cerrar sesión → login
    $('#logoutBtn').addEventListener('click', async () => {
      try { await sb.auth.signOut(); } catch(e){}
      window.location.replace(LOGIN_PATH);
    });

    async function loadAccount(){
      // nombre (si existe profile)
      let profName = null;
      try{
        const { data:prof } = await sb.from('profiles').select('id, full_name').eq('id', user.id).maybeSingle();
        profName = prof?.full_name || null;
      }catch{}
      const { data } = await sb.from('accounts')
        .select('id, capital, currency, plan, invest_months, interest_pct, joined_at')
        .eq('user_id', user.id).maybeSingle();
      account = data || null;
      if (account) account.full_name = profName || user.email;
    }

    function renderAccount(){
      $('#acc_name').textContent     = account?.full_name || user?.email || '—';
      $('#acc_id').textContent       = account?.id || '—';
      $('#acc_plan').textContent     = account?.plan || '—';
      $('#acc_currency').textContent = account?.currency || '—';
      $('#acc_months').textContent   = account?.invest_months ?? '—';
      $('#acc_capital').textContent  = fmtQ(account?.capital || 0);

      // interés total del periodo (simple)
      let itotal = 0;
      if (account?.capital && account?.interest_pct && account?.invest_months){
        const per6   = (account.interest_pct/100) * account.capital;
        const factor = (account.invest_months/6);
        itotal = per6 * factor;
      }
      $('#acc_interest_total').textContent = fmtQ(itotal);
    }

    function renderWeekly(){
      const tbody = $('#weeks_tbody');
      tbody.innerHTML = '';
      $('#weeks_total').textContent = '—';
      $('#period_note').textContent = '—';
      $('#close_note').textContent  = '';

      if (!account?.joined_at || !account?.capital || !account?.interest_pct) {
        tbody.innerHTML = '<tr><td>—</td><td>—</td></tr>';
        return;
      }
      const joined = new Date(account.joined_at);
      const today  = new Date();

      // Ventana mensual: del día que entró al mismo día del mes siguiente
      const start = new Date(today);
      start.setDate(joined.getDate());
      if (start > today) start.setMonth(start.getMonth()-1);
      const end = new Date(start); end.setMonth(end.getMonth()+1);

      const fmt = (d)=> d.toLocaleDateString('es-GT',{day:'2-digit',month:'2-digit',year:'numeric'});
      $('#period_note').textContent = `${fmt(start)} — ${fmt(end)}`;
      $('#close_note').textContent  = `El período cierra el ${fmt(end)}.`;

      const monthly = (account.interest_pct/100)*account.capital/6; // simple
      const fridays = [];
      const day = new Date(start);
      while(day.getDay() !== 5) day.setDate(day.getDate()+1); // 5=viernes
      while(day < end){ fridays.push(new Date(day)); day.setDate(day.getDate()+7); }

      let showCount = 0;
      for(const f of fridays){ if (today >= f) showCount++; }
      if (showCount === 0) { tbody.innerHTML = '<tr><td>—</td><td>—</td></tr>'; return; }

      const weeks = fridays.length || 4;
      const base  = monthly / weeks;
      const deltas = Array.from({length:weeks}, ()=> (Math.random()*0.04 - 0.02));
      const sumFactor = deltas.reduce((a,b)=>a+b,0);
      for (let i=0;i<deltas.length;i++) deltas[i] -= sumFactor/weeks;

      for (let i=0;i<showCount;i++){
        const f = fridays[i];
        const interest = Math.max(0, base * (1 + deltas[i]));
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${fmt(f)}</td><td>${fmtQ(interest)}</td>`;
        tbody.appendChild(tr);
      }
      if (today >= end) $('#weeks_total').textContent = fmtQ(monthly);
    }

    // Simulador 6 meses
    function autoPlan(amount){
      let plan='NO ELEGIBLE', pct=0;
      if (amount >= 2000 && amount < 250000){ plan='STANDARD (15% semestral)'; pct=15; }
      else if (amount >= 250000){ plan='PLATINUM (20% semestral)'; pct=20; }
      return {plan,pct};
    }
    document.getElementById('sim_amount').addEventListener('change', calcSim);
    function calcSim(){
      const raw = document.getElementById('sim_amount').value.replace(/[^\d.]/g,'');
      const amount = Number(raw||0);
      const {plan,pct} = autoPlan(amount);
      document.getElementById('sim_plan').value = plan;
      const tbody = document.getElementById('sim_tbody');
      if (pct===0){ tbody.innerHTML = '<tr><td>1</td><td>—</td></tr>'; return; }
      const m = (pct/100)*amount/6; // 6 meses simple
      let rows='';
      for(let i=1;i<=6;i++) rows += `<tr><td>${i}</td><td>${fmtQ(m)}</td></tr>`;
      tbody.innerHTML = rows;
    }

    // Retiro
    function setupUI(){
      // abrir/cerrar modal
      document.getElementById('openWithdraw').addEventListener('click', ()=> document.getElementById('wd_backdrop').style.display='flex');
      document.getElementById('wd_close').addEventListener('click', ()=> document.getElementById('wd_backdrop').style.display='none');
      document.getElementById('wd_cancel').addEventListener('click', ()=> document.getElementById('wd_backdrop').style.display='none');

      // tabs
      document.querySelectorAll('#wd_types .pill').forEach(p=>{
        p.addEventListener('click', ()=>{
          document.querySelectorAll('#wd_types .pill').forEach(x=>x.classList.remove('active'));
          p.classList.add('active');
        });
      });

      // switch retirar todo
      const all = document.getElementById('wd_all');
      const amount = document.getElementById('wd_amount');
      document.getElementById('wd_switch').addEventListener('click', (e)=>{
        e.preventDefault(); all.checked = !all.checked; applyAll();
      });
      all.addEventListener('change', applyAll);
      function applyAll(){
        if (!account) return;
        if (all.checked){ amount.value = String(account.capital||0); amount.setAttribute('disabled','disabled'); }
        else { amount.removeAttribute('disabled'); amount.value=''; }
      }

      // enviar solicitud
      document.getElementById('wd_submit').addEventListener('click', submitWithdraw);
    }

    async function submitWithdraw(){
      if (!account) return alert('Cuenta no disponible.');
      const type = document.querySelector('#wd_types .pill.active')?.dataset.type || 'early';
      const reason = document.getElementById('wd_reason').value.trim();
      const all = document.getElementById('wd_all').checked;
      const amountInput = document.getElementById('wd_amount');
      let amt = 0;
      if (all){ amt = account.capital||0; }
      else{
        const raw = amountInput.value.replace(/[^\d.]/g,''); amt = Number(raw||0);
        if (amt<=0) return alert('Ingrese un monto válido.');
        if (amt > (account.capital||0)) return alert('No puede retirar más que su capital.');
        if ((account.capital - amt) < 2000) return alert('Si el retiro es parcial, el capital restante no puede ser menor a Q 2,000.');
      }
      if (!reason) return alert('Por favor, escriba el motivo.');

      try{
        const { error } = await sb.from('withdrawal_requests').insert({
          account_id: account.id,
          amount: amt,
          type: type === 'early' ? 'EARLY' : 'HEALTH',
          reason
        });
        if (error) throw error;

        // Notificación por Edge Function (opcional)
        try{
          await fetch(`${SUPABASE_URL}/functions/v1/notify-withdrawal`, {
            method:'POST',
            headers:{ 'Content-Type':'application/json','Authorization':`Bearer ${SUPABASE_ANON_KEY}` },
            body: JSON.stringify({
              account_id: account.id,
              client_name: account.full_name || user.email,
              client_email: user.email,
              amount: amt,
              type: (type === 'early' ? 'EARLY' : 'HEALTH'),
              reason
            })
          });
        }catch(_){}

        alert('Hemos recibido su solicitud; será atendida en un lapso no mayor a 24 horas hábiles, de lunes a viernes, dentro del horario laboral establecido.');
        document.getElementById('wd_backdrop').style.display='none';
      }catch(e){
        console.error(e); alert('No se pudo registrar la solicitud.');
      }
    }
  </script>
</body>
</html>
