<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. ‚Äî Panel Cliente</title>
<style>
:root{--bg:#000;--fg:#fff;--muted:#ffffffcc;--card:#0f0f0f;--card2:#141414;--border:#1f1f1f;--accent:#ffffff;}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
.container{max-width:1100px;margin:0 auto;padding:24px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card{background:linear-gradient(180deg,var(--card2),#181818);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px}
h1,h2{margin:0 0 8px}
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;margin-right:8px;color:#cfd6e4}
.grid-3{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
table{width:100%;border-collapse:collapse} th,td{padding:12px 10px;border-bottom:1px solid var(--border)} th{text-align:left;color:var(--muted)}
small{color:var(--muted)}
button{background:#fff;color:#000;border:none;padding:12px 16px;border-radius:999px;font-weight:700;cursor:pointer}
.btn-outline{background:transparent;border:1px solid var(--border);color:#fff}
.pill{border-radius:999px;border:1px solid var(--border);padding:6px 10px;display:inline-block}
.hidden{display:none !important}

/* ===== MODAL CAMBIO DE CONTRASE√ëA ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:20px;z-index:10000}
.modal-card{width:100%;max-width:640px;background:linear-gradient(180deg,#151515,#1b1b1b);border:1px solid #2a2a2a;border-radius:18px;padding:22px 22px 16px;box-shadow:0 15px 40px #000a;position:relative}
.modal-titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.modal-titlebar h3{margin:0;font-size:22px}
.close-x{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
.modal-sub{color:var(--muted);margin-bottom:14px}
label{display:block;margin:8px 0 4px}

/* inputs + ojos */
.input-wrap{position:relative}
.input-wrap .prefix{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.6}
.input-wrap input, .input-wrap textarea{width:100%;background:#000;color:#fff;border:1px solid #2a2a2a;border-radius:12px;padding:10px 64px 10px 38px;height:50px;font-size:16px}
textarea{padding:12px 12px 12px 42px;height:120px;resize:vertical}
.eye-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);width:46px;height:46px;background:transparent;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5}
.eye,.eye-off{width:32px;height:32px;fill:#fff;opacity:.98}

/* Toast */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#101b10;border:1px solid #214c21;color:#c6f3c6;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px #000a;z-index:11000}

/* ===== MODAL RETIRO ===== */
.sheet{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px;z-index:9000}
.sheet-card{width:100%;max-width:900px;background:#151515;border:1px solid #303030;border-radius:18px;box-shadow:0 15px 40px #000a;padding:22px;position:relative}
.sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.sheet-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.option-row{display:flex;gap:12px}
.opt{flex:1;background:#0f1216;border:1px solid #253043;border-radius:14px;padding:16px;color:#fff}
.opt h4{margin:0 0 4px}
.opt p{margin:0;color:#a9b7d0;font-size:13px}
.opt.active{outline:2px solid #7aa2ff}
.opt *{color:#fff} /* fuerza blanco en tarjetas */

/* Simulator stats */
.kpi{background:#111;border:1px solid var(--border);border-radius:14px;padding:12px}
.kpi h5{margin:0 0 6px;color:#cfd6e4}
.kpi .v{font-weight:700;font-size:18px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>FX | CAPITAL R.L. ‚Äî Panel Cliente</h1>
    <button id="logoutBtn" type="button">Cerrar sesi√≥n</button>
  </div>

  <div class="card">
    <h2>Mi cuenta</h2>
    <div class="grid-3">
      <div><span class="badge">Nombre</span><div id="c_name">‚Äî</div></div>
      <div><span class="badge">Plan</span><div id="c_plan">‚Äî</div></div>
      <div><span class="badge">Moneda</span><div id="c_currency">‚Äî</div></div>
      <div><span class="badge">Capital</span><div id="c_capital">‚Äî</div></div>
      <div><span class="badge">Cuenta (ID)</span><div id="c_account">‚Äî</div></div>
      <div><span class="badge">Per√≠odo (meses)</span><div id="c_months">‚Äî</div></div>
      <div><span class="badge">Inter√©s total del per√≠odo</span><div id="c_period_interest">‚Äî</div></div>
    </div>
    <div style="margin-top:12px">
      <button id="withdrawBtn" class="btn-outline" type="button">Solicitar retiro</button>
    </div>
  </div>

  <div class="card">
    <h2>Resultados del mes</h2>
    <p id="periodLabel">‚Äî</p>
    <table>
      <thead><tr><th>Viernes</th><th>Inter√©s semanal</th></tr></thead>
      <tbody id="weeks"></tbody>
      <tfoot><tr><th>Total mes</th><th id="monthTotal">‚Äî</th></tr></tfoot>
    </table>
    <small id="periodNote" class="pill" style="margin-top:8px;display:inline-block"></small>
  </div>

  <div class="card">
    <h2>Simulador de crecimiento</h2>
    <small>Proyecci√≥n con capitalizaci√≥n <b>no compuesta</b> (inter√©s simple) por <b>6 meses</b>, seg√∫n el plan asignado autom√°ticamente por monto.</small>
    <div class="grid-3" style="margin-top:10px">
      <div class="input-wrap">
        <span class="prefix">Q</span>
        <input id="simCapital" type="number" placeholder="Ej. 40,000">
      </div>
      <div class="input-wrap">
        <input id="simPlan" type="text" disabled value="NO ELEGIBLE">
      </div>
      <div><button id="simCalc" type="button">Calcular</button></div>
    </div>

    <div class="grid-3" style="margin-top:14px">
      <div class="kpi"><h5>Capital inicial</h5><div id="simCapKpi" class="v">‚Äî</div></div>
      <div class="kpi"><h5>Inter√©s total acumulado (6m)</h5><div id="simIntKpi" class="v">‚Äî</div></div>
      <div class="kpi"><h5>Capital final estimado (6m)</h5><div id="simTotalKpi" class="v">‚Äî</div></div>
    </div>

    <table style="margin-top:12px">
      <thead><tr><th>Mes</th><th>Inter√©s del mes</th></tr></thead>
      <tbody id="simRows"></tbody>
    </table>
    <small id="simFoot" style="display:block;margin-top:8px;color:#aab2c2"></small>
  </div>
</div>

<!-- ===== MODAL CAMBIO CONTRASE√ëA ===== -->
<div id="pwdModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="pwdTitle">
  <div class="modal-card">
    <div class="modal-titlebar">
      <h3 id="pwdTitle">BIENVENIDO A FX | CAPITAL R.L.</h3>
      <button id="pwdCloseX" class="close-x" type="button" title="Cerrar" aria-label="Cerrar">‚úï</button>
    </div>
    <p class="modal-sub">Por motivos de seguridad, le solicitamos actualizar su contrase√±a actual.</p>

    <label>Correo electr√≥nico</label>
    <div class="input-wrap">
      <span class="prefix">‚úâÔ∏è</span>
      <input id="pwdEmail" type="email" placeholder="tu@email.com" autocomplete="email">
    </div>

    <label style="margin-top:8px">Contrase√±a actual</label>
    <div class="input-wrap">
      <span class="prefix">üîí</span>
      <input id="curPwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      <button type="button" class="eye-btn" data-toggle="curPwd" aria-label="mostrar/ocultar">
        <svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>
    </div>

    <label style="margin-top:8px">Nueva contrase√±a</label>
    <div class="input-wrap">
      <span class="prefix">üÜï</span>
      <input id="newPwd" type="password" placeholder="M√≠nimo 8 caracteres" autocomplete="new-password">
      <button type="button" class="eye-btn" data-toggle="newPwd" aria-label="mostrar/ocultar">
        <svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>
    </div>

    <label style="margin-top:8px">Confirmar nueva contrase√±a</label>
    <div class="input-wrap">
      <span class="prefix">‚úÖ</span>
      <input id="confPwd" type="password" placeholder="Repetir nueva contrase√±a" autocomplete="new-password">
      <button type="button" class="eye-btn" data-toggle="confPwd" aria-label="mostrar/ocultar">
        <svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>
    </div>

    <div style="display:flex;gap:10px;margin-top:10px">
      <label><input id="showAllPwds" type="checkbox"> Mostrar contrase√±as</label>
    </div>
    <div class="helper" style="color:#aab2c2;margin-bottom:6px">Use al menos 8 caracteres. Recomendado: letras, n√∫meros y s√≠mbolos.</div>

    <div id="pwdMsg" style="color:#ffb3b3;min-height:20px;text-align:center"></div>
    <div id="pwdOk" style="color:#b3ffcb;min-height:20px;text-align:center"></div>

    <div style="display:flex;gap:10px;margin-top:10px">
      <button id="pwdSubmit" class="btn-outline" type="button">Actualizar contrase√±a</button>
      <button id="pwdCancel" class="btn-outline" type="button">Cancelar</button>
    </div>
  </div>
</div>

<!-- ===== MODAL RETIRO ===== -->
<div id="wSheet" class="sheet hidden" role="dialog" aria-modal="true">
  <div class="sheet-card">
    <div class="sheet-head">
      <h3>Solicitud de retiro</h3>
      <button id="wClose" class="close-x" type="button">‚úï</button>
    </div>
    <div class="sheet-grid">
      <div>
        <label>Seleccione el tipo de retiro</label>
        <div class="option-row">
          <div id="optEarly" class="opt active" data-kind="EARLY">
            <h4>Antes de tiempo</h4>
            <p>Aplicar√° una penalizaci√≥n del 10%.</p>
          </div>
          <div id="optHealth" class="opt" data-kind="HEALTH">
            <h4>Causas de salud</h4>
            <p>Exento de penalizaci√≥n.</p>
          </div>
        </div>

        <div style="margin-top:12px">
          <label class="input-wrap" style="padding-left:0">
            <span class="prefix">Q</span>
            <input id="wAmount" type="number" placeholder="Ej. 5,000">
          </label>
          <small>Si el retiro es parcial, debe permanecer al menos Q 2,000.</small>
        </div>

        <div style="margin-top:12px;display:flex;align-items:center;gap:10px">
          <input id="wAll" type="checkbox"><label for="wAll" style="margin:0">Retirar todo mi capital</label>
        </div>
      </div>
      <div>
        <label>Motivo</label>
        <div class="input-wrap">
          <span class="prefix">‚úèÔ∏è</span>
          <textarea id="wReason" placeholder="Explique brevemente el motivo‚Ä¶"></textarea>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-start">
      <button id="wSend" type="button">Enviar solicitud</button>
      <button id="wCancel" type="button" class="btn-outline">Cancelar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden">Listo.</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** CONFIG SUPABASE ***/
const PROJECT_URL="https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE=PROJECT_URL+"/rest/v1";
const supa = supabase.createClient(PROJECT_URL, ANON_KEY);
function hdr(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||"")}}
function hdrJSON(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||""),"Content-Type":"application/json"}}
const GTZ='America/Guatemala';
function guateNow(){return new Date(new Date().toLocaleString('en-US',{timeZone:GTZ}))}
function money(n,cur){return new Intl.NumberFormat('es-GT',{style:'currency',currency:(cur||'GTQ')==='USD'?'USD':'GTQ'}).format(n||0)}
function toast(msg){const t=document.getElementById('toast'); t.textContent=msg||'Listo.'; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2200);}

/*** STATE ***/
let PROFILE=null,ACCOUNT=null;
let PWD_FORCE=true;

/*** LOGOUT ***/
function logout(){ localStorage.clear(); location.href='cliente-login.html'; }
document.getElementById('logoutBtn').onclick=logout;

/*** EYES toggle ***/
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('.eye-btn'); if(!btn) return;
  const id=btn.getAttribute('data-toggle'); const el=document.getElementById(id); if(!el) return;
  el.type=(el.type==='password')?'text':'password';
  btn.innerHTML=(el.type==='password')
    ? `<svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>`
    : `<svg class="eye-off" viewBox="0 0 24 24"><path d="M2 5l2-2 17 17-2 2-3.6-3.6C13.7 19 12.9 19 12 19 5 19 2 12 2 12a17 17 0 0 1 5.2-6.3L2 5zm7.3 2.9A5 5 0 0 0 7 12a5 5 0 0 0 5 5c.6 0 1.1-.1 1.6-.3L9.3 7.9zM12 5c7 0 10 7 10 7a16.8 16.8 0 0 1-3.2 4.7l-1.5-1.5A14.6 14.6 0 0 0 20 12s-3-7-8-7c-1 0-2 .2-2.9 .5L7.7 4.1C9 3.7 10.4 3.5 12 3.5z"/></svg>`;
});

/*** MODAL helpers ***/
const $pwdModal  = document.getElementById('pwdModal');
const $pwdCancel = document.getElementById('pwdCancel');
const $pwdCloseX = document.getElementById('pwdCloseX');
function reallyHideModal(){ $pwdModal.classList.add('hidden'); $pwdModal.style.display='none'; setTimeout(()=>{$pwdModal.style.display='';},0); }
function closePwdModal(){ reallyHideModal(); sessionStorage.pwdModalDismissed='1'; }
function openPwdModal(force){
  PWD_FORCE = !!force;
  document.getElementById('pwdCancel').style.display = force ? 'none' : 'inline-block';
  document.getElementById('pwdCloseX').style.display = force ? 'none' : 'flex';
  document.getElementById('pwdEmail').value = localStorage.email || '';
  ['curPwd','newPwd','confPwd'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('pwdMsg').textContent=''; document.getElementById('pwdOk').textContent='';
  $pwdModal.classList.remove('hidden');
}
['click','touchend'].forEach(evt=>{
  $pwdCancel.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation(); if(!PWD_FORCE) closePwdModal();});
  $pwdCloseX.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation(); if(!PWD_FORCE) closePwdModal();});
});
$pwdModal.addEventListener('click',(e)=>{ if(e.target===$pwdModal && !PWD_FORCE) closePwdModal(); });
window.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && !PWD_FORCE && !$pwdModal.classList.contains('hidden')) closePwdModal(); });
document.getElementById('showAllPwds').addEventListener('change',(e)=>{['curPwd','newPwd','confPwd'].forEach(id=>{const el=document.getElementById(id); el.type=e.target.checked?'text':'password';});});

/*** WITHDRAW sheet ***/
const $wSheet = document.getElementById('wSheet');
document.getElementById('withdrawBtn').onclick=()=>{$wSheet.classList.remove('hidden');};
document.getElementById('wClose').onclick=()=>{$wSheet.classList.add('hidden');};
document.getElementById('wCancel').onclick=()=>{$wSheet.classList.add('hidden');};
document.getElementById('optEarly').onclick=selOpt; document.getElementById('optHealth').onclick=selOpt;
function selOpt(e){ document.querySelectorAll('.opt').forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active'); }
document.getElementById('wAll').addEventListener('change',(e)=>{ document.getElementById('wAmount').disabled=e.target.checked; });

document.getElementById('wSend').onclick=async ()=>{
  const kind = document.querySelector('.opt.active')?.dataset.kind || 'EARLY';
  const all  = document.getElementById('wAll').checked;
  const amt  = Number(document.getElementById('wAmount').value||0);
  const reason = (document.getElementById('wReason').value||'').trim();
  if(!all && (!amt || amt<=0)){ toast('Ingrese un monto v√°lido.'); return; }
  if(!reason){ toast('Indique un motivo.'); return; }
  // payload SIN user_id (RLS lo toma de auth.uid())
  const payload = { kind, withdraw_all: all, amount: all? null : amt, reason, account_id: ACCOUNT?.id || null };
  try{
    await fetch(`${BASE}/withdrawal_requests`,{
      method:'POST', headers:{...hdrJSON(),"Prefer":"return=minimal"}, body:JSON.stringify(payload)
    });
    $wSheet.classList.add('hidden');
    alert('Hemos recibido su solicitud; ser√° atendida en un lapso no mayor a 24 horas h√°biles, de lunes a viernes, dentro del horario laboral establecido.');
  }catch{ toast('No se pudo enviar la solicitud.'); }
};

/*** BOOT ***/
(async function boot(){
  if(!localStorage.token){ logout(); return; }

  // Validar token
  const rUser=await fetch(`${PROJECT_URL}/auth/v1/user`,{headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`}})
  if(!rUser.ok){ logout(); return; }

  // Perfil + Cuenta (traer joined_at, invest_months, interest_pct)
  const rp=await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}&select=id,full_name,require_password_change,first_login_completed`,{headers:hdr()});
  PROFILE=(await rp.json())[0]||null;

  const ra=await fetch(`${BASE}/accounts?user_id=eq.${localStorage.uid}&select=id,currency,principal_locked,plan,black_enabled,joined_at,invest_months,interest_pct`,{headers:hdr()});
  ACCOUNT=(await ra.json())[0]||null;

  // Pintar cabecera
  document.getElementById("c_name").textContent=PROFILE?.full_name||"‚Äî";
  document.getElementById("c_plan").textContent=ACCOUNT?.plan||"‚Äî";
  document.getElementById("c_currency").textContent=ACCOUNT?.currency||"‚Äî";
  document.getElementById("c_capital").textContent=money(ACCOUNT?.principal_locked||0,ACCOUNT?.currency||"GTQ");
  document.getElementById("c_account").textContent=ACCOUNT?.id||"‚Äî";
  document.getElementById("c_months").textContent=ACCOUNT?.invest_months ?? "‚Äî";

  // Inter√©s total del per√≠odo (simple)
  const semRate = getSemRate();
  const totalPeriodInt = (ACCOUNT?.principal_locked||0) * semRate * ( (ACCOUNT?.invest_months||0)/6 );
  document.getElementById("c_period_interest").textContent = money(totalPeriodInt, ACCOUNT?.currency);

  // Construir resultados mensuales (ventana m√≥vil)
  buildMonthResults();

  // Mostrar modal SOLO primera vez
  const firstLoginNotDone = PROFILE?.first_login_completed !== true;
  const localSkip = localStorage.pwdFirstDone === 'true' || sessionStorage.pwdModalDismissed === '1';
  if (firstLoginNotDone && !localSkip) openPwdModal(true);

  // Eventos modal password
  document.getElementById('pwdSubmit').onclick=submitPasswordChange;

  // Simulador
  document.getElementById('simCalc').onclick=runSimulator;
})();

/*** Helpers negocio ***/
function getSemRate(){
  // Si el admin fij√≥ inter√©s personalizado en % semestral
  if(typeof ACCOUNT?.interest_pct === 'number' && !isNaN(ACCOUNT.interest_pct)) return (ACCOUNT.interest_pct/100);
  // Por plan
  const p=(ACCOUNT?.plan||'').toUpperCase();
  if(p==='BLACK') return 0.25;
  if(p==='PLATINUM') return 0.20;
  return 0.15; // STANDARD
}

function buildMonthResults(){
  if(!ACCOUNT) return;

  const capital = ACCOUNT.principal_locked||0;
  const currency = ACCOUNT.currency||'GTQ';
  const planRate = getSemRate();               // 0.15 | 0.20 | 0.25
  const monthRate = planRate / 6;              // % mensual simple
  const monthInterest = capital * monthRate;   // inter√©s del mes (exacto)

  // Ventana desde el d√≠a de ingreso a mismo d√≠a del mes siguiente
  const joinedAt = ACCOUNT.joined_at ? new Date(ACCOUNT.joined_at) : guateNow();
  const now = guateNow();
  const start = shiftToLocalSameTime(joinedAt); // inicio de la ventana vigente (este mes m√≥vil)
  const end   = addOneMonthSameDay(start);

  // Si ya pas√≥ el cierre, mueve ventana al siguiente ciclo hasta abarcar "ahora"
  while(now >= end){ start.setMonth(start.getMonth()+1); end.setMonth(end.getMonth()+1); }

  // Rango visible
  const label = `${fmtLong(start)} ‚Äî ${fmtLong(end)}`;
  document.getElementById('periodLabel').textContent = label;

  // Fridays dentro del rango
  const fridays = listFridaysBetween(start, end);
  const pastFridays = fridays.filter(d=> d <= now);  // solo semanas transcurridas

  // Distribuci√≥n determin√≠stica para que las semanas var√≠en y el cierre cuadre exacto
  const weights = seededWeekWeights(ACCOUNT.id, start, fridays.length);
  const amounts = splitByWeights(monthInterest, weights); // array de N que suma exactamente

  const tb=document.getElementById('weeks'); tb.innerHTML='';
  let shownSum = 0;
  pastFridays.forEach((d,i)=>{
    const tr=document.createElement('tr');
    const amt = amounts[i] || 0;
    shownSum += amt;
    tr.innerHTML=`<td>${d.toLocaleDateString('es-GT',{timeZone:GTZ})}</td><td>${money(amt,currency)}</td>`;
    tb.appendChild(tr);
  });

  // Total solo al cierre del per√≠odo
  const atClose = now >= end;
  document.getElementById('monthTotal').textContent = atClose ? money(monthInterest, currency) : '‚Äî';
  const note = document.getElementById('periodNote');
  note.textContent = atClose ? '' : `El per√≠odo cierra el ${end.toLocaleDateString('es-GT',{timeZone:GTZ})}.`;
  note.style.display = atClose ? 'none':'inline-block';
}

// Fechas utilitarias
function fmtLong(d){ return d.toLocaleDateString('es-GT',{timeZone:GTZ, day:'numeric', month:'long', year:'numeric'}); }
function shiftToLocalSameTime(d){
  // Asegura fecha local (sin perder d√≠a) para GT
  const local = new Date(d.toLocaleString('en-US',{timeZone:GTZ}));
  return new Date(local.getFullYear(), local.getMonth(), local.getDate(), 0,0,0,0);
}
function addOneMonthSameDay(d){
  const x=new Date(d); const m=x.getMonth(); x.setMonth(m+1);
  // Si el mes tiene menos d√≠as, JS ajusta; est√° bien para un periodo "hasta esa fecha"
  return x;
}
function listFridaysBetween(start,end){
  const res=[]; const d=new Date(start);
  // ir al primer viernes >= start
  while(d.getDay()!==5){ d.setDate(d.getDate()+1); }
  while(d<end){ res.push(new Date(d)); d.setDate(d.getDate()+7); }
  return res;
}
// pesos determin√≠sticos por cuenta y periodo
function seededWeekWeights(accountId, startDate, n){
  if(n<=0) return [];
  const seed = hashStr(String(accountId) + '|' + startDate.toISOString());
  let x = seed % 2147483647; if(x<=0) x+=2147483646;
  const arr=[]; for(let i=0;i<n;i++){ x=(x*48271)%2147483647; arr.push(0.6 + (x/2147483647)); } // 0.6..1.6 aprox
  const s=arr.reduce((a,b)=>a+b,0); return arr.map(v=>v/s);
}
function hashStr(s){ let h=2166136261>>>0; for(let i=0;i<s.length;i++){ h^=s.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }
function splitByWeights(total,normW){
  const n=normW.length; if(n===0) return [];
  // repartir y ajustar centavos para que la suma sea exacta
  const raw = normW.map(w=> total*w);
  const cents = raw.map(v=> Math.floor(v*100));
  let diff = Math.round(total*100) - cents.reduce((a,b)=>a+b,0);
  // distribuir los centavos faltantes/sobrantes
  let i=0; while(diff!==0){ const step = diff>0?1:-1; cents[i]+=step; diff-=step; i=(i+1)%n; }
  return cents.map(c=> c/100);
}

/*** Simulador (6 meses fijo, inter√©s simple) ***/
function autoPlanForAmount(amount){
  // BLACK aplica si la cuenta lo tiene habilitado
  if(ACCOUNT?.black_enabled) return {name:'BLACK',rate:0.25};
  if(amount>=250000) return {name:'PLATINUM',rate:0.20};
  if(amount>=2000) return {name:'STANDARD',rate:0.15};
  return {name:'NO ELEGIBLE',rate:0};
}
function runSimulator(){
  const amt = Number(document.getElementById('simCapital').value||0);
  const plan = autoPlanForAmount(amt);
  const months = 6;
  const monthRate = plan.rate/6;
  const monthInt = amt * monthRate;
  const totalInt = monthInt * months;
  document.getElementById('simPlan').value = plan.name + (plan.rate?` (${Math.round(plan.rate*100)}% semestral)`:``);
  document.getElementById('simCapKpi').textContent = money(amt, ACCOUNT?.currency);
  document.getElementById('simIntKpi').textContent = money(totalInt, ACCOUNT?.currency);
  document.getElementById('simTotalKpi').textContent = money(amt + totalInt, ACCOUNT?.currency);

  const tb=document.getElementById('simRows'); tb.innerHTML='';
  for(let m=1;m<=months;m++){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${m}</td><td>${money(monthInt, ACCOUNT?.currency)}</td>`;
    tb.appendChild(tr);
  }
  document.getElementById('simFoot').textContent = plan.rate
    ? `Plan: ${plan.name}. Tasa semestral ${Math.round(plan.rate*100)}%. ‚Äî Inter√©s simple (no compuesto).`
    : `Monto no elegible (< Q2,000).`;
}

/*** Cambio de contrase√±a ***/
async function submitPasswordChange(){
  const email=(document.getElementById('pwdEmail').value||'').trim();
  const cur=document.getElementById('curPwd').value;
  const neo=document.getElementById('newPwd').value;
  const rep=document.getElementById('confPwd').value;
  const err=document.getElementById('pwdMsg'); const ok=document.getElementById('pwdOk'); err.textContent=''; ok.textContent='';

  if(!email||!cur||!neo||!rep){ err.textContent='Complete todos los campos.'; return; }
  if(neo.length<8){ err.textContent='La nueva contrase√±a debe tener al menos 8 caracteres.'; return; }
  if(neo!==rep){ err.textContent='La confirmaci√≥n no coincide.'; return; }

  const btn = document.getElementById('pwdSubmit');
  btn.disabled = true; const oldTxt = btn.textContent; btn.textContent = 'Actualizando...';

  const { error: signInErr } = await supa.auth.signInWithPassword({ email, password: cur });
  if (signInErr) { err.textContent='Correo o contrase√±a actual incorrectos.'; btn.disabled=false; btn.textContent=oldTxt; return; }

  const { error: updErr } = await supa.auth.updateUser({ password: neo });
  if (updErr) { err.textContent = updErr.message || 'No se pudo actualizar la contrase√±a.'; btn.disabled=false; btn.textContent=oldTxt; return; }

  // refrescar sesi√≥n local
  const { data: signInNew, error: signInNewErr } = await supa.auth.signInWithPassword({ email, password: neo });
  if (!signInNewErr && signInNew?.session?.access_token) {
    localStorage.token = signInNew.session.access_token;
    localStorage.uid   = signInNew.user.id;
    localStorage.email = email;
  }

  // marcar primer login completado (para NO mostrar m√°s el modal)
  try{
    await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}`,{
      method:'PATCH',headers:hdrJSON(),
      body:JSON.stringify({ first_login_completed:true, require_password_change:false, last_password_changed_at:new Date().toISOString() })
    });
  }catch{}

  localStorage.pwdFirstDone = 'true';
  sessionStorage.pwdModalDismissed = '1';
  PWD_FORCE = false;
  document.getElementById('pwdCancel').style.display='inline-block';
  document.getElementById('pwdCloseX').style.display='flex';

  ok.textContent='Contrase√±a actualizada correctamente.';
  setTimeout(()=>{ closePwdModal(); toast('Contrase√±a actualizada correctamente.'); }, 250);

  btn.disabled=false; btn.textContent=oldTxt;
}
</script>
</body>
</html>
