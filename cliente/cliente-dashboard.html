<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. — Panel Cliente</title>
<style>
:root{--bg:#000;--fg:#fff;--muted:#ffffffcc;--card:#0d0d0d;--border:#1a1a1a;--accent:#4ea1ff;--accent-2:#8ab6ff;--danger:#ff7777}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
.container{max-width:1100px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
h1,h2{margin:0 0 8px}
small{color:var(--muted)}
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;margin-right:8px}
.grid-3{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
button{background:#fff;color:#000;border:none;padding:12px 16px;border-radius:999px;font-weight:700;cursor:pointer}
.hidden{display:none!important}
.helper{font-size:12px;color:#9fb4d1}
.err{color:#ffb3b3;min-height:18px;text-align:center}
.success{color:#b3ffcb;min-height:18px;text-align:center}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--border)}
th{text-align:left;color:var(--muted)}

/* ===== MODAL RETIRO ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;padding:20px;z-index:10000}
.modal-card{width:100%;max-width:820px;background:linear-gradient(180deg,#151515,#1c1c1c);border:1px solid #2a2a2a;border-radius:18px;padding:22px 22px 18px;box-shadow:0 15px 40px #000a;position:relative}
.modal-titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.modal-titlebar h3{margin:0;font-size:22px}
.close-x{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}

.select-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
.opt{border:1px solid #2a2a2a;border-radius:14px;padding:14px 12px}
.opt.active{border-color:#3466ff;box-shadow:0 0 0 3px #3466ff22}
.opt h4{margin:0 0 4px;color:#fff}
.opt p{margin:0;color:#cbd5ff}

/* Inputs */
label{display:block;margin:10px 0 6px}
.input-wrap{position:relative}
.input-wrap .prefix{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.6}
.input-wrap input{width:100%;background:#000;color:#fff;border:1px solid #2a2a2a;border-radius:12px;padding:10px 12px 10px 42px;height:46px}
textarea{width:100%;min-height:120px;background:#000;color:#fff;border:1px solid #2a2a2a;border-radius:12px;padding:12px}

/* Modern switch */
.switch{display:inline-flex;align-items:center;gap:10px}
.switch input{position:absolute;opacity:0;pointer-events:none}
.toggle{
  width:54px;height:30px;border-radius:999px;background:#222;border:1px solid #2a2a2a;position:relative;transition:all .25s ease;
  box-shadow:inset 0 0 0 0 #3466ff;
}
.toggle::after{
  content:"";position:absolute;left:3px;top:3px;width:24px;height:24px;border-radius:50%;
  background:#fff;transition:transform .25s ease, background .25s ease;
}
.switch input:checked + .toggle{
  background:#0b2a64;border-color:#3466ff;box-shadow:inset 0 0 0 18px #1a3f8a;
}
.switch input:checked + .toggle::after{transform:translateX(24px);background:#cfe2ff}
.switch label{cursor:pointer;color:#fff}

/* actions row */
.modal-actions{display:flex;gap:10px;margin-top:14px}
.modal-actions .primary{flex:1;background:#0f0f0f;color:#fff;border:1px solid #2a2a2a}

/* Toast */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#101b10;border:1px solid #214c21;color:#c6f3c6;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px #000a;z-index:11000}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>FX | CAPITAL R.L. — Panel Cliente</h1>
    <button id="logoutBtn" type="button">Cerrar sesión</button>
  </div>

  <div class="card">
    <h2>Mi cuenta</h2>
    <div class="grid-3">
      <div><span class="badge">Nombre</span><div id="c_name">—</div></div>
      <div><span class="badge">Plan</span><div id="c_plan">—</div></div>
      <div><span class="badge">Moneda</span><div id="c_currency">—</div></div>
      <div><span class="badge">Capital</span><div id="c_capital">—</div></div>
      <div><span class="badge">Cuenta (ID)</span><div id="c_account">—</div></div>
      <div><span class="badge">Período (meses)</span><div id="c_months">—</div></div>
      <div><span class="badge">Interés total del período</span><div id="c_interest_total">—</div></div>
    </div>
    <div style="margin-top:12px">
      <button id="openWithdraw" type="button">Solicitar retiro</button>
    </div>
  </div>

  <div class="card">
    <h2>Resultados del mes</h2>
    <p id="monthLabel">—</p>
    <table>
      <thead><tr><th>Viernes</th><th>Interés semanal</th></tr></thead>
      <tbody id="weeks"></tbody>
      <tfoot><tr><th>Total mes</th><th id="monthTotal">—</th></tr></tfoot>
    </table>
    <div class="helper" id="periodHint"></div>
  </div>

  <!-- ===== SIMULADOR 6 MESES ===== -->
  <div class="card">
    <h2>Simulador de crecimiento</h2>
    <small>Proyección con capitalización <b>no compuesta</b> (interés simple) por <b>6 meses</b>, según el plan asignado automáticamente por monto.</small>
    <div class="grid-3" style="margin-top:10px">
      <div>
        <label>Capital a simular (Q)</label>
        <div class="input-wrap">
          <span class="prefix">Q</span>
          <input id="sim_cap" placeholder="Ej. 40,000">
        </div>
      </div>
      <div>
        <label>Plan asignado (auto)</label>
        <div id="sim_plan" class="badge" style="display:block;height:46px;line-height:28px;padding-top:8px">—</div>
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="sim_btn" type="button">Calcular</button>
      </div>
    </div>
    <div class="grid-3" style="margin-top:12px">
      <div><span class="badge">Capital inicial</span><div id="sim_capital0">—</div></div>
      <div><span class="badge">Interés total acumulado</span><div id="sim_interest_total">—</div></div>
      <div><span class="badge">Capital final estimado</span><div id="sim_final">—</div></div>
    </div>
    <table style="margin-top:10px">
      <thead><tr><th>Mes</th><th>Interés del mes</th></tr></thead>
      <tbody id="sim_rows"></tbody>
    </table>
    <div class="helper" id="sim_legend"></div>
  </div>
</div>

<!-- ===== MODAL RETIRO ===== -->
<div id="withdrawModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="wTitle">
  <div class="modal-card">
    <div class="modal-titlebar">
      <h3 id="wTitle">Solicitud de retiro</h3>
      <button id="wCloseX" class="close-x" type="button" title="Cerrar" aria-label="Cerrar">✕</button>
    </div>

    <div class="select-row">
      <div id="optEarly" class="opt active" tabindex="0" role="button" aria-pressed="true">
        <h4>Antes de tiempo</h4>
        <p>Aplicará una penalización del 10%.</p>
      </div>
      <div id="optHealth" class="opt" tabindex="0" role="button" aria-pressed="false">
        <h4>Causas de salud</h4>
        <p>Exento de penalización.</p>
      </div>
    </div>

    <div class="grid-3" style="margin-top:12px">
      <div style="grid-column:1/2">
        <label>Monto a retirar (Q)</label>
        <div class="input-wrap">
          <span class="prefix">Q</span>
          <input id="wAmount" inputmode="numeric" placeholder="Ej. 5,000">
        </div>
        <div class="helper" id="wRule">Si el retiro es parcial, debe permanecer al menos Q 2,000.</div>
      </div>
      <div style="grid-column:2/4">
        <label>Motivo</label>
        <textarea id="wReason" placeholder="Explique brevemente el motivo…"></textarea>
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="switch" title="Retirar todo mi capital">
        <input id="wAll" type="checkbox" aria-label="Retirar todo mi capital">
        <span class="toggle"></span>
        <label for="wAll">Retirar todo mi capital</label>
      </div>
    </div>

    <div id="wErr" class="err" style="margin-top:8px"></div>
    <div class="modal-actions">
      <button id="wSend" class="primary" type="button">Enviar solicitud</button>
      <button id="wCancel" type="button">Cancelar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden">Listo.</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** CONFIG SUPABASE ***/
const PROJECT_URL="https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE=PROJECT_URL+"/rest/v1";
const supa = supabase.createClient(PROJECT_URL, ANON_KEY);

function hdr(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||"")}}
function hdrJSON(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||""),"Content-Type":"application/json"}}
const GTZ='America/Guatemala';
function money(n,cur){return new Intl.NumberFormat('es-GT',{style:'currency',currency:cur==='USD'?'USD':'GTQ'}).format(Number(n||0))}
function guateNow(){return new Date(new Date().toLocaleString('en-US',{timeZone:GTZ}))}
function toast(msg){const t=document.getElementById('toast'); t.textContent=msg||'Listo.'; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2000);}

/*** LOGOUT (con redirección robusta) ***/
function logout(){
  localStorage.clear(); sessionStorage.clear();
  // Intento 1: ruta absoluta en el subdominio
  location.replace('/cliente-login.html');
  // Fallback por si el hosting reescribe rutas
  setTimeout(()=>{ location.href = 'https://clientes.fxcapital-gt.com/cliente-login.html'; }, 150);
}
document.getElementById('logoutBtn').onclick=logout;

/*** ESTADO ***/
let PROFILE=null,ACCOUNT=null;

/*** BOOT ***/
(async function boot(){
  if(!localStorage.token){ logout(); return; }

  const rUser=await fetch(`${PROJECT_URL}/auth/v1/user`,{headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`}})
  if(!rUser.ok){ logout(); return; }

  const rp=await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}&select=id,full_name,require_password_change,first_login_completed`,{headers:hdr()});
  PROFILE=(await rp.json())[0]||null;

  const ra=await fetch(`${BASE}/accounts?user_id=eq.${localStorage.uid}&select=id,currency,principal_locked,plan,months,interest_pct,joined_at`,{headers:hdr()});
  ACCOUNT=(await ra.json())[0]||null;

  document.getElementById("c_name").textContent=PROFILE?.full_name||"—";
  document.getElementById("c_plan").textContent=ACCOUNT?.plan||"—";
  document.getElementById("c_currency").textContent=ACCOUNT?.currency||"—";
  document.getElementById("c_capital").textContent=money(ACCOUNT?.principal_locked||0,ACCOUNT?.currency||"GTQ");
  document.getElementById("c_account").textContent=ACCOUNT?.id||"—";
  document.getElementById("c_months").textContent=ACCOUNT?.months ?? "—";

  // Interés total periodo (interés simple)
  const rate = (ACCOUNT?.interest_pct ?? planDefaultRate(ACCOUNT?.plan));
  const totalInterest = (ACCOUNT?.principal_locked||0) * (rate/100) * ((ACCOUNT?.months||6)/6);
  document.getElementById("c_interest_total").textContent = money(totalInterest, ACCOUNT?.currency);

  buildRollingMonthResults();

  // Mostrar cambio de contraseña SOLO primera vez
  const mustForce = PROFILE?.first_login_completed !== true && PROFILE?.require_password_change === true;
  if(mustForce){ openPwdModal(true); }

  // Abrir modal retiro
  document.getElementById('openWithdraw').addEventListener('click',()=> openWithdrawModal());
})();

/*** PLANES (tasa semestral simple) ***/
function planDefaultRate(plan){
  if(plan==='PLATINUM') return 20;
  if(plan==='BLACK') return 25;
  return 15; // STANDARD
}

/*** RESULTADOS RODANTES: de fecha de ingreso a misma fecha del mes siguiente ***/
function buildRollingMonthResults(){
  if(!ACCOUNT) return;
  const start = ACCOUNT?.joined_at ? new Date(ACCOUNT.joined_at) : guateNow();
  const tzStart = new Date(start.toLocaleString('en-US',{timeZone:GTZ}));
  const end = new Date(tzStart); end.setMonth(end.getMonth()+1);

  document.getElementById('monthLabel').textContent =
    tzStart.toLocaleDateString('es-GT',{timeZone:GTZ})+" — "+
    end.toLocaleDateString('es-GT',{timeZone:GTZ});
  document.getElementById('periodHint').textContent =
    "El período cierra el "+ end.toLocaleDateString('es-GT',{timeZone:GTZ})+".";

  const frs=[]; // viernes dentro del rango
  const d=new Date(tzStart);
  while(d<=end){ if(d.getDay()===5 && d>tzStart && d<=end){ frs.push(new Date(d)); } d.setDate(d.getDate()+1); }

  // tasa mensual simple a partir de tasa semestral
  const rate = (ACCOUNT?.interest_pct ?? planDefaultRate(ACCOUNT?.plan)); // % por 6 meses
  const monthlyPct = (rate/6)/100; // % por mes
  const weeksThisMonth = frs.length;
  const baseMonthlyInterest = (ACCOUNT.principal_locked||0)*monthlyPct;

  // repartimos el interés del mes en semanas con pequeñas variaciones pero cerrando exacto
  const parts = variedWeeklyParts(baseMonthlyInterest, weeksThisMonth);

  const tb=document.getElementById('weeks'); tb.innerHTML='';
  let sum=0;
  const now = guateNow();
  frs.forEach((f,i)=>{
    // sólo mostrar semanas hasta la actual; el resto quedan reservadas
    if(f<=now){
      const v=parts[i]; sum+=v;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${f.toLocaleDateString('es-GT',{timeZone:GTZ})}</td><td>${money(v,ACCOUNT.currency)}</td>`;
      tb.appendChild(tr);
    }
  });
  // total sólo cuando cierra el mes; sino guion
  document.getElementById('monthTotal').textContent = (now>=end) ? money(parts.reduce((a,b)=>a+b,0),ACCOUNT.currency) : "—";
}

// genera n partes con ligera variación y suma exacta = total
function variedWeeklyParts(total, n){
  if(n<=0) return [];
  if(n===1) return [total];
  const xs = Array.from({length:n},()=> 0.93 + Math.random()*0.14); // [0.93..1.07]
  const s = xs.reduce((a,b)=>a+b,0);
  let parts = xs.map(v=> (total*(v/s)));
  // redondeo a 2 decimales y ajuste de residuo en la última
  parts = parts.map(v=> Math.round(v*100)/100);
  const diff = Math.round((total - parts.reduce((a,b)=>a+b,0))*100)/100;
  parts[parts.length-1] = Math.round((parts[parts.length-1]+diff)*100)/100;
  return parts;
}

/*** ====== SIMULADOR (siempre 6 meses) ====== ***/
function inferPlanByAmount(q){
  if(q>=250000) return 'PLATINUM';
  if(q>=2000) return 'STANDARD';
  return 'NO_ELEGIBLE';
}
function planLabel(p){
  if(p==='PLATINUM') return 'PLATINUM (20% semestral)';
  if(p==='BLACK') return 'BLACK (25% semestral)';
  if(p==='STANDARD') return 'STANDARD (15% semestral)';
  return 'NO ELEGIBLE';
}
function parseAmount(str){ return Number(String(str||'').replace(/[^\d.]/g,''))||0; }

document.getElementById('sim_btn').addEventListener('click', ()=>{
  const cap = parseAmount(document.getElementById('sim_cap').value);
  const plan = inferPlanByAmount(cap);
  const rate = planDefaultRate(plan);
  document.getElementById('sim_plan').textContent = planLabel(plan);
  document.getElementById('sim_capital0').textContent = money(cap,'GTQ');

  if(plan==='NO_ELEGIBLE'){ 
    document.getElementById('sim_interest_total').textContent='—';
    document.getElementById('sim_final').textContent='—';
    document.getElementById('sim_rows').innerHTML='';
    document.getElementById('sim_legend').textContent='El monto debe ser al menos Q 2,000.';
    return;
  }

  const monthly = (rate/6)/100; // interés simple mensual
  const rows = [];
  for(let m=1;m<=6;m++){ rows.push(Math.round(cap*monthly*100)/100); }
  const total = rows.reduce((a,b)=>a+b,0);
  document.getElementById('sim_interest_total').textContent = money(total,'GTQ');
  document.getElementById('sim_final').textContent = money(cap+total,'GTQ');

  const tb=document.getElementById('sim_rows'); tb.innerHTML='';
  rows.forEach((v,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${money(v,'GTQ')}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('sim_legend').textContent = `Plan: ${plan} · Tasa semestral ${rate}% · Tasa mensual ${(rate/6).toFixed(2)}%.`;
});

/*** ====== MODAL RETIRO (con switch elegante) ====== ***/
const $wModal  = document.getElementById('withdrawModal');
const $wCloseX = document.getElementById('wCloseX');
const $wCancel = document.getElementById('wCancel');
const $wSend   = document.getElementById('wSend');
const $wAll    = document.getElementById('wAll');
const $wAmount = document.getElementById('wAmount');
const $wReason = document.getElementById('wReason');
const $wErr    = document.getElementById('wErr');
const $optEarly= document.getElementById('optEarly');
const $optHealth=document.getElementById('optHealth');

let withdrawKind='EARLY'; // EARLY | HEALTH

function openWithdrawModal(){
  $wErr.textContent='';
  $wAmount.value=''; $wReason.value='';
  $wAll.checked=false; syncAllToggle();
  setKind('EARLY');
  $wModal.classList.remove('hidden');
}
function closeWithdrawModal(){ $wModal.classList.add('hidden'); }
$wCloseX.onclick=closeWithdrawModal; $wCancel.onclick=closeWithdrawModal;
$optEarly.onclick = ()=> setKind('EARLY');
$optHealth.onclick= ()=> setKind('HEALTH');

function setKind(k){
  withdrawKind=k;
  if(k==='EARLY'){ $optEarly.classList.add('active'); $optHealth.classList.remove('active'); }
  else{ $optHealth.classList.add('active'); $optEarly.classList.remove('active'); }
}

function syncAllToggle(){
  if(!$wAmount) return;
  const cap = ACCOUNT?.principal_locked||0;
  if($wAll.checked){
    $wAmount.value = cap.toFixed(2);
    $wAmount.disabled = true;
  }else{
    $wAmount.disabled = false;
  }
}
$wAll.addEventListener('change', syncAllToggle);

/* Validaciones y envío (REST ya existente en tu backend/RPC/email edge) */
$wSend.addEventListener('click', async ()=>{
  $wErr.textContent='';
  const cap = ACCOUNT?.principal_locked||0;
  const amt = parseAmount($wAmount.value);
  const reason = ($wReason.value||'').trim();
  if(!$wAll.checked){
    if(!amt || amt<=0){ $wErr.textContent='Ingrese un monto válido.'; return; }
    if(amt>cap){ $wErr.textContent='El monto no puede ser mayor a su capital.'; return; }
    if(cap-amt<2000){ $wErr.textContent='Debe permanecer al menos Q 2,000 si es retiro parcial.'; return; }
  }
  if($wAll.checked){
    if(cap<=0){ $wErr.textContent='No tiene capital disponible.'; return; }
  }
  if(!reason){ $wErr.textContent='Describa brevemente el motivo.'; return; }

  // Construir payload (sin user_id; lo resuelve RLS en DB)
  const payload = {
    account_id: ACCOUNT.id,
    kind: withdrawKind === 'EARLY' ? 'EARLY' : 'HEALTH',
    amount: $wAll.checked ? cap : amt,
    all_capital: $wAll.checked,
    penalty_pct: withdrawKind === 'EARLY' ? 10 : 0,
    reason
  };

  try{
    // 1) Registrar solicitud
    await fetch(`${BASE}/withdrawal_requests`,{
      method:'POST', headers:hdrJSON(),
      body:JSON.stringify({ account_id: payload.account_id, amount: payload.amount, all_capital: payload.all_capital, kind: payload.kind, penalty_pct: payload.penalty_pct, reason: payload.reason })
    });

    // 2) Notificación a admins (Edge Function notify-withdrawal)
    try{
      await fetch(`${PROJECT_URL}/functions/v1/notify-withdrawal`,{
        method:'POST',
        headers:{ Authorization:`Bearer ${ANON_KEY}`, 'Content-Type':'application/json' },
        body: JSON.stringify({
          account_id: ACCOUNT.id,
          client_name: PROFILE?.full_name,
          client_email: localStorage.email,
          amount: payload.amount,
          kind: payload.kind,
          penalty_pct: payload.penalty_pct,
          reason: payload.reason,
        })
      });
    }catch(e){ console.warn('notify-withdrawal falló (no bloqueante):', e); }

    toast('Solicitud enviada.');
    closeWithdrawModal();
  }catch(e){
    console.error(e); $wErr.textContent='No se pudo enviar la solicitud.';
  }
});

/*** ======== CAMBIO DE CONTRASEÑA (FORZADO SÓLO 1ra VEZ) ======== */
/* Re-uso del modal de contraseñas que ya tenías (omitido aquí por brevedad)
   Si en tu archivo anterior estaba como se te entregó, seguirá funcionando:
   - openPwdModal(force) debe existir; si no, simplemente comenta la llamada. */
function openPwdModal(){/* si usas la versión anterior, déjala; si no, omitir */}

/*** Accesibilidad: cerrar modal con ESC y click afuera ***/
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && !$wModal.classList.contains('hidden')) closeWithdrawModal(); });
$wModal.addEventListener('click',(e)=>{ if(e.target===$wModal) closeWithdrawModal(); });
</script>
</body>
</html>
