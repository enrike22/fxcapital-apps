<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. — Panel Cliente</title>
<style>
/* ===== Design tokens (blanco/negro corporativo) ===== */
:root{
  --bg:#0a0a0a;
  --surface:#101214;
  --card:#0f1012;
  --fg:#f5f7fa;
  --muted:#cdd3da;
  --muted-2:#aab3bd;
  --border:#21262c;
  --ring:#3a86ff33;
  --shadow:0 14px 40px rgba(0,0,0,.50);
  --radius:18px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:
    radial-gradient(1100px 700px at 10% -10%, #121416 0%, transparent 55%),
    radial-gradient(1300px 900px at 90% 110%, #0c0d0f 0%, transparent 60%),
    var(--bg);
  color:var(--fg);
  font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
.container{max-width:1120px;margin:0 auto;padding:28px 20px}

/* ===== Header ===== */
.header{display:flex;align-items:center;justify-content:space-between;margin:6px 0 22px}
.header h1{font-size:28px;font-weight:800;letter-spacing:.3px;margin:0}
.btn{
  background:#fff;color:#0b0c0e;border:0;border-radius:999px;padding:12px 18px;
  font-weight:800;cursor:pointer;transition:filter .15s ease,transform .02s ease
}
.btn:hover{filter:brightness(.98)}
.btn:active{transform:translateY(1px)}
.btn-ghost{background:transparent;color:var(--fg);border:1px solid var(--border)}
.btn-secondary{background:#eef1f4;color:#0c0d0f}

/* ===== Cards ===== */
.card{
  background:linear-gradient(180deg,var(--card),var(--surface));
  border:1px solid var(--border); border-radius:var(--radius); padding:20px 18px;
  box-shadow:var(--shadow); margin-bottom:16px;
}
.card h2{margin:0 0 6px;font-size:18px}
.sub{color:var(--muted);font-size:13px;margin:0 0 8px}

/* ===== Badges & grid ===== */
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px;margin-right:8px}
.grid-3{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}

/* ===== Table ===== */
table{width:100%;border-collapse:collapse}
th,td{padding:12px 10px;border-bottom:1px solid var(--border)}
th{text-align:left;color:#d7dce2;font-weight:600}

/* ===== Forms ===== */
label{display:block;margin:8px 0 6px;font-size:13px;color:var(--muted)}
input,select,textarea{
  width:100%;background:#0b0d0f;color:var(--fg);
  border:1px solid var(--border);border-radius:12px;padding:12px 12px;font-size:14px;
  transition:border .15s ease,box-shadow .15s ease
}
input:focus,select:focus,textarea:focus{outline:0;border-color:#2b3036;box-shadow:0 0 0 3px var(--ring)}
.helper{font-size:12px;color:#b9c6d7}
.err{color:#ffb3b3;min-height:18px;margin-top:4px}
.success{color:#b3ffcb;min-height:18px;margin-top:4px}

/* Prefijo */
.input-prefix{position:relative}
.input-prefix .prefix{position:absolute;left:10px;top:50%;transform:translateY(-50%);font-weight:700;color:#b8c0c8;opacity:.85}
.input-prefix input{padding-left:36px}

/* ===== Modal base ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.62);display:flex;align-items:center;justify-content:center;padding:28px;z-index:10000}
.modal-card{
  width:100%;max-width:820px;background:linear-gradient(180deg,#121315,#0e1012);
  border:1px solid #1d2227;border-radius:20px;padding:22px 22px 18px;box-shadow:0 18px 60px rgba(0,0,0,.6)
}
.modal-titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.modal-titlebar h3{margin:0;font-size:22px}
.close-x{width:36px;height:36px;border-radius:12px;border:1px solid #2a2f35;background:#0b0d0f;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
.modal-sub{color:var(--muted);margin-bottom:16px}

/* ===== Modal Retiro (espaciado mejorado) ===== */
.wd-grid{display:grid;grid-template-columns:1.05fr 1fr;gap:22px}
@media (max-width:900px){.wd-grid{grid-template-columns:1fr;gap:16px}}

.choice-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:4px}
.choice-card{
  position:relative;border:1px solid var(--border);border-radius:14px;padding:14px 14px 14px 46px;min-height:70px;
  background:#0f1113;cursor:pointer;transition:border .12s ease,box-shadow .12s ease,transform .02s ease
}
.choice-card:hover{border-color:#2b3138}
.choice-card:active{transform:translateY(1px)}
.choice-card input[type="radio"]{position:absolute;left:14px;top:20px;transform:scale(1.1)}
.choice-title{font-weight:800;margin:0 0 4px}
.choice-desc{margin:0;color:var(--muted-2);font-size:12.5px}
.divider{height:1px;background:linear-gradient(90deg,transparent,#1f2328,transparent);margin:14px 0}

/* Switch retirar todo */
.switch{display:inline-flex;align-items:center;gap:10px;cursor:pointer;user-select:none;margin-top:6px}
.switch input{display:none}
.switch .track{width:50px;height:28px;border-radius:999px;background:#161a21;border:1px solid #222832;position:relative;transition:background .18s ease,border .18s ease}
.switch .thumb{position:absolute;left:4px;top:4px;width:20px;height:20px;border-radius:999px;background:#e6eaef;transition:left .18s ease}
.switch input:checked + .track{background:#2b3440;border-color:#333c47}
.switch input:checked + .track .thumb{left:26px}

/* Footer modal */
.modal-actions{display:flex;gap:12px;margin-top:8px}
.btn-wide{min-width:170px}

/* Toast */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#121e12;border:1px solid #234d23;color:#dff2df;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);z-index:11000}

/* Util */
.hidden{display:none !important}
.small-table th,.small-table td{padding:8px}
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
.kpi{background:#0c0e10;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
.kpi .k{color:#b7c0ca;font-size:12px}
.kpi .v{font-weight:800;margin-top:2px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>FX | CAPITAL R.L. — Panel Cliente</h1>
    <button id="logoutBtn" class="btn btn-secondary" type="button">Cerrar sesión</button>
  </div>

  <div class="card">
    <h2>Mi cuenta</h2>
    <p class="sub">Resumen de su portafolio y configuración actual.</p>
    <div class="grid-3">
      <div><span class="badge">Nombre</span><div id="c_name">—</div></div>
      <div><span class="badge">Plan</span><div id="c_plan">—</div></div>
      <div><span class="badge">Moneda</span><div id="c_currency">—</div></div>
      <div><span class="badge">Capital</span><div id="c_capital">—</div></div>
      <div><span class="badge">Cuenta (ID)</span><div id="c_account">—</div></div>
      <div><span class="badge">Periodo (meses)</span><div id="c_months">—</div></div>
      <div><span class="badge">Interés total del período</span><div id="c_term_interest">—</div></div>
    </div>
    <div style="margin-top:14px">
      <button id="openWithdraw" class="btn">Solicitar retiro</button>
    </div>
  </div>

  <div class="card">
    <h2>Resultados del mes</h2>
    <p id="monthLabel" class="sub">—</p>
    <table>
      <thead><tr><th>Viernes</th><th>Interés semanal</th></tr></thead>
      <tbody id="weeks"></tbody>
      <tfoot><tr><th>Total mes</th><th id="monthTotal">—</th></tr></tfoot>
    </table>
  </div>

  <div class="card">
    <h2>Simulador de crecimiento</h2>
    <p class="sub">Proyección con capitalización mensual según el plan asignado automáticamente por monto.</p>
    <div class="grid-3">
      <div>
        <label>Capital a simular (Q)</label>
        <div class="input-prefix">
          <span class="prefix">Q</span>
          <input id="sim_capital" type="number" min="2000" step="0.01" placeholder="Ej. 40,000">
        </div>
      </div>
      <div>
        <label>Meses</label>
        <select id="sim_months">
          <option>6</option><option selected>12</option><option>18</option><option>24</option><option>36</option>
        </select>
      </div>
      <div>
        <label>Plan asignado (auto)</label>
        <input id="sim_plan" type="text" disabled>
      </div>
    </div>

    <div id="sim_err" class="err"></div>
    <div style="margin:12px 0 6px"><button id="runSim" class="btn btn-wide">Calcular</button></div>

    <!-- KPIs -->
    <div id="sim_out" class="hidden" style="margin-top:14px">
      <div class="kpi-row">
        <div class="kpi"><div class="k">Capital inicial</div><div id="kpi_ini" class="v">—</div></div>
        <div class="kpi"><div class="k">Interés total acumulado</div><div id="kpi_int" class="v">—</div></div>
        <div class="kpi"><div class="k">Capital final estimado</div><div id="kpi_fin" class="v">—</div></div>
      </div>

      <h3 style="margin:14px 0 6px;font-size:16px">Interés generado por cada mes</h3>
      <table class="small-table">
        <thead><tr><th>Mes</th><th>Interés del mes</th></tr></thead>
        <tbody id="sim_rows"></tbody>
      </table>
      <div class="helper" id="sim_summary" style="margin-top:6px"></div>
    </div>
  </div>
</div>

<!-- ===== Modal de contraseña ===== -->
<div id="pwdModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="pwdTitle">
  <div class="modal-card">
    <div class="modal-titlebar">
      <h3 id="pwdTitle">Bienvenido a FX | CAPITAL R.L.</h3>
      <button id="pwdCloseX" class="close-x" type="button" aria-label="Cerrar">✕</button>
    </div>
    <p class="modal-sub">Por seguridad, actualice su contraseña.</p>

    <label>Correo electrónico</label>
    <input id="pwdEmail" type="email" placeholder="tu@email.com" autocomplete="email">

    <label style="margin-top:8px">Contraseña actual</label>
    <input id="curPwd" type="password" placeholder="••••••••" autocomplete="current-password">

    <label style="margin-top:8px">Nueva contraseña</label>
    <input id="newPwd" type="password" placeholder="Mínimo 8 caracteres" autocomplete="new-password">

    <label style="margin-top:8px">Confirmar nueva contraseña</label>
    <input id="confPwd" type="password" placeholder="Repetir nueva contraseña" autocomplete="new-password">

    <div class="helper" style="margin-top:6px">Use al menos 8 caracteres; combine letras, números y símbolos.</div>
    <div id="pwdMsg" class="err"></div>
    <div id="pwdOk" class="success"></div>

    <div class="modal-actions" style="margin-top:12px">
      <button id="pwdSubmit" class="btn btn-wide" type="button">Actualizar contraseña</button>
      <button id="pwdCancel" class="btn btn-ghost" type="button">Cancelar</button>
    </div>
  </div>
</div>

<!-- ===== Modal: Solicitud de retiro ===== -->
<div id="wdModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="wdTitle">
  <div class="modal-card">
    <div class="modal-titlebar">
      <h3 id="wdTitle">Solicitud de retiro</h3>
      <button id="wdCloseX" class="close-x" type="button" aria-label="Cerrar">✕</button>
    </div>
    <p class="modal-sub">Seleccione el tipo de retiro y complete la información.</p>

    <div class="wd-grid">
      <!-- Columna izquierda -->
      <div>
        <label>Tipo de retiro</label>
        <div class="choice-row">
          <label class="choice-card" for="optEarly">
            <input id="optEarly" type="radio" name="wd_kind" value="EARLY" checked>
            <p class="choice-title">Antes de tiempo</p>
            <p class="choice-desc">Aplicará una penalización del 10%.</p>
          </label>
          <label class="choice-card" for="optHealth">
            <input id="optHealth" type="radio" name="wd_kind" value="HEALTH">
            <p class="choice-title">Causas de salud</p>
            <p class="choice-desc">Exento de penalización.</p>
          </label>
        </div>

        <div class="divider"></div>

        <label class="switch" title="Retirar el 100% del capital">
          <input id="wd_all" type="checkbox">
          <span class="track"><span class="thumb"></span></span>
          <span>Retirar todo mi capital</span>
        </label>
      </div>

      <!-- Columna derecha -->
      <div>
        <label>Monto a retirar (Q)</label>
        <div id="wd_amount_wrap" class="input-prefix">
          <span class="prefix">Q</span>
          <input id="wd_amount" type="number" min="0" step="0.01" placeholder="Ej. 5,000">
          <div class="helper">Si el retiro es parcial, debe permanecer al menos <b>Q 2,000</b>.</div>
        </div>

        <label style="margin-top:14px">Motivo</label>
        <textarea id="wd_reason" rows="5" placeholder="Explique brevemente el motivo…"></textarea>

        <div id="wd_err" class="err"></div>
        <div id="wd_ok" class="success"></div>
      </div>
    </div>

    <div class="modal-actions" style="margin-top:14px">
      <button id="wdSubmit" class="btn btn-wide" type="button">Enviar solicitud</button>
      <button id="wdCancel" class="btn btn-ghost" type="button">Cancelar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden">Listo.</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** CONFIG SUPABASE ***/
const PROJECT_URL="https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE=PROJECT_URL+"/rest/v1";
const supa = supabase.createClient(PROJECT_URL, ANON_KEY);

function hdr(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||"")}}
function hdrJSON(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||""),"Content-Type":"application/json","Prefer":"return=representation"}}
const GTZ='America/Guatemala';
function logout(){localStorage.clear();location.href='cliente-login.html'}
document.getElementById('logoutBtn').onclick=logout;
function money(n,cur){return new Intl.NumberFormat('es-GT',{style:'currency',currency:cur==='USD'?'USD':'GTQ'}).format(n)}
function guateNow(){return new Date(new Date().toLocaleString('en-US',{timeZone:GTZ}))}
function toast(msg){const t=document.getElementById('toast'); t.textContent=msg||'Listo.'; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2200);}

/*** ESTADO ***/
let PROFILE=null,ACCOUNT=null; let PWD_FORCE=true;

/*** Modales util ***/
const $pwdModal=document.getElementById('pwdModal'); const $pwdCancel=document.getElementById('pwdCancel'); const $pwdCloseX=document.getElementById('pwdCloseX');
function reallyHide(el){el.classList.add('hidden'); el.style.display='none'; setTimeout(()=>{el.style.display='';},0);}
function closePwdModal(){ reallyHide($pwdModal); sessionStorage.pwdModalDismissed='1'; }
function openPwdModal(force){
  PWD_FORCE=!!force;
  document.getElementById('pwdCancel').style.display=force?'none':'inline-block';
  document.getElementById('pwdCloseX').style.display=force?'none':'flex';
  document.getElementById('pwdEmail').value=localStorage.email||'';
  ['curPwd','newPwd','confPwd'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('pwdMsg').textContent=''; document.getElementById('pwdOk').textContent='';
  $pwdModal.classList.remove('hidden');
}
['click','touchend'].forEach(evt=>{
  $pwdCancel.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation(); if(!PWD_FORCE) closePwdModal();});
  $pwdCloseX.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation(); if(!PWD_FORCE) closePwdModal();});
});
$pwdModal.addEventListener('click',(e)=>{ if(e.target===$pwdModal && !PWD_FORCE) closePwdModal(); });
window.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && !PWD_FORCE && !$pwdModal.classList.contains('hidden')) closePwdModal(); });

/*** Modal retiro ***/
const $wdModal=document.getElementById('wdModal'); const $wdCancel=document.getElementById('wdCancel'); const $wdCloseX=document.getElementById('wdCloseX');
function openWdModal(){
  document.getElementById('wd_err').textContent=''; document.getElementById('wd_ok').textContent='';
  document.getElementById('wd_reason').value=''; document.getElementById('wd_amount').value='';
  document.getElementById('wd_all').checked=false; document.getElementById('wd_amount_wrap').classList.remove('hidden');
  $wdModal.classList.remove('hidden');
}
function closeWd(){ reallyHide($wdModal); }
document.getElementById('openWithdraw').onclick=openWdModal;
['click','touchend'].forEach(evt=>{
  $wdCancel.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation(); closeWd();});
  $wdCloseX.addEventListener(evt,(e)=>{e.preventDefault();e.stopPropagation(); closeWd();});
});
$wdModal.addEventListener('click',(e)=>{ if(e.target===$wdModal) closeWd(); });

/*** BOOT ***/
(async function boot(){
  if(!localStorage.token){ logout(); return; }

  const rUser=await fetch(`${PROJECT_URL}/auth/v1/user`,{headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`}})
  if(!rUser.ok){ logout(); return; }

  const rp=await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}&select=id,full_name,require_password_change,first_login_completed`,{headers:hdr()});
  PROFILE=(await rp.json())[0]||null;

  // joined_at, invest_months, interest_pct para cálculos y filtro de semanas
  const ra=await fetch(`${BASE}/accounts?user_id=eq.${localStorage.uid}&select=id,currency,principal_locked,plan,black_enabled,joined_at,invest_months,interest_pct`,{headers:hdr()});
  ACCOUNT=(await ra.json())[0]||null;

  // Datos base
  document.getElementById("c_name").textContent=PROFILE?.full_name||"—";
  document.getElementById("c_plan").textContent=ACCOUNT?.plan||"—";
  document.getElementById("c_currency").textContent=ACCOUNT?.currency||"—";
  document.getElementById("c_capital").textContent=money(ACCOUNT?.principal_locked||0,ACCOUNT?.currency||"GTQ");
  document.getElementById("c_account").textContent=ACCOUNT?.id||"—";

  // Periodo + interés total del período (capital * tasaSem/100 * meses/6)
  const months = Number(ACCOUNT?.invest_months || 6);
  document.getElementById("c_months").textContent = months;

  const planRateDefault = (ACCOUNT?.plan==='PLATINUM')?20:(ACCOUNT?.plan==='BLACK')?25:15; // default por plan
  const rateSem = (ACCOUNT?.interest_pct ?? planRateDefault); // % por 6 meses
  const totalInterest = (ACCOUNT?.principal_locked||0) * (rateSem/100) * (months/6);
  document.getElementById("c_term_interest").textContent = money(totalInterest, ACCOUNT?.currency||"GTQ");

  buildMonthResults();

  const needChange = PROFILE?.require_password_change === true || PROFILE?.first_login_completed !== true;
  const localSkip = localStorage.pwdFirstDone === 'true' || sessionStorage.pwdModalDismissed === '1';
  if (needChange && !localSkip) openPwdModal(true);

  // simulador
  document.getElementById('sim_capital').addEventListener('input',updateSimPlan);
  updateSimPlan();
  document.getElementById('runSim').onclick=runSimulation;

  // retirar todo
  document.getElementById('wd_all').addEventListener('change',(e)=>{
    document.getElementById('wd_amount_wrap').classList.toggle('hidden', e.target.checked);
  });

  document.getElementById('pwdSubmit').onclick=submitPasswordChange;
})();

/*** Plan asignado (simulador) ***/
function planForAmount(q){
  if (ACCOUNT?.black_enabled) return { name:'BLACK', rateSem:0.25 };
  if (q >= 250000) return { name:'PLATINUM', rateSem:0.20 };
  if (q >= 2000)   return { name:'STANDARD', rateSem:0.15 };
  return { name:'NO ELEGIBLE', rateSem:0 };
}
function updateSimPlan(){
  const val = Number(document.getElementById('sim_capital').value || 0);
  const plan = planForAmount(val);
  const el = document.getElementById('sim_plan');
  el.value = `${plan.name} ${plan.rateSem>0?`(${(plan.rateSem*100).toFixed(0)}% semestral)`:''}`;
}

/*** Simulación: SOLO interés mensual + KPIs ***/
function runSimulation(){
  const err = document.getElementById('sim_err'); err.textContent='';
  const out = document.getElementById('sim_out'); out.classList.add('hidden');
  const tbody = document.getElementById('sim_rows'); tbody.innerHTML='';
  const months = parseInt(document.getElementById('sim_months').value,10);
  let capitalIni = Number(document.getElementById('sim_capital').value || 0);

  if (isNaN(capitalIni) || capitalIni < 2000){ err.textContent='Ingrese un capital válido (mínimo Q2,000).'; return; }
  const { name, rateSem } = planForAmount(capitalIni);
  if (rateSem<=0){ err.textContent='El capital debe ser al menos Q2,000.'; return; }

  let capital = capitalIni;
  const r_m = rateSem/6;
  let totalInteres = 0;

  for(let m=1;m<=months;m++){
    const interesMes = capital * r_m;
    totalInteres += interesMes;
    capital += interesMes;

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m}</td><td>Q ${interesMes.toLocaleString('es-GT',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>`;
    tbody.appendChild(tr);
  }

  // KPIs
  document.getElementById('kpi_ini').textContent = `Q ${capitalIni.toLocaleString('es-GT',{minimumFractionDigits:2})}`;
  document.getElementById('kpi_int').textContent = `Q ${totalInteres.toLocaleString('es-GT',{minimumFractionDigits:2})}`;
  document.getElementById('kpi_fin').textContent = `Q ${capital.toLocaleString('es-GT',{minimumFractionDigits:2})}`;

  const summary = `Plan: ${name} · Tasa semestral ${(rateSem*100).toFixed(0)}% · Tasa mensual ${(r_m*100).toFixed(2)}%.`;
  document.getElementById('sim_summary').textContent = summary;
  out.classList.remove('hidden');
}

/*** Resultados del mes (solo desde fecha de ingreso) ***/
function buildMonthResults(){
  const PLAN_RATES={STANDARD:0.15/6,PLATINUM:0.20/6,BLACK:0.25/6};
  if(!ACCOUNT) return;

  const now=guateNow(); const y=now.getFullYear(), m0=now.getMonth();
  document.getElementById('monthLabel').textContent = now.toLocaleString('es-GT',{timeZone:GTZ,month:'long',year:'numeric'});

  // Lista de viernes del mes EN CURSO
  const fridays=[]; const d=new Date(Date.UTC(y,m0,1));
  while(d.getUTCMonth()===m0){
    const local=new Date(d.toLocaleString('en-US',{timeZone:GTZ}));
    if(local.getDay()===5) fridays.push(new Date(local));
    d.setUTCDate(d.getUTCDate()+1);
  }

  // Fecha de ingreso -> solo a partir de ese día
  let joinedLocal = null;
  if (ACCOUNT?.joined_at){
    joinedLocal = new Date(new Date(ACCOUNT.joined_at).toLocaleString('en-US',{timeZone:GTZ}));
  }
  const fridaysFromJoin = joinedLocal
    ? fridays.filter(f => f >= startOfDay(joinedLocal))
    : fridays;

  const tb=document.getElementById('weeks'); tb.innerHTML='';
  if(fridaysFromJoin.length===0){
    document.getElementById('monthTotal').textContent = money(0, ACCOUNT.currency);
    return;
  }

  // Interés mensual estimado y reparto proporcional entre viernes activos
  const rateMonthly = PLAN_RATES[ACCOUNT.plan] || 0;
  const totalMonthInterest = (ACCOUNT.principal_locked||0) * rateMonthly;
  const parts = randomParts(totalMonthInterest, fridaysFromJoin.length);

  fridaysFromJoin.forEach((f,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${f.toLocaleDateString('es-GT',{timeZone:GTZ})}</td><td>${money(parts[i], ACCOUNT.currency)}</td>`;
    tb.appendChild(tr);
  });

  document.getElementById('monthTotal').textContent = money(parts.reduce((a,b)=>a+b,0), ACCOUNT.currency);
}

function startOfDay(dt){const x=new Date(dt); x.setHours(0,0,0,0); return x;}
function randomParts(total,n){if(n<=0)return[];const xs=Array.from({length:n},()=>Math.random()+0.5);const s=xs.reduce((a,b)=>a+b,0);return xs.map(v=> total*(v/s));}

/*** Cambio de contraseña ***/
async function submitPasswordChange(){
  const email=(document.getElementById('pwdEmail').value||'').trim();
  const cur=document.getElementById('curPwd').value;
  const neo=document.getElementById('newPwd').value;
  const rep=document.getElementById('confPwd').value;
  const err=document.getElementById('pwdMsg'); const ok=document.getElementById('pwdOk'); err.textContent=''; ok.textContent='';

  if(!email||!cur||!neo||!rep){ err.textContent='Complete todos los campos.'; return; }
  if(neo.length<8){ err.textContent='La nueva contraseña debe tener al menos 8 caracteres.'; return; }
  if(neo!==rep){ err.textContent='La confirmación no coincide.'; return; }

  const btn=document.getElementById('pwdSubmit');
  btn.disabled=true; const old=btn.textContent; btn.textContent='Actualizando...';

  const { error: e1 } = await supa.auth.signInWithPassword({ email, password: cur });
  if (e1){ err.textContent='Correo o contraseña actual incorrectos.'; btn.disabled=false; btn.textContent=old; return; }

  const { error: e2 } = await supa.auth.updateUser({ password: neo });
  if (e2){ err.textContent = e2.message || 'No se pudo actualizar la contraseña.'; btn.disabled=false; btn.textContent=old; return; }

  const { data: s2, error: e3 } = await supa.auth.signInWithPassword({ email, password: neo });
  if (!e3 && s2?.session?.access_token){
    localStorage.token = s2.session.access_token;
    localStorage.refresh_token = s2.session.refresh_token || '';
    localStorage.uid   = s2.user.id;
    localStorage.email = email;
  }

  try{
    await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}`,{
      method:'PATCH',headers:hdrJSON(),
      body:JSON.stringify({ first_login_completed:true, require_password_change:false, last_password_changed_at:new Date().toISOString() })
    });
  }catch{}

  localStorage.pwdFirstDone='true'; sessionStorage.pwdModalDismissed='1'; PWD_FORCE=false;

  ok.textContent='Contraseña actualizada correctamente.';
  setTimeout(()=>{ closePwdModal(); toast('Contraseña actualizada correctamente.'); }, 250);

  btn.disabled=false; btn.textContent=old;
}

/*** Enviar solicitud de retiro (sin user_id) ***/
document.getElementById('wdSubmit').onclick = async () => {
  const err = document.getElementById('wd_err'); const ok = document.getElementById('wd_ok'); err.textContent=''; ok.textContent='';
  if(!ACCOUNT){ err.textContent='No se encontró la cuenta.'; return; }

  const kind = (document.querySelector('input[name="wd_kind"]:checked')||{}).value || 'EARLY';
  const penalty_pct = kind==='EARLY'?10:0;

  let amount = 0;
  const all = document.getElementById('wd_all').checked;
  if (all){ amount = Number(ACCOUNT.principal_locked||0); }
  else {
    amount = Number(document.getElementById('wd_amount').value||0);
    if (isNaN(amount) || amount<=0){ err.textContent='Monto inválido.'; return; }
    if (amount > (ACCOUNT.principal_locked||0)){ err.textContent='El monto excede su capital.'; return; }
    const remain = (ACCOUNT.principal_locked||0) - amount;
    if (remain < 2000){ err.textContent='Si el retiro es parcial, debe quedar al menos Q2,000 de capital.'; return; }
  }

  const reason = (document.getElementById('wd_reason').value||'').trim();
  if (!reason){ err.textContent='Explique brevemente el motivo.'; return; }

  const payload = {
    account_id: ACCOUNT.id,
    amount,
    currency: ACCOUNT.currency || 'GTQ',
    penalty_pct,
    kind,
    reason,
    status: 'PENDING',
    created_at: new Date().toISOString()
  };

  const r1 = await fetch(`${BASE}/withdrawal_requests`,{ method:'POST', headers: hdrJSON(), body: JSON.stringify(payload) });
  if (!r1.ok){ err.textContent='No se pudo enviar la solicitud.'; return; }
  const inserted = (await r1.json())[0];

  try{
    await fetch(`${BASE}/admin_notifications`,{
      method:'POST', headers: hdrJSON(),
      body: JSON.stringify({
        kind: 'WITHDRAWAL_REQUEST',
        payload: { withdrawal_id: inserted.id, account_id: ACCOUNT.id, kind, penalty_pct, amount, currency: ACCOUNT.currency },
        created_at: new Date().toISOString()
      })
    });
  }catch{}

  ok.textContent='Solicitud enviada.';
  alert('Hemos recibido su solicitud; será atendida en un lapso no mayor a 24 horas hábiles, de lunes a viernes, dentro del horario laboral establecido.');
  closeWd(); toast('Solicitud enviada');
};
</script>
</body>
</html>
