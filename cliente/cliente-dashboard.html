<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. — Panel Cliente</title>
<style>
:root{
  --bg:#000; --fg:#fff; --muted:#ffffffcc; --card:#0d0d0d; --card-2:#121212; --border:#1f1f1f;
  --accent:#2a66ff; --accent-2:#3a78ff; --chip:#181818; --ok:#1f7a3f; --warn:#af4a00; --err:#d14d4d;
}
*{box-sizing:border-box} html,body{background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial;margin:0}
.container{max-width:1100px;margin:0 auto;padding:24px}
h1{font-size:32px;margin:0 0 16px} h2{margin:0 0 12px;font-size:22px}
.card{background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--border);border-radius:18px;padding:18px;margin:18px 0;box-shadow:0 10px 30px #0006}
.header{display:flex;align-items:center;justify-content:space-between}
button{background:#fff;color:#000;border:none;padding:12px 16px;border-radius:999px;font-weight:700;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid var(--border);color:#fff}
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);margin-right:10px;margin-bottom:8px;color:#cfd3ff}
.kv{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-top:8px}
.kv .item .lbl{display:inline-block;margin-bottom:6px;color:var(--muted);font-size:12px}
.kv .item .val{font-weight:600}
table{width:100%;border-collapse:collapse} th,td{padding:12px;border-bottom:1px solid var(--border)} th{text-align:left;color:var(--muted)}
hr.sep{border:0;border-top:1px solid var(--border);margin:14px 0}

/* ===== CÁLCULO ===== */
.grid-3{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.stat{background:var(--chip);border:1px solid var(--border);border-radius:14px;padding:12px}
.stat .caption{color:var(--muted);font-size:12px;margin-bottom:4px}
.stat .value{font-size:18px;font-weight:700}

/* ===== MODAL RETIRO ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:20px;z-index:10000}
.hidden{display:none!important}
.modal{width:100%;max-width:780px;background:linear-gradient(180deg,#151515,#1b1b1b);border:1px solid #262626;border-radius:18px;padding:20px;box-shadow:0 18px 60px #000a}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.modal-title{font-size:22px;margin:0}
.close-x{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
.row2{display:grid;grid-template-columns:1.1fr 1fr;gap:18px}
@media(max-width:900px){.row2{grid-template-columns:1fr}}
.opt-wrap{display:flex;gap:12px}
.opt{flex:1;min-height:94px;border:1px solid var(--border);background:linear-gradient(180deg,#121212,#0f0f0f);border-radius:14px;padding:14px;cursor:pointer;transition:all .15s}
.opt h4{margin:0 0 6px;color:#fff} .opt p{margin:0;color:#cfd3ff;font-size:13px}
.opt.active{outline:2px solid var(--accent)}
.input{position:relative}
.input .prefix{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.7}
input,textarea,select{width:100%;background:#000;color:#fff;border:1px solid #2a2a2a;border-radius:12px;padding:12px 14px}
input[type=number]{appearance:textfield} input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{appearance:none;margin:0}
.input input{padding-left:40px;height:48px}
textarea{min-height:140px;resize:vertical}
.help{color:#9fb4d1;font-size:12px;margin-top:6px}
.switch{display:flex;align-items:center;gap:10px;margin:10px 0}
.modal-actions{display:flex;gap:10px;margin-top:14px}
.msg-err{color:#ffb3b3;min-height:18px} .msg-ok{color:#b8ffc9;min-height:18px}

/* Toast */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#101b10;border:1px solid #214c21;color:#c6f3c6;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px #000a;z-index:11000}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>FX | CAPITAL R.L. — Panel Cliente</h1>
    <button id="logoutBtn" type="button">Cerrar sesión</button>
  </div>

  <!-- MI CUENTA -->
  <div class="card">
    <h2>Mi cuenta</h2>
    <div class="kv" id="accountKv">
      <div class="item"><span class="lbl">Nombre</span><div class="val" id="c_name">—</div></div>
      <div class="item"><span class="lbl">Plan</span><div class="val" id="c_plan">—</div></div>
      <div class="item"><span class="lbl">Moneda</span><div class="val" id="c_currency">—</div></div>
      <div class="item"><span class="lbl">Capital</span><div class="val" id="c_capital">—</div></div>
      <div class="item"><span class="lbl">Cuenta (ID)</span><div class="val" id="c_account">—</div></div>
      <div class="item"><span class="lbl">Período (meses)</span><div class="val" id="c_months">—</div></div>
      <div class="item"><span class="lbl">Interés total del período</span><div class="val" id="c_period_interest">—</div></div>
    </div>
    <hr class="sep">
    <button class="btn-ghost" id="openWithdraw">Solicitar retiro</button>
  </div>

  <!-- RESULTADOS DEL MES -->
  <div class="card">
    <h2>Resultados del mes</h2>
    <p id="periodLabel" class="badge" style="background:#0f1320;border-color:#1b2a55;color:#cfe2ff">—</p>
    <table>
      <thead><tr><th>Viernes</th><th>Interés semanal</th></tr></thead>
      <tbody id="weeks"></tbody>
      <tfoot><tr><th>Total mes</th><th id="monthTotal">—</th></tr></tfoot>
    </table>
    <div class="help" id="periodCloseHelp">El período cierra el —.</div>
  </div>

  <!-- SIMULADOR -->
  <div class="card">
    <h2>Simulador de crecimiento</h2>
    <p class="help">Proyección con capitalización <b>no compuesta</b> (interés simple) por <b>6 meses</b>, según el plan asignado automáticamente por monto.</p>
    <div class="grid-3" style="margin-bottom:10px">
      <div class="input">
        <span class="prefix">Q</span>
        <input id="sim_cap" type="number" min="0" placeholder="Ej. 40,000">
      </div>
      <div class="input">
        <input id="sim_plan" type="text" disabled value="Plan asignado (auto)">
      </div>
      <div><button id="sim_go" type="button">Calcular</button></div>
    </div>
    <div class="grid-3">
      <div class="stat"><div class="caption">Capital inicial</div><div class="value" id="sim_capital">—</div></div>
      <div class="stat"><div class="caption">Interés total acumulado (6m)</div><div class="value" id="sim_interest">—</div></div>
      <div class="stat"><div class="caption">Capital final estimado</div><div class="value" id="sim_final">—</div></div>
    </div>
    <table style="margin-top:12px">
      <thead><tr><th>Mes</th><th>Interés del mes</th></tr></thead>
      <tbody id="sim_rows"></tbody>
    </table>
    <div class="help" id="sim_note"></div>
  </div>
</div>

<!-- ===== MODAL RETIRO ===== -->
<div id="wdModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="wdTitle">
  <div class="modal">
    <div class="modal-head">
      <h3 id="wdTitle" class="modal-title">Solicitud de retiro</h3>
      <button id="wdCloseX" class="close-x" type="button" aria-label="Cerrar">✕</button>
    </div>

    <div class="row2">
      <div>
        <div class="help" style="margin-bottom:8px">Seleccione el tipo de retiro</div>
        <div class="opt-wrap">
          <div id="opt_early" class="opt active" role="button" tabindex="0" aria-pressed="true">
            <h4>Antes de tiempo</h4>
            <p>Aplicará una penalización del 10%.</p>
          </div>
          <div id="opt_health" class="opt" role="button" tabindex="0" aria-pressed="false">
            <h4>Causas de salud</h4>
            <p>Exento de penalización.</p>
          </div>
        </div>
      </div>

      <div>
        <label class="help">Motivo</label>
        <textarea id="wd_reason" placeholder="Explique brevemente el motivo…" maxlength="600"></textarea>
      </div>
    </div>

    <div class="row2" style="margin-top:12px">
      <div>
        <label class="help">Monto a retirar (Q)</label>
        <div class="input">
          <span class="prefix">Q</span>
          <input id="wd_amount" type="number" min="0" step="1" placeholder="Ej. 5,000">
        </div>
        <div class="help">Si el retiro es parcial, debe permanecer al menos <b>Q 2,000</b>.</div>
        <div class="switch">
          <input id="wd_all" type="checkbox"><label for="wd_all" style="margin:0">Retirar todo mi capital</label>
        </div>
      </div>
      <div>
        <div class="msg-err" id="wd_err"></div>
        <div class="msg-ok" id="wd_ok"></div>
      </div>
    </div>

    <div class="modal-actions">
      <button id="wd_submit" type="button">Enviar solicitud</button>
      <button id="wd_cancel" type="button" class="btn-ghost">Cancelar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden">Listo.</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** CONFIG SUPABASE ***/
const PROJECT_URL="https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE=PROJECT_URL+"/rest/v1";
const supa = supabase.createClient(PROJECT_URL, ANON_KEY);

/** CORREO A ADMINS **/
const EDGE_FUNCTION_NAME = "notify-withdrawal"; // <- nombre de la Edge Function que envía correos

const GTZ='America/Guatemala';
function guateNow(){return new Date(new Date().toLocaleString('en-US',{timeZone:GTZ}))}
function money(n,cur){return new Intl.NumberFormat('es-GT',{style:'currency',currency:(cur==='USD'?'USD':'GTQ')}).format(n||0)}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg||'Listo.';t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),2000);}

/*** ESTADO ***/
let PROFILE=null, ACCOUNT=null;
const LOGIN_URL=`${location.origin}/cliente-login.html`;

/*** LOGOUT SEGURO ***/
async function logout(){
  try{ await supa.auth.signOut(); }catch{}
  localStorage.clear(); sessionStorage.clear();
  location.replace(LOGIN_URL);
  setTimeout(()=>{ if(!document.hidden) location.replace(`${location.origin}/`); },1200);
}
document.getElementById('logoutBtn').onclick=logout;

/*** CARGA ***/
(async function boot(){
  if(!localStorage.token){ logout(); return; }

  const rUser=await fetch(`${PROJECT_URL}/auth/v1/user`,{headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`}})
  if(!rUser.ok){ logout(); return; }

  const rp=await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}&select=id,full_name,email,first_login_completed`,{headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`}});  
  PROFILE=(await rp.json())[0]||null;

  const ra=await fetch(`${BASE}/accounts?user_id=eq.${localStorage.uid}&select=id,currency,principal_locked,plan,invest_months,interest_pct,joined_at`,{headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`}});  
  ACCOUNT=(await ra.json())[0]||null;

  // pintar
  document.getElementById("c_name").textContent=PROFILE?.full_name||"—";
  document.getElementById("c_plan").textContent=ACCOUNT?.plan||"—";
  document.getElementById("c_currency").textContent=ACCOUNT?.currency||"—";
  document.getElementById("c_capital").textContent=money(ACCOUNT?.principal_locked,ACCOUNT?.currency);
  document.getElementById("c_account").textContent=ACCOUNT?.id||"—";
  document.getElementById("c_months").textContent=ACCOUNT?.invest_months??"—";

  // interés del periodo (simple)
  const rate = (ACCOUNT?.interest_pct!=null) ? (ACCOUNT.interest_pct/100) :
               (ACCOUNT?.plan==='PLATINUM'?0.20:(ACCOUNT?.plan==='BLACK'?0.25:0.15));
  const periodInterest = (ACCOUNT?.principal_locked||0) * rate * ((ACCOUNT?.invest_months||6)/6);
  document.getElementById("c_period_interest").textContent=money(periodInterest, ACCOUNT?.currency);

  buildMonthResults();
  initWithdrawUI();
  initSimulator();
})();

/*** RESULTADOS DEL MES ***/
function buildMonthResults(){
  if(!ACCOUNT) return;
  const cap = ACCOUNT.principal_locked || 0;
  const plan = ACCOUNT.plan || 'STANDARD';
  const rate6 = (ACCOUNT?.interest_pct!=null) ? (ACCOUNT.interest_pct/100) :
                (plan==='PLATINUM'?0.20:(plan==='BLACK'?0.25:0.15));
  const monthlyRate = rate6/6;

  const today = guateNow();
  let anchor = new Date(today); anchor.setDate(new Date(ACCOUNT.joined_at||today).getDate());
  if (today < anchor) anchor.setMonth(anchor.getMonth()-1);
  const nextAnchor = new Date(anchor); nextAnchor.setMonth(nextAnchor.getMonth()+1);

  document.getElementById('periodLabel').textContent =
    anchor.toLocaleDateString('es-GT',{timeZone:GTZ,day:'numeric',month:'long',year:'numeric'}) +
    ' — ' +
    nextAnchor.toLocaleDateString('es-GT',{timeZone:GTZ,day:'numeric',month:'long',year:'numeric'});
  document.getElementById('periodCloseHelp').textContent = 'El período cierra el '+
    nextAnchor.toLocaleDateString('es-GT',{timeZone:GTZ,day:'numeric',month:'long',year:'numeric'}) + '.';

  // viernes dentro de [anchor, nextAnchor)
  const frs=[], d=new Date(anchor);
  while(d<nextAnchor){ const local=new Date(d.toLocaleString('en-US',{timeZone:GTZ})); if(local.getDay()===5) frs.push(new Date(local)); d.setDate(d.getDate()+1); }

  const shown = frs.filter(f=> f<=today);
  const tbody=document.getElementById('weeks'); tbody.innerHTML='';
  if(shown.length===0){
    tbody.innerHTML = `<tr><td colspan="2" style="color:#9fb4d1">Aún no hay viernes cerrados en este período.</td></tr>`;
    document.getElementById('monthTotal').textContent='—';
    return;
  }

  const monthInterest = cap * monthlyRate;
  const parts = randomPartsToSum(monthInterest, shown.length);
  shown.forEach((f,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${f.toLocaleDateString('es-GT',{timeZone:GTZ})}</td><td>${money(parts[i],ACCOUNT.currency)}</td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('monthTotal').textContent = (today>=nextAnchor) ? money(monthInterest,ACCOUNT.currency) : '—';
}
function randomPartsToSum(total, n){
  if(n<=0) return [];
  const avg=total/n; const wig=0.07;
  let xs=Array.from({length:n},()=> avg*(1 + (Math.random()*2*wig - wig)));
  const s=xs.reduce((a,b)=>a+b,0); const factor= total/s; xs=xs.map(v=> v*factor);
  xs=xs.map(v=> Math.round(v*100)/100);
  const diff = Math.round((total - xs.reduce((a,b)=>a+b,0))*100)/100;
  xs[n-1] = Math.round((xs[n-1]+diff)*100)/100;
  return xs;
}

/*** MODAL RETIRO + VALIDACIONES + EMAIL A ADMINS ***/
function initWithdrawUI(){
  const $ov=document.getElementById('wdModal');
  const $open=document.getElementById('openWithdraw');
  const $close=document.getElementById('wdCloseX');
  const $cancel=document.getElementById('wd_cancel');
  const $early=document.getElementById('opt_early');
  const $health=document.getElementById('opt_health');
  const $all=document.getElementById('wd_all');
  const $amt=document.getElementById('wd_amount');
  const $reason=document.getElementById('wd_reason');
  const $err=document.getElementById('wd_err');
  const $ok=document.getElementById('wd_ok');
  const $submit=document.getElementById('wd_submit');

  let kind='EARLY'; // EARLY | HEALTH

  const setKind=(k)=>{
    kind=k;
    $early.classList.toggle('active',k==='EARLY');
    $health.classList.toggle('active',k==='HEALTH');
  };
  $early.onclick=()=>setKind('EARLY');
  $health.onclick=()=>setKind('HEALTH');

  const open=()=>{ $err.textContent=''; $ok.textContent=''; $amt.value=''; $reason.value=''; $all.checked=false; $ov.classList.remove('hidden'); };
  const close=()=>{ $ov.classList.add('hidden'); };
  $open.onclick=open; $close.onclick=close; $cancel.onclick=close;
  $ov.addEventListener('click',(e)=>{ if(e.target===$ov) close(); });

  function validate(){
    $err.textContent=''; $ok.textContent='';
    const capital=ACCOUNT?.principal_locked||0;
    const all=$all.checked;
    const amount= Number($amt.value||0);
    if(!all){
      if(amount<=0){ $err.textContent='Ingrese el monto a retirar.'; return false; }
      if(amount>capital){ $err.textContent='El monto no puede ser mayor a su capital.'; return false; }
      if((capital - amount) < 2000){ $err.textContent='Debe permanecer al menos Q 2,000 en su cuenta (retiro parcial).'; return false; }
    }
    if(($reason.value||'').trim().length<4){ $err.textContent='Explique brevemente el motivo.'; return false; }
    return true;
  }

  async function notifyAdmins(payload){
    // 1) Edge Function para enviar emails
    try{
      const r = await fetch(`${PROJECT_URL}/functions/v1/${EDGE_FUNCTION_NAME}`,{
        method:'POST',
        headers:{
          'Content-Type':'application/json',
          Authorization:`Bearer ${localStorage.token}`,
          apikey: ANON_KEY
        },
        body: JSON.stringify(payload)
      });
      // no interrumpir si falla: el insert de solicitud ya se hizo
    }catch(e){ console.warn('Edge function email error', e); }
    // 2) Respaldo: insertar notificación interna
    try{
      await fetch(`${BASE}/admin_notifications`,{
        method:'POST',
        headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`,'Content-Type':'application/json'},
        body: JSON.stringify({
          account_id: ACCOUNT.id,
          title: 'Nueva solicitud de retiro',
          message: `${payload.client_name} (${payload.client_email}) solicitó Q${payload.amount} — ${payload.withdrawal_type}.`,
          meta: payload
        })
      });
    }catch(e){ console.warn('admin_notifications insert error', e); }
  }

  $submit.onclick=async ()=>{
    if(!validate()) return;
    const capital=ACCOUNT?.principal_locked||0;
    const all=$all.checked;
    const amount = all ? capital : Number($amt.value||0);

    const payload={
      account_id: ACCOUNT.id,
      kind: (kind==='EARLY'?'EARLY_WITHDRAWAL':'HEALTH_WITHDRAWAL'),
      amount: amount,
      reason: $reason.value.trim(),
      penalty_pct: (kind==='EARLY'?10:0)
    };

    // Inserta solicitud
    try{
      const r=await fetch(`${BASE}/withdrawal_requests`,{
        method:'POST',
        headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`,'Content-Type':'application/json','Prefer':'return=representation'},
        body:JSON.stringify(payload)
      });
      if(!r.ok){ const t=await r.text(); throw new Error(t||'No se pudo registrar la solicitud'); }
    }catch(e){
      $err.textContent='No se pudo registrar la solicitud.'; return;
    }

    // Enviar correo a admins (Edge Function)
    const mailPayload = {
      client_name: PROFILE?.full_name || '',
      client_email: PROFILE?.email || '',
      account_id: ACCOUNT?.id || '',
      plan: ACCOUNT?.plan || '',
      currency: ACCOUNT?.currency || 'GTQ',
      principal: ACCOUNT?.principal_locked || 0,
      amount: amount,
      withdrawal_type: (kind==='EARLY' ? 'Antes de tiempo (10% penalización)' : 'Causas de salud (sin penalización)'),
      reason: $reason.value.trim(),
      requested_at: new Date().toISOString()
    };
    notifyAdmins(mailPayload);

    $ok.textContent='Hemos recibido su solicitud; será atendida en un lapso no mayor a 24 horas hábiles, de lunes a viernes, dentro del horario laboral establecido.';
    toast('Solicitud enviada');
    setTimeout(()=>{ $ov.classList.add('hidden'); },800);
  };
}

/*** SIMULADOR (6 meses fijos, interés simple) ***/
function initSimulator(){
  const capIn=document.getElementById('sim_cap');
  const planOut=document.getElementById('sim_plan');
  const go=document.getElementById('sim_go');
  const rows=document.getElementById('sim_rows');
  const vCap=document.getElementById('sim_capital');
  const vInt=document.getElementById('sim_interest');
  const vFin=document.getElementById('sim_final');
  const note=document.getElementById('sim_note');

  function autoPlan(cap){
    if(ACCOUNT?.plan==='BLACK' && ACCOUNT?.black_enabled) return 'BLACK';
    if(cap>=250000) return 'PLATINUM';
    if(cap>=2000) return 'STANDARD';
    return 'NO_ELEGIBLE';
  }
  function rate6(plan){
    return (ACCOUNT?.interest_pct!=null) ? (ACCOUNT.interest_pct/100)
      : (plan==='PLATINUM'?0.20:(plan==='BLACK'?0.25:0.15));
  }

  go.onclick=()=>{
    const cap=Number(capIn.value||0);
    const plan=autoPlan(cap);
    planOut.value= plan==='NO_ELEGIBLE' ? 'NO ELEGIBLE' :
      (plan==='PLATINUM'?'PLATINUM (20% semestral)':(plan==='BLACK'?'BLACK (25% semestral)':'STANDARD (15% semestral)'));
    if(plan==='NO_ELEGIBLE'){
      rows.innerHTML=''; vCap.textContent=money(cap); vInt.textContent='—'; vFin.textContent='—';
      note.textContent='El capital mínimo para simular es Q 2,000.'; return;
    }
    const r6=rate6(plan); const rm=r6/6; const months=6;
    const monthInterest = cap*rm; const total = monthInterest*months; const final = cap+total;
    vCap.textContent=money(cap); vInt.textContent=money(total); vFin.textContent=money(final);
    rows.innerHTML='';
    for(let i=1;i<=months;i++){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i}</td><td>${money(monthInterest)}</td>`;
      rows.appendChild(tr);
    }
    note.textContent=`Plan: ${plan}. Tasa semestral ${(r6*100).toFixed(0)}% — Tasa mensual ${(rm*100).toFixed(2)}%.`;
  };
}
</script>
</body>
</html>
