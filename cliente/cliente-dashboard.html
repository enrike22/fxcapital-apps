
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FX | CAPITAL R.L. ‚Äî Panel del Cliente</title>

<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" href="favicon.ico" sizes="any">
<link rel="manifest" href="site.webmanifest">
<meta name="theme-color" content="#0b0c0e">

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg0:#000; --bg1:#0b0c0e; --bg2_toggle:#111317; --bg3:#14171c;

    --txt:#ffffff;
    --fg:#ffffff;
    --muted:#d6dceb;
    --line:rgba(255,255,255,.14);

    --grad-app: radial-gradient(1200px 800px at 10% -20%, #12151a 0%, #0b0c0e 45%, #060708 100%);
    --grad-panel: linear-gradient(180deg, #111317 0%, #0b0d10 100%);
    --grad-card: linear-gradient(180deg, #191d22 0%, #12161b 100%);
    --shadow-1: 0 10px 25px rgba(0,0,0,.45);
    --shadow-2: 0 18px 40px rgba(0,0,0,.55);
    --shadow-inset: inset 0 1px 0 rgba(255,255,255,.05), inset 0 -1px 0 rgba(0,0,0,.7);
    --radius:18px;
    --gloss: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 35%);
    --chip:#171b20;
    --danger:#ff4d4f;
    --ok:#2dd4bf;

    --panel-gray-bg1:#4b515b;
    --panel-gray-bg2:#1b1f27;
    --panel-gray-border:rgba(255,255,255,.16);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--txt);
    background:var(--grad-app) fixed, var(--bg0);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1100px;margin:40px auto;padding:0 22px}

  header{position:relative;display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:18px}
  .brand-wrap{display:flex;flex-direction:column;gap:0}
  .brand-row{display:flex;align-items:center;gap:18px}
  .brand-logo{width:112px;height:112px;border-radius:16px;object-fit:contain;background:transparent;display:block}

  .brand-title{
    margin:0;
    font-weight:900;
    letter-spacing:.4px;
    font-size:clamp(32px,6vw,72px);
    line-height:1;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .brand-sub{margin:10px 0 0 0;font-weight:700;color:#e7ecf6;font-size:clamp(16px,2.2vw,28px);opacity:.92}

  .btn{
    appearance:none;border:0;border-radius:999px;
    padding:12px 18px;font-weight:900;cursor:pointer;
    color:#0b0c0e;background:#fff;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.7),0 10px 22px rgba(0,0,0,.45);
    transition:transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{
    color:var(--txt);
    background:var(--gloss),linear-gradient(180deg,#1a1d23,#0f1216);
    border:1px solid var(--line);
    box-shadow:var(--shadow-1),var(--shadow-inset)
  }

  .btn.cta{
    padding:13px 20px;
    font-weight:900;
    letter-spacing:.2px;
    background:
      radial-gradient(140% 180% at 30% 0%, rgba(255,255,255,.35) 0%, rgba(255,255,255,0) 55%),
      linear-gradient(180deg,#ffffff 0%, #e9eef7 100%);
    color:#0b0c0e;
    border:1px solid rgba(255,255,255,.92);
    box-shadow:
      0 18px 46px rgba(0,0,0,.58),
      0 0 0 6px rgba(255,255,255,.06),
      inset 0 1px 0 rgba(255,255,255,.85);
    display:inline-flex;
    align-items:center;
    gap:10px;
  }
  .btn.cta::before{
    content:"‚áÑ";
    width:26px;height:26px;border-radius:10px;
    display:grid;place-items:center;
    background:rgba(0,0,0,.08);
    border:1px solid rgba(0,0,0,.10);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.7);
    font-weight:900;
  }
  .btn.cta:hover{filter:brightness(.98)}

  @media (max-width:560px){
    .brand-title{font-size: clamp(24px, 8.2vw, 34px);}
  }

  .panel{
    background:var(--grad-panel);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:0 0 0 1px rgba(255,255,255,.05),0 30px 80px rgba(0,0,0,.55),var(--shadow-inset)
  }

  .panel.gray{
    background:
      radial-gradient(120% 160% at 12% 0%, rgba(255,255,255,.10) 0%, rgba(255,255,255,0) 45%),
      linear-gradient(180deg, var(--panel-gray-bg1) 0%, var(--panel-gray-bg2) 100%) !important;
    border:1px solid var(--panel-gray-border);
    box-shadow:
      0 18px 46px rgba(0,0,0,.55),
      inset 0 1px 0 rgba(255,255,255,.12),
      inset 0 -14px 30px rgba(0,0,0,.55);
    color:#fff !important;
  }
  .panel.gray > h2,
  .panel.gray > .muted,
  .panel.gray > .note{ color:#fff !important; opacity:.95; }

  .card{
    background:var(--grad-card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow-1),var(--shadow-inset)
  }

  .section{padding:24px}

  .grid{display:grid;gap:16px}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:920px){.grid.cols-3{grid-template-columns:1fr 1fr}}
  @media (max-width:680px){.grid.cols-3{grid-template-columns:1fr}}

  .group{padding:18px 20px;position:relative;overflow:hidden}
  .group::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.05),transparent 40%);pointer-events:none}

  .k{
    display:inline-block;font-size:13px;
    color:var(--muted);
    background:rgba(0,0,0,.28);
    border:1px solid rgba(255,255,255,.12);
    padding:6px 10px;border-radius:999px;margin-bottom:8px
  }

  .v{display:block;font-size:16px;font-weight:800;letter-spacing:.2px}

  .input{
    width:100%;
    border:1px solid rgba(255,255,255,.16);
    border-radius:12px;
    padding:12px 14px;
    background:#0f1116;
    color:#ffffff
  }

  .muted{color:var(--muted);font-weight:650}

  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.14)}
  .table th{
    color:#f2f5ff;
    font-weight:900;text-align:left;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
    position:sticky;top:0;z-index:1
  }
  .panel.gray .table td{ color:#ffffff !important; }
  .panel.gray .table th{ color:#ffffff !important; }

  .note{color:var(--muted);font-size:13px;margin-top:10px;opacity:.95}

  .wrap > section.panel.section{ margin-top:18px; }

  dialog{
    border:0;border-radius:22px;
    background:var(--gloss),linear-gradient(180deg,#14161b,#0f1116);
    color:var(--txt);
    width:min(840px,92vw);
    box-shadow:0 24px 64px rgba(0,0,0,.65),var(--shadow-inset)
  }
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .modal-h{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.14)}
  .modal-b{padding:18px 22px}
  .modal-close{
    width:36px;height:36px;border-radius:50%;
    display:grid;place-items:center;border:1px solid rgba(255,255,255,.18);
    background:linear-gradient(180deg,#121419,#0f1116);color:#fff;cursor:pointer;
    box-shadow:var(--shadow-inset)
  }

  .pill{
    border:1px solid rgba(255,255,255,.16);
    border-radius:16px;padding:12px 14px;cursor:pointer;
    background:linear-gradient(180deg,#15181d,#101317);
    box-shadow:var(--shadow-inset);transition:all .18s
  }
  .pill:hover{filter:brightness(1.06)}
  .pill.selected{
    background:#fff;color:#0b0c0e;border-color:#fff;
    box-shadow:0 10px 22px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.7)
  }
  .pill.selected .muted{color:#1b1f24}

  .switch{
    --w:58px;--h:32px;--knob:26px;
    inline-size:var(--w);block-size:var(--h);
    background:linear-gradient(180deg,#1b1f26,#0f1216);
    border-radius:999px;border:1px solid rgba(255,255,255,.16);position:relative;
    transition:all .18s ease; cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.7);
  }
  .switch::after{
    content:"";position:absolute;inline-size:var(--knob);block-size:var(--knob);
    border-radius:50%;background:linear-gradient(180deg,#fff,#d9d9d9);
    top:50%;left:3px;translate:0 -50%; transition:all .18s ease;
  }
  .switch.on{
    background:#fff; border-color:#fff;
    box-shadow:0 10px 22px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.7);
  }
  .switch.on::after{
    left:calc(var(--w) - var(--knob) - 3px);
    background:linear-gradient(180deg,#2a2f36,#161a1f);
  }

  #tdlg .k{ color:#ffffff !important; font-weight:900 !important; }
  #tdlg .input{
    background:#ffffff !important;
    color:#000000 !important;
    border:1px solid #bfc6d1;
  }
  #tdlg .input::placeholder{ color:#6b7280; }
  #tdlg .input:focus{
    outline:none;
    border-color:#000000;
    box-shadow:0 0 0 2px rgba(0,0,0,.08);
  }

  .tx-wrap{padding-top:22px}
  .tx-head{display:flex; align-items:flex-start; justify-content:space-between; gap:14px; margin:0 0 14px 0}
  .tx-title{display:flex; gap:12px; align-items:flex-start}
  .tx-icon{
    width:38px; height:38px; border-radius:14px;
    display:grid; place-items:center;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    flex:0 0 auto;
  }
  .tx-title h2{margin:0;font-size:20px;letter-spacing:.2px}
  .tx-title p{margin:6px 0 0; font-size:13px; line-height:1.4; color:var(--muted)}
  .tx-badge{
    font-size:12px;
    padding:7px 12px;
    border-radius:999px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    color:#f4f7ff;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    max-width:100%;
    white-space:normal;
    text-align:center;
  }
  @media (max-width: 520px){
    .tx-head{flex-direction: column;align-items: flex-start;}
    .tx-badge{margin-top: 8px;}
  }

  .tx-steps{display:flex; align-items:center; gap:10px; margin:0 0 16px 0}
  .tx-step{
    display:flex; align-items:center; gap:8px;
    font-size:12.5px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:#f4f7ff;
  }
  .tx-step-dot{
    width:20px; height:20px; border-radius:999px;
    display:grid; place-items:center;
    font-size:12px;
    background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.14);
  }
  .tx-step-active{
    background:rgba(255,255,255,.12);
    border-color:rgba(255,255,255,.20);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
  }
  .tx-step-line{flex:1;height:1px;background:rgba(255,255,255,.14);border-radius:999px}

  .tx-grid{display:grid; grid-template-columns: 1.4fr .9fr; gap:14px}
  @media (max-width: 900px){ .tx-grid{grid-template-columns:1fr} }

  .tx-panel{
    border-radius:16px;
    padding:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  }
  .tx-panel-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
  .tx-chip{
    font-size:12px; padding:6px 10px; border-radius:999px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    color:#f4f7ff;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
  }

  .tx-rows{display:flex; flex-direction:column; gap:10px}
  .tx-row{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
    padding:10px 10px;
    border-radius:12px;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
  }
  .tx-row-strong{grid-template-columns: 1fr auto auto}
  .tx-k{font-size:12.5px; opacity:.92; color:#f1f5ff}
  .tx-v{font-size:13px; font-weight:900; color:#ffffff}

  .tx-mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    letter-spacing:.3px;
    padding:6px 10px;
    border-radius:10px;
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.16);
    color:#ffffff;
  }

  .tx-copy{
    height:34px; padding:0 12px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.12);
    color:#fff;
    font-weight:900;
    cursor:pointer;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
  }
  .tx-copy:hover{background:rgba(255,255,255,.16)}
  .tx-copy:disabled{opacity:.6; cursor:not-allowed}

  .tx-hint{
    margin-top:12px;
    font-size:12.5px;
    color:var(--muted);
    line-height:1.4;
  }

  .tx-primary{
    width:100%;
    height:44px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.18);
    background:#fff;
    color:#0b0c0e;
    font-weight:900;
    cursor:pointer;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.75), 0 12px 26px rgba(0,0,0,.38);
  }
  .tx-primary:hover{filter:brightness(.98)}

  .tx-note{
    margin-top:12px;
    font-size:12.5px;
    color:var(--muted);
    line-height:1.45;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
  }

  .nav-actions{display:flex; gap:12px; margin:0 0 18px 0; flex-wrap:wrap; align-items:center}

  .nav-panel-toggle{
    display:inline-flex;
    align-items:center;
    gap:12px;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background:var(--gloss),linear-gradient(180deg,#1a1d23,#0f1216);
    box-shadow:var(--shadow-1),var(--shadow-inset);
    user-select:none;
  }
  .nav-panel-toggle .label{
    font-weight:900;
    letter-spacing:.2px;
    color:#fff;
    display:inline-flex;
    align-items:center;
    gap:10px;
    line-height:1;
  }
  .nav-panel-toggle .label::before{
    content:"‚ñ¶";
    width:18px;height:18px;border-radius:8px;
    display:grid;place-items:center;
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.16);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.10);
    font-size:13px;
  }
  .nav-panel-toggle.active{
    border-color:rgba(45,212,191,.65);
    box-shadow:
      0 10px 30px rgba(45,212,191,.25),
      inset 0 1px 0 rgba(255,255,255,.12);
  }

  .nav-actions .btn{display:inline-flex;align-items:center;gap:10px}
  .btn.icon::before{
    content:"‚¨§";
    width:10px;height:10px;border-radius:50%;
    background:rgba(0,0,0,.18);
    border:1px solid rgba(0,0,0,.15);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.55);
    display:inline-block;
  }
  .btn.withdrawBtn::before{content:"‚á£";}
  .btn.backBtn::before{content:"‚Üê";}

  .nav-actions .btn.active{
    background: linear-gradient(180deg, rgba(45,212,191,.95), rgba(45,212,191,.75));
    color:#02110f;
    border:1px solid rgba(45,212,191,.9);
    box-shadow:
      0 10px 30px rgba(45,212,191,.35),
      inset 0 1px 0 rgba(255,255,255,.55);
  }

  @media (max-width:560px){
    header{padding-top:64px}
    .brand-row{gap:12px}
    .brand-logo{width:84px;height:84px}
    .brand-title{font-size:clamp(26px,7.6vw,36px);line-height:1.02}
    .brand-sub{font-size:clamp(13px,3.6vw,18px);margin-top:8px}
    #btnSignOut{position:absolute; top:10px; right:12px; z-index:5; padding:10px 14px;}
  }

  #accountSection.space-after{ margin-bottom:14px; }
  #accountSection.tight-after{ margin-bottom:0; }

  .hidden{display:none !important;}

  /* ‚úÖ Chips para estados (retiros) */
  .status-chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:900;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.08);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    white-space:nowrap;
  }
  .status-dot{
    width:10px;height:10px;border-radius:50%;
    background:rgba(255,255,255,.35);
    border:1px solid rgba(0,0,0,.18);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.45);
  }
  .status-pending .status-dot{ background: rgba(255,255,255,.40); }
  .status-approved .status-dot{ background: rgba(45,212,191,.95); }
  .status-rejected .status-dot{ background: rgba(255,77,79,.95); }

.account-select{
  width:100%;
  background:var(--chip);
  color:var(--fg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 12px;
  font-weight:900;
  letter-spacing:.2px;
  outline:none;
}
.account-select:focus{
  border-color:#3a4654;
  box-shadow:0 0 0 3px rgba(255,255,255,.06);
}
.account-select option{
  background:#0f1012;
  color:var(--fg);
}

</style>
</head>

<body>
  <div class="wrap" id="appWrap">
    <header>
      <div class="brand-wrap">
        <div class="brand-row">
          <img
            src="/logo-white.png?v=1"
            alt="FX Capital"
            class="brand-logo"
            loading="eager"
            onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/enrike22/fxcapital-apps/main/cliente/logo-white.png?raw=1';"
          />
          <div>
            <h1 class="brand-title">FX | CAPITAL R.L.</h1>
            <h2 class="brand-sub">‚Äî Panel del Cliente</h2>
          </div>
        </div>
      </div>
      <button class="btn" id="btnSignOut">Cerrar sesi√≥n</button>
    </header>

    <div class="nav-actions">
      <div id="navPanelToggleWrap" class="nav-panel-toggle active" role="group" aria-label="Mi Panel">
        <span class="label">Mi Panel</span>
        <div id="switchPanelExtras" class="switch" role="switch" aria-checked="false" tabindex="0" title="Mostrar / ocultar secciones adicionales"></div>
      </div>

      <button class="btn cta icon" id="btnNavDeposit" type="button">Depositar</button>
      <button class="btn secondary withdrawBtn icon" id="btnNavWithdraw" type="button">Retirar</button>
      <button class="btn secondary backBtn icon" id="btnBackPanel" type="button" style="display:none">Volver a Mi Panel</button>
    </div>

    <div id="viewPanel">
      <section class="panel section gray" id="accountSection">
        <h2 style="margin:0 0 14px 0">Mi cuenta</h2>
        <div class="grid cols-3">
          <div class="card group"><span class="k">Nombre</span><span id="valName" class="v">‚Äî</span></div>
          <div class="card group"><span class="k">Apertura de cuenta</span><span id="valOpenDate" class="v">‚Äî</span></div>
          <div class="card group"><span class="k">Plan</span><span id="valPlan" class="v">‚Äî</span></div>

          <div class="card group"><span class="k">Moneda</span><span id="valCurrency" class="v">‚Äî</span></div>
          <div class="card group"><span class="k">Cuenta</span><div class="v" style="display:flex;flex-direction:column;gap:6px"><select id="accountPicker" class="account-select" aria-label="Seleccionar cuenta"></select><span id="valAccountId" class="muted" style="font-size:12px;opacity:.85">‚Äî</span></div></div>
          <div class="card group"><span class="k">Per√≠odo (meses)</span><span id="valMonths" class="v">‚Äî</span></div>

          <div class="card group"><span class="k">Capital</span><span id="valCapital" class="v">Q 0.00</span></div>
          <div class="card group"><span class="k">Finalizaci√≥n de apertura de cuenta</span><span id="valCloseDate" class="v">‚Äî</span></div>
          <div class="card group"><span class="k">Inter√©s total del per√≠odo</span><span id="valPeriodInterest" class="v">Q 0.00</span></div>
        </div>
      </section>

      <div id="panelExtras">
        <section class="panel section gray" style="margin-top:18px">
          <h2 style="margin:0 0 10px 0">Resultados del mes</h2>
          <div class="muted" id="monthRange">‚Äî</div>
          <div style="overflow:auto;margin-top:8px">
            <table class="table">
              <thead><tr><th>Viernes</th><th>Inter√©s semanal</th></tr></thead>
              <tbody id="weekBody"><tr><td>‚Äî</td><td>‚Äî</td></tr></tbody>
              <tfoot><tr class="sum-row"><td>Acumulado del mes</td><td id="weekSum">‚Äî</td></tr></tfoot>
            </table>
          </div>
          <div id="monthNote" class="note">Periodo de cierre fin de mes: ‚Äî</div>
        </section>

        <section class="panel section gray" style="margin-top:18px">
          <h2 style="margin:0 0 10px 0">Estado de cuenta</h2>
          <div class="muted" id="stmtRange">‚Äî</div>

          <div style="overflow:auto;margin-top:8px">
            <table class="table">
              <thead>
                <tr>
                  <th>Mes</th>
                  <th>Capital inicio</th>
                  <th>Inter√©s (beneficio)</th>
                  <th>Estado</th>
                  <th>Saldo</th>
                </tr>
              </thead>
              <tbody id="stmtBody">
                <tr><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td></tr>
              </tbody>
            </table>
          </div>

          <div class="note" id="stmtNote">‚Äî</div>
        </section>

        <section class="panel section" style="margin-top:18px">
          <h2 style="margin:0 0 4px 0">Simulador de crecimiento</h2>
          <div class="muted" style="margin-bottom:14px">Inter√©s simple por <b>6 meses</b>. Plan autom√°tico seg√∫n capital ingresado.</div>
          <div class="grid cols-3">
            <div class="group card"><span class="k">Capital a simular (Q)</span>
              <input id="simCapital" class="input" type="text" inputmode="decimal" placeholder="Ej. 40,000" />
            </div>
            <div class="group card"><span class="k">Plan y % (seg√∫n monto)</span><div id="simPlan" class="v">‚Äî</div></div>
            <div class="group card"><span class="k">Capital final estimado</span><div id="simFinal" class="v">Q 0.00</div></div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
            <button class="btn" id="btnCalc">Calcular</button>
            <span id="simNote" class="note"></span>
          </div>
          <div style="overflow:auto;margin-top:12px">
            <table class="table" id="simTable">
              <thead><tr><th>Mes</th><th>Inter√©s del mes</th></tr></thead>
              <tbody id="simBody"><tr><td>1</td><td>Q 0.00</td></tr></tbody>
              <tfoot><tr class="sum-row"><td>Inter√©s total acumulado</td><td id="simSum">Q 0.00</td></tr></tfoot>
            </table>
          </div>
        </section>
      </div>
    </div>

    <div id="viewDeposit" style="display:none">
      <section class="panel section tx-wrap">
        <div class="tx-head">
          <div class="tx-title">
            <div class="tx-icon">‚áÑ</div>
            <div>
              <h2>Dep√≥sito por transferencia</h2>
              <p>Env√≠e su boleta de transferencia para solicitar una recarga. Un administrador revisar√° y acreditar√° su capital.</p>
            </div>
          </div>
          <span class="tx-badge">Validaci√≥n administrativa</span>
        </div>

        <div class="tx-steps">
          <div class="tx-step tx-step-active" id="txStep1">
            <span class="tx-step-dot">1</span><span>Transferir</span>
          </div>
          <div class="tx-step-line"></div>
          <div class="tx-step" id="txStep2">
            <span class="tx-step-dot">2</span><span>Subir boleta</span>
          </div>
        </div>

        <div class="tx-grid">
          <div class="tx-panel">
            <div class="tx-panel-head">
              <span class="tx-chip">Datos para transferencia</span>
            </div>

            <div class="tx-rows">
              <div class="tx-row">
                <span class="tx-k">Nombre de la cuenta</span>
                <span class="tx-v">Fx Inversiones</span>
              </div>

              <div class="tx-row">
                <span class="tx-k">Banco</span>
                <span class="tx-v">Banco Industrial</span>
              </div>

              <div class="tx-row tx-row-strong">
                <span class="tx-k">N√∫mero de cuenta</span>
                <span class="tx-v tx-mono" id="acctNumber">021-010518-5</span>
                <button class="tx-copy" type="button" id="btnCopyAcct">Copiar</button>
              </div>

              <div class="tx-row">
                <span class="tx-k">Tipo de cuenta</span>
                <span class="tx-v">Monetaria</span>
              </div>

              <div class="tx-row">
                <span class="tx-k">Moneda</span>
                <span class="tx-v">Quetzales (GTQ)</span>
              </div>
            </div>

            <div class="tx-hint">
              Realice la transferencia a esta cuenta y posteriormente adjunte la boleta para solicitar la recarga de su capital.
            </div>
          </div>

          <div class="tx-panel">
            <div class="tx-panel-head">
              <span class="tx-chip">Acci√≥n</span>
            </div>

            <button class="tx-primary" id="btnOpenTopup" type="button">
              Enviar boleta de dep√≥sito
            </button>

            <div class="tx-note">
              <b>Nota:</b> El acreditamiento puede tomar unas horas (seg√∫n validaci√≥n).
            </div>
          </div>
        </div>
      </section>
    </div>

    <div id="viewWithdraw" style="display:none">
      <section class="panel section gray">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
          <h2 style="margin:0">Solicitud de retiro de capital</h2>
          <button class="btn secondary" id="btnRefreshWithdrawals" type="button">Refrescar historial</button>
        </div>

        <div class="row" style="display:grid;gap:14px;grid-template-columns:1fr 1fr;margin-top:14px">
          <div class="pill selected" id="optEarly" tabindex="0" role="button" aria-pressed="true">
            <div style="font-weight:800;margin-bottom:6px">Antes de tiempo</div>
            <div class="muted">Aplicar√° una penalizaci√≥n del 10%.</div>
          </div>
          <div class="pill" id="optHealth" tabindex="0" role="button" aria-pressed="false">
            <div style="font-weight:800;margin-bottom:6px">Causas de salud</div>
            <div class="muted">Exento de penalizaci√≥n.</div>
          </div>
        </div>

        <div class="row" style="display:grid;gap:14px;grid-template-columns:1fr 1fr;margin-top:14px">
          <div>
            <div class="k">Monto a retirar (Q)</div>
            <input id="wAmount" class="input" type="text" inputmode="decimal" placeholder="Ej. 5,000">
            <div class="note">Si el retiro es parcial, debe permanecer al menos <b>Q 2,000</b>.</div>
          </div>

          <div>
            <div class="k">Motivo</div>
            <textarea id="wReason" class="input" placeholder="Explique brevemente el motivo‚Ä¶" style="min-height:96px;max-height:240px;resize:vertical"></textarea>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;margin:16px 0">
          <div id="switchAll" class="switch" role="switch" aria-checked="false" tabindex="0" title="Retirar todo mi capital"></div>
          <div>Retirar todo mi capital</div>
        </div>

        <div class="actions" style="display:flex;gap:12px;justify-content:flex-start">
          <button class="btn secondary" id="wCancel">Cancelar</button>
          <button class="btn" id="wSend">Enviar solicitud</button>
        </div>

        <div class="note" style="margin-top:14px">
          Al enviar la solicitud, un representante de <b>FX | CAPITAL R.L.</b> revisar√° su informaci√≥n y se comunicar√° con usted.
        </div>

        <!-- ‚úÖ HISTORIAL DE RETIROS -->
        <div style="margin-top:18px; padding-top:14px; border-top:1px solid rgba(255,255,255,.16)">
          <h2 style="margin:0 0 8px 0">Historial de retiros</h2>
          <div class="muted" id="wHistRange">‚Äî</div>

          <div style="overflow:auto;margin-top:10px">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Monto</th>
                  <th>Tipo</th>
                  <th>Estado</th>
                  <th>Detalle</th>
                </tr>
              </thead>
              <tbody id="wHistBody">
                <tr><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td></tr>
              </tbody>
            </table>
          </div>

          <div class="note" id="wHistNote">‚Äî</div>
        </div>
      </section>
    </div>

  </div>

  <dialog id="pwdDlg" aria-labelledby="pwdTitle">
    <div class="modal-h">
      <div id="pwdTitle" style="font-weight:900">Actualizar contrase√±a</div>
      <div style="width:36px;height:36px"></div>
    </div>
    <div class="modal-b">
      <p class="note" style="margin-top:0;margin-bottom:16px">
        Por seguridad, debe actualizar su contrase√±a antes de continuar usando el panel.
      </p>

      <div style="display:grid;gap:14px;grid-template-columns:1fr 1fr">
        <div>
          <div class="k">Nueva contrase√±a</div>
          <div class="pwd-field-wrap" style="position:relative">
            <input id="pwdNew" class="input" type="password" autocomplete="new-password" placeholder="M√≠nimo 8 caracteres" style="padding-right:44px">
            <button type="button" id="pwdNewEye" class="pwd-toggle" aria-label="Mostrar u ocultar contrase√±a"
              style="position:absolute; right:12px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; font-size:17px; color:#8c92a0; padding:4px;">üëÅ</button>
          </div>
        </div>
        <div>
          <div class="k">Confirmar nueva contrase√±a</div>
          <div class="pwd-field-wrap" style="position:relative">
            <input id="pwdConfirm" class="input" type="password" autocomplete="new-password" placeholder="Repita la contrase√±a" style="padding-right:44px">
            <button type="button" id="pwdConfirmEye" class="pwd-toggle" aria-label="Mostrar u ocultar contrase√±a"
              style="position:absolute; right:12px; top:50%; transform:translateY(-50%); border:0; background:transparent; cursor:pointer; font-size:17px; color:#8c92a0; padding:4px;">üëÅ</button>
          </div>
        </div>
      </div>

      <div id="pwdError" style="margin-top:8px;font-size:13px;color:var(--danger)"></div>

      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:18px">
        <button class="btn" id="pwdSave">Guardar contrase√±a</button>
      </div>
    </div>
  </dialog>

  <dialog id="tdlg" aria-labelledby="tdlgTitle">
    <div class="modal-h">
      <div id="tdlgTitle" style="font-weight:900">Enviar boleta de dep√≥sito</div>
      <button class="modal-close" id="tClose" aria-label="Cerrar">‚úï</button>
    </div>

    <div class="modal-b">
      <div class="row" style="display:grid;gap:14px;grid-template-columns:1fr 1fr">
        <div>
          <div class="k">Monto depositado (Q)</div>
          <input id="tAmount" class="input" type="text" inputmode="decimal" placeholder="Ej. 5,000">
          <div class="note">Monto m√≠nimo sugerido: <b>Q 2,000</b>.</div>
        </div>
        <div>
          <div class="k">Banco (opcional)</div>
          <input id="tBank" class="input" type="text" placeholder="Ej. Banrural / BAC / BI">
        </div>
      </div>

      <div class="row" style="display:grid;gap:14px;grid-template-columns:1fr 1fr;margin-top:14px">
        <div>
          <div class="k">Fecha/hora del dep√≥sito (opcional)</div>
          <input id="tDate" class="input" type="datetime-local">
        </div>
        <div>
          <div class="k">Boleta (JPG/PNG/PDF)</div>
          <input id="tReceipt" class="input" type="file" accept="image/*,application/pdf">
          <div class="note">M√°ximo recomendado: <b>6 MB</b>.</div>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="k">Notas (opcional)</div>
        <textarea id="tNotes" class="input" placeholder="Referencia, n√∫mero de transacci√≥n, etc." style="min-height:96px;resize:vertical"></textarea>
      </div>

      <div class="actions" style="display:flex;gap:12px;justify-content:flex-start;margin-top:16px">
        <button class="btn secondary" id="tCancel">Cancelar</button>
        <button class="btn" id="tSend">Enviar dep√≥sito</button>
      </div>
    </div>
  </dialog>

  <dialog id="msgDlg">
    <div class="modal-h">
      <div style="font-weight:900">FX | CAPITAL R.L.</div>
      <button class="modal-close" id="msgClose" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="modal-b">
      <p id="msgText" style="margin:0;line-height:1.6"></p>
      <div style="margin-top:16px;display:flex;justify-content:flex-end">
        <button class="btn" id="msgOk">Aceptar</button>
      </div>
    </div>
  </dialog>

  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

// --- FIX: asegurar setNavMode global (evita ReferenceError si una versi√≥n vieja no la trae) ---
window.setNavMode = window.setNavMode || function(mode){
  try{
    const toggleWrap = document.getElementById('navPanelToggleWrap');
    const btnDep     = document.getElementById('btnNavDeposit');
    const btnW       = document.getElementById('btnNavWithdraw');
    const btnBack    = document.getElementById('btnBackPanel');

    const showMainNav = (mode === 'panel');
    if(toggleWrap) toggleWrap.style.display = showMainNav ? 'inline-flex' : 'none';
    if(btnDep)     btnDep.style.display     = showMainNav ? 'inline-flex' : 'none';
    if(btnW)       btnW.style.display       = showMainNav ? 'inline-flex' : 'none';
    if(btnBack)    btnBack.style.display    = showMainNav ? 'none' : 'inline-flex';
  }catch(e){}
};
  <script>
  const BASE_URL   = 'https://clientes.fxcapital-gt.com/';
  const LOGIN_URL  = BASE_URL;

  const SUPABASE_URL = 'https://czvpehbubfrinutztnwh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true} });

  const $ = s=>document.querySelector(s);
  const fmtQ = n => { try{ return new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ'}).format(n||0) }catch(e){ return `Q ${(Number(n)||0).toFixed(2)}` } };

  /* ==========================================
     ‚úÖ ZONA HORARIA AMARRADA A GUATEMALA
  ========================================== */
  const TZ = 'America/Guatemala';

  const dtfPartsGT = new Intl.DateTimeFormat('en-CA', {
    timeZone: TZ,
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });

  function getGTParts(date){
    const parts = dtfPartsGT.formatToParts(date);
    const map = {};
    parts.forEach(p => { if(p.type !== 'literal') map[p.type] = p.value; });
    return { y: Number(map.year), m: Number(map.month), d: Number(map.day) };
  }

  // Guatemala es UTC-6 fijo. Medianoche GT = 06:00 UTC.
  function makeGTDate(y, m, d, hh=0, mm=0, ss=0){
    const utcH = hh + 6;
    return new Date(Date.UTC(y, m-1, d, utcH, mm, ss, 0));
  }

  function clampGT(dateLike){
    const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
    const { y, m, d:dd } = getGTParts(d);
    return makeGTDate(y, m, dd, 0, 0, 0);
  }

  function fmtDateGT(dateLike){
    const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
    return new Intl.DateTimeFormat('es-GT', { timeZone: TZ }).format(d);
  }

  function fmtDateTimeGT(dateLike){
    const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
    return new Intl.DateTimeFormat('es-GT', { timeZone: TZ, dateStyle:'short', timeStyle:'short' }).format(d);
  }

  function getGTNow(){
    return new Date();
  }

  function getGTDow(dateLike){
    const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
    const wd = new Intl.DateTimeFormat('en-US', { timeZone: TZ, weekday:'short' }).format(d);
    const map = { Sun:0, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6 };
    return map[wd] ?? d.getDay();
  }

  /* ============================================================
     ‚úÖ FIX DEFINITIVO joined_at:
     - TOMAMOS SOLO "YYYY-MM-DD" (lo que puso el admin)
     - IGNORAMOS horas/UTC/navegador para que NO cambie el d√≠a
     - NUNCA devuelve null (para que no se rompa el script)
  ============================================================ */
  function parseJoinedExactGT(v){
    const s = String(v || '');
    const d10 = s.slice(0,10); // YYYY-MM-DD
    if(/^\d{4}-\d{2}-\d{2}$/.test(d10)){
      const [y,m,d] = d10.split('-').map(Number);
      return makeGTDate(y, m, d, 0, 0, 0); // 00:00 GT del d√≠a EXACTO
    }
    // fallback seguro: si viniera raro, no rompemos nada
    return clampGT(v ? new Date(v) : getGTNow());
  }

  // ‚úÖ Guardar nombre/email del usuario logueado
  let CURRENT_USER_NAME = '';
  let CURRENT_USER_EMAIL = '';
  let CURRENT_ACCOUNT_ID = null;
  let CURRENT_ACCOUNTS = [];

  async function forceLogout(){
    try {
      const { error } = await sb.auth.signOut({ scope:'global' });
      if (error) console.warn('Supabase signOut error:', error?.message);
      Object.keys(localStorage).forEach(k=>{ if (k.startsWith('sb-') && k.endsWith('-auth-token')) localStorage.removeItem(k); });
      sessionStorage.clear();
      if (indexedDB && indexedDB.databases){
        try{
          const dbs = await indexedDB.databases();
          for (const db of dbs){ if (db.name && /supabase|auth|localforage/i.test(db.name)) indexedDB.deleteDatabase(db.name); }
        }catch(e){}
      }
    } finally {
      const bust = `logged_out=${Date.now()}`;
      const sep  = LOGIN_URL.includes('?') ? '&' : '?';
      window.location.replace(`${LOGIN_URL}${sep}${bust}`);
    }
  }
  document.getElementById('btnSignOut')?.addEventListener('click', (ev)=>{ ev.preventDefault(); forceLogout(); });
  sb.auth.onAuthStateChange((event) => {
    if (event === 'SIGNED_OUT') {
      const bust = `logged_out=${Date.now()}`;
      const sep  = LOGIN_URL.includes('?') ? '&' : '?';
      window.location.replace(`${LOGIN_URL}${sep}${bust}`);
    }
  });

  function nextMonthSameDayGT(d){
    const x = clampGT(d);
    const { y, m, d:dd } = getGTParts(x);
    const targetM = m + 1;
    let ny = y;
    let nm = targetM;
    if(nm === 13){ nm = 1; ny += 1; }

    let t = makeGTDate(ny, nm, dd, 0,0,0);
    while(getGTParts(t).m !== nm){
      const p = getGTParts(t);
      t = makeGTDate(p.y, p.m, p.d - 1, 0,0,0);
    }
    return clampGT(t);
  }

  function addMonthsSameDayGT(d, months){
    let x = clampGT(d);
    for(let i=0;i<Number(months||0);i++) x = nextMonthSameDayGT(x);
    return x;
  }

  function fridayOfSameWeekGT(d){
    const x = clampGT(d);
    const dow = getGTDow(x);
    const add = (5 - dow + 7) % 7;
    const p = getGTParts(x);
    const base = makeGTDate(p.y, p.m, p.d + add, 0,0,0);
    return clampGT(base);
  }

  function currentWindowGT(joinedAt, today){
    let start = clampGT(joinedAt);
    let end = nextMonthSameDayGT(start);
    const t = clampGT(today);
    while(end <= t){
      start = end;
      end = nextMonthSameDayGT(start);
    }
    return { start, end };
  }

  function fridaysInRangeGT(start,end){
    let f = fridayOfSameWeekGT(start);
    if(f < clampGT(start)){
      const fp = getGTParts(f);
      f = makeGTDate(fp.y, fp.m, fp.d + 7, 0,0,0);
      f = clampGT(f);
    }
    const list=[];
    while(f < clampGT(end)){
      list.push(clampGT(f));
      const fp = getGTParts(f);
      f = makeGTDate(fp.y, fp.m, fp.d + 7, 0,0,0);
      f = clampGT(f);
    }
    return list;
  }

  function cleanMoney(s){ return (s||'').toString().replace(/[,\s]/g,''); }
  function formatNumberString(val){
    val = cleanMoney(val);
    if(val === '') return '';
    const parts = val.split('.');
    parts[0] = parts[0].replace(/^0+(?=\d)/,'');
    const withCommas = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return parts.length > 1 ? withCommas + '.' + parts[1].slice(0, 2) : withCommas;
  }
  function bindMoneyInput(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.inputMode = 'decimal';
    el.autocomplete = 'off';
    el.addEventListener('input', ()=>{ el.value = formatNumberString(el.value); el.selectionStart = el.selectionEnd = el.value.length; });
    el.addEventListener('blur', ()=>{ el.value = formatNumberString(el.value); });
    el.addEventListener('focus', ()=> el.select());
  }

  function buildPeriodsGT(joinedAt, investMonths){
    const start0 = clampGT(joinedAt);
    const periods = [];
    let start = start0;
    for(let i=0;i<Number(investMonths||0);i++){
      const end = nextMonthSameDayGT(start);
      periods.push({ idx:i+1, start: clampGT(start), end: clampGT(end) });
      start = end;
    }
    return periods;
  }

  // ‚úÖ Si cierre cae s√°bado/domingo => "cierra" lunes
  function businessCloseDateGT(endDate){
    let d = clampGT(endDate);
    const dow = getGTDow(d);
    if(dow === 6){
      const p = getGTParts(d);
      d = makeGTDate(p.y, p.m, p.d + 2, 0,0,0);
    } else if(dow === 0){
      const p = getGTParts(d);
      d = makeGTDate(p.y, p.m, p.d + 1, 0,0,0);
    }
    return clampGT(d);
  }

  function normalizeTopups(list){
    return (list||[])
      .filter(t => t && (t.approved_at || t.paid_at || t.created_at) )
      .map(t => ({
        amount: Number(t.amount||0),
        at: clampGT(new Date(t.approved_at || t.paid_at || t.created_at))
      }))
      .filter(t => t.amount > 0);
  }

  function findPeriodIndexByDate(periods, dt){
    const d = clampGT(dt);
    for(const p of periods){
      const ps = clampGT(p.start);
      const pe = clampGT(p.end);
      if(d >= ps && d < pe) return p.idx;
    }
    return null;
  }

  function buildTopupBuckets(periods, topups){
    const buckets = {};
    for(const p of periods) buckets[p.idx] = 0;

    const norm = normalizeTopups(topups);
    for(const t of norm){
      const idx = findPeriodIndexByDate(periods, t.at);
      if(idx != null){
        buckets[idx] = (buckets[idx]||0) + t.amount;
      }
    }
    return buckets;
  }

  function deriveInitialCapital(acc, approvedTopups){
    const sumTopups = (approvedTopups||[]).reduce((s,t)=> s + Number(t.amount||0), 0);
    const ic = (acc && acc.initial_capital != null) ? Number(acc.initial_capital||0) : null;
    if(ic != null && !Number.isNaN(ic)) return ic;
    return Math.max(0, Number(acc?.capital||0) - sumTopups);
  }

  function capitalAtPeriodStart(periods, topupBuckets, initialCapital, periodIdx){
    let cap = Number(initialCapital||0);
    for(const p of periods){
      if(p.idx > periodIdx) break;
      cap += Number(topupBuckets[p.idx]||0);
    }
    return cap;
  }

  function monthLabelGT(start, end, idx){
    const s = fmtDateGT(start);
    const e = fmtDateGT(end);
    const n = String(idx).padStart(2,'0');
    return `Mes ${n} (${s} ‚Äî ${e})`;
  }

  function renderStatementTable({ acc, periods, approvedTopups }){
    const tbody = document.getElementById('stmtBody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const semRate = Number(acc.interest_pct||0)/100;
    const monthlyRate = semRate/6;
    const isCompound = !!acc.compound_interest;

    const initialCapital = deriveInitialCapital(acc, approvedTopups||[]);
    const buckets = buildTopupBuckets(periods, approvedTopups||[]);

    const today = clampGT(getGTNow());
    const visiblePeriods = periods.filter(p => clampGT(p.start) <= today);

    const stmtRange = document.getElementById('stmtRange');
    if(stmtRange && visiblePeriods.length){
      stmtRange.textContent = `${fmtDateGT(visiblePeriods[0].start)} ‚Äî ${fmtDateGT(visiblePeriods[visiblePeriods.length-1].end)}`;
    } else if(stmtRange){
      stmtRange.textContent = '‚Äî';
    }

    let accrued = 0;

    for(const p of visiblePeriods){
      const closeEffective = businessCloseDateGT(p.end);
      const ended = today >= closeEffective;

      const capStart = capitalAtPeriodStart(periods, buckets, initialCapital, p.idx);
      const interest = capStart * monthlyRate;

      let estado = 'En curso';
      if(isCompound){
        estado = ended ? 'Acumulado' : 'En curso';
      }else{
        estado = ended ? 'Pagado' : 'En curso';
      }

      let saldo = capStart;
      if(isCompound){
        if(ended) accrued += interest;
        saldo = capStart + accrued;
      }else{
        saldo = capStart;
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${monthLabelGT(p.start, p.end, p.idx)}</td>
        <td>${fmtQ(capStart)}</td>
        <td>${fmtQ(interest)}</td>
        <td><b>${estado}</b></td>
        <td>${fmtQ(saldo)}</td>
      `;
      tbody.appendChild(tr);
    }

    if(!visiblePeriods.length){
      tbody.innerHTML = `<tr><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td></tr>`;
    }

    const note = document.getElementById('stmtNote');
    if(note){
      note.innerHTML = isCompound
        ? `Modo: <b>Inter√©s acumulado</b>. El <b>Capital inicio</b> se actualiza desde el mes en que entra una recarga. El <b>Inter√©s (beneficio)</b> se calcula siempre sobre el <b>capital base</b> del mes (no sobre el saldo). El <b>Saldo</b> refleja capital + intereses acumulados al cierre (si el cierre cae s√°bado/domingo, cambia hasta el lunes).`
        : `Modo: <b>Pago mensual</b>. El <b>Capital inicio</b> se actualiza desde el mes en que entra una recarga. El <b>Inter√©s (beneficio)</b> se calcula sobre el capital del mes, pero el <b>Saldo</b> no se acumula (se mantiene como capital). Al concluir el mes, el estado se muestra como <b>Pagado</b> autom√°ticamente (si el cierre cae s√°bado/domingo, cambia a Pagado hasta el lunes).`;
    }
  }

  // ‚úÖ Viernes a las 9:00 AM (Guatemala)
  function fridayUnlockAt9AMGT(fridayDate){
    const f = clampGT(fridayDate);
    const p = getGTParts(f);
    return makeGTDate(p.y, p.m, p.d, 9, 0, 0);
  }

  function paintWeeks(acc, opts={}){
    const now = getGTNow();
    const today = clampGT(now);

    // ‚úÖ USAR FECHA EXACTA DEL ADMIN
    const joined = parseJoinedExactGT(acc?.joined_at);

    let todayForCalc = today;
    if (opts.freezeAtClose){
      const freeze = clampGT(opts.freezeAtClose);
      const fp = getGTParts(freeze);
      const prev = makeGTDate(fp.y, fp.m, fp.d - 1, 0,0,0);
      todayForCalc = clampGT(prev);
    }

    const {start,end} = currentWindowGT(joined, todayForCalc);
    $('#monthRange').textContent = `${fmtDateGT(start)} ‚Äî ${fmtDateGT(end)}`;
    $('#monthNote').textContent  = `Periodo de cierre fin de mes: ${fmtDateGT(end)}.`;

    const cap = Number(acc.capital||0);
    const semRate = Number(acc.interest_pct||0)/100;
    const monthly = cap*(semRate/6);

    const allFridays = fridaysInRangeGT(start,end);
    const weekly = allFridays.length ? (monthly/allFridays.length) : 0;

    const tbody = $('#weekBody'); tbody.innerHTML='';
    const cutoff = (todayForCalc < end ? todayForCalc : end);

    const shown = allFridays.filter(f => {
      if(f >= cutoff) return false;
      const unlock = fridayUnlockAt9AMGT(f);
      return now >= unlock;
    });

    if(shown.length===0){
      tbody.innerHTML = `<tr><td>‚Äî</td><td>‚Äî</td></tr>`;
      $('#weekSum').textContent = '‚Äî';
    }else{
      shown.forEach(f=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${fmtDateGT(f)}</td><td>${fmtQ(weekly)}</td>`;
        tbody.appendChild(tr);
      });
      const partial = weekly * shown.length;
      $('#weekSum').textContent = fmtQ(partial);
    }
  }

  function cleanMoneyStr(s){ return (s||'').toString().replace(/[,\s]/g,''); }

  // ‚úÖ UI
  function selectType(t){
    document.getElementById('optEarly')?.classList.toggle('selected',t==='early');
    document.getElementById('optHealth')?.classList.toggle('selected',t==='health');
    document.getElementById('optEarly')?.setAttribute('aria-pressed', String(t==='early'));
    document.getElementById('optHealth')?.setAttribute('aria-pressed', String(t==='health'));
  }
  function toggleSwitchAll(force){
    const sw=document.getElementById('switchAll');
    if(!sw) return;
    const on=(typeof force==='boolean')?force:!sw.classList.contains('on');
    sw.classList.toggle('on',on); sw.setAttribute('aria-checked',String(on));
    const wa = document.getElementById('wAmount');
    if(wa) wa.disabled = on;
  }

  /* ==========================================
     ‚úÖ HISTORIAL DE RETIROS (CORRECTO)
     - Usa withdrawal_requests como fuente
     - Si hay pago en withdrawals.request_id => estado PAID
  ========================================== */

  // ‚úÖ REEMPLAZO DEFINITIVO: PAID / APPROVED / REJECTED / PENDING
  function statusChipHTML(status){
    const raw = (status ?? '').toString().trim();
    const s = raw.toUpperCase();

    let cls = 'status-pending';
    let label = 'Pendiente';

    if (s === 'PAID' || s === 'PAGADO') {
      cls = 'status-approved';
      label = 'Pagado';
      return `<span class="status-chip ${cls}"><span class="status-dot"></span>${label}</span>`;
    }

    if (s === 'APPROVED' || s === 'APROBADO') {
      cls = 'status-approved';
      label = 'Aprobado';
      return `<span class="status-chip ${cls}"><span class="status-dot"></span>${label}</span>`;
    }

    if (s === 'REJECTED' || s === 'RECHAZADO' || s === 'CANCELLED' || s === 'CANCELED') {
      cls = 'status-rejected';
      label = 'Rechazado';
      return `<span class="status-chip ${cls}"><span class="status-dot"></span>${label}</span>`;
    }

    if (s === 'PENDING' || s === 'PENDIENTE') {
      cls = 'status-pending';
      label = 'Pendiente';
      return `<span class="status-chip ${cls}"><span class="status-dot"></span>${label}</span>`;
    }

    return `<span class="status-chip ${cls}"><span class="status-dot"></span>${raw || label}</span>`;
  }

  async function loadWithdrawalHistory(){
    const tbody = document.getElementById('wHistBody');
    const range = document.getElementById('wHistRange');
    const note  = document.getElementById('wHistNote');

    if(!tbody || !range || !note) return;

    tbody.innerHTML = `<tr><td colspan="5">Cargando‚Ä¶</td></tr>`;
    range.textContent = '‚Äî';
    note.textContent  = 'Cargando historial‚Ä¶';

    if(!CURRENT_ACCOUNT_ID){
      tbody.innerHTML = `<tr><td colspan="5">No se encontr√≥ la cuenta para cargar el historial.</td></tr>`;
      note.textContent = '‚Äî';
      return;
    }

    // 1) Requests
    const { data: reqs, error: reqErr } = await sb
      .from('withdrawal_requests')
      .select('id, created_at, amount, kind, status, penalty_pct, reason_text, reason, full_withdrawal, reviewed_at')
      .eq('account_id', CURRENT_ACCOUNT_ID)
      .order('created_at', { ascending:false })
      .limit(50);

    if(reqErr){
      console.warn('withdrawal_requests error:', reqErr?.message || reqErr);
      tbody.innerHTML = `<tr><td colspan="5">No se pudo cargar el historial (RLS/permisos).</td></tr>`;
      note.textContent = 'Revise RLS en withdrawal_requests para SELECT por account_id del usuario.';
      return;
    }

    const rows = reqs || [];
    if(rows.length === 0){
      tbody.innerHTML = `<tr><td colspan="5">No hay solicitudes registradas.</td></tr>`;
      note.textContent = 'Cuando env√≠e una solicitud, aparecer√° aqu√≠.';
      return;
    }

    // 2) Pagos ligados (withdrawals.request_id)
    const ids = rows.map(r => r.id);
    let payMap = new Map();
    if(ids.length){
      const { data: pays, error: payErr } = await sb
        .from('withdrawals')
        .select('id, request_id, created_at, reference, note')
        .in('request_id', ids);

      if(!payErr && Array.isArray(pays)){
        for(const p of pays){
          if(p?.request_id) payMap.set(p.request_id, p);
        }
      } else {
        // Si no hay permisos en withdrawals, igual funciona con status del request
        console.warn('withdrawals (pagos) no accesible o error:', payErr?.message || payErr);
      }
    }

    // rango
    const first = rows[rows.length-1]?.created_at;
    const last  = rows[0]?.created_at;
    range.textContent = (first && last) ? `${fmtDateGT(first)} ‚Äî ${fmtDateGT(last)}` : '‚Äî';

    tbody.innerHTML = '';
    rows.forEach(r=>{
      const created = r.created_at;
      const amount  = Number(r.amount || 0);
      const kind    = String(r.kind || '').toUpperCase();
      const full    = !!r.full_withdrawal;

      // Tipo
      let typeLabel = full ? 'Total' : 'Parcial';
      if(kind === 'HEALTH') typeLabel = 'Salud';
      if(kind === 'EARLY')  typeLabel = 'Antes de tiempo';

      // ‚úÖ Estado: si hay pago => PAID, si no => status del request
      const pay = payMap.get(r.id);
      const status = pay ? 'PAID' : String(r.status || 'PENDING').toUpperCase();

      // Detalle
      const detailParts = [];
      if(r.penalty_pct != null && !Number.isNaN(Number(r.penalty_pct)) && Number(r.penalty_pct) > 0){
        detailParts.push(`Penalizaci√≥n: ${Number(r.penalty_pct)}%`);
      }
      if(pay?.reference) detailParts.push(`Ref: ${pay.reference}`);
      const det = detailParts.join(' ¬∑ ') || '‚Äî';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${created ? fmtDateTimeGT(created) : '‚Äî'}</td>
        <td><b>${fmtQ(amount)}</b></td>
        <td>${typeLabel}</td>
        <td>${statusChipHTML(status)}</td>
        <td>${det}</td>
      `;
      tbody.appendChild(tr);
    });

    note.innerHTML = `Fuente: <b>withdrawal_requests</b>` + (payMap.size ? ` + pagos ligados` : ``) + `.`;
  }

  /** Crear solicitud (cliente):
   * Inserta SOLO en withdrawal_requests con columnas reales.
   */
  async function enviarSolicitudRetiro(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){
      const bust=`no_session=${Date.now()}`;
      const sep=LOGIN_URL.includes('?')?'&':'?';
      window.location.replace(`${LOGIN_URL}${sep}${bust}`);
      return;
    }

    const { data: acc, error: accErr } = await sb
      .from('accounts')
      .select('id, capital')
      .eq('user_id', session.user.id)
      .single();

    if(accErr || !acc){
      alert('No se pudo cargar su cuenta.');
      return;
    }

    const capital = Number(acc.capital||0);
    const all = document.getElementById('switchAll')?.classList.contains('on');

    const amount = all ? capital : Number(cleanMoneyStr(document.getElementById('wAmount')?.value) || 0);
    const reasonText = (document.getElementById('wReason')?.value || '').trim();

    const isHealth = document.getElementById('optHealth')?.classList.contains('selected');
    const kind = isHealth ? 'HEALTH' : 'EARLY';
    const penaltyPct = isHealth ? 0 : 10;

    if(!all){
      if(amount<=0){ alert('Ingrese un monto v√°lido.'); return; }
      if(amount>capital){ alert('El monto no puede ser mayor al capital disponible.'); return; }
      const restante = capital - amount;
      if(restante < 2000){ alert('Debe permanecer al menos Q 2,000 (a menos que retire todo).'); return; }
    }
    if(reasonText.length < 5){ alert('Describa brevemente el motivo.'); return; }

    const btn = document.getElementById('wSend');
    if(btn){ btn.disabled = true; btn.textContent = 'Enviando...'; }

    try{
      // ‚úÖ Insert REAL en withdrawal_requests
      const payload = {
        account_id: acc.id,
        kind: kind,                 // enum withdrawal_kind
        reason_text: reasonText,    // columna existe
        penalty_pct: penaltyPct,
        status: 'PENDING',          // enum request_status
        amount: amount,
        reason: reasonText,         // tu columna existe tambi√©n
        full_withdrawal: !!all
      };

      const { error: insErr } = await sb
        .from('withdrawal_requests')
        .insert([payload]);

      if(insErr){
        console.error(insErr);
        alert('No se pudo registrar la solicitud (RLS/permisos).\n' + (insErr.message||''));
        return;
      }

      // ‚úÖ Opcional: email (si tu Edge Function existe)
      try{
        const { error: fnErr } = await sb.functions.invoke('send-withdrawal-email', {
          body:{
            amount,
            reason: reasonText,
            full_withdrawal: !!all,
            account_id: acc.id,
            user_email: session.user.email,
            user_name: (document.getElementById('valName')?.textContent || ''),
            withdraw_type: (isHealth ? 'health' : 'early'),
            penalty_pct: penaltyPct
          }
        });
        if(fnErr) console.warn('send-withdrawal-email error:', fnErr);
      }catch(e){
        console.warn('send-withdrawal-email fail:', e);
      }

      showMessage('Solicitud enviada con √©xito. Un representante de <b>FX | CAPITAL R.L.</b> revisar√° su informaci√≥n.');

      // reset UI
      if(document.getElementById('wAmount')) document.getElementById('wAmount').value='';
      if(document.getElementById('wReason')) document.getElementById('wReason').value='';
      toggleSwitchAll(false);
      selectType('early');

      await loadWithdrawalHistory();
    } finally {
      if(btn){ btn.disabled = false; btn.textContent = 'Enviar solicitud'; }
    }
  }

  const msgDlg = document.getElementById('msgDlg');
  function showMessage(html){
    const mt = document.getElementById('msgText');
    if(mt) mt.innerHTML = html;
    if(msgDlg && !msgDlg.open) msgDlg.showModal();
  }

  const tdlg = document.getElementById('tdlg');

  function genRefCode(){ return `FXC-${Math.floor(100000 + Math.random()*900000)}`; }
  function extFromFile(file){
    const name = (file?.name || '').toLowerCase();
    const parts = name.split('.');
    return parts.length > 1 ? parts.pop() : 'bin';
  }
  function safeParseMoney(str){ return Number(cleanMoneyStr(str) || 0); }

  async function enviarTopupTransferencia(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ showMessage('Sesi√≥n no v√°lida. Inicie sesi√≥n nuevamente.'); return; }

    const amount = safeParseMoney(document.getElementById('tAmount')?.value);
    const bank   = (document.getElementById('tBank')?.value || '').trim();
    const notes  = (document.getElementById('tNotes')?.value || '').trim();
    const dtRaw  = (document.getElementById('tDate')?.value || '').trim();
    const fileEl = document.getElementById('tReceipt');
    const file   = fileEl?.files?.[0];

    if(amount <= 0){ alert('Ingrese un monto v√°lido.'); return; }
    if(!file){ alert('Debe adjuntar la boleta (JPG/PNG/PDF).'); return; }

    const MAX_MB = 6;
    if(file.size > MAX_MB * 1024 * 1024){
      alert(`La boleta excede ${MAX_MB}MB. Compr√≠mala o env√≠e una versi√≥n m√°s ligera.`);
      return;
    }

    const okType = (file.type || '').startsWith('image/') || file.type === 'application/pdf';
    if(!okType){ alert('Formato no permitido. Use JPG/PNG o PDF.'); return; }

    const btn = document.getElementById('tSend');
    if(btn){ btn.disabled = true; btn.textContent = 'Enviando...'; }

    const reference_code = genRefCode();
    const deposit_datetime = dtRaw ? new Date(dtRaw).toISOString() : null;

    try{
      const topupId = (crypto?.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}` );
      const ext = extFromFile(file);
      const receipt_path = `${session.user.id}/${topupId}/receipt.${ext}`;

      const up = await sb.storage.from('topup-receipts').upload(receipt_path, file, {
        cacheControl: '3600',
        upsert: false,
        contentType: file.type || undefined
      });
      if(up.error){
        console.error(up.error);
        alert('No se pudo subir la boleta. Intente de nuevo.');
        return;
      }

      const accessToken = session.access_token;

      const { error: fnErr } = await sb.functions.invoke('create-topup', {
        body: {
          amount,
          currency: 'GTQ',
          bank_name: bank || null,
          receipt_path,
          reference_code,
          note: notes || null,
          deposit_datetime
        },
        headers: {
          Authorization: `Bearer ${accessToken}`
        }
      });

      if(fnErr){
        let extra = '';
        try{
          if(fnErr.context){
            const t = await fnErr.context.text();
            extra = '\n\nDetalles:\n' + t;
          }
        }catch(e){}
        alert('No se pudo registrar el dep√≥sito (create-topup).\n' + (fnErr.message || '') + extra);
        return;
      }

      showMessage(
        `Dep√≥sito enviado con √©xito.<br><br>
         <b>C√≥digo:</b> ${reference_code}<br>
         Un administrador revisar√° su boleta y acreditar√° el capital.`
      );

      document.getElementById('txStep1')?.classList.remove('tx-step-active');
      document.getElementById('txStep2')?.classList.add('tx-step-active');

      tdlg?.close();
      if(document.getElementById('tAmount')) document.getElementById('tAmount').value = '';
      if(document.getElementById('tBank')) document.getElementById('tBank').value = '';
      if(document.getElementById('tNotes')) document.getElementById('tNotes').value = '';
      if(document.getElementById('tDate')) document.getElementById('tDate').value = '';
      if(fileEl) fileEl.value = '';
    } finally {
      if(btn){ btn.disabled = false; btn.textContent = 'Enviar dep√≥sito'; }
    }
  }

  let pwdDlg;
  function openPwdDialog(){
    if(!pwdDlg) pwdDlg = document.getElementById('pwdDlg');
    if(!pwdDlg) return;
    pwdDlg.addEventListener('cancel', (e)=> e.preventDefault());
    pwdDlg.showModal();
    const newEl = document.getElementById('pwdNew');
    const confEl = document.getElementById('pwdConfirm');
    const errEl = document.getElementById('pwdError');
    if(newEl) newEl.value = '';
    if(confEl) confEl.value = '';
    if(errEl) errEl.textContent = '';
  }

  async function handleSavePassword(){
    const newEl = document.getElementById('pwdNew');
    const confEl = document.getElementById('pwdConfirm');
    const errEl  = document.getElementById('pwdError');
    if(!newEl || !confEl || !errEl) return;

    const pwd  = (newEl.value || '').trim();
    const cpwd = (confEl.value || '').trim();

    errEl.textContent = '';

    if(pwd.length < 8){ errEl.textContent = 'La contrase√±a debe tener al menos 8 caracteres.'; return; }
    if(pwd !== cpwd){ errEl.textContent = 'Las contrase√±as no coinciden.'; return; }

    const btn = document.getElementById('pwdSave');
    if(btn){ btn.disabled = true; btn.textContent = 'Guardando...'; }

    try{
      const { error: updErr } = await sb.auth.updateUser({ password: pwd });
      if(updErr){
        errEl.textContent = 'No se pudo actualizar la contrase√±a. Int√©ntelo de nuevo.';
        console.error(updErr);
        return;
      }

      const { data:{ user } } = await sb.auth.getUser();
      if(user?.id){
        await sb.from('profiles')
          .update({ must_change_password:false, must_change_password_at: null })
          .eq('id', user.id);
      }

      if(pwdDlg && pwdDlg.open) pwdDlg.close();
      showMessage('Su contrase√±a se actualiz√≥ correctamente. Puede seguir utilizando su panel con normalidad.');
    }finally{
      if(btn){ btn.disabled = false; btn.textContent = 'Guardar contrase√±a'; }
    }
  }

  function togglePwdVisibility(inputId){
    const input = document.getElementById(inputId);
    if(!input) return;
    input.type = (input.type === 'password') ? 'text' : 'password';
  }

  function getSimPlanForCapital(cap){
    cap = Number(cap||0);
    if(cap >= 250000) return { plan:'PLATINUM', semPct:20 };
    if(cap >= 2000)   return { plan:'STANDARD', semPct:15 };
    return { plan:'‚Äî', semPct:0 };
  }
  function buildSimRows(cap, semPct){
    const monthlyRate = (Number(semPct||0)/100)/6;
    const rows = [];
    let sum = 0;
    for(let i=1;i<=6;i++){
      const interest = cap * monthlyRate;
      sum += interest;
      rows.push({ month:i, interest });
    }
    return { rows, sum, final: cap + sum };
  }
  function renderSim(cap, semPct){
    const { rows, sum, final } = buildSimRows(cap, semPct);

    const tbody = document.getElementById('simBody');
    if(tbody){
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.month}</td><td>${fmtQ(r.interest)}</td>`;
        tbody.appendChild(tr);
      });
    }
    const ss = document.getElementById('simSum');
    if(ss) ss.textContent = fmtQ(sum);
    const sf = document.getElementById('simFinal');
    if(sf) sf.textContent = fmtQ(final);
  }
  function handleCalc(){
    const raw = document.getElementById('simCapital')?.value || '';
    const cap = Number(cleanMoneyStr(raw) || 0);
    const note = document.getElementById('simNote');
    const sp = document.getElementById('simPlan');

    if(cap <= 0){
      if(sp) sp.textContent = '‚Äî';
      if(note) note.textContent = 'Ingrese un capital v√°lido.';
      renderSim(0, 0);
      return;
    }

    const { plan, semPct } = getSimPlanForCapital(cap);

    if(cap < 2000){
      if(sp) sp.textContent = '‚Äî';
      if(note) note.textContent = 'El m√≠nimo para simular es Q 2,000.00.';
      renderSim(cap, 0);
      return;
    }

    if(sp) sp.textContent = `${plan} ‚Äî ${semPct}% semestral`;
    if(note) note.textContent = 'C√°lculo estimado (inter√©s simple).';
    renderSim(cap, semPct);
  }

  async function loadHeader(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){
      const bust = `no_session=${Date.now()}`;
      const sep  = LOGIN_URL.includes('?') ? '&' : '?';
      window.location.replace(`${LOGIN_URL}${sep}${bust}`);
      return;
    }
    const uid = session.user.id;

    const [profRes, accRes] = await Promise.all([
      sb.from('profiles').select('full_name,email,must_change_password').eq('id',uid).single(),
      sb.from('accounts')
        .select('id,plan,currency,capital,invest_months,interest_pct,joined_at,compound_interest,initial_capital')
        .eq('user_id',uid)
        .order('joined_at', { ascending:true })
    ]);

    const prof = profRes?.data || null;
    const accounts = Array.isArray(accRes?.data) ? accRes.data : [];

    CURRENT_USER_NAME  = (prof?.full_name || prof?.email || session.user.email || '‚Äî');
    CURRENT_USER_EMAIL = (prof?.email || session.user.email || '');

    const vn = document.getElementById('valName');
    if(vn) vn.textContent = CURRENT_USER_NAME;

    // Guardamos lista
    CURRENT_ACCOUNTS = accounts;

    const picker = document.getElementById('accountPicker');
    const setEmpty = ()=>{
      if(picker) {
        picker.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'Sin cuenta asignada';
        picker.appendChild(opt);
        picker.disabled = true;
      }
    };

    if(!accounts.length){
      setEmpty();
      ['valAccountId','valPlan','valCurrency','valMonths','valOpenDate','valCloseDate'].forEach(id=>{
        const el=document.getElementById(id); if(el) el.textContent='‚Äî';
      });
      const vc=document.getElementById('valCapital'); if(vc) vc.textContent=fmtQ(0);
      const vpi=document.getElementById('valPeriodInterest'); if(vpi) vpi.textContent=fmtQ(0);

      const sp = document.getElementById('simPlan'); if(sp) sp.textContent = '‚Äî';
      renderSim(0,0);

      if(prof?.must_change_password){ openPwdDialog(); }
      return;
    }

    // Construir opciones (Cuenta N.1, N.2‚Ä¶)
    if(picker){
      picker.disabled = false;
      picker.innerHTML = '';
      accounts.forEach((a, i)=>{
        const opt = document.createElement('option');
        opt.value = a.id;
        const plan = (a.plan || '‚Äî');
        const cur  = (a.currency || 'GTQ');
        const cap  = (typeof a.capital === 'number' || typeof a.capital === 'string') ? fmtMoney(a.capital, cur) : '';
        opt.textContent = `Cuenta N.${i+1} ‚Äî ${plan}${cap ? ' ‚Äî ' + cap : ''}`;
        picker.appendChild(opt);
      });
    }

    // Selecci√≥n persistente
    let preferred = null;
    try{ preferred = localStorage.getItem('fxc_account_id'); }catch{ preferred = null; }
    let selected = accounts.find(a=>a.id === preferred) || accounts[0];

    // Si por alguna raz√≥n qued√≥ inv√°lido, usamos la primera.
    if(!selected) selected = accounts[0];

    if(picker) picker.value = selected.id;

    // Cambiar de cuenta (actualiza todo sin recargar)
    if(picker && !picker.dataset.bound){
      picker.dataset.bound = '1';
      picker.addEventListener('change', async ()=>{
        const id = picker.value;
        const a = accounts.find(x=>x.id === id);
        if(!a) return;
        await refreshForAccount(a);
      });
    }

    async function refreshForAccount(acc){
      // Mostrar ID y campos b√°sicos inmediatamente (sensaci√≥n premium)
      const idEl = document.getElementById('valAccountId');
      if(idEl) idEl.textContent = acc?.id ? `ID: ${String(acc.id).slice(0,8)}‚Ä¶` : '‚Äî';

      const pl = document.getElementById('valPlan'); if(pl) pl.textContent = acc?.plan || '‚Äî';
      const cu = document.getElementById('valCurrency'); if(cu) cu.textContent = acc?.currency || '‚Äî';
      const mo = document.getElementById('valMonths'); if(mo) mo.textContent = (acc?.invest_months ?? '‚Äî');

      // Reusa la l√≥gica existente (topups, c√°lculos, fechas, etc.)
      CURRENT_ACCOUNT_ID = acc.id;
    try{ localStorage.setItem('fxc_account_id', CURRENT_ACCOUNT_ID); }catch{}

    const { data: approvedTopups } = await sb
      .from('topups')
      .select('amount, approved_at, paid_at, created_at, status, account_id')
      .eq('account_id', acc.id)
      .eq('status', 'paid');

    // ‚úÖ FECHA EXACTA DEL ADMIN
    const joinedExact = parseJoinedExactGT(acc.joined_at);

    // ‚úÖ Periodos exactos
    const periods = buildPeriodsGT(joinedExact, acc.invest_months);

    renderStatementTable({ acc, periods, approvedTopups: approvedTopups||[] });

    const map = {
      valAccountId: acc.id||'‚Äî',
      valPlan: acc.plan||'‚Äî',
      valCurrency: acc.currency||'‚Äî',
      valMonths: acc.invest_months ?? '‚Äî'
    };
    for (const k in map){
      const el=document.getElementById(k);
      if(el) el.textContent=map[k];
    }

    const vc=document.getElementById('valCapital'); if(vc) vc.textContent=fmtQ(acc.capital||0);

    const close  = addMonthsSameDayGT(joinedExact, acc.invest_months||0);

    const vo=document.getElementById('valOpenDate'); if(vo) vo.textContent  = fmtDateGT(joinedExact);
    const vc2=document.getElementById('valCloseDate'); if(vc2) vc2.textContent = fmtDateGT(close);

    const semPct=(acc.interest_pct||0)/100;
    const total= (acc.capital||0) * semPct * ((acc.invest_months||0)/6);
    const vpi=document.getElementById('valPeriodInterest'); if(vpi) vpi.textContent = fmtQ(total);

    // ‚úÖ Viernes 9AM Guatemala + joined exacto
    paintWeeks(acc, {});

    if(prof?.must_change_password){ openPwdDialog(); }
  }

  let CURRENT_VIEW = 'panel';

  function setNavMode(mode){
    const toggleWrap = document.getElementById('navPanelToggleWrap');
    const btnDep   = document.getElementById('btnNavDeposit');
    const btnW     = document.getElementById('btnNavWithdraw');
    const btnBack  = document.getElementById('btnBackPanel');

    const showMainNav = (mode === 'panel');
    if(toggleWrap) toggleWrap.style.display = showMainNav ? 'inline-flex' : 'none';
    if(btnDep)     btnDep.style.display     = showMainNav ? 'inline-flex' : 'none';
    if(btnW)       btnW.style.display       = showMainNav ? 'inline-flex' : 'none';
    if(btnBack)    btnBack.style.display    = showMainNav ? 'none' : 'inline-flex';
  }

  function setActiveNav(which){
    const toggleWrap = document.getElementById('navPanelToggleWrap');
    const b2=document.getElementById('btnNavDeposit');
    const b3=document.getElementById('btnNavWithdraw');

    toggleWrap?.classList.toggle('active', which==='panel');
    b2?.classList.toggle('active', which==='deposit');
    b3?.classList.toggle('active', which==='withdraw');
  }

  function resetDepositSteps(){
    document.getElementById('txStep1')?.classList.add('tx-step-active');
    document.getElementById('txStep2')?.classList.remove('tx-step-active');
    }

    await refreshForAccount(selected);

    if(prof?.must_change_password){ openPwdDialog(); }
  }


  async function showView(which){
    const panel = document.getElementById('viewPanel');
    const dep   = document.getElementById('viewDeposit');
    const wit   = document.getElementById('viewWithdraw');

    CURRENT_VIEW = which;

    if(which === 'deposit'){
      if(panel) panel.style.display = 'none';
      if(dep)   dep.style.display   = 'block';
      if(wit)   wit.style.display   = 'none';
      if (typeof setNavMode === 'function') setNavMode('sub');
      setActiveNav('deposit');
      resetDepositSteps();
      window.location.hash = '#depositar';
      return;
    }

    if(which === 'withdraw'){
      if(panel) panel.style.display = 'none';
      if(dep)   dep.style.display   = 'none';
      if(wit)   wit.style.display   = 'block';
      if (typeof setNavMode === 'function') setNavMode('sub');
      setActiveNav('withdraw');
      window.location.hash = '#retirar';
      selectType('early');
      toggleSwitchAll(false);

      // ‚úÖ cargar historial al entrar
      await loadWithdrawalHistory();
      return;
    }

    if(panel) panel.style.display = 'block';
    if(dep)   dep.style.display   = 'none';
    if(wit)   wit.style.display   = 'none';
    if (typeof setNavMode === 'function') setNavMode('panel');
    setActiveNav('panel');
    if(window.location.hash === '#depositar' || window.location.hash === '#retirar'){
      history.replaceState(null,'', window.location.pathname);
    }
  }

  let PANEL_EXTRAS_OPEN = false;

  function setPanelExtras(open){
    const extras = document.getElementById('panelExtras');
    const sw = document.getElementById('switchPanelExtras');
    const accSec = document.getElementById('accountSection');

    PANEL_EXTRAS_OPEN = !!open;

    if(extras) extras.classList.toggle('hidden', !PANEL_EXTRAS_OPEN);

    if(accSec){
      accSec.classList.toggle('space-after', !PANEL_EXTRAS_OPEN);
      accSec.classList.toggle('tight-after',  PANEL_EXTRAS_OPEN);
    }

    if(sw){
      sw.classList.toggle('on', PANEL_EXTRAS_OPEN);
      sw.setAttribute('aria-checked', String(PANEL_EXTRAS_OPEN));
    }
  }

  function togglePanelExtras(){ setPanelExtras(!PANEL_EXTRAS_OPEN); }

  document.getElementById('switchPanelExtras')?.addEventListener('click', ()=>{
    if(CURRENT_VIEW !== 'panel'){ showView('panel'); }
    togglePanelExtras();
  });
  document.getElementById('switchPanelExtras')?.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault();
      if(CURRENT_VIEW !== 'panel'){ showView('panel'); }
      togglePanelExtras();
    }
  });

  document.getElementById('btnNavDeposit')?.addEventListener('click', ()=> showView('deposit'));
  document.getElementById('btnNavWithdraw')?.addEventListener('click', ()=> showView('withdraw'));
  document.getElementById('btnBackPanel')?.addEventListener('click', ()=> { showView('panel'); setPanelExtras(false); });

  document.getElementById('optEarly')?.addEventListener('click', ()=> selectType('early'));
  document.getElementById('optHealth')?.addEventListener('click', ()=> selectType('health'));
  document.getElementById('switchAll')?.addEventListener('click', ()=> toggleSwitchAll());
  document.getElementById('switchAll')?.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); toggleSwitchAll(); }
  });
  document.getElementById('wSend')?.addEventListener('click', enviarSolicitudRetiro);
  document.getElementById('wCancel')?.addEventListener('click', ()=> { showView('panel'); setPanelExtras(false); });

  document.getElementById('btnRefreshWithdrawals')?.addEventListener('click', loadWithdrawalHistory);

  document.getElementById('msgClose')?.addEventListener('click', ()=> msgDlg?.close());
  document.getElementById('msgOk')?.addEventListener('click', ()=> msgDlg?.close());

  document.getElementById('btnOpenTopup')?.addEventListener('click', ()=>{
    document.getElementById('txStep1')?.classList.remove('tx-step-active');
    document.getElementById('txStep2')?.classList.add('tx-step-active');
    tdlg?.showModal();
  });
  document.getElementById('tClose')?.addEventListener('click', ()=> tdlg?.close());
  document.getElementById('tCancel')?.addEventListener('click', ()=> tdlg?.close());
  document.getElementById('tSend')?.addEventListener('click', enviarTopupTransferencia);

  document.getElementById('btnCopyAcct')?.addEventListener('click', async ()=>{
    const txt = document.getElementById('acctNumber')?.textContent?.trim() || '';
    if(!txt) return;
    try{
      await navigator.clipboard.writeText(txt);
      showMessage('N√∫mero de cuenta copiado al portapapeles.');
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      showMessage('N√∫mero de cuenta copiado al portapapeles.');
    }
  });

  document.getElementById('pwdNewEye')?.addEventListener('click', ()=> togglePwdVisibility('pwdNew'));
  document.getElementById('pwdConfirmEye')?.addEventListener('click', ()=> togglePwdVisibility('pwdConfirm'));
  document.getElementById('pwdSave')?.addEventListener('click', handleSavePassword);

  document.getElementById('btnCalc')?.addEventListener('click', handleCalc);

  bindMoneyInput('wAmount');
  bindMoneyInput('simCapital');
  bindMoneyInput('tAmount');

  (async function init(){
    const h = (window.location.hash||'').toLowerCase();
    if(h === '#depositar') await showView('deposit');
    else if(h === '#retirar') await showView('withdraw');
    else await showView('panel');

    setPanelExtras(false);

    await loadHeader();

    const sp = document.getElementById('simPlan');
    if(sp) sp.textContent = '‚Äî';
    renderSim(0, 0);
    const note = document.getElementById('simNote');
    if(note) note.textContent = 'Ingrese un capital y presione Calcular.';
  })();
  </script>
</body>
</html>
