<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FX | CAPITAL R.L. — Panel del Cliente</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg0:#000; --bg1:#0b0c0e; --bg2:#111317; --bg3:#14171c;
    --line:#1f232a; --muted:#a8b0bc; --txt:#f7f9fc;
    --grad-app: radial-gradient(1200px 800px at 10% -20%, #12151a 0%, #0b0c0e 45%, #060708 100%);
    --grad-panel: linear-gradient(180deg, #0f1114 0%, #0b0d10 100%);
    --grad-card: linear-gradient(180deg, #14171c 0%, #0f1216 100%);
    --shadow-1: 0 10px 25px rgba(0,0,0,.45);
    --shadow-2: 0 18px 40px rgba(0,0,0,.55);
    --shadow-inset: inset 0 1px 0 rgba(255,255,255,.04), inset 0 -1px 0 rgba(0,0,0,.6);
    --radius:18px; --gloss: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0) 35%);
    --chip:#15181d; --danger:#ff4d4f;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;color:var(--txt);background:var(--grad-app) fixed, var(--bg0);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1100px;margin:40px auto;padding:0 22px}

  header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px}
  .brand-wrap{display:flex;flex-direction:column;gap:6px}
  .brand-row{display:flex;align-items:center;gap:18px}
  .brand-logo{
    width:112px;height:112px;border-radius:16px;object-fit:contain;
    background:#fff; padding:8px; border:1px solid var(--line);
    box-shadow: var(--shadow-2), var(--shadow-inset);
  }
  .brand-title{margin:0;font-weight:900;letter-spacing:.4px;font-size:clamp(32px,6vw,72px);line-height:1}
  .brand-sub{margin:0;font-weight:700;color:#cfd6e2;font-size:clamp(16px,2.2vw,28px);opacity:.9}

  .btn{appearance:none;border:0;border-radius:999px;padding:12px 18px;font-weight:700;cursor:pointer;color:#0b0c0e;background:#fff;box-shadow:inset 0 1px 0 rgba(255,255,255,.6),0 8px 18px rgba(0,0,0,.45)}
  .btn.secondary{color:var(--txt);background:var(--gloss),linear-gradient(180deg,#1a1d23,#0f1216);border:1px solid var(--line);box-shadow:var(--shadow-1),var(--shadow-inset)}
  .btn.danger{color:#fff;background:linear-gradient(180deg,#bb3335,#941f21);border:1px solid #651b1d;box-shadow:0 10px 22px rgba(149,33,36,.45), inset 0 1px 0 rgba(255,255,255,.05)}

  .panel{background:var(--grad-panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 0 0 1px rgba(255,255,255,.04),0 30px 80px rgba(0,0,0,.55),var(--shadow-inset)}
  .card{background:var(--grad-card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow-1),var(--shadow-inset)}
  .section{padding:24px}

  .grid{display:grid;gap:16px}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:920px){.grid.cols-3{grid-template-columns:1fr 1fr}}
  @media (max-width:680px){.grid.cols-3{grid-template-columns:1fr} header{align-items:flex-start;gap:16px}}

  .group{padding:18px 20px;position:relative;overflow:hidden}
  .group::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.04),transparent 40%);pointer-events:none}
  .k{display:inline-block;font-size:13px;color:var(--muted);background:#0f1216;border:1px solid var(--line);padding:6px 10px;border-radius:999px;margin-bottom:8px}
  .v{display:block;font-size:16px;font-weight:700;letter-spacing:.2px}

  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{padding:14px 16px;border-bottom:1px solid var(--line)}
  .table th{color:var(--muted);font-weight:700;text-align:left;background:linear-gradient(180deg,#101318,#0c0f13);position:sticky;top:0;z-index:1}

  .note{color:var(--muted);font-size:13px;margin-top:10px}

  dialog{border:0;border-radius:22px;background:var(--gloss),linear-gradient(180deg,#14161b,#0f1116);color:var(--txt);width:min(840px,92vw);box-shadow:0 24px 64px rgba(0,0,0,.65),var(--shadow-inset)}
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .modal-h{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--line)}
  .modal-b{padding:18px 22px}

  .pill{border:1px solid var(--line);border-radius:16px;padding:12px 14px;cursor:pointer;background:linear-gradient(180deg,#121419,#0f1116);box-shadow:var(--shadow-inset)}
  .pill.selected{border-color:#3a3f48;box-shadow:0 0 0 2px rgba(255,255,255,.08) inset,var(--shadow-inset)}

  .input,textarea{width:100%;border:1px solid var(--line);background:#0f1116;color:#f5f7fb;border-radius:12px;padding:12px 14px}
  .row{display:grid;gap:14px;grid-template-columns:1fr 1fr}
  @media (max-width:720px){.row{grid-template-columns:1fr}}

  .switch{--w:58px;--h:32px;--knob:26px;inline-size:var(--w);block-size:var(--h);background:linear-gradient(180deg,#1b1f26,#0f1216);border-radius:999px;border:1px solid var(--line);position:relative}
  .switch::after{content:"";position:absolute;inline-size:var(--knob);block-size:var(--knob);border-radius:50%;background:linear-gradient(180deg,#fff,#d9d9d9);top:50%;left:3px;translate:0 -50%}
  .switch.on::after{left:calc(var(--w) - var(--knob) - 3px)}
  .blocker{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px);display:none}
  .blocker.on{display:block}

  .pwd-field{position:relative}
  .pwd-field .input{padding-right:56px}
  .eye-btn{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    width:48px; height:48px; border-radius:14px;
    border:1px solid var(--line);
    background:linear-gradient(180deg,#121419,#0f1116);
    color:#fff; display:grid; place-items:center; cursor:pointer;
    box-shadow:var(--shadow-inset);
  }
  .eye-btn svg{width:28px;height:28px}
  .input.invalid{border-color:var(--danger)!important}
  .err{color:var(--danger); font-size:12px; margin-top:6px}
</style>
</head>
<body>
  <div class="wrap" id="appWrap">
    <header>
      <div class="brand-wrap">
        <div class="brand-row">
          <img
            src="/logo.png?v=6"
            alt="FX Capital"
            class="brand-logo"
            loading="eager"
            onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/enrike22/fxcapital-apps/main/cliente/logo.png?raw=1';"
          />
          <h1 class="brand-title">FX | CAPITAL R.L.</h1>
        </div>
        <h2 class="brand-sub">— Panel del Cliente</h2>
      </div>
      <button class="btn" id="btnSignOut">Cerrar sesión</button>
    </header>

    <!-- MI CUENTA -->
    <section class="panel section">
      <h2 style="margin:0 0 14px 0">Mi cuenta</h2>
      <div class="grid cols-3">
        <div class="card group"><span class="k">Nombre</span><span id="valName" class="v">—</span></div>
        <div class="card group"><span class="k">Apertura de cuenta</span><span id="valOpenDate" class="v">—</span></div>
        <div class="card group"><span class="k">Plan</span><span id="valPlan" class="v">—</span></div>

        <div class="card group"><span class="k">Moneda</span><span id="valCurrency" class="v">—</span></div>
        <div class="card group"><span class="k">Cuenta (ID)</span><span id="valAccountId" class="v">—</span></div>
        <div class="card group"><span class="k">Período (meses)</span><span id="valMonths" class="v">—</span></div>

        <div class="card group"><span class="k">Capital</span><span id="valCapital" class="v">Q 0.00</span></div>
        <div class="card group"><span class="k">Finalización de apertura de cuenta</span><span id="valCloseDate" class="v">—</span></div>
        <div class="card group"><span class="k">Interés total del período</span><span id="valPeriodInterest" class="v">Q 0.00</span></div>
      </div>
      <div style="margin-top:16px">
        <button class="btn secondary" id="btnOpenWithdraw">Solicitar retiro</button>
      </div>
    </section>

    <!-- RESULTADOS DEL MES -->
    <section class="panel section" style="margin-top:18px">
      <h2 style="margin:0 0 10px 0">Resultados del mes</h2>
      <div class="muted" id="monthRange">—</div>
      <div style="overflow:auto;margin-top:8px">
        <table class="table">
          <thead><tr><th>Viernes</th><th>Interés semanal</th></tr></thead>
          <tbody id="weekBody"><tr><td>—</td><td>—</td></tr></tbody>
          <tfoot><tr class="sum-row"><td>Acumulado del mes</td><td id="weekSum">—</td></tr></tfoot>
        </table>
      </div>
      <div id="monthNote" class="note">Periodo de cierre fin de mes: —</div>
    </section>

    <!-- SIMULADOR -->
    <section class="panel section" style="margin-top:18px">
      <h2 style="margin:0 0 4px 0">Simulador de crecimiento</h2>
      <div class="muted" style="margin-bottom:14px">Interés simple por <b>6 meses</b>, según el plan asignado automáticamente por monto.</div>
      <div class="grid cols-3">
        <div class="group card"><span class="k">Capital a simular (Q)</span>
          <input id="simCapital" class="input" type="text" inputmode="decimal" placeholder="Ej. 40,000" />
        </div>
        <div class="group card"><span class="k">Plan asignado (auto)</span><div id="simPlan" class="v">—</div></div>
        <div class="group card"><span class="k">Capital final estimado</span><div id="simFinal" class="v">Q 0.00</div></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
        <button class="btn" id="btnCalc">Calcular</button>
        <span id="simNote" class="note"></span>
      </div>
      <div style="overflow:auto;margin-top:12px">
        <table class="table" id="simTable">
          <thead><tr><th>Mes</th><th>Interés del mes</th></tr></thead>
          <tbody id="simBody"><tr><td>1</td><td>Q 0.00</td></tr></tbody>
          <tfoot><tr class="sum-row"><td>Interés total acumulado</td><td id="simSum">Q 0.00</td></tr></tfoot>
        </table>
      </div>
    </section>
  </div>

  <div class="blocker" id="panelBlocker"></div>

  <!-- MODAL RETIRO -->
  <dialog id="wdlg">
    <div class="modal-h">
      <div style="font-weight:800">Solicitud de retiro</div>
      <button class="btn secondary" style="padding:8px 12px" id="xClose">✕</button>
    </div>
    <div class="modal-b">
      <div class="row">
        <div class="pill" id="optEarly" tabindex="0" role="button" aria-pressed="true">
          <div style="font-weight:700;margin-bottom:6px">Antes de tiempo</div>
          <div class="muted">Aplicará una penalización del 10%.</div>
        </div>
        <div class="pill" id="optHealth" tabindex="0" role="button" aria-pressed="false">
          <div style="font-weight:700;margin-bottom:6px">Causas de salud</div>
          <div class="muted">Exento de penalización.</div>
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <div>
          <div class="k">Monto a retirar (Q)</div>
          <input id="wAmount" class="input" type="text" inputmode="decimal" placeholder="Ej. 5,000">
          <div class="note">Si el retiro es parcial, debe permanecer al menos <b>Q 2,000</b>.</div>
        </div>
        <div>
          <div class="k">Motivo</div>
          <textarea id="wReason" placeholder="Explique brevemente el motivo…"></textarea>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px;margin:16px 0">
        <div id="switchAll" class="switch" role="switch" aria-checked="false" tabindex="0" title="Retirar todo mi capital"></div>
        <div>Retirar todo mi capital</div>
      </div>

      <div class="actions">
        <button class="btn secondary" id="wCancel">Cancelar</button>
        <button class="btn" id="wSend">Enviar solicitud</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL CAMBIO DE CONTRASEÑA FORZADO -->
  <dialog id="forcePwdDlg">
    <div class="modal-h"><div style="font-weight:800">BIENVENIDO A FX|CAPITAL R.L.</div></div>
    <div class="modal-b">
      <p class="muted" style="margin-top:0">Por motivos de seguridad, le solicitamos actualizar su contraseña actual.</p>

      <div class="row">
        <div>
          <div class="k">Nueva contraseña</div>
          <div class="pwd-field">
            <input id="newPwd" class="input" type="password" minlength="8" placeholder="Mínimo 8 caracteres" aria-describedby="errNew">
            <button type="button" id="eyeNew" class="eye-btn" aria-pressed="false" aria-label="Mostrar u ocultar contraseña"></button>
          </div>
          <div id="errNew" class="err" role="alert" aria-live="polite" style="display:none"></div>
        </div>
        <div>
          <div class="k">Confirmar contraseña</div>
          <div class="pwd-field">
            <input id="newPwd2" class="input" type="password" minlength="8" placeholder="Repite la contraseña" aria-describedby="errNew2">
            <button type="button" id="eyeNew2" class="eye-btn" aria-pressed="false" aria-label="Mostrar u ocultar confirmación"></button>
          </div>
          <div id="errNew2" class="err" role="alert" aria-live="polite" style="display:none"></div>
        </div>
      </div>

      <div class="actions" style="margin-top:28px">
        <button class="btn danger" id="logoutNow">Salir sin cambiar</button>
        <button class="btn" id="savePwd">Guardar y continuar</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL FIN DE PERÍODO DE CUENTA (SIEMPRE QUE HAYA FINALIZADO) -->
  <dialog id="endPeriodDlg" aria-labelledby="endTitle" aria-describedby="endDesc">
    <div class="modal-h">
      <div id="endTitle" style="font-weight:800">Aviso importante</div>
    </div>
    <div class="modal-b">
      <p id="endDesc" class="muted" style="margin-top:0;font-size:15px;line-height:1.6">
        Su período de cuenta ha finalizado. Para más información o para renovar la cuenta, por favor visite o póngase en contacto con una de nuestras oficinas.
        <br><br>
        Cordialmente,<br><b>FX | CAPITAL R.L.</b>
      </p>
      <div class="actions" style="margin-top:18px">
        <button class="btn" id="ackEnd">Aceptar</button>
      </div>
    </div>
  </dialog>

  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  const BASE_URL = 'https://clientes.fxcapital-gt.com/';
  const SUPABASE_URL = 'https://czvpehbubfrinutztnwh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true} });
  const $ = s=>document.querySelector(s);
  const fmtQ = n => { try{ return new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ'}).format(n||0) }catch(e){ return `Q ${(Number(n)||0).toFixed(2)}` } };
  const clampDate = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };

  function nextMonthSameDay(d){ const x=clampDate(d); const t=new Date(x.getFullYear(), x.getMonth()+1, x.getDate()); while(t.getMonth() !== (x.getMonth()+1)%12){ t.setDate(t.getDate()-1);} t.setHours(0,0,0,0); return t; }
  function fridayOfSameWeek(d){ const x=clampDate(d); const add=(5-x.getDay()+7)%7; const f=new Date(x); f.setDate(x.getDate()+add); f.setHours(0,0,0,0); return f; }
  function currentWindow(joinedAt, today){ let start=clampDate(joinedAt), end=nextMonthSameDay(start); while(end <= today){ start=end; end=nextMonthSameDay(start); } return {start,end}; }
  function fridaysInRange(start,end){ let f=fridayOfSameWeek(start); if(f<start) f.setDate(f.getDate()+7); const list=[]; while(f<end){ list.push(new Date(f)); f.setDate(f.getDate()+7); } return list; }

  function cleanMoney(s){ return (s||'').toString().replace(/[,\s]/g,''); }
  function formatNumberString(val){
    val = cleanMoney(val);
    if(val === '') return '';
    const parts = val.split('.');
    parts[0] = parts[0].replace(/^0+(?=\d)/,'');
    const withCommas = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return parts.length > 1 ? withCommas + '.' + parts[1].slice(0, 2) : withCommas;
  }
  function bindMoneyInput(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.inputMode = 'decimal';
    el.autocomplete = 'off';
    el.addEventListener('input', ()=>{
      el.value = formatNumberString(el.value);
      el.selectionStart = el.selectionEnd = el.value.length;
    });
    el.addEventListener('blur', ()=>{ el.value = formatNumberString(el.value); });
    el.addEventListener('focus', ()=> el.select());
  }

  // Congelar en la fecha de cierre: usar el día anterior al cierre para mostrar el último estado "antes del fin"
  function paintWeeks(acc, opts={}){
    const today=clampDate(new Date());
    const joined=acc?.joined_at? clampDate(new Date(acc.joined_at)) : today;

    // Si hay freezeAtClose => tomar el día anterior al cierre como "hoy" lógico
    let todayForCalc = today;
    if (opts.freezeAtClose){
      const freeze = clampDate(opts.freezeAtClose);
      const prev = new Date(freeze); prev.setDate(prev.getDate()-1); // día previo al cierre
      todayForCalc = prev;
    }

    const {start,end}=currentWindow(joined,todayForCalc);
    $('#monthRange').textContent = `${start.toLocaleDateString('es-GT')} — ${end.toLocaleDateString('es-GT')}`;
    $('#monthNote').textContent  = `Periodo de cierre fin de mes: ${end.toLocaleDateString('es-GT')}.`;

    const cap=Number(acc.capital||0), semRate=Number(acc.interest_pct||0)/100, monthly=cap*(semRate/6);
    const allFridays=fridaysInRange(start,end), weekly=allFridays.length? (monthly/allFridays.length) : 0;

    const tbody=$('#weekBody'); tbody.innerHTML='';
    const cutoff = todayForCalc < end ? todayForCalc : end;
    const shown = allFridays.filter(f => f < cutoff);

    if(shown.length===0){
      tbody.innerHTML = `<tr><td>—</td><td>—</td></tr>`;
      $('#weekSum').textContent = '—';
    }else{
      shown.forEach(f=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${f.toLocaleDateString('es-GT')}</td><td>${fmtQ(weekly)}</td>`;
        tbody.appendChild(tr);
      });
      // Acumulado parcial hasta la última fecha mostrada (último monto actualizado antes del fin)
      const partial = weekly * shown.length;
      $('#weekSum').textContent = fmtQ(partial);
    }
  }

  async function loadHeader(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ window.location.href = BASE_URL; return; }
    const uid=session.user.id;

    const [{ data: prof }, { data: acc }] = await Promise.all([
      sb.from('profiles').select('full_name,email,must_change_password').eq('id',uid).single(),
      sb.from('accounts').select('id,plan,currency,capital,invest_months,interest_pct,joined_at').eq('user_id',uid).single()
    ]);

    if (prof?.must_change_password === true) __fxpwd_enforce();

    $('#valName').textContent = (prof?.full_name || prof?.email || session.user.email || '—');
    if(!acc){
      ['valAccountId','valPlan','valCurrency','valMonths','valOpenDate','valCloseDate'].forEach(id=>$('#'+id).textContent='—');
      $('#valCapital').textContent=fmtQ(0); $('#valPeriodInterest').textContent=fmtQ(0);
      return;
    }

    $('#valAccountId').textContent = acc.id||'—';
    $('#valPlan').textContent = acc.plan||'—';
    $('#valCurrency').textContent = acc.currency||'—';
    $('#valMonths').textContent = acc.invest_months ?? '—';
    $('#valCapital').textContent = fmtQ(acc.capital||0);

    const joined = acc.joined_at ? new Date(acc.joined_at) : new Date();
    const close  = new Date(joined.getFullYear(), joined.getMonth() + (acc.invest_months||0), joined.getDate());
    const closeClamped = clampDate(close);

    $('#valOpenDate').textContent  = joined.toLocaleDateString('es-GT');
    $('#valCloseDate').textContent = close.toLocaleDateString('es-GT');

    const semPct=(acc.interest_pct||0)/100;
    const total= (acc.capital||0) * semPct * ((acc.invest_months||0)/6);
    $('#valPeriodInterest').textContent = fmtQ(total);

    const accountEnded = clampDate(new Date()) >= closeClamped;

    // Pintar semanas congelando al día previo al cierre si ya finalizó
    paintWeeks(acc, { freezeAtClose: accountEnded ? closeClamped : null });

    // Mostrar SIEMPRE el modal si la cuenta ya finalizó (en cada login/carga)
    if(accountEnded){
      const endDlg = document.getElementById('endPeriodDlg');
      if(endDlg && !endDlg.open) endDlg.showModal();
      document.getElementById('ackEnd')?.addEventListener('click', ()=> endDlg.close(), { once:true });
    }
  }

  // ===== Retiros =====
  const dlg = document.getElementById('wdlg');
  let withdrawType='early';
  function selectType(t){
    withdrawType=t;
    document.getElementById('optEarly').classList.toggle('selected',t==='early');
    document.getElementById('optHealth').classList.toggle('selected',t==='health');
  }
  function toggleSwitchAll(force){
    const sw=document.getElementById('switchAll');
    const on=(typeof force==='boolean')?force:!sw.classList.contains('on');
    sw.classList.toggle('on',on); sw.setAttribute('aria-checked',String(on));
    document.getElementById('wAmount').disabled=on;
  }

  async function enviarSolicitudRetiro(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ window.location.href = BASE_URL; return; }

    const { data: acc, error: accErr } = await sb.from('accounts').select('capital,id').eq('user_id',session.user.id).single();
    if(accErr){ alert('No se pudo cargar su cuenta.'); return; }

    const capital=Number(acc?.capital||0);
    const all=document.getElementById('switchAll').classList.contains('on');
    const amount=all? capital : Number(cleanMoney(document.getElementById('wAmount').value) || 0);
    const reason=(document.getElementById('wReason').value||'').trim();

    if(!all){
      if(amount<=0){ alert('Ingrese un monto válido.'); return; }
      if(amount>capital){ alert('El monto no puede ser mayor al capital disponible.'); return; }
      const restante=capital-amount; if(restante<2000){ alert('Debe permanecer al menos Q 2,000 (a menos que retire todo).'); return; }
    }
    if(reason.length<5){ alert('Describa brevemente el motivo.'); return; }

    const { error } = await sb.functions.invoke('send-withdrawal-email', {
      body:{ amount, reason, full_withdrawal:all, account_id:acc?.id||null, user_email:session.user.email, user_name: $('#valName')?.textContent || '' }
    });

    if(error){ alert('No se pudo enviar la solicitud.\n' + (error.message||JSON.stringify(error))); return; }

    alert('Solicitud enviada. Te escribiremos pronto.');
    dlg.close();
    document.getElementById('wAmount').value=''; document.getElementById('wReason').value='';
    toggleSwitchAll(false);
  }

  // ===== Cambio de contraseña forzado =====
  const __fxpwd_forceDlg = document.getElementById('forcePwdDlg');
  const __fxpwd_blocker  = document.getElementById('panelBlocker');

  function __fxpwd_lockPanel(lock){
    if(!__fxpwd_blocker) return;
    __fxpwd_blocker.classList.toggle('on', !!lock);
    document.querySelectorAll('button,input,textarea,select').forEach(el=>{
      if(__fxpwd_forceDlg && el.closest('#forcePwdDlg')) return;
      el.disabled = !!lock;
    });
  }
  function __fxpwd_enforce(){
    __fxpwd_lockPanel(true);
    if(__fxpwd_forceDlg && !__fxpwd_forceDlg.open) __fxpwd_forceDlg.showModal();
  }

  const __eyeSVG = `
<svg viewBox="0 0 24 24" fill="none">
  <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" stroke="currentColor" stroke-width="1.8"/>
  <circle cx="12" cy="12" r="3.5" stroke="currentColor" stroke-width="1.8"/>
</svg>`;
  const __eyeOffSVG = `
<svg viewBox="0 0 24 24" fill="none">
  <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.8"/>
  <path d="M1 12s4-7 11-7c2.7 0 5 .9 6.9 2.1M23 12s-4 7-11 7c-2.7 0-5-.9-6.9-2.1" stroke="currentColor" stroke-width="1.8"/>
  <path d="M9.9 9.9a3.5 3.5 0 004.2 4.2" stroke="currentColor" stroke-width="1.8"/>
</svg>`;
  function __bindPwdEye(inputId, btnId){
    const inp = document.getElementById(inputId);
    const btn = document.getElementById(btnId);
    if(!inp || !btn) return;
    btn.innerHTML = __eyeSVG;
    btn.addEventListener('click', ()=>{
      const show = inp.type === 'password';
      inp.type = show ? 'text' : 'password';
      btn.setAttribute('aria-pressed', String(show));
      btn.innerHTML = show ? __eyeOffSVG : __eyeSVG;
    });
  }

  function __fxpwd_setError(inputEl, errEl, msg){
    if(!inputEl || !errEl) return;
    if(msg){
      inputEl.classList.add('invalid');
      errEl.textContent = msg;
      errEl.style.display = 'block';
    }else{
      inputEl.classList.remove('invalid');
      errEl.textContent = '';
      errEl.style.display = 'none';
    }
  }
  function __fxpwd_validate(){
    const p1 = (document.getElementById('newPwd')?.value || '').trim();
    const p2 = (document.getElementById('newPwd2')?.value || '').trim();
    const in1 = document.getElementById('newPwd');
    const in2 = document.getElementById('newPwd2');
    const e1  = document.getElementById('errNew');
    const e2  = document.getElementById('errNew2');

    let ok = true;
    if(p1.length < 8){ __fxpwd_setError(in1,e1,'La contraseña debe tener al menos 8 caracteres.'); ok = false; } else { __fxpwd_setError(in1,e1,''); }
    if(p2.length === 0){ __fxpwd_setError(in2,e2,'Confirme su contraseña.'); ok = false; }
    else if(p1 !== p2){ __fxpwd_setError(in2,e2,'Las contraseñas no coinciden.'); ok = false; } else { __fxpwd_setError(in2,e2,''); }
    return ok;
  }

  async function __fxpwd_save(){
    if(!__fxpwd_validate()) return;

    const p1 = (document.getElementById('newPwd')?.value || '').trim();
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ window.location.href = BASE_URL; return; }

    const up = await sb.auth.updateUser({ password:p1 });
    if(up.error){ alert('No se pudo actualizar la contraseña: '+up.error.message); return; }

    const upd = await sb.from('profiles').update({ must_change_password:false }).eq('id',session.user.id);
    if(upd.error){ console.warn('No se pudo actualizar must_change_password:', upd.error.message); }

    __fxpwd_forceDlg?.close();
    __fxpwd_lockPanel(false);
    alert('¡Contraseña actualizada! Bienvenido al panel.');
  }

  async function __fxpwd_logout(){
    await sb.auth.signOut();
    window.location.href = BASE_URL;
  }

  function autoPlanAndRate(capital){
    if(capital >= 2000 && capital < 250000) return { name:'STANDARD (15% semestral)', rate:0.15 };
    if(capital >= 250000)                     return { name:'PLATINUM (20% semestral)', rate:0.20 };
    return { name:'NO ELEGIBLE', rate:0 };
  }
  function simulate(){
    const cap = Number(cleanMoney(document.getElementById('simCapital').value) || 0);
    if(cap < 2000){
      alert('El capital mínimo para simular es Q 2,000.');
      return;
    }
    const {name, rate} = autoPlanAndRate(cap);
    document.getElementById('simPlan').textContent = name;

    const months = 6;
    const monthlyInterest = cap * (rate/6);
    const total = monthlyInterest * months;

    document.getElementById('simFinal').textContent = fmtQ(cap + total);
    document.getElementById('simSum').textContent   = fmtQ(total);
    document.getElementById('simNote').textContent  = `Plan: ${name}. Tasa semestral ${(rate*100).toFixed(0)}%. Tasa mensual ${(rate/6*100).toFixed(2)}%.`;

    const body = document.getElementById('simBody');
    body.innerHTML = '';
    for(let m=1;m<=months;m++){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${m}</td><td>${fmtQ(monthlyInterest)}</td>`;
      body.appendChild(tr);
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('btnSignOut').addEventListener('click', async ()=>{ await sb.auth.signOut(); window.location.href = BASE_URL; });

    document.getElementById('btnOpenWithdraw').addEventListener('click', ()=> dlg.showModal());
    document.getElementById('xClose').addEventListener('click', ()=> dlg.close());
    document.getElementById('wCancel')?.addEventListener('click', ()=> dlg.close());
    document.getElementById('wSend').addEventListener('click', enviarSolicitudRetiro);
    document.getElementById('switchAll').addEventListener('click', ()=>toggleSwitchAll());
    document.getElementById('optEarly').addEventListener('click', ()=>selectType('early'));
    document.getElementById('optHealth').addEventListener('click', ()=>selectType('health'));
    selectType('early'); toggleSwitchAll(false);

    __bindPwdEye('newPwd','eyeNew');
    __bindPwdEye('newPwd2','eyeNew2');
    ['newPwd','newPwd2'].forEach(id=>{
      document.getElementById(id)?.addEventListener('input', __fxpwd_validate);
      document.getElementById(id)?.addEventListener('blur', __fxpwd_validate);
    });
    document.getElementById('savePwd')?.addEventListener('click', __fxpwd_save);
    document.getElementById('logoutNow')?.addEventListener('click', __fxpwd_logout);

    bindMoneyInput('wAmount');
    bindMoneyInput('simCapital');

    document.getElementById('btnCalc').addEventListener('click', simulate);

    loadHeader();
  });
  </script>
</body>
</html>
