<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. ‚Äî Panel Cliente</title>
<style>
:root{--bg:#000;--fg:#fff;--muted:#bfc6d1;--card:#0e0f11;--border:#21262c}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
.container{max-width:1100px;margin:0 auto;padding:24px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card{background:linear-gradient(180deg,#121316,#0c0d0f);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px;box-shadow:0 12px 36px #0007}
h1,h2{margin:0 0 10px}
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;margin-right:8px;color:var(--muted);font-size:12px}
.grid-3{display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
.kpi{background:#0b0c0e;border:1px solid var(--border);border-radius:14px;padding:14px}
.kpi small{color:var(--muted);display:block;margin-bottom:6px}
.kpi strong{font-size:18px}

/* tables */
table{width:100%;border-collapse:collapse}
th,td{padding:12px;border-bottom:1px solid var(--border)}
th{text-align:left;color:var(--muted);font-weight:600}
button{background:#fff;color:#000;border:none;padding:12px 16px;border-radius:999px;font-weight:800;cursor:pointer}
small{color:var(--muted)}
.hidden{display:none !important}

/* Withdrawal modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:20px;z-index:10000}
.modal-card{width:100%;max-width:820px;background:linear-gradient(180deg,#151619,#101113);border:1px solid #272c33;border-radius:18px;padding:22px;box-shadow:0 15px 40px #000a;position:relative}
.modal-title{font-size:22px;margin:0 0 12px}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.selector{display:flex;gap:12px}
.sel{flex:1;border:1px solid #2b313a;border-radius:14px;padding:14px 12px;background:#0e1013}
.sel.active{border-color:#3d85ff;background:#0f141c}
.input-wrap{position:relative}
.input-wrap .prefix{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.6}
.input-wrap input{width:100%;background:#000;color:#fff;border:1px solid #2a2f36;border-radius:12px;padding:10px 42px 10px 42px;height:46px}
textarea{width:100%;min-height:120px;background:#000;border:1px solid #2a2f36;border-radius:12px;padding:12px;color:#fff}
.modal-actions{display:flex;gap:10px;justify-content:flex-start;margin-top:12px}
.switch{display:inline-flex;align-items:center;gap:10px;margin-top:2px}
.switch input{appearance:none;width:38px;height:22px;border-radius:999px;background:#242a32;position:relative;outline:none;cursor:pointer;border:1px solid #2a2f36}
.switch input:checked{background:#2e7d32}
.switch input::after{content:"";position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .2s}
.switch input:checked::after{transform:translateX(16px)}

/* Password modal */
.modal-card-sm{max-width:720px}
.input-wrap .eye-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);width:46px;height:46px;background:transparent;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center}
.eye,.eye-off{width:28px;height:28px;fill:#fff;opacity:.95}

/* Toast */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#101b10;border:1px solid #214c21;color:#c6f3c6;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px #000a;z-index:11000}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>FX | CAPITAL R.L. ‚Äî Panel Cliente</h1>
    <button id="logoutBtn" type="button">Cerrar sesi√≥n</button>
  </div>

  <div class="card">
    <h2>Mi cuenta</h2>
    <small>Resumen de su portafolio y configuraci√≥n actual.</small>
    <div class="grid-3" style="margin-top:10px">
      <div><span class="badge">Nombre</span><div id="c_name">‚Äî</div></div>
      <div><span class="badge">Plan</span><div id="c_plan">‚Äî</div></div>
      <div><span class="badge">Moneda</span><div id="c_currency">‚Äî</div></div>
      <div><span class="badge">Capital</span><div id="c_capital">‚Äî</div></div>
      <div><span class="badge">Cuenta (ID)</span><div id="c_account">‚Äî</div></div>
      <div><span class="badge">Per√≠odo (meses)</span><div id="c_period">‚Äî</div></div>
      <div><span class="badge">Inter√©s total del per√≠odo</span><div id="c_interest_total">‚Äî</div></div>
    </div>
    <div style="margin-top:14px"><button id="btnWithdraw" type="button">Solicitar retiro</button></div>
  </div>

  <div class="card">
    <h2>Resultados del mes</h2>
    <small id="monthLabel">‚Äî</small>
    <table style="margin-top:10px">
      <thead><tr><th>Viernes</th><th>Inter√©s semanal</th></tr></thead>
      <tbody id="weeks"></tbody>
      <tfoot><tr><th>Total mes</th><th id="monthTotal">‚Äî</th></tr></tfoot>
    </table>
  </div>

  <div class="card">
    <h2>Simulador de crecimiento</h2>
    <small>Proyecci√≥n con capitalizaci√≥n <b>no compuesta</b> (inter√©s simple) seg√∫n el plan asignado autom√°ticamente por monto.</small>

    <div class="grid-3" style="margin-top:12px">
      <div>
        <span class="badge">Capital a simular (Q)</span>
        <div class="input-wrap">
          <span class="prefix">Q</span>
          <input id="sim_capital" type="number" min="0" step="0.01" value="40000" style="padding-left:38px">
        </div>
      </div>
      <div>
        <span class="badge">Meses</span>
        <select id="sim_months">
          <option>6</option><option selected>12</option><option>18</option><option>24</option>
          <option>30</option><option>36</option><option>42</option><option>48</option>
          <option>54</option><option>60</option>
        </select>
      </div>
      <div>
        <span class="badge">Plan asignado (auto)</span>
        <input id="sim_plan" type="text" disabled value="‚Äî">
      </div>
    </div>

    <div style="margin-top:12px"><button id="simBtn" type="button">Calcular</button></div>

    <!-- KPIs -->
    <div class="grid-3" style="margin-top:12px">
      <div class="kpi"><small>Capital inicial</small><strong id="kpi_capital">‚Äî</strong></div>
      <div class="kpi"><small>Inter√©s total acumulado</small><strong id="kpi_interest">‚Äî</strong></div>
      <div class="kpi"><small>Capital final estimado</small><strong id="kpi_final">‚Äî</strong></div>
    </div>

    <h3 style="margin:14px 0 6px">Inter√©s generado por cada mes</h3>
    <table>
      <thead><tr><th>Mes</th><th>Inter√©s del mes</th></tr></thead>
      <tbody id="sim_rows"></tbody>
      <tfoot><tr><th>Total inter√©s</th><th id="sim_total">‚Äî</th></tr></tfoot>
    </table>
    <small id="sim_note" style="display:block;margin-top:8px;color:#98a2af"></small>
  </div>
</div>

<!-- Withdrawal Modal -->
<div id="wdModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="wdTitle">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 id="wdTitle" class="modal-title">Solicitud de retiro</h3>
      <button id="wdClose" style="width:36px;height:36px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff;cursor:pointer">‚úï</button>
    </div>

    <div class="modal-grid">
      <div>
        <small>Seleccione el tipo de retiro</small>
        <div class="selector" style="margin-top:8px">
          <button class="sel active" id="optEarly" type="button">
            <div style="font-weight:700;margin-bottom:4px">Antes de tiempo</div>
            <div class="small">Aplicar√° una penalizaci√≥n del 10%.</div>
          </button>
          <button class="sel" id="optHealth" type="button">
            <div style="font-weight:700;margin-bottom:4px">Causas de salud</div>
            <div class="small">Exento de penalizaci√≥n.</div>
          </button>
        </div>

        <label class="switch" style="margin-top:14px">
          <input id="wdAll" type="checkbox">
          <span>Retirar todo mi capital</span>
        </label>
      </div>

      <div>
        <small>Monto a retirar (Q)</small>
        <div class="input-wrap" style="margin-top:8px">
          <span class="prefix">Q</span>
          <input id="wdAmount" type="number" min="0" step="0.01" placeholder="Ej. 5,000" style="padding-left:38px">
        </div>
        <div class="small" style="margin-top:6px">Si el retiro es parcial, debe permanecer al menos Q 2,000.</div>

        <small style="display:block;margin-top:12px">Motivo</small>
        <textarea id="wdReason" placeholder="Explique brevemente el motivo‚Ä¶"></textarea>
      </div>
    </div>

    <div class="modal-actions">
      <button id="wdSubmit" type="button">Enviar solicitud</button>
      <button id="wdCancel" type="button" style="background:#14161a;color:#e6e8ec;border:1px solid #2a2f36">Cancelar</button>
    </div>
  </div>
</div>

<!-- Password (first login) Modal -->
<div id="pwdModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="pwdTitle">
  <div class="modal-card modal-card-sm">
    <h3 id="pwdTitle" class="modal-title">Bienvenido a FX | CAPITAL R.L.</h3>
    <p class="small" style="margin:-4px 0 12px">Por seguridad, actualice su contrase√±a.</p>

    <label>Correo electr√≥nico</label>
    <div class="input-wrap">
      <span class="prefix">‚úâÔ∏è</span>
      <input id="pwdEmail" type="email" placeholder="tu@email.com" autocomplete="email" style="padding-left:38px">
    </div>

    <label style="margin-top:10px">Contrase√±a actual</label>
    <div class="input-wrap">
      <span class="prefix">üîí</span>
      <input id="curPwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" style="padding-left:38px">
      <button type="button" class="eye-btn" data-toggle="curPwd" aria-label="mostrar/ocultar">
        <svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>
    </div>

    <label style="margin-top:10px">Nueva contrase√±a</label>
    <div class="input-wrap">
      <span class="prefix">üÜï</span>
      <input id="newPwd" type="password" placeholder="M√≠nimo 8 caracteres" autocomplete="new-password" style="padding-left:38px">
      <button type="button" class="eye-btn" data-toggle="newPwd" aria-label="mostrar/ocultar">
        <svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>
    </div>

    <label style="margin-top:10px">Confirmar nueva contrase√±a</label>
    <div class="input-wrap">
      <span class="prefix">‚úÖ</span>
      <input id="confPwd" type="password" placeholder="Repetir nueva contrase√±a" autocomplete="new-password" style="padding-left:38px">
      <button type="button" class="eye-btn" data-toggle="confPwd" aria-label="mostrar/ocultar">
        <svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>
    </div>

    <label class="switch" style="margin-top:8px">
      <input id="showAllPwds" type="checkbox"><span>Mostrar contrase√±as</span>
    </label>

    <div id="pwdMsg" class="small" style="color:#ffb3b3;min-height:20px;margin-top:6px"></div>
    <div id="pwdOk" class="small" style="color:#b3ffcb;min-height:20px"></div>

    <div class="modal-actions">
      <button id="pwdSubmit" class="primary" type="button">Actualizar contrase√±a</button>
      <button id="pwdCancel" type="button" style="background:#14161a;color:#e6e8ec;border:1px solid #2a2f36">Cancelar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden">Listo.</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/*** CONFIG ***/
const PROJECT_URL="https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE=PROJECT_URL+"/rest/v1";
const supa = supabase.createClient(PROJECT_URL, ANON_KEY);
function hdr(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||"")}}
function hdrJSON(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||""),"Content-Type":"application/json"}}
const GTZ='America/Guatemala';
function $(id){return document.getElementById(id)}
function logout(){localStorage.clear();location.href='cliente-login.html'}
$("logoutBtn").onclick=logout;
function money(n,cur){return new Intl.NumberFormat('es-GT',{style:'currency',currency:cur==='USD'?'USD':'GTQ'}).format(n||0)}
function guateNow(){return new Date(new Date().toLocaleString('en-US',{timeZone:GTZ}))}
function toast(msg){const t=$("toast"); t.textContent=msg||'Listo.'; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2000);}
function fmtDate(d){return d.toLocaleDateString('es-GT',{timeZone:GTZ,day:'numeric',month:'long',year:'numeric'})}

/*** STATE ***/
let PROFILE=null,ACCOUNT=null;
let WD_KIND='EARLY';

/*** EYES toggle ***/
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('.eye-btn'); if(!btn) return;
  const id=btn.getAttribute('data-toggle'); const el=$(id); if(!el) return;
  el.type = (el.type==='password') ? 'text' : 'password';
  btn.innerHTML = (el.type==='password')
    ? '<svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>'
    : '<svg class="eye-off" viewBox="0 0 24 24"><path d="M2 5l2-2 17 17-2 2-3.6-3.6C13.7 19 12.9 19 12 19 5 19 2 12 2 12a17 17 0 0 1 5.2-6.3L2 5zm7.3 2.9A5 5 0 0 0 7 12a5 5 0 0 0 5 5c.6 0 1.1-.1 1.6-.3L9.3 7.9zM12 5c7 0 10 7 10 7a16.8 16.8 0 0 1-3.2 4.7l-1.5-1.5A14.6 14.6 0 0 0 20 12s-3-7-8-7c-1 0-2 .2-2.9 .5L7.7 4.1C9 3.7 10.4 3.5 12 3.5z"/></svg>';
});
$("showAllPwds").addEventListener('change',(e)=>{
  ['curPwd','newPwd','confPwd'].forEach(id=>{ const el=$(id); el.type=e.target.checked?'text':'password'; });
});

/*** BOOT ***/
(async function boot(){
  if(!localStorage.token){ logout(); return; }
  const rUser=await fetch(`${PROJECT_URL}/auth/v1/user`,{headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`}})
  if(!rUser.ok){ logout(); return; }

  const rp=await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}&select=id,full_name,require_password_change,first_login_completed`,{headers:hdr()});
  PROFILE=(await rp.json())[0]||null;

  const ra=await fetch(`${BASE}/accounts?user_id=eq.${localStorage.uid}&select=id,currency,principal_locked,plan,joined_at,invest_months,interest_pct`,{headers:hdr()});
  ACCOUNT=(await ra.json())[0]||null;

  $("c_name").textContent=PROFILE?.full_name||"‚Äî";
  $("c_plan").textContent=ACCOUNT?.plan||"‚Äî";
  $("c_currency").textContent=ACCOUNT?.currency||"‚Äî";
  $("c_capital").textContent=money(ACCOUNT?.principal_locked,ACCOUNT?.currency);
  $("c_account").textContent=ACCOUNT?.id||"‚Äî";
  $("c_period").textContent=ACCOUNT?.invest_months ?? 6;

  // Inter√©s total del per√≠odo configurado (inter√©s simple)
  const months = ACCOUNT?.invest_months || 6;
  const semRate = (ACCOUNT?.interest_pct!=null) ? (ACCOUNT.interest_pct/100)
                  : (ACCOUNT?.plan==='PLATINUM'?0.20:(ACCOUNT?.plan==='BLACK'?0.25:0.15));
  const monthlyRate = semRate/6;
  const totalInterest = (ACCOUNT?.principal_locked||0) * monthlyRate * months;
  $("c_interest_total").textContent = money(totalInterest, ACCOUNT?.currency);

  buildMonthResults();      // semanas del rango rolling (joined_at ‚Üí +1 mes)
  setupWithdraw();
  setupSimulator();

  const firstLoginNotDone = PROFILE?.first_login_completed !== true;
  if (firstLoginNotDone) openPwdModal(true);

  $("btnWithdraw").onclick=()=>openWdModal();
})();

/*** Rango rolling de 1 mes desde la fecha de ingreso ***/
function buildMonthResults(){
  if(!ACCOUNT) return;
  const start = ACCOUNT.joined_at ? new Date(new Date(ACCOUNT.joined_at).toLocaleString('en-US',{timeZone:GTZ})) : guateNow();
  const end = new Date(start); end.setMonth(end.getMonth()+1);
  $("monthLabel").textContent = `${fmtDate(start)} ‚Äî ${fmtDate(end)}`;

  const fridays = [];
  const d = new Date(start);
  while(d.getDay()!==5){ d.setDate(d.getDate()+1); }
  while(d < end){ fridays.push(new Date(d)); d.setDate(d.getDate()+7); }

  const PLAN_RATES={STANDARD:0.15/6,PLATINUM:0.20/6,BLACK:0.25/6};
  const weeklyRate=(ACCOUNT?.interest_pct!=null)? (ACCOUNT.interest_pct/6/100) : (PLAN_RATES[ACCOUNT?.plan]||0.15/6);
  const totalThisMonth=(ACCOUNT?.principal_locked||0)*weeklyRate*fridays.length;
  const parts=randomParts(totalThisMonth, fridays.length);

  const tb=$("weeks"); tb.innerHTML='';
  fridays.forEach((f,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${f.toLocaleDateString('es-GT',{timeZone:GTZ})}</td><td>${money(parts[i],ACCOUNT.currency)}</td>`; tb.appendChild(tr); });
  $("monthTotal").textContent=money(parts.reduce((a,b)=>a+b,0), ACCOUNT.currency);
}
function randomParts(total,n){if(n<=0)return[];const xs=Array.from({length:n},()=>Math.random()+0.5);const s=xs.reduce((a,b)=>a+b,0);return xs.map(v=> total*(v/s));}

/*** Withdrawal modal ***/
function openWdModal(){ $("wdModal").classList.remove('hidden'); }
function closeWdModal(){ $("wdModal").classList.add('hidden'); }
function setupWithdraw(){
  $("optEarly").onclick=()=>{WD_KIND='EARLY';$("optEarly").classList.add('active');$("optHealth").classList.remove('active');}
  $("optHealth").onclick=()=>{WD_KIND='HEALTH';$("optHealth").classList.add('active');$("optEarly").classList.remove('active');}
  $("wdClose").onclick=closeWdModal; $("wdCancel").onclick=closeWdModal;
  $("wdAll").addEventListener('change',(e)=>{$("wdAmount").disabled=e.target.checked; if(e.target.checked){$("wdAmount").value='';}});
  $("wdSubmit").onclick=submitWithdrawal;
}
async function submitWithdrawal(){
  const all = $("wdAll").checked;
  const amt = all ? (ACCOUNT?.principal_locked||0) : Number($("wdAmount").value||0);
  if(!all){
    const remaining=(ACCOUNT?.principal_locked||0)-amt;
    if(remaining<2000){ alert("Si el retiro es parcial, el capital restante debe ser al menos Q 2,000."); return; }
  }
  const penalty = WD_KIND==='EARLY' ? 10 : 0;
  const payload = {
    kind: WD_KIND==='EARLY'?'EARLY_WITHDRAWAL':'HEALTH_WITHDRAWAL',
    account_id: ACCOUNT?.id,
    withdrawal_id: crypto.randomUUID(),
    penalty_pct: penalty,
    amount: amt,
    reason: $("wdReason").value||null
  };
  try{
    await fetch(`${BASE}/withdrawal_requests`,{method:'POST',headers:hdrJSON(),body:JSON.stringify({ id: payload.withdrawal_id, account_id: ACCOUNT.id, kind: payload.kind, amount: amt, penalty_pct: penalty, reason: payload.reason, status:'PENDING'})});
    await fetch(`${BASE}/admin_notifications`,{method:'POST',headers:hdrJSON(),body:JSON.stringify({ kind:'WITHDRAWAL_REQUEST', payload })});
    closeWdModal();
    alert('Hemos recibido su solicitud; ser√° atendida en un lapso no mayor a 24 horas h√°biles, de lunes a viernes, dentro del horario laboral establecido.');
  }catch(e){ alert('No se pudo enviar la solicitud.'); }
}

/*** Simulador ‚Äî inter√©s simple ***/
function setupSimulator(){ $("simBtn").onclick=runSim; runSim(); }
function assignedPlanByCapital(cap){
  if(cap<2000) return {name:'NO ELEGIBLE', sem:0, eligible:false};
  if(cap>=250000) return {name:'PLATINUM', sem:20, eligible:true};
  return {name:'STANDARD', sem:15, eligible:true};
}
function runSim(){
  const cap = Number($("sim_capital").value||0);
  const months = parseInt($("sim_months").value,10);
  const plan = assignedPlanByCapital(cap);
  $("sim_plan").value = plan.eligible ? `${plan.name} (${plan.sem}% semestral)` : 'NO ELEGIBLE';

  // Inter√©s simple: tasa mensual = sem/6; el inter√©s de cada mes es constante (capital * tasa_mensual).
  const monthlyRate = plan.eligible ? (plan.sem/6)/100 : 0;
  const interestMonthly = cap * monthlyRate;         // constante
  const totalInterest = interestMonthly * months;    // suma lineal
  const finalCapital  = cap + totalInterest;

  // KPIs
  $("kpi_capital").textContent  = money(cap,'GTQ');
  $("kpi_interest").textContent = money(totalInterest,'GTQ');
  $("kpi_final").textContent    = money(finalCapital,'GTQ');

  // Tabla mensual
  const tb=$("sim_rows"); tb.innerHTML="";
  for(let m=1;m<=months;m++){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${m}</td><td>${money(interestMonthly,'GTQ')}</td>`;
    tb.appendChild(tr);
  }
  $("sim_total").textContent = money(totalInterest,'GTQ');
  $("sim_note").textContent = plan.eligible
    ? `Plan: ${plan.name}. Tasa semestral ${plan.sem}%. Tasa mensual ${(plan.sem/6).toFixed(2)}%.`
    : `Monto no elegible (m√≠nimo Q2,000).`;
}

/*** Password modal ***/
function openPwdModal(force){
  $("pwdEmail").value = localStorage.email || '';
  ["curPwd","newPwd","confPwd"].forEach(id=>$(id).value="");
  $("pwdMsg").textContent=''; $("pwdOk").textContent='';
  $("pwdModal").classList.remove('hidden');
  $("pwdCancel").style.display = force ? 'none' : 'inline-block';
}
function closePwdModal(){ $("pwdModal").classList.add('hidden'); }
$("pwdCancel").onclick=closePwdModal;
$("pwdSubmit").onclick = async function submitPasswordChange(){
  const email=($("pwdEmail").value||'').trim();
  const cur=$("curPwd").value, neo=$("newPwd").value, rep=$("confPwd").value;
  const err=$("pwdMsg"), ok=$("pwdOk"); err.textContent=''; ok.textContent='';
  if(!email||!cur||!neo||!rep){ err.textContent='Complete todos los campos.'; return; }
  if(neo.length<8){ err.textContent='La nueva contrase√±a debe tener al menos 8 caracteres.'; return; }
  if(neo!==rep){ err.textContent='La confirmaci√≥n no coincide.'; return; }

  const btn=$("pwdSubmit"); btn.disabled=true; const txt=btn.textContent; btn.textContent='Actualizando‚Ä¶';

  const { error: signInErr } = await supa.auth.signInWithPassword({ email, password: cur });
  if (signInErr) { err.textContent='Correo o contrase√±a actual incorrectos.'; btn.disabled=false; btn.textContent=txt; return; }

  const { error: updErr } = await supa.auth.updateUser({ password: neo });
  if (updErr) { err.textContent = updErr.message || 'No se pudo actualizar la contrase√±a.'; btn.disabled=false; btn.textContent=txt; return; }

  const { data: signInNew, error: signInNewErr } = await supa.auth.signInWithPassword({ email, password: neo });
  if (!signInNewErr && signInNew?.session?.access_token) {
    localStorage.token = signInNew.session.access_token;
    localStorage.uid   = signInNew.user.id;
    localStorage.email = email;
  }

  try{
    await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}`,{
      method:'PATCH',headers:hdrJSON(),
      body:JSON.stringify({ first_login_completed:true, require_password_change:false, last_password_changed_at:new Date().toISOString() })
    });
  }catch{}

  ok.textContent='Contrase√±a actualizada correctamente.';
  setTimeout(()=>{ closePwdModal(); toast('Contrase√±a actualizada correctamente.'); }, 250);

  btn.disabled=false; btn.textContent=txt;
};
</script>
</body>
</html>
