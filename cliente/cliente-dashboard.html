<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FX | CAPITAL R.L. ‚Äî Panel del Cliente</title>

<!-- Evitar cache del dashboard (especialmente tras cerrar sesi√≥n) -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16.png">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<link rel="icon" href="favicon.ico" sizes="any">
<link rel="manifest" href="site.webmanifest">
<meta name="theme-color" content="#0b0c0e">

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

<style>
  :root{
    --bg0:#000; --bg1:#0b0c0e; --bg2:#111317; --bg3:#14171c;

    /* ‚úÖ Mejor legibilidad */
    --txt:#ffffff;
    --muted:#d6dceb;
    --line:rgba(255,255,255,.14);

    --grad-app: radial-gradient(1200px 800px at 10% -20%, #12151a 0%, #0b0c0e 45%, #060708 100%);
    --grad-panel: linear-gradient(180deg, #111317 0%, #0b0d10 100%);
    --grad-card: linear-gradient(180deg, #191d22 0%, #12161b 100%);
    --shadow-1: 0 10px 25px rgba(0,0,0,.45);
    --shadow-2: 0 18px 40px rgba(0,0,0,.55);
    --shadow-inset: inset 0 1px 0 rgba(255,255,255,.05), inset 0 -1px 0 rgba(0,0,0,.7);
    --radius:18px; --gloss: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 35%);
    --chip:#171b20; --danger:#ff4d4f;

    /* ‚úÖ Gris ‚Äúpremium 3D‚Äù (m√°s contraste, sin ‚Äúgrit√≥n‚Äù) */
    --panel-gray-bg1:#4b515b;
    --panel-gray-bg2:#1b1f27;
    --panel-gray-border:rgba(255,255,255,.16);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--txt);
    background:var(--grad-app) fixed, var(--bg0);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif
  }
  .wrap{max-width:1100px;margin:40px auto;padding:0 22px}

  /* ======= HEADER ======= */
header{position:relative;display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:18px}
.brand-wrap{display:flex;flex-direction:column;gap:0}
.brand-row{display:flex;align-items:center;gap:18px}
.brand-logo{width:112px;height:112px;border-radius:16px;object-fit:contain;background:transparent;display:block}

.brand-title{
  margin:0;
  font-weight:900;
  letter-spacing:.4px;
  font-size:clamp(32px,6vw,72px);
  line-height:1;

  /* ‚úÖ evita que Android lo parta en 2 l√≠neas */
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.brand-sub{margin:10px 0 0 0;font-weight:700;color:#e7ecf6;font-size:clamp(16px,2.2vw,28px);opacity:.92}

.btn{
  appearance:none;border:0;border-radius:999px;
  padding:12px 18px;font-weight:900;cursor:pointer;
  color:#0b0c0e;background:#fff;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.7),0 10px 22px rgba(0,0,0,.45)
}
.btn.secondary{
  color:var(--txt);
  background:var(--gloss),linear-gradient(180deg,#1a1d23,#0f1216);
  border:1px solid var(--line);
  box-shadow:var(--shadow-1),var(--shadow-inset)
}

/* ‚úÖ Ajuste solo en m√≥viles */
@media (max-width:560px){
  .brand-title{
    font-size: clamp(24px, 8.2vw, 34px);
  }
}

  /* ‚úÖ BOT√ìN CTA ‚ÄúRECARGAR CAPITAL‚Äù (m√°s visible) */
  .btn.cta{
    padding:13px 20px;
    font-weight:1000;
    letter-spacing:.2px;
    background:
      radial-gradient(140% 180% at 30% 0%, rgba(255,255,255,.35) 0%, rgba(255,255,255,0) 55%),
      linear-gradient(180deg,#ffffff 0%, #e9eef7 100%);
    color:#0b0c0e;
    border:1px solid rgba(255,255,255,.92);
    box-shadow:
      0 18px 46px rgba(0,0,0,.58),
      0 0 0 6px rgba(255,255,255,.06),
      inset 0 1px 0 rgba(255,255,255,.85);
    display:inline-flex;
    align-items:center;
    gap:10px;
  }
  .btn.cta::before{
    content:"‚áÑ";
    width:26px;height:26px;border-radius:10px;
    display:grid;place-items:center;
    background:rgba(0,0,0,.08);
    border:1px solid rgba(0,0,0,.10);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.7);
    font-weight:1000;
  }
  .btn.cta:hover{filter:brightness(.98)}
  .btn.cta:active{transform:translateY(1px)}

  /* ======= PANEL + VARIANTE GRIS ======= */
  .panel{
    background:var(--grad-panel);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:0 0 0 1px rgba(255,255,255,.05),0 30px 80px rgba(0,0,0,.55),var(--shadow-inset)
  }

  .panel.gray{
    background:
      radial-gradient(120% 160% at 12% 0%, rgba(255,255,255,.10) 0%, rgba(255,255,255,0) 45%),
      linear-gradient(180deg, var(--panel-gray-bg1) 0%, var(--panel-gray-bg2) 100%) !important;
    border:1px solid var(--panel-gray-border);
    box-shadow:
      0 18px 46px rgba(0,0,0,.55),
      inset 0 1px 0 rgba(255,255,255,.12),
      inset 0 -14px 30px rgba(0,0,0,.55);
    color:#fff !important;
  }
  .panel.gray > h2,
  .panel.gray > .muted,
  .panel.gray > .note{ color:#fff !important; opacity:.95; }

  .card{
    background:var(--grad-card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    box-shadow:var(--shadow-1),var(--shadow-inset)
  }

  .section{padding:24px}

  .grid{display:grid;gap:16px}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media (max-width:920px){.grid.cols-3{grid-template-columns:1fr 1fr}}
  @media (max-width:680px){.grid.cols-3{grid-template-columns:1fr}}

  .group{padding:18px 20px;position:relative;overflow:hidden}
  .group::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.05),transparent 40%);pointer-events:none}

  .k{
    display:inline-block;font-size:13px;
    color:var(--muted);
    background:rgba(0,0,0,.28);
    border:1px solid rgba(255,255,255,.12);
    padding:6px 10px;border-radius:999px;margin-bottom:8px
  }

  .v{display:block;font-size:16px;font-weight:800;letter-spacing:.2px}

  .input{
    width:100%;
    border:1px solid rgba(255,255,255,.16);
    border-radius:12px;
    padding:12px 14px;
    background:#0f1116;
    color:#ffffff
  }

  .muted{color:var(--muted);font-weight:650}

  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.14)}
  .table th{
    color:#f2f5ff;
    font-weight:900;text-align:left;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
    position:sticky;top:0;z-index:1
  }
  .panel.gray .table td{ color:#ffffff !important; }
  .panel.gray .table th{ color:#ffffff !important; }

  .note{color:var(--muted);font-size:13px;margin-top:10px;opacity:.95}

  .wrap > section.panel.section{ margin-top:18px; }

  dialog{
    border:0;border-radius:22px;
    background:var(--gloss),linear-gradient(180deg,#14161b,#0f1116);
    color:var(--txt);
    width:min(840px,92vw);
    box-shadow:0 24px 64px rgba(0,0,0,.65),var(--shadow-inset)
  }
  dialog::backdrop{background:rgba(0,0,0,.6)}
  .modal-h{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.14)}
  .modal-b{padding:18px 22px}
  .modal-close{
    width:36px;height:36px;border-radius:50%;
    display:grid;place-items:center;border:1px solid rgba(255,255,255,.18);
    background:linear-gradient(180deg,#121419,#0f1116);color:#fff;cursor:pointer;
    box-shadow:var(--shadow-inset)
  }

  .pill{
    border:1px solid rgba(255,255,255,.16);
    border-radius:16px;padding:12px 14px;cursor:pointer;
    background:linear-gradient(180deg,#15181d,#101317);
    box-shadow:var(--shadow-inset);transition:all .18s
  }
  .pill:hover{filter:brightness(1.06)}
  .pill.selected{
    background:#fff;color:#0b0c0e;border-color:#fff;
    box-shadow:0 10px 22px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.7)
  }
  .pill.selected .muted{color:#1b1f24}

  .switch{
    --w:58px;--h:32px;--knob:26px;
    inline-size:var(--w);block-size:var(--h);
    background:linear-gradient(180deg,#1b1f26,#0f1216);
    border-radius:999px;border:1px solid rgba(255,255,255,.16);position:relative;
    transition:all .18s ease; cursor:pointer;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.7);
  }
  .switch::after{
    content:"";position:absolute;inline-size:var(--knob);block-size:var(--knob);
    border-radius:50%;background:linear-gradient(180deg,#fff,#d9d9d9);
    top:50%;left:3px;translate:0 -50%; transition:all .18s ease;
  }
  .switch.on{
    background:#fff; border-color:#fff;
    box-shadow:0 10px 22px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.7);
  }
  .switch.on::after{
    left:calc(var(--w) - var(--knob) - 3px);
    background:linear-gradient(180deg,#2a2f36,#161a1f);
  }

  #wdlg .input{background:#fff;color:#0b0c0e;border:1px solid rgba(0,0,0,.18)}
  #wReason.input{min-height:96px;max-height:240px;resize:vertical}

  #pwdDlg{
    background:radial-gradient(160% 200% at 10% 0%, #272c38 0%, #171b24 40%, #06070b 100%);
    box-shadow:0 36px 90px rgba(0,0,0,.92),0 0 0 1px rgba(255,255,255,.08),
      inset 0 1px 0 rgba(255,255,255,.08), inset 0 -10px 30px rgba(0,0,0,.8);
    border-radius:30px;
    transform:translateY(-6px);
  }
  #pwdDlg .modal-h{border-bottom-color:rgba(255,255,255,.14)}
  #pwdDlg .k{
    background:rgba(255,255,255,.08);
    border-color:rgba(255,255,255,.28);
    color:#f3f6ff;
    font-size:13px;
    font-weight:700;
  }
  #pwdDlg .input{
    background:#fdfdfd;
    color:#0b0c0e;
    font-size:15.5px;
    padding:14px 44px 14px 16px;
    border-radius:14px;
    border:1px solid #0c1018;
    box-shadow:0 0 0 1px rgba(0,0,0,.55) inset, 0 10px 24px rgba(0,0,0,.45);
  }
  #pwdDlg .input::placeholder{color:#7a808c}
  #pwdDlg .input:focus{
    outline:none;
    background:#ffffff;
    border-color:#ffffff;
    box-shadow:0 0 0 1px rgba(255,255,255,.9), 0 0 0 4px rgba(255,255,255,.09), 0 14px 30px rgba(0,0,0,.6);
  }
  .pwd-field-wrap{position:relative}
  .pwd-toggle{
    position:absolute; right:12px; top:50%; transform:translateY(-50%);
    border:0; background:transparent; cursor:pointer;
    font-size:17px; color:#8c92a0; padding:4px;
  }
  .pwd-toggle:hover{color:#dde3f2}
  .pwd-toggle:focus-visible{outline:2px solid #ffffff; outline-offset:2px}
  #pwdError{margin-top:8px;font-size:13px;color:var(--danger)}

  @media (max-width:560px){
    header{padding-top:64px}
    .brand-row{gap:12px}
    .brand-logo{width:84px;height:84px}
    .brand-title{font-size:clamp(26px,7.6vw,36px);line-height:1.02}
    .brand-sub{font-size:clamp(13px,3.6vw,18px);margin-top:8px}
    #btnSignOut{position:absolute; top:10px; right:12px; z-index:5; padding:10px 14px;}
  }

  /* ===== RECARGA POR TRANSFERENCIA (3D PRO) ===== */
  .tx-wrap{padding-top:22px}
  .tx-head{display:flex; align-items:flex-start; justify-content:space-between; gap:14px; margin:0 0 14px 0}
  .tx-title{display:flex; gap:12px; align-items:flex-start}
  .tx-icon{
    width:38px; height:38px; border-radius:14px;
    display:grid; place-items:center;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    flex:0 0 auto;
  }
  .tx-title h2{margin:0;font-size:20px;letter-spacing:.2px}
  .tx-title p{margin:6px 0 0; font-size:13px; line-height:1.4; color:var(--muted)}
  .tx-badge{
  font-size:12px;
  padding:7px 12px;
  border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.14);
  color:#f4f7ff;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.08);

  /* ‚úÖ FIX Android */
  max-width:100%;
  white-space:normal;
  text-align:center;
}
@media (max-width: 520px){
  .tx-head{
    flex-direction: column;
    align-items: flex-start;
  }

  .tx-badge{
    margin-top: 8px;
  }
}

  .tx-steps{display:flex; align-items:center; gap:10px; margin:0 0 16px 0}
  .tx-step{
    display:flex; align-items:center; gap:8px;
    font-size:12.5px;
    padding:7px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:#f4f7ff;
  }
  .tx-step-dot{
    width:20px; height:20px; border-radius:999px;
    display:grid; place-items:center;
    font-size:12px;
    background:rgba(255,255,255,.12);
    border:1px solid rgba(255,255,255,.14);
  }
  .tx-step-active{
    background:rgba(255,255,255,.12);
    border-color:rgba(255,255,255,.20);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
  }
  .tx-step-line{flex:1;height:1px;background:rgba(255,255,255,.14);border-radius:999px}

  .tx-grid{display:grid; grid-template-columns: 1.4fr .9fr; gap:14px}
  @media (max-width: 900px){ .tx-grid{grid-template-columns:1fr} }

  .tx-panel{
    border-radius:16px;
    padding:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
  }
  .tx-panel-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
  .tx-chip{
    font-size:12px; padding:6px 10px; border-radius:999px;
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.14);
    color:#f4f7ff;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
  }

  .tx-rows{display:flex; flex-direction:column; gap:10px}
  .tx-row{
    display:grid;
    grid-template-columns: 1fr auto;
    gap:10px;
    align-items:center;
    padding:10px 10px;
    border-radius:12px;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
  }
  .tx-row-strong{grid-template-columns: 1fr auto auto}
  .tx-k{font-size:12.5px; opacity:.92; color:#f1f5ff}
  .tx-v{font-size:13px; font-weight:900; color:#ffffff}

  .tx-mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    letter-spacing:.3px;
    padding:6px 10px;
    border-radius:10px;
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.16);
    color:#ffffff;
  }

  .tx-copy{
    height:34px; padding:0 12px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.12);
    color:#fff;
    font-weight:900;
    cursor:pointer;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
  }
  .tx-copy:hover{background:rgba(255,255,255,.16)}
  .tx-copy:disabled{opacity:.6; cursor:not-allowed}

  .tx-hint{
    margin-top:12px;
    font-size:12.5px;
    color:var(--muted);
    line-height:1.4;
  }

  .tx-primary{
    width:100%;
    height:44px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.18);
    background:#fff;
    color:#0b0c0e;
    font-weight:1000;
    cursor:pointer;
    box-shadow: inset 0 1px 0 rgba(255,255,255,.75), 0 12px 26px rgba(0,0,0,.38);
  }
  .tx-primary:hover{filter:brightness(.98)}

  .tx-note{
    margin-top:12px;
    font-size:12.5px;
    color:var(--muted);
    line-height:1.45;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);
  }

  #tdlg .k{ color:#ffffff !important; font-weight:900 !important; }

  #tdlg .input{
    background:#ffffff !important;
    color:#000000 !important;
    border:1px solid #bfc6d1;
  }
  #tdlg .input::placeholder{ color:#6b7280; }
  #tdlg .input:focus{
    outline:none;
    border-color:#000000;
    box-shadow:0 0 0 2px rgba(0,0,0,.08);
  }
</style>
</head>

<body>
  <div class="wrap" id="appWrap">
    <header>
      <div class="brand-wrap">
        <div class="brand-row">
          <img
            src="/logo-white.png?v=1"
            alt="FX Capital"
            class="brand-logo"
            loading="eager"
            onerror="this.onerror=null;this.src='https://raw.githubusercontent.com/enrike22/fxcapital-apps/main/cliente/logo-white.png?raw=1';"
          />
          <div>
            <h1 class="brand-title">FX | CAPITAL R.L.</h1>
            <h2 class="brand-sub">‚Äî Panel del Cliente</h2>
          </div>
        </div>
      </div>
      <button class="btn" id="btnSignOut">Cerrar sesi√≥n</button>
    </header>

    <!-- NAV / ACCIONES -->
    <div style="display:flex; gap:12px; margin:0 0 18px 0; flex-wrap:wrap">
      <button class="btn cta" id="btnGoTopup" type="button">Recargar Capital</button>
      <button class="btn secondary" id="btnGoHome" type="button" style="display:none">Volver a Mi cuenta</button>
    </div>

    <!-- VISTA PRINCIPAL -->
    <div id="viewHome">
      <!-- MI CUENTA -->
      <section class="panel section gray">
        <h2 style="margin:0 0 14px 0">Mi cuenta</h2>
        <div class="grid cols-3">
          <div class="card group"><span class="k">Nombre</span><span id="valName" class="v">‚Äî</span></div>
          <div class="card group"><span class="k">Apertura de cuenta</span><span id="valOpenDate" class="v">‚Äî</span></div>
          <div class="card group"><span class="k">Plan</span><span id="valPlan" class="v">‚Äî</span></div>

          <div class="card group"><span class="k">Moneda</span><span id="valCurrency" class="v">‚Äî</span></div>
          <div class="card group"><span class="k">Cuenta (ID)</span><span id="valAccountId" class="v">‚Äî</span></div>
          <div class="card group"><span class="k">Per√≠odo (meses)</span><span id="valMonths" class="v">‚Äî</span></div>

          <div class="card group"><span class="k">Capital</span><span id="valCapital" class="v">Q 0.00</span></div>
          <div class="card group"><span class="k">Finalizaci√≥n de apertura de cuenta</span><span id="valCloseDate" class="v">‚Äî</span></div>
          <div class="card group"><span class="k">Inter√©s total del per√≠odo</span><span id="valPeriodInterest" class="v">Q 0.00</span></div>
        </div>
        <div style="margin-top:16px">
          <button class="btn" id="btnOpenWithdraw">Solicitar retiro</button>
        </div>
      </section>

      <!-- RESULTADOS DEL MES -->
      <section class="panel section gray" style="margin-top:18px">
        <h2 style="margin:0 0 10px 0">Resultados del mes</h2>
        <div class="muted" id="monthRange">‚Äî</div>
        <div style="overflow:auto;margin-top:8px">
          <table class="table">
            <thead><tr><th>Viernes</th><th>Inter√©s semanal</th></tr></thead>
            <tbody id="weekBody"><tr><td>‚Äî</td><td>‚Äî</td></tr></tbody>
            <tfoot><tr class="sum-row"><td>Acumulado del mes</td><td id="weekSum">‚Äî</td></tr></tfoot>
          </table>
        </div>
        <div id="monthNote" class="note">Periodo de cierre fin de mes: ‚Äî</div>
      </section>

      <!-- ESTADO DE CUENTA -->
      <section class="panel section gray" style="margin-top:18px">
        <h2 style="margin:0 0 10px 0">Estado de cuenta</h2>
        <div class="muted" id="stmtRange">‚Äî</div>

        <div style="overflow:auto;margin-top:8px">
          <table class="table">
            <thead>
              <tr>
                <th>Mes</th>
                <th>Capital inicio</th>
                <th>Inter√©s (beneficio)</th>
                <th>Estado</th>
                <th>Saldo</th>
              </tr>
            </thead>
            <tbody id="stmtBody">
              <tr><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td></tr>
            </tbody>
          </table>
        </div>

        <div class="note" id="stmtNote">‚Äî</div>
      </section>

      <!-- SIMULADOR -->
      <section class="panel section" style="margin-top:18px">
        <h2 style="margin:0 0 4px 0">Simulador de crecimiento</h2>
        <div class="muted" style="margin-bottom:14px">Inter√©s simple por <b>6 meses</b>. Plan autom√°tico seg√∫n capital ingresado.</div>
        <div class="grid cols-3">
          <div class="group card"><span class="k">Capital a simular (Q)</span>
            <input id="simCapital" class="input" type="text" inputmode="decimal" placeholder="Ej. 40,000" />
          </div>
          <div class="group card"><span class="k">Plan y % (seg√∫n monto)</span><div id="simPlan" class="v">‚Äî</div></div>
          <div class="group card"><span class="k">Capital final estimado</span><div id="simFinal" class="v">Q 0.00</div></div>
        </div>
        <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
          <button class="btn" id="btnCalc">Calcular</button>
          <span id="simNote" class="note"></span>
        </div>
        <div style="overflow:auto;margin-top:12px">
          <table class="table" id="simTable">
            <thead><tr><th>Mes</th><th>Inter√©s del mes</th></tr></thead>
            <tbody id="simBody"><tr><td>1</td><td>Q 0.00</td></tr></tbody>
            <tfoot><tr class="sum-row"><td>Inter√©s total acumulado</td><td id="simSum">Q 0.00</td></tr></tfoot>
          </table>
        </div>
      </section>
    </div><!-- /#viewHome -->

    <!-- VISTA RECARGA -->
    <div id="viewTopup" style="display:none">
      <section class="panel section tx-wrap">
        <div class="tx-head">
          <div class="tx-title">
            <div class="tx-icon">‚áÑ</div>
            <div>
              <h2>Recarga por transferencia</h2>
              <p>Env√≠e su boleta de transferencia para solicitar una recarga. Un administrador revisar√° y acreditar√° su capital.</p>
            </div>
          </div>
          <span class="tx-badge">Validaci√≥n administrativa</span>
        </div>

        <div class="tx-steps">
          <div class="tx-step tx-step-active" id="txStep1">
            <span class="tx-step-dot">1</span><span>Transferir</span>
          </div>
          <div class="tx-step-line"></div>
          <div class="tx-step" id="txStep2">
            <span class="tx-step-dot">2</span><span>Subir boleta</span>
          </div>
        </div>

        <div class="tx-grid">
          <div class="tx-panel">
            <div class="tx-panel-head">
              <span class="tx-chip">Datos para transferencia</span>
            </div>

            <div class="tx-rows">
              <div class="tx-row">
                <span class="tx-k">Nombre de la cuenta</span>
                <span class="tx-v">Fx Inversiones</span>
              </div>

              <div class="tx-row tx-row-strong">
                <span class="tx-k">N√∫mero de cuenta</span>
                <span class="tx-v tx-mono" id="acctNumber">021-010518-5</span>
                <button class="tx-copy" type="button" id="btnCopyAcct">Copiar</button>
              </div>

              <div class="tx-row">
                <span class="tx-k">Tipo de cuenta</span>
                <span class="tx-v">Monetaria</span>
              </div>

              <div class="tx-row">
                <span class="tx-k">Moneda</span>
                <span class="tx-v">Quetzales (GTQ)</span>
              </div>
            </div>

            <div class="tx-hint">
              Realice la transferencia a esta cuenta y posteriormente adjunte la boleta para solicitar la recarga de su capital.
            </div>
          </div>

          <div class="tx-panel">
            <div class="tx-panel-head">
              <span class="tx-chip">Acci√≥n</span>
            </div>

            <button class="tx-primary" id="btnOpenTopup" type="button">
              Enviar boleta de recarga
            </button>

            <div class="tx-note">
              <b>Nota:</b> El acreditamiento puede tomar unas horas (seg√∫n validaci√≥n).
            </div>
          </div>
        </div>
      </section>
    </div><!-- /#viewTopup -->

  </div><!-- /wrap -->

  <div class="blocker" id="panelBlocker"></div>

  <!-- MODAL RETIRO -->
  <dialog id="wdlg" aria-labelledby="wdlgTitle">
    <div class="modal-h">
      <div id="wdlgTitle" style="font-weight:900">Solicitud retiro de capital</div>
      <button class="modal-close" id="xClose" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="modal-b">
      <div class="row" style="display:grid;gap:14px;grid-template-columns:1fr 1fr">
        <div class="pill selected" id="optEarly" tabindex="0" role="button" aria-pressed="true">
          <div style="font-weight:800;margin-bottom:6px">Antes de tiempo</div>
          <div class="muted">Aplicar√° una penalizaci√≥n del 10%.</div>
        </div>
        <div class="pill" id="optHealth" tabindex="0" role="button" aria-pressed="false">
          <div style="font-weight:800;margin-bottom:6px">Causas de salud</div>
          <div class="muted">Exento de penalizaci√≥n.</div>
        </div>
      </div>

      <div class="row" style="display:grid;gap:14px;grid-template-columns:1fr 1fr;margin-top:14px">
        <div>
          <div class="k">Monto a retirar (Q)</div>
          <input id="wAmount" class="input" type="text" inputmode="decimal" placeholder="Ej. 5,000">
          <div class="note">Si el retiro es parcial, debe permanecer al menos <b>Q 2,000</b>.</div>
        </div>

        <div>
          <div class="k">Motivo</div>
          <textarea id="wReason" class="input" placeholder="Explique brevemente el motivo‚Ä¶"></textarea>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px;margin:16px 0">
        <div id="switchAll" class="switch" role="switch" aria-checked="false" tabindex="0" title="Retirar todo mi capital"></div>
        <div>Retirar todo mi capital</div>
      </div>

      <div class="actions" style="display:flex;gap:12px;justify-content:flex-start">
        <button class="btn secondary" id="wCancel">Cancelar</button>
        <button class="btn" id="wSend">Enviar solicitud</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL CONTRASE√ëA -->
  <dialog id="pwdDlg" aria-labelledby="pwdTitle">
    <div class="modal-h">
      <div id="pwdTitle" style="font-weight:900">Actualizar contrase√±a</div>
      <div style="width:36px;height:36px"></div>
    </div>
    <div class="modal-b">
      <p class="note" style="margin-top:0;margin-bottom:16px">
        Por seguridad, debe actualizar su contrase√±a antes de continuar usando el panel.
      </p>

      <div style="display:grid;gap:14px;grid-template-columns:1fr 1fr">
        <div>
          <div class="k">Nueva contrase√±a</div>
          <div class="pwd-field-wrap">
            <input id="pwdNew" class="input" type="password" autocomplete="new-password" placeholder="M√≠nimo 8 caracteres">
            <button type="button" id="pwdNewEye" class="pwd-toggle" aria-label="Mostrar u ocultar contrase√±a">üëÅ</button>
          </div>
        </div>
        <div>
          <div class="k">Confirmar nueva contrase√±a</div>
          <div class="pwd-field-wrap">
            <input id="pwdConfirm" class="input" type="password" autocomplete="new-password" placeholder="Repita la contrase√±a">
            <button type="button" id="pwdConfirmEye" class="pwd-toggle" aria-label="Mostrar u ocultar contrase√±a">üëÅ</button>
          </div>
        </div>
      </div>

      <div id="pwdError"></div>

      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:18px">
        <button class="btn" id="pwdSave">Guardar contrase√±a</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL RECARGA (TRANSFERENCIA) -->
  <dialog id="tdlg" aria-labelledby="tdlgTitle">
    <div class="modal-h">
      <div id="tdlgTitle" style="font-weight:900">Enviar boleta de recarga</div>
      <button class="modal-close" id="tClose" aria-label="Cerrar">‚úï</button>
    </div>

    <div class="modal-b">
      <div class="row" style="display:grid;gap:14px;grid-template-columns:1fr 1fr">
        <div>
          <div class="k">Monto depositado (Q)</div>
          <input id="tAmount" class="input" type="text" inputmode="decimal" placeholder="Ej. 5,000">
          <div class="note">Monto m√≠nimo sugerido: <b>Q 2,000</b>.</div>
        </div>
        <div>
          <div class="k">Banco (opcional)</div>
          <input id="tBank" class="input" type="text" placeholder="Ej. Banrural / BAC / BI">
        </div>
      </div>

      <div class="row" style="display:grid;gap:14px;grid-template-columns:1fr 1fr;margin-top:14px">
        <div>
          <div class="k">Fecha/hora del dep√≥sito (opcional)</div>
          <input id="tDate" class="input" type="datetime-local">
        </div>
        <div>
          <div class="k">Boleta (JPG/PNG/PDF)</div>
          <input id="tReceipt" class="input" type="file" accept="image/*,application/pdf">
          <div class="note">M√°ximo recomendado: <b>6 MB</b>.</div>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="k">Notas (opcional)</div>
        <textarea id="tNotes" class="input" placeholder="Referencia, n√∫mero de transacci√≥n, etc." style="min-height:96px;resize:vertical"></textarea>
      </div>

      <div class="actions" style="display:flex;gap:12px;justify-content:flex-start;margin-top:16px">
        <button class="btn secondary" id="tCancel">Cancelar</button>
        <button class="btn" id="tSend">Enviar recarga</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL MENSAJES -->
  <dialog id="msgDlg">
    <div class="modal-h">
      <div style="font-weight:900">FX | CAPITAL R.L.</div>
      <button class="modal-close" id="msgClose" aria-label="Cerrar">‚úï</button>
    </div>
    <div class="modal-b">
      <p id="msgText" style="margin:0;line-height:1.6"></p>
      <div style="margin-top:16px;display:flex;justify-content:flex-end">
        <button class="btn" id="msgOk">Aceptar</button>
      </div>
    </div>
  </dialog>

  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  const BASE_URL   = 'https://clientes.fxcapital-gt.com/';
  const LOGIN_URL  = BASE_URL;

  const SUPABASE_URL = 'https://czvpehbubfrinutztnwh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true} });

  const $ = s=>document.querySelector(s);
  const fmtQ = n => { try{ return new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ'}).format(n||0) }catch(e){ return `Q ${(Number(n)||0).toFixed(2)}` } };
  const clampDate = d => { const x=new Date(d); x.setHours(0,0,0,0); return x; };

  /* ===== Logout robusto ===== */
  async function forceLogout(){
    try {
      const { error } = await sb.auth.signOut({ scope:'global' });
      if (error) console.warn('Supabase signOut error:', error?.message);
      Object.keys(localStorage).forEach(k=>{ if (k.startsWith('sb-') && k.endsWith('-auth-token')) localStorage.removeItem(k); });
      sessionStorage.clear();
      if (indexedDB && indexedDB.databases){
        try{
          const dbs = await indexedDB.databases();
          for (const db of dbs){ if (db.name && /supabase|auth|localforage/i.test(db.name)) indexedDB.deleteDatabase(db.name); }
        }catch(e){}
      }
    } finally {
      const bust = `logged_out=${Date.now()}`;
      const sep  = LOGIN_URL.includes('?') ? '&' : '?';
      window.location.replace(`${LOGIN_URL}${sep}${bust}`);
    }
  }
  document.getElementById('btnSignOut')?.addEventListener('click', (ev)=>{ ev.preventDefault(); forceLogout(); });
  sb.auth.onAuthStateChange((event) => {
    if (event === 'SIGNED_OUT') {
      const bust = `logged_out=${Date.now()}`;
      const sep  = LOGIN_URL.includes('?') ? '&' : '?';
      window.location.replace(`${LOGIN_URL}${sep}${bust}`);
    }
  });

  /* ===== Helpers ===== */
  function nextMonthSameDay(d){
    const x=clampDate(d);
    const t=new Date(x.getFullYear(), x.getMonth()+1, x.getDate());
    while(t.getMonth() !== (x.getMonth()+1)%12){ t.setDate(t.getDate()-1); }
    t.setHours(0,0,0,0);
    return t;
  }
  function fridayOfSameWeek(d){ const x=clampDate(d); const add=(5-x.getDay()+7)%7; const f=new Date(x); f.setDate(x.getDate()+add); f.setHours(0,0,0,0); return f; }
  function currentWindow(joinedAt, today){ let start=clampDate(joinedAt), end=nextMonthSameDay(start); while(end <= today){ start=end; end=nextMonthSameDay(start); } return {start,end}; }
  function fridaysInRange(start,end){ let f=fridayOfSameWeek(start); if(f<start) f.setDate(f.getDate()+7); const list=[]; while(f<end){ list.push(new Date(f)); f.setDate(f.getDate()+7); } return list; }

  function cleanMoney(s){ return (s||'').toString().replace(/[,\s]/g,''); }
  function formatNumberString(val){
    val = cleanMoney(val);
    if(val === '') return '';
    const parts = val.split('.');
    parts[0] = parts[0].replace(/^0+(?=\d)/,'');
    const withCommas = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    return parts.length > 1 ? withCommas + '.' + parts[1].slice(0, 2) : withCommas;
  }
  function bindMoneyInput(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.inputMode = 'decimal';
    el.autocomplete = 'off';
    el.addEventListener('input', ()=>{ el.value = formatNumberString(el.value); el.selectionStart = el.selectionEnd = el.value.length; });
    el.addEventListener('blur', ()=>{ el.value = formatNumberString(el.value); });
    el.addEventListener('focus', ()=> el.select());
  }

  function paintWeeks(acc, opts={}){
    const today=clampDate(new Date());
    const joined=acc?.joined_at? clampDate(new Date(acc.joined_at)) : today;

    let todayForCalc = today;
    if (opts.freezeAtClose){
      const freeze = clampDate(opts.freezeAtClose);
      const prev = new Date(freeze); prev.setDate(prev.getDate()-1);
      todayForCalc = prev;
    }

    const {start,end}=currentWindow(joined,todayForCalc);
    $('#monthRange').textContent = `${start.toLocaleDateString('es-GT')} ‚Äî ${end.toLocaleDateString('es-GT')}`;
    $('#monthNote').textContent  = `Periodo de cierre fin de mes: ${end.toLocaleDateString('es-GT')}.`;

    const cap=Number(acc.capital||0), semRate=Number(acc.interest_pct||0)/100, monthly=cap*(semRate/6);
    const allFridays=fridaysInRange(start,end), weekly=allFridays.length? (monthly/allFridays.length) : 0;

    const tbody=$('#weekBody'); tbody.innerHTML='';
    const cutoff = todayForCalc < end ? todayForCalc : end;
    const shown = allFridays.filter(f => f < cutoff);

    if(shown.length===0){
      tbody.innerHTML = `<tr><td>‚Äî</td><td>‚Äî</td></tr>`;
      $('#weekSum').textContent = '‚Äî';
    }else{
      shown.forEach(f=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${f.toLocaleDateString('es-GT')}</td><td>${fmtQ(weekly)}</td>`;
        tbody.appendChild(tr);
      });
      const partial = weekly * shown.length;
      $('#weekSum').textContent = fmtQ(partial);
    }
  }

  /* ===== Estado de cuenta (mes a mes) ===== */

  function addMonthsSameDay(d, months){
    let x = clampDate(d);
    for(let i=0;i<months;i++) x = nextMonthSameDay(x);
    return x;
  }

  function buildPeriods(joinedAt, investMonths){
    const start0 = clampDate(joinedAt);
    const periods = [];
    let start = start0;
    for(let i=0;i<Number(investMonths||0);i++){
      const end = nextMonthSameDay(start);
      periods.push({ idx:i+1, start:new Date(start), end:new Date(end) });
      start = end;
    }
    return periods;
  }

  function daysBetween(a,b){
    const ms = 24*60*60*1000;
    return Math.max(0, Math.round((clampDate(b) - clampDate(a))/ms));
  }

  // ‚úÖ Si el cierre cae s√°bado/domingo, se considera ‚Äúcerrado‚Äù hasta lunes
  function businessCloseDate(endDate){
    const d = clampDate(endDate);
    const dow = d.getDay(); // 0=Dom, 6=Sab
    if(dow === 6){ d.setDate(d.getDate()+2); }
    else if(dow === 0){ d.setDate(d.getDate()+1); }
    d.setHours(0,0,0,0);
    return d;
  }

  function buildCapitalEvents(acc, approvedTopups){
    const joined = acc?.joined_at ? new Date(acc.joined_at) : new Date();

    const sumTopups = (approvedTopups||[]).reduce((s,t)=>s + Number(t.amount||0), 0);
    const initial = Number(acc.initial_capital ?? (Number(acc.capital||0) - sumTopups) ?? 0);

    let running = initial;
    const ev = [{ at: clampDate(joined), capital: running }];

    const sorted = (approvedTopups||[])
      .filter(t => t.approved_at)
      .slice()
      .sort((a,b)=> new Date(a.approved_at)-new Date(b.approved_at));

    for(const t of sorted){
      running += Number(t.amount||0);
      ev.push({ at: clampDate(new Date(t.approved_at)), capital: running });
    }
    return ev;
  }

  function interestForPeriod(periodStart, periodEnd, events, monthlyRate){
    const start = clampDate(periodStart);
    const end   = clampDate(periodEnd);
    const totalDays = daysBetween(start, end) || 1;

    const pts = events
      .filter(e => e.at < end)
      .map(e => ({ at: clampDate(e.at), capital: Number(e.capital||0) }))
      .sort((a,b)=>a.at-b.at);

    let currentCapital = pts[0]?.capital ?? 0;
    for(const p of pts){
      if(p.at <= start) currentCapital = p.capital;
    }

    const segs = [];
    let cursor = new Date(start);

    const inside = pts.filter(e => e.at > start && e.at < end);

    for(const e of inside){
      segs.push({ from:new Date(cursor), to:new Date(e.at), capital: currentCapital });
      currentCapital = e.capital;
      cursor = new Date(e.at);
    }
    segs.push({ from:new Date(cursor), to:new Date(end), capital: currentCapital });

    let interest = 0;
    for(const s of segs){
      const d = daysBetween(s.from, s.to);
      const portion = d / totalDays;
      interest += (Number(s.capital||0) * Number(monthlyRate||0)) * portion;
    }
    return interest;
  }

  function monthLabel(start, end, idx){
    const s = start.toLocaleDateString('es-GT');
    const e = new Date(end); e.setDate(e.getDate()-1);
    const ee = e.toLocaleDateString('es-GT');
    const n = String(idx).padStart(2,'0');
    return `Mes ${n} (${s} ‚Äî ${ee})`;
  }

  function renderStatementTable({ acc, periods, events, settlementsMap }){
    const tbody = document.getElementById('stmtBody');
    if(!tbody) return;
    tbody.innerHTML = '';

    const semRate = Number(acc.interest_pct||0)/100;
    const monthlyRate = semRate/6;

    const isCompound = !!acc.compound_interest;

    let saldo = 0;

    const firstCap = (()=>{
      let cap = 0;
      const s0 = clampDate(new Date(acc.joined_at));
      for(const ev of events){
        if(ev.at <= s0) cap = ev.capital;
      }
      return cap;
    })();
    saldo = firstCap;

    const today = clampDate(new Date());

    // ‚úÖ Mostrar SOLO meses ya iniciados: pasados + mes en curso (no futuros)
    const visiblePeriods = periods.filter(p => clampDate(p.start) <= today);

    const stmtRange = document.getElementById('stmtRange');
    if(stmtRange && visiblePeriods.length){
      stmtRange.textContent = `${visiblePeriods[0].start.toLocaleDateString('es-GT')} ‚Äî ${visiblePeriods[visiblePeriods.length-1].end.toLocaleDateString('es-GT')}`;
    } else if(stmtRange){
      stmtRange.textContent = '‚Äî';
    }

    for(const p of visiblePeriods){
      const closeEffective = businessCloseDate(p.end);
      const ended = today >= closeEffective;

      let capStart = firstCap;
      for(const ev of events){
        if(ev.at <= clampDate(p.start)) capStart = ev.capital;
      }

      const interest = interestForPeriod(p.start, p.end, events, monthlyRate);

      const key = clampDate(p.start).toISOString().slice(0,10);
      const st  = settlementsMap[key];

      let estado = 'En curso';
      if(isCompound){
        estado = ended ? 'Acumulado' : 'En curso';
      }else{
        // ‚úÖ AUTOM√ÅTICO: termin√≥ ‚Üí Pagado, si no ‚Üí En curso (con regla fin de semana)
        estado = ended ? 'Pagado' : 'En curso';
      }

      if(isCompound && ended){
        saldo += interest;
      }else{
        saldo = capStart;
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${monthLabel(p.start, p.end, p.idx)}</td>
        <td>${fmtQ(capStart)}</td>
        <td>${fmtQ(interest)}</td>
        <td><b>${estado}</b></td>
        <td>${fmtQ(saldo)}</td>
      `;
      tbody.appendChild(tr);
    }

    if(!visiblePeriods.length){
      tbody.innerHTML = `<tr><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td><td>‚Äî</td></tr>`;
    }

    const note = document.getElementById('stmtNote');
    if(note){
      note.innerHTML = isCompound
        ? `Modo: <b>Inter√©s acumulado</b>. El capital permanece fijo; el saldo aumenta al cierre de cada mes.`
        : `Modo: <b>Pago mensual</b>. El capital y el saldo se mantienen; al concluir el mes, el estado se muestra como <b>Pagado</b> autom√°ticamente (si el cierre cae s√°bado/domingo, cambia a Pagado hasta el lunes).`;
    }
  }

  /* ===== Retiro ===== */
  const dlg = document.getElementById('wdlg');
  function selectType(t){
    document.getElementById('optEarly')?.classList.toggle('selected',t==='early');
    document.getElementById('optHealth')?.classList.toggle('selected',t==='health');
    document.getElementById('optEarly')?.setAttribute('aria-pressed', String(t==='early'));
    document.getElementById('optHealth')?.setAttribute('aria-pressed', String(t==='health'));
  }
  function toggleSwitchAll(force){
    const sw=document.getElementById('switchAll');
    if(!sw) return;
    const on=(typeof force==='boolean')?force:!sw.classList.contains('on');
    sw.classList.toggle('on',on); sw.setAttribute('aria-checked',String(on));
    const wa = document.getElementById('wAmount');
    if(wa) wa.disabled = on;
  }

  async function enviarSolicitudRetiro(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ const bust=`no_session=${Date.now()}`; const sep=LOGIN_URL.includes('?')?'&':'?'; window.location.replace(`${LOGIN_URL}${sep}${bust}`); return; }

    const { data: acc, error: accErr } = await sb.from('accounts').select('capital,id').eq('user_id',session.user.id).single();
    if(accErr){ alert('No se pudo cargar su cuenta.'); return; }

    const capital=Number(acc?.capital||0);
    const all=document.getElementById('switchAll')?.classList.contains('on');
    const amount=all? capital : Number((document.getElementById('wAmount')?.value||'').replace(/[,\s]/g,'') || 0);
    const reason=(document.getElementById('wReason')?.value||'').trim();

    if(!all){
      if(amount<=0){ alert('Ingrese un monto v√°lido.'); return; }
      if(amount>capital){ alert('El monto no puede ser mayor al capital disponible.'); return; }
      const restante=capital-amount; if(restante<2000){ alert('Debe permanecer al menos Q 2,000 (a menos que retire todo).'); return; }
    }
    if(reason.length<5){ alert('Describa brevemente el motivo.'); return; }

    const { error } = await sb.functions.invoke('send-withdrawal-email', {
      body:{ amount, reason, full_withdrawal:!!all, account_id:acc?.id||null, user_email:session.user.email, user_name: document.getElementById('valName')?.textContent || '' }
    });

    if(error){ alert('No se pudo enviar la solicitud.\n' + (error.message||JSON.stringify(error))); return; }

    showMessage('Solicitud enviada con √©xito. Un representante de <b>FX | CAPITAL R.L.</b> revisar√° su informaci√≥n y le escribir√° en las pr√≥ximas horas.');

    dlg?.close();
    if(document.getElementById('wAmount')) document.getElementById('wAmount').value='';
    if(document.getElementById('wReason')) document.getElementById('wReason').value='';
    toggleSwitchAll(false);
    selectType('early');
  }

  /* ===== Mensajes ===== */
  const msgDlg = document.getElementById('msgDlg');
  function showMessage(html){
    const mt = document.getElementById('msgText');
    if(mt) mt.innerHTML = html;
    if(msgDlg && !msgDlg.open) msgDlg.showModal();
  }

  /* ===== Recarga por transferencia ===== */
  const tdlg = document.getElementById('tdlg');
  let CURRENT_ACCOUNT_ID = null;

  function genRefCode(){ return `FXC-${Math.floor(100000 + Math.random()*900000)}`; }
  function extFromFile(file){
    const name = (file?.name || '').toLowerCase();
    const parts = name.split('.');
    return parts.length > 1 ? parts.pop() : 'bin';
  }
  function safeParseMoney(str){ return Number((str || '').toString().replace(/[,\s]/g,'') || 0); }

  async function enviarTopupTransferencia(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ showMessage('Sesi√≥n no v√°lida. Inicie sesi√≥n nuevamente.'); return; }
    if(!CURRENT_ACCOUNT_ID){ showMessage('No se encontr√≥ su cuenta. Intente recargar la p√°gina.'); return; }

    const amount = safeParseMoney(document.getElementById('tAmount')?.value);
    const bank   = (document.getElementById('tBank')?.value || '').trim();
    const notes  = (document.getElementById('tNotes')?.value || '').trim();
    const dtRaw  = (document.getElementById('tDate')?.value || '').trim();
    const fileEl = document.getElementById('tReceipt');
    const file   = fileEl?.files?.[0];

    if(amount <= 0){ alert('Ingrese un monto v√°lido.'); return; }
    if(!file){ alert('Debe adjuntar la boleta (JPG/PNG/PDF).'); return; }

    const MAX_MB = 6;
    if(file.size > MAX_MB * 1024 * 1024){
      alert(`La boleta excede ${MAX_MB}MB. Compr√≠mala o env√≠e una versi√≥n m√°s ligera.`);
      return;
    }

    const okType = (file.type || '').startsWith('image/') || file.type === 'application/pdf';
    if(!okType){ alert('Formato no permitido. Use JPG/PNG o PDF.'); return; }

    const btn = document.getElementById('tSend');
    if(btn){ btn.disabled = true; btn.textContent = 'Enviando...'; }

    const reference_code = genRefCode();
    const deposit_datetime = dtRaw ? new Date(dtRaw).toISOString() : null;

    try{
      const topupId = (crypto?.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random()}` );
      const ext = extFromFile(file);
      const receipt_path = `${session.user.id}/${topupId}/receipt.${ext}`;

      const up = await sb.storage.from('topup-receipts').upload(receipt_path, file, {
        cacheControl: '3600',
        upsert: false,
        contentType: file.type || undefined
      });
      if(up.error){
        console.error(up.error);
        alert('No se pudo subir la boleta. Intente de nuevo.');
        return;
      }

      const ins = await sb.from('topups').insert({
        user_id: session.user.id,
        account_id: CURRENT_ACCOUNT_ID,
        amount,
        currency: 'GTQ',
        provider: 'bank_transfer',
        status: 'pending',
        reference_code,
        bank_name: bank || null,
        deposit_datetime,
        receipt_path,
        notes: notes || null,
        provider_ref: null,
        checkout_url: null,
        idempotency_key: null,
        webhook_event_id: null
      });

      if(ins.error){
        console.error(ins.error);
        try{ await sb.storage.from('topup-receipts').remove([receipt_path]); }catch(e){}
        alert('No se pudo registrar la recarga. Intente de nuevo.');
        return;
      }

      showMessage(
        `Recarga enviada con √©xito.<br><br>
         <b>C√≥digo:</b> ${reference_code}<br>
         Un administrador revisar√° su boleta y acreditar√° el capital.`
      );

      document.getElementById('txStep1')?.classList.remove('tx-step-active');
      document.getElementById('txStep2')?.classList.add('tx-step-active');

      tdlg?.close();
      if(document.getElementById('tAmount')) document.getElementById('tAmount').value = '';
      if(document.getElementById('tBank')) document.getElementById('tBank').value = '';
      if(document.getElementById('tNotes')) document.getElementById('tNotes').value = '';
      if(document.getElementById('tDate')) document.getElementById('tDate').value = '';
      if(fileEl) fileEl.value = '';
    } finally {
      if(btn){ btn.disabled = false; btn.textContent = 'Enviar recarga'; }
    }
  }

  /* === L√ìGICA CAMBIO DE CONTRASE√ëA OBLIGATORIO === */
  let pwdDlg;
  function openPwdDialog(){
    if(!pwdDlg) pwdDlg = document.getElementById('pwdDlg');
    if(!pwdDlg) return;
    pwdDlg.addEventListener('cancel', (e)=> e.preventDefault());
    pwdDlg.showModal();
    const newEl = document.getElementById('pwdNew');
    const confEl = document.getElementById('pwdConfirm');
    const errEl = document.getElementById('pwdError');
    if(newEl) newEl.value = '';
    if(confEl) confEl.value = '';
    if(errEl) errEl.textContent = '';
  }

  async function handleSavePassword(){
    const newEl = document.getElementById('pwdNew');
    const confEl = document.getElementById('pwdConfirm');
    const errEl  = document.getElementById('pwdError');
    if(!newEl || !confEl || !errEl) return;

    const pwd  = (newEl.value || '').trim();
    const cpwd = (confEl.value || '').trim();

    errEl.textContent = '';

    if(pwd.length < 8){ errEl.textContent = 'La contrase√±a debe tener al menos 8 caracteres.'; return; }
    if(pwd !== cpwd){ errEl.textContent = 'Las contrase√±as no coinciden.'; return; }

    const btn = document.getElementById('pwdSave');
    if(btn){ btn.disabled = true; btn.textContent = 'Guardando...'; }

    try{
      const { error: updErr } = await sb.auth.updateUser({ password: pwd });
      if(updErr){
        errEl.textContent = 'No se pudo actualizar la contrase√±a. Int√©ntelo de nuevo.';
        console.error(updErr);
        return;
      }

      const { data:{ user } } = await sb.auth.getUser();
      if(user?.id){
        await sb.from('profiles').update({ must_change_password:false }).eq('id', user.id);
      }

      if(pwdDlg && pwdDlg.open) pwdDlg.close();
      showMessage('Su contrase√±a se actualiz√≥ correctamente. Puede seguir utilizando su panel con normalidad.');
    }finally{
      if(btn){ btn.disabled = false; btn.textContent = 'Guardar contrase√±a'; }
    }
  }

  function togglePwdVisibility(inputId, btnId){
    const input = document.getElementById(inputId);
    const btn   = document.getElementById(btnId);
    if(!input || !btn) return;
    const isPassword = input.type === 'password';
    input.type = isPassword ? 'text' : 'password';
  }

  /* ===== Simulador (plan autom√°tico por monto) ===== */
  function getSimPlanForCapital(cap){
    cap = Number(cap||0);
    if(cap >= 250000) return { plan:'PLATINUM', semPct:20 };
    if(cap >= 2000)   return { plan:'STANDARD', semPct:15 };
    return { plan:'‚Äî', semPct:0 };
  }

  function buildSimRows(cap, semPct){
    const monthlyRate = (Number(semPct||0)/100)/6; // semestral /6
    const rows = [];
    let sum = 0;
    for(let i=1;i<=6;i++){
      const interest = cap * monthlyRate;
      sum += interest;
      rows.push({ month:i, interest });
    }
    return { rows, sum, final: cap + sum };
  }

  function renderSim(cap, semPct){
    const { rows, sum, final } = buildSimRows(cap, semPct);

    const tbody = document.getElementById('simBody');
    if(tbody){
      tbody.innerHTML = '';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.month}</td><td>${fmtQ(r.interest)}</td>`;
        tbody.appendChild(tr);
      });
    }
    const ss = document.getElementById('simSum');
    if(ss) ss.textContent = fmtQ(sum);
    const sf = document.getElementById('simFinal');
    if(sf) sf.textContent = fmtQ(final);
  }

  function handleCalc(){
    const raw = document.getElementById('simCapital')?.value || '';
    const cap = Number(raw.replace(/[,\s]/g,'') || 0);
    const note = document.getElementById('simNote');
    const sp = document.getElementById('simPlan');

    if(cap <= 0){
      if(sp) sp.textContent = '‚Äî';
      if(note) note.textContent = 'Ingrese un capital v√°lido.';
      renderSim(0, 0);
      return;
    }

    const { plan, semPct } = getSimPlanForCapital(cap);

    if(cap < 2000){
      if(sp) sp.textContent = '‚Äî';
      if(note) note.textContent = 'El m√≠nimo para simular es Q 2,000.00.';
      renderSim(cap, 0);
      return;
    }

    if(sp) sp.textContent = `${plan} ‚Äî ${semPct}% semestral`;
    if(note) note.textContent = 'C√°lculo estimado (inter√©s simple).';
    renderSim(cap, semPct);
  }

  /* ===== Cabecera / Carga cuenta ===== */
  async function loadHeader(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ const bust=`no_session=${Date.now()}`; const sep=LOGIN_URL.includes('?')?'&':'?'; window.location.replace(`${LOGIN_URL}${sep}${bust}`); return; }
    const uid=session.user.id;

    const [{ data: prof }, { data: acc }] = await Promise.all([
      sb.from('profiles').select('full_name,email,must_change_password').eq('id',uid).single(),
      sb.from('accounts').select('id,plan,currency,capital,invest_months,interest_pct,joined_at,compound_interest,initial_capital').eq('user_id',uid).single()
    ]);

    const vn = document.getElementById('valName');
    if(vn) vn.textContent = (prof?.full_name || prof?.email || session.user.email || '‚Äî');

    if(!acc){
      ['valAccountId','valPlan','valCurrency','valMonths','valOpenDate','valCloseDate'].forEach(id=>{
        const el=document.getElementById(id); if(el) el.textContent='‚Äî';
      });
      const vc=document.getElementById('valCapital'); if(vc) vc.textContent=fmtQ(0);
      const vpi=document.getElementById('valPeriodInterest'); if(vpi) vpi.textContent=fmtQ(0);

      // Simulador sin datos
      const sp = document.getElementById('simPlan'); if(sp) sp.textContent = '‚Äî';
      renderSim(0,0);

      if(prof?.must_change_password){ openPwdDialog(); }
      return;
    }

    CURRENT_ACCOUNT_ID = acc.id;

    const { data: approvedTopups } = await sb
      .from('topups')
      .select('amount, approved_at, status, account_id')
      .eq('account_id', acc.id)
      .eq('status', 'paid');

    const { data: settlements } = await sb
      .from('interest_settlements')
      .select('period_start, status, paid_at, paid_amount')
      .eq('account_id', acc.id);

    const settlementsMap = {};
    (settlements||[]).forEach(s=>{
      const k = (s.period_start ? s.period_start.toString().slice(0,10) : '');
      if(k) settlementsMap[k] = s;
    });

    const joinedForPeriods = acc.joined_at ? new Date(acc.joined_at) : new Date();
    const periods = buildPeriods(joinedForPeriods, acc.invest_months);
    const events  = buildCapitalEvents(acc, approvedTopups||[]);
    renderStatementTable({ acc, periods, events, settlementsMap });

    const map = {
      valAccountId: acc.id||'‚Äî',
      valPlan: acc.plan||'‚Äî',
      valCurrency: acc.currency||'‚Äî',
      valMonths: acc.invest_months ?? '‚Äî'
    };
    for (const k in map){
      const el=document.getElementById(k);
      if(el) el.textContent=map[k];
    }

    const vc=document.getElementById('valCapital'); if(vc) vc.textContent=fmtQ(acc.capital||0);

    const joined = acc.joined_at ? new Date(acc.joined_at) : new Date();
    const close  = addMonthsSameDay(joined, acc.invest_months||0);

    const vo=document.getElementById('valOpenDate'); if(vo) vo.textContent  = joined.toLocaleDateString('es-GT');
    const vc2=document.getElementById('valCloseDate'); if(vc2) vc2.textContent = close.toLocaleDateString('es-GT');

    const semPct=(acc.interest_pct||0)/100;
    const total= (acc.capital||0) * semPct * ((acc.invest_months||0)/6);
    const vpi=document.getElementById('valPeriodInterest'); if(vpi) vpi.textContent = fmtQ(total);

    paintWeeks(acc, {});

    if(prof?.must_change_password){ openPwdDialog(); }
  }

  /* ===== Navegaci√≥n Home / Recarga ===== */
  function showView(which){
    const home = document.getElementById('viewHome');
    const top  = document.getElementById('viewTopup');
    const btnTop = document.getElementById('btnGoTopup');
    const btnHome = document.getElementById('btnGoHome');

    if(which === 'topup'){
      if(home) home.style.display = 'none';
      if(top) top.style.display = 'block';
      if(btnTop) btnTop.style.display = 'none';
      if(btnHome) btnHome.style.display = 'inline-flex';
      window.location.hash = '#recarga';
    }else{
      if(home) home.style.display = 'block';
      if(top) top.style.display = 'none';
      if(btnTop) btnTop.style.display = 'inline-flex';
      if(btnHome) btnHome.style.display = 'none';
      if(window.location.hash === '#recarga') history.replaceState(null,'', window.location.pathname);
    }
  }

  /* ===== Eventos UI ===== */
  document.getElementById('btnGoTopup')?.addEventListener('click', ()=> showView('topup'));
  document.getElementById('btnGoHome')?.addEventListener('click', ()=> showView('home'));

  // Abrir modal retiro
  document.getElementById('btnOpenWithdraw')?.addEventListener('click', ()=>{
    selectType('early');
    toggleSwitchAll(false);
    dlg?.showModal();
  });
  document.getElementById('xClose')?.addEventListener('click', ()=> dlg?.close());
  document.getElementById('wCancel')?.addEventListener('click', ()=> dlg?.close());

  document.getElementById('optEarly')?.addEventListener('click', ()=> selectType('early'));
  document.getElementById('optHealth')?.addEventListener('click', ()=> selectType('health'));

  document.getElementById('switchAll')?.addEventListener('click', ()=> toggleSwitchAll());
  document.getElementById('switchAll')?.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); toggleSwitchAll(); }
  });

  document.getElementById('wSend')?.addEventListener('click', enviarSolicitudRetiro);

  // Modal mensajes
  document.getElementById('msgClose')?.addEventListener('click', ()=> msgDlg?.close());
  document.getElementById('msgOk')?.addEventListener('click', ()=> msgDlg?.close());

  // Modal topup
  document.getElementById('btnOpenTopup')?.addEventListener('click', ()=>{
    document.getElementById('txStep1')?.classList.remove('tx-step-active');
    document.getElementById('txStep2')?.classList.add('tx-step-active');
    tdlg?.showModal();
  });
  document.getElementById('tClose')?.addEventListener('click', ()=> tdlg?.close());
  document.getElementById('tCancel')?.addEventListener('click', ()=> tdlg?.close());
  document.getElementById('tSend')?.addEventListener('click', enviarTopupTransferencia);

  // Copiar n√∫mero de cuenta
  document.getElementById('btnCopyAcct')?.addEventListener('click', async ()=>{
    const txt = document.getElementById('acctNumber')?.textContent?.trim() || '';
    if(!txt) return;
    try{
      await navigator.clipboard.writeText(txt);
      showMessage('N√∫mero de cuenta copiado al portapapeles.');
    }catch(e){
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      showMessage('N√∫mero de cuenta copiado al portapapeles.');
    }
  });

  // Password toggles
  document.getElementById('pwdNewEye')?.addEventListener('click', ()=> togglePwdVisibility('pwdNew','pwdNewEye'));
  document.getElementById('pwdConfirmEye')?.addEventListener('click', ()=> togglePwdVisibility('pwdConfirm','pwdConfirmEye'));
  document.getElementById('pwdSave')?.addEventListener('click', handleSavePassword);

  // Simulador
  document.getElementById('btnCalc')?.addEventListener('click', handleCalc);

  /* ===== Bind inputs monetarios ===== */
  bindMoneyInput('wAmount');
  bindMoneyInput('simCapital');
  bindMoneyInput('tAmount');

  /* ===== Init ===== */
  (async function init(){
    if(window.location.hash === '#recarga') showView('topup');
    await loadHeader();

    // Inicializa simulador
    const sp = document.getElementById('simPlan');
    if(sp) sp.textContent = '‚Äî';
    renderSim(0, 0);
    const note = document.getElementById('simNote');
    if(note) note.textContent = 'Ingrese un capital y presione Calcular.';
  })();

  </script>
</body>
</html>
