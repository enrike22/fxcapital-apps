<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. ‚Äî Panel Cliente</title>
<style>
:root{--bg:#000;--fg:#fff;--muted:#ffffffcc;--card:#0d0d0d;--border:#1a1a1a}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
.container{max-width:1100px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
h1,h2{margin:0 0 8px} small{color:var(--muted)}
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;margin-right:8px}
.grid-3{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border)} th{text-align:left;color:var(--muted)}
.hidden{display:none}
button{background:#fff;color:#000;border:none;padding:12px 16px;border-radius:999px;font-weight:700;cursor:pointer}
small{color:var(--muted)}

/* ===== MODAL CAMBIO DE CONTRASE√ëA ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:20px;z-index:1000}
.modal-card{width:100%;max-width:560px;background:linear-gradient(180deg,#151515,#1c1c1c);border:1px solid #2a2a2a;border-radius:18px;padding:22px 22px 16px;box-shadow:0 15px 40px #000a;position:relative}
.modal-titlebar{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.modal-titlebar h3{margin:0;font-size:22px}
.close-x{width:36px;height:36px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f0f;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
.modal-sub{color:var(--muted);margin-bottom:14px}
label{display:block;margin:8px 0 4px}

/* inputs con ojo a la derecha - VISIBLE */
.input-wrap{position:relative}
.input-wrap .prefix{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.6}
.input-wrap input{
  width:100%;background:#000;color:#fff;border:1px solid #2a2a2a;border-radius:12px;
  padding:10px 64px 10px 38px;
  height:50px;font-size:16px;
}
.eye-btn{position:absolute;right:6px;top:50%;transform:translateY(-50%);width:46px;height:46px;
  background:transparent;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5}
.eye,.eye-off{width:32px;height:32px;fill:#fff;opacity:.98}
.eye-btn:hover .eye,.eye-btn:hover .eye-off{opacity:1}

.inline{display:flex;align-items:center;gap:10px;margin-top:6px}
.helper{font-size:12px;color:#9fb4d1}
.err{color:#ffb3b3;min-height:18px;text-align:center}
.success{color:#b3ffcb;min-height:18px;text-align:center}
.modal-actions{display:flex;gap:10px;margin-top:12px}
.modal-actions .primary{flex:1;background:#0f0f0f;color:#fff;border:1px solid #2a2a2a}

/* Toast */
.toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
  background:#101b10;border:1px solid #214c21;color:#c6f3c6;padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px #000a;z-index:1100}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>FX | CAPITAL R.L. ‚Äî Panel Cliente</h1>
    <button id="logoutBtn">Cerrar sesi√≥n</button>
  </div>

  <!-- Resumen -->
  <div class="card">
    <h2>Mi cuenta</h2>
    <div class="grid-3">
      <div><span class="badge">Nombre</span><div id="c_name">‚Äî</div></div>
      <div><span class="badge">Plan</span><div id="c_plan">‚Äî</div></div>
      <div><span class="badge">Moneda</span><div id="c_currency">‚Äî</div></div>
      <div><span class="badge">Capital</span><div id="c_capital">‚Äî</div></div>
      <div><span class="badge">Cuenta (ID)</span><div id="c_account">‚Äî</div></div>
      <div><span class="badge">BLACK habilitado</span><div id="c_black">‚Äî</div></div>
    </div>
  </div>

  <!-- Resultados del mes (demo) -->
  <div class="card">
    <h2>Resultados del mes</h2>
    <p id="monthLabel">‚Äî</p>
    <table>
      <thead><tr><th>Viernes</th><th>Inter√©s semanal</th></tr></thead>
      <tbody id="weeks"></tbody>
      <tfoot><tr><th>Total mes</th><th id="monthTotal">‚Äî</th></tr></tfoot>
    </table>
  </div>
</div>

<!-- ===== MODAL PRIMER INGRESO ===== -->
<div id="pwdModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="pwdTitle">
  <div class="modal-card">
    <div class="modal-titlebar">
      <h3 id="pwdTitle">BIENVENIDO A FX | CAPITAL R.L.</h3>
      <button id="pwdCloseX" class="close-x" title="Cerrar">‚úï</button>
    </div>
    <p class="modal-sub">Por motivos de seguridad, le solicitamos actualizar su contrase√±a actual.</p>

    <label>Correo electr√≥nico</label>
    <div class="input-wrap">
      <span class="prefix">‚úâÔ∏è</span>
      <input id="pwdEmail" type="email" placeholder="tu@email.com" autocomplete="email">
    </div>

    <label style="margin-top:8px">Contrase√±a actual</label>
    <div class="input-wrap">
      <span class="prefix">üîí</span>
      <input id="curPwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      <button type="button" class="eye-btn" data-toggle="curPwd" aria-label="mostrar/ocultar">
        <svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>
    </div>

    <label style="margin-top:8px">Nueva contrase√±a</label>
    <div class="input-wrap">
      <span class="prefix">üÜï</span>
      <input id="newPwd" type="password" placeholder="M√≠nimo 8 caracteres" autocomplete="new-password">
      <button type="button" class="eye-btn" data-toggle="newPwd" aria-label="mostrar/ocultar">
        <svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>
    </div>

    <label style="margin-top:8px">Confirmar nueva contrase√±a</label>
    <div class="input-wrap">
      <span class="prefix">‚úÖ</span>
      <input id="confPwd" type="password" placeholder="Repetir nueva contrase√±a" autocomplete="new-password">
      <button type="button" class="eye-btn" data-toggle="confPwd" aria-label="mostrar/ocultar">
        <svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>
      </button>
    </div>

    <div class="inline">
      <input id="showAllPwds" type="checkbox"><label for="showAllPwds" style="margin:0">Mostrar contrase√±as</label>
    </div>
    <div class="helper">Use al menos 8 caracteres. Recomendado: letras, n√∫meros y s√≠mbolos.</div>

    <div id="pwdMsg" class="err"></div>
    <div id="pwdOk" class="success"></div>

    <div class="modal-actions">
      <button id="pwdSubmit" class="primary" type="button">Actualizar contrase√±a</button>
      <button id="pwdCancel" type="button">Cancelar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hidden">Contrase√±a actualizada correctamente.</div>

<!-- SDK de Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/*** CONFIG SUPABASE ***/
const PROJECT_URL="https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE=PROJECT_URL+"/rest/v1";
const supa = supabase.createClient(PROJECT_URL, ANON_KEY);

function hdr(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||"")}}
function hdrJSON(){return{apikey:ANON_KEY,Authorization:"Bearer "+(localStorage.token||""),"Content-Type":"application/json"}}
const GTZ='America/Guatemala';

/*** UTIL ***/
function show(elId,visible){document.getElementById(elId).classList[visible?'remove':'add']('hidden')}
function logout(){localStorage.clear();location.href='cliente-login.html'}
document.getElementById('logoutBtn').onclick=logout;

function money(n,cur){return new Intl.NumberFormat('es-GT',{style:'currency',currency:cur==='USD'?'USD':'GTQ'}).format(n)}
function guateNow(){return new Date(new Date().toLocaleString('en-US',{timeZone:GTZ}))}
function toast(msg){const t=document.getElementById('toast'); t.textContent=msg||'Listo.'; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2200);}

/*** ESTADO ***/
let PROFILE=null,ACCOUNT=null;

/*** CARGA INICIAL (requiere sesi√≥n v√°lida) ***/
(async function boot(){
  if(!localStorage.token){ logout(); return; }

  // Verifica token
  const rUser=await fetch(`${PROJECT_URL}/auth/v1/user`,{headers:{apikey:ANON_KEY,Authorization:`Bearer ${localStorage.token}`}})
  if(!rUser.ok){ logout(); return; }

  // Datos
  const rp=await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}&select=id,full_name,require_password_change,first_login_completed`,{headers:hdr()});
  PROFILE=(await rp.json())[0]||null;

  const ra=await fetch(`${BASE}/accounts?user_id=eq.${localStorage.uid}&select=id,currency,principal_locked,plan,black_enabled`,{headers:hdr()});
  ACCOUNT=(await ra.json())[0]||null;

  // Pintar
  document.getElementById("c_name").textContent=PROFILE?.full_name||"‚Äî";
  document.getElementById("c_plan").textContent=ACCOUNT?.plan||"‚Äî";
  document.getElementById("c_currency").textContent=ACCOUNT?.currency||"‚Äî";
  document.getElementById("c_capital").textContent=money(ACCOUNT?.principal_locked||0,ACCOUNT?.currency||"GTQ");
  document.getElementById("c_account").textContent=ACCOUNT?.id||"‚Äî";
  document.getElementById("c_black").textContent=ACCOUNT?.black_enabled?"S√≠":"No";

  // Demo resultados
  buildMonthResults();

  // MOSTRAR MODAL (primera vez u obligatorio)
  const mustByPolicy = PROFILE?.require_password_change===true;
  const firstNotDone = PROFILE?.first_login_completed!==true;

  // Anti ‚Äúrebote‚Äù por latencia: no reabrir si acaba de cambiar la contrase√±a (2 min)
  const just = Number(localStorage.pwdJustChangedAt||0);
  const avoidReopen = just && (Date.now()-just < 120000);

  if(!avoidReopen && (mustByPolicy || firstNotDone)) openPwdModal(true);

  // Eventos modal
  document.getElementById('pwdSubmit').onclick=submitPasswordChange;
  document.getElementById('pwdCancel').onclick=closePwdModal;
  document.getElementById('pwdCloseX').onclick=closePwdModal;
  document.getElementById('showAllPwds').addEventListener('change',(e)=>{
    ['curPwd','newPwd','confPwd'].forEach(id=>{
      const el=document.getElementById(id); el.type=e.target.checked?'text':'password';
    });
  });

  // toggles (ojos)
  document.addEventListener('click',(e)=>{
    const btn=e.target.closest('.eye-btn'); if(!btn) return;
    const id=btn.getAttribute('data-toggle'); const el=document.getElementById(id); if(!el) return;
    el.type=(el.type==='password')?'text':'password';
    btn.innerHTML=(el.type==='password')
      ? `<svg class="eye" viewBox="0 0 24 24"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/></svg>`
      : `<svg class="eye-off" viewBox="0 0 24 24"><path d="M2 5l2-2 17 17-2 2-3.6-3.6C13.7 19 12.9 19 12 19 5 19 2 12 2 12a17 17 0 0 1 5.2-6.3L2 5zm7.3 2.9A5 5 0 0 0 7 12a5 5 0 0 0 5 5c.6 0 1.1-.1 1.6-.3L9.3 7.9zM12 5c7 0 10 7 10 7a16.8 16.8 0 0 1-3.2 4.7l-1.5-1.5A14.6 14.6 0 0 0 20 12s-3-7-8-7c-1 0-2 .2-2.9 .5L7.7 4.1C9 3.7 10.4 3.5 12 3.5z"/></svg>`;
  });

})();

function buildMonthResults(){
  const PLAN_RATES={STANDARD:0.15/6,PLATINUM:0.20/6,BLACK:0.25/6};
  if(!ACCOUNT) return;
  const now=guateNow(); const y=now.getFullYear(), m0=now.getMonth();
  document.getElementById('monthLabel').textContent=now.toLocaleString('es-GT',{timeZone:GTZ,month:'long',year:'numeric'});
  const frs=[]; const d=new Date(Date.UTC(y,m0,1));
  while(d.getUTCMonth()===m0){ const local=new Date(d.toLocaleString('en-US',{timeZone:GTZ})); if(local.getDay()===5) frs.push(new Date(local)); d.setUTCDate(d.getUTCDate()+1);}
  const parts=randomParts((ACCOUNT.principal_locked||0)*(PLAN_RATES[ACCOUNT.plan]||0), frs.length);
  const tb=document.getElementById('weeks'); tb.innerHTML='';
  frs.forEach((f,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${f.toLocaleDateString('es-GT',{timeZone:GTZ})}</td><td>${money(parts[i],ACCOUNT.currency)}</td>`; tb.appendChild(tr); });
  document.getElementById('monthTotal').textContent=money(parts.reduce((a,b)=>a+b,0), ACCOUNT.currency);
}
function randomParts(total,n){if(n<=0)return[];const xs=Array.from({length:n},()=>Math.random()+0.5);const s=xs.reduce((a,b)=>a+b,0);return xs.map(v=> total*(v/s));}

/*** Modal helpers ***/
function openPwdModal(force){
  // Si es obligatorio, escondemos cancelar y la X; si no, permitimos cerrar
  document.getElementById('pwdCancel').style.display = force ? 'none' : 'inline-block';
  document.getElementById('pwdCloseX').style.display = force ? 'none' : 'flex';

  document.getElementById('pwdEmail').value = localStorage.email || '';
  ['curPwd','newPwd','confPwd'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('pwdMsg').textContent=''; document.getElementById('pwdOk').textContent='';
  document.getElementById('pwdModal').classList.remove('hidden');
}
function closePwdModal(){ document.getElementById('pwdModal').classList.add('hidden'); }

/*** Cambio de contrase√±a con supabase-js ***/
async function submitPasswordChange(){
  const email=(document.getElementById('pwdEmail').value||'').trim();
  const cur=document.getElementById('curPwd').value;
  const neo=document.getElementById('newPwd').value;
  const rep=document.getElementById('confPwd').value;
  const err=document.getElementById('pwdMsg'); const ok=document.getElementById('pwdOk'); err.textContent=''; ok.textContent='';

  if(!email||!cur||!neo||!rep){ err.textContent='Complete todos los campos.'; return; }
  if(neo.length<8){ err.textContent='La nueva contrase√±a debe tener al menos 8 caracteres.'; return; }
  if(neo!==rep){ err.textContent='La confirmaci√≥n no coincide.'; return; }

  // 1) Verificar credenciales actuales
  const { error: signInErr, data: signInData } = await supa.auth.signInWithPassword({ email, password: cur });
  if (signInErr) { err.textContent='Correo o contrase√±a actual incorrectos.'; return; }

  // 2) Cambiar contrase√±a usando el token actual
  const { error: updErr } = await supa.auth.updateUser({ password: neo });
  if (updErr) { err.textContent = updErr.message || 'No se pudo actualizar la contrase√±a.'; return; }

  // 3) Re-login con la nueva para refrescar localStorage
  const { data: signInNew, error: signInNewErr } = await supa.auth.signInWithPassword({ email, password: neo });
  if (!signInNewErr && signInNew?.session?.access_token) {
    localStorage.token = signInNew.session.access_token;
    localStorage.uid   = signInNew.user.id;
    localStorage.email = email;
  }

  // 4) Marcar primer ingreso completado
  try{
    await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}`,{
      method:'PATCH',headers:hdrJSON(),
      body:JSON.stringify({ first_login_completed:true, require_password_change:false, last_password_changed_at:new Date().toISOString() })
    });
  }catch{}

  // Guard para no reabrir modal si los flags tardan en replicar
  localStorage.pwdJustChangedAt = Date.now().toString();

  ok.textContent='Contrase√±a actualizada correctamente.';
  setTimeout(()=>{ closePwdModal(); toast('Contrase√±a actualizada correctamente.'); }, 250);
}
</script>
</body>
</html>
