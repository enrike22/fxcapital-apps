<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FX | CAPITAL R.L. — Panel del Cliente</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0b0d;
    --panel:#121316;
    --card:#17191d;
    --soft:#21242b;
    --muted:#9aa1ac;
    --txt:#f5f7fb;
    --brand:#5ea1ff;
    --accent:#3d73ff;
    --ok:#1ed760;
    --danger:#ff4d4f;
    --outline:rgba(255,255,255,.08);
    --shadow:0 10px 30px rgba(0,0,0,.35);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:radial-gradient(1200px 800px at 10% -20%, #1a1d24 0%, #0b0b0d 55%) fixed;
    color:var(--txt); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{max-width:1100px;margin:36px auto;padding:0 20px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px}
  .brand{display:flex;gap:14px;align-items:center}
  .brand-logo{width:46px;height:46px;border-radius:12px;background: radial-gradient(120% 120% at 20% 20%, #7fb3ff 0%, #3a6dff 40%, #1b2a57 80%);box-shadow:var(--shadow)}
  .brand h1{margin:0;font-weight:800;letter-spacing:.5px;font-size:clamp(22px,2.9vw,36px)}
  .brand h1 span{opacity:.9;font-weight:700}
  .btn{appearance:none;border:0;border-radius:999px;padding:12px 18px;font-weight:600;background:#fff;color:#000;cursor:pointer;box-shadow:var(--shadow)}
  .btn.secondary{background:var(--soft);color:var(--txt);border:1px solid var(--outline)}
  .btn.danger{background:var(--danger);color:#fff}
  .panel{background:var(--panel);border:1px solid var(--outline);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card{background:var(--card);border:1px solid var(--outline);border-radius:var(--radius)}
  .section{padding:22px}
  .grid{display:grid;gap:14px}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:920px){ .grid.cols-3{grid-template-columns:1fr 1fr} }
  @media (max-width:680px){ .grid.cols-3,.grid.cols-2{grid-template-columns:1fr} header{align-items:flex-start;gap:16px}}
  .group{padding:18px 20px}
  .k{display:inline-block;font-size:13px;color:var(--muted);background:#0f1116;border:1px solid var(--outline);padding:6px 10px;border-radius:999px;margin-bottom:8px}
  .v{display:block;font-size:15px;font-weight:600}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:14px 16px;border-bottom:1px solid var(--outline)}
  .table th{color:var(--muted);font-weight:600;text-align:left}
  .sum-row td{font-weight:700}
  .note{color:var(--muted);font-size:13px;margin-top:10px}
  dialog{border:0;border-radius:20px;background:linear-gradient(180deg,#14161b 0%, #0f1116 100%);color:var(--txt);width:min(840px,92vw)}
  dialog::backdrop{background:rgba(0,0,0,.55)}
  .modal-h{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--outline)}
  .modal-b{padding:18px 22px}
  .pill{border:1px solid var(--outline);border-radius:14px;padding:12px 14px}
  .input, textarea{width:100%;border:1px solid var(--outline);background:#0f1116;color:var(--txt);border-radius:12px;padding:12px 14px;outline:none}
  textarea{min-height:120px;resize:vertical}
  .row{display:grid;gap:14px;grid-template-columns:1fr 1fr}
  @media (max-width:720px){ .row{grid-template-columns:1fr} }
  .switch{--w:42px;--h:24px;--knob:18px;inline-size:var(--w);block-size:var(--h);background:#2a2d34;border-radius:999px;border:1px solid var(--outline);position:relative;cursor:pointer;transition:.2s ease}
  .switch::after{content:"";position:absolute;inline-size:var(--knob);block-size:var(--knob);border-radius:50%;background:#fff;top:50%;left:3px;translate:0 -50%;transition:.2s ease;box-shadow:0 3px 10px rgba(0,0,0,.3)}
  .switch.on{background:linear-gradient(90deg,#2b7cff,#6ba9ff)}
  .switch.on::after{left:calc(var(--w) - var(--knob) - 3px)}
  .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}
  .btn.full{width:100%;border-radius:14px;padding:14px 16px;font-size:15px}
  .muted{color:var(--muted)}
  /* Bloqueo del panel cuando la contraseña es obligatoria */
  .blocker{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);display:none}
  .blocker.on{display:block}
</style>
</head>
<body>
  <div class="wrap" id="appWrap">
    <header>
      <div class="brand">
        <div class="brand-logo" title="FX Capital"></div>
        <h1>FX <span>| CAPITAL R.L.</span> — Panel del Cliente</h1>
      </div>
      <button class="btn" id="btnSignOut">Cerrar sesión</button>
    </header>

    <!-- MI CUENTA -->
    <section class="panel section">
      <h2 style="margin:0 0 14px 0">Mi cuenta</h2>
      <div class="grid cols-3">
        <div class="card group"><span class="k">Nombre</span><span id="valName" class="v">—</span></div>
        <div class="card group"><span class="k">Plan</span><span id="valPlan" class="v">—</span></div>
        <div class="card group"><span class="k">Moneda</span><span id="valCurrency" class="v">—</span></div>
        <div class="card group"><span class="k">Cuenta (ID)</span><span id="valAccountId" class="v">—</span></div>
        <div class="card group"><span class="k">Período (meses)</span><span id="valMonths" class="v">—</span></div>
        <div class="card group"><span class="k">Capital</span><span id="valCapital" class="v">Q 0.00</span></div>
        <div class="card group" style="grid-column:1 / -1">
          <span class="k">Interés total del período</span><span id="valPeriodInterest" class="v">Q 0.00</span>
        </div>
      </div>
      <div style="margin-top:16px">
        <button class="btn secondary" id="btnOpenWithdraw">Solicitar retiro</button>
      </div>
    </section>

    <!-- RESULTADOS DEL MES -->
    <section class="panel section" style="margin-top:18px">
      <h2 style="margin:0 0 10px 0">Resultados del mes</h2>
      <div class="muted" id="monthRange">—</div>
      <div style="overflow:auto;margin-top:8px">
        <table class="table" id="weekTable">
          <thead>
            <tr><th>Viernes</th><th>Interés semanal</th></tr>
          </thead>
          <tbody id="weekBody">
            <tr><td>—</td><td>—</td></tr>
          </tbody>
          <tfoot>
            <tr class="sum-row"><td>Total mes</td><td id="weekSum">—</td></tr>
          </tfoot>
        </table>
      </div>
      <div id="monthNote" class="note">El período cierra el —.</div>
    </section>

    <!-- SIMULADOR -->
    <section class="panel section" style="margin-top:18px">
      <h2 style="margin:0 0 4px 0">Simulador de crecimiento</h2>
      <div class="muted" style="margin-bottom:14px">
        Interés simple por <b>6 meses</b>, según el plan asignado automáticamente por monto.
      </div>
      <div class="grid cols-3">
        <div class="group card">
          <span class="k">Capital a simular (Q)</span>
          <input id="simCapital" class="input" type="number" min="0" placeholder="Ej. 40,000" />
        </div>
        <div class="group card"><span class="k">Plan asignado (auto)</span><div id="simPlan" class="v">—</div></div>
        <div class="group card"><span class="k">Capital final estimado</span><div id="simFinal" class="v">Q 0.00</div></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
        <button class="btn" id="btnCalc">Calcular</button>
        <span id="simNote" class="note"></span>
      </div>
      <div style="overflow:auto;margin-top:12px">
        <table class="table" id="simTable">
          <thead><tr><th>Mes</th><th>Interés del mes</th></tr></thead>
          <tbody id="simBody"><tr><td>1</td><td>Q 0.00</td></tr></tbody>
          <tfoot><tr class="sum-row"><td>Interés total acumulado</td><td id="simSum">Q 0.00</td></tr></tfoot>
        </table>
      </div>
    </section>
  </div>

  <!-- BLOQUEO (cuando se exige cambio de contraseña) -->
  <div class="blocker" id="panelBlocker"></div>

  <!-- MODAL RETIRO -->
  <dialog id="wdlg">
    <div class="modal-h">
      <div style="font-weight:800">Solicitud de retiro</div>
      <button class="btn secondary" style="padding:8px 12px" id="xClose">✕</button>
    </div>
    <div class="modal-b">
      <div class="row">
        <div class="pill" id="optEarly" tabindex="0" style="cursor:pointer">
          <div style="font-weight:700;margin-bottom:6px">Antes de tiempo</div>
          <div class="muted">Aplicará una penalización del 10%.</div>
        </div>
        <div class="pill" id="optHealth" tabindex="0" style="cursor:pointer">
          <div style="font-weight:700;margin-bottom:6px">Causas de salud</div>
          <div class="muted">Exento de penalización.</div>
        </div>
      </div>
      <div class="row" style="margin-top:14px">
        <div>
          <div class="k">Monto a retirar (Q)</div>
          <input id="wAmount" class="input" type="number" min="0" placeholder="Ej. 5,000">
          <div class="note">Si el retiro es parcial, debe permanecer al menos <b>Q 2,000</b>.</div>
        </div>
        <div>
          <div class="k">Motivo</div>
          <textarea id="wReason" placeholder="Explique brevemente el motivo…"></textarea>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin:16px 0">
        <div id="switchAll" class="switch" role="switch" aria-checked="false" tabindex="0"></div>
        <div>Retirar todo mi capital</div>
      </div>
      <div class="actions">
        <button class="btn secondary" id="wCancel">Cancelar</button>
        <button class="btn full" id="wSend">Enviar solicitud</button>
      </div>
    </div>
  </dialog>

  <!-- MODAL CAMBIO DE CONTRASEÑA FORZADO -->
  <dialog id="forcePwdDlg">
    <div class="modal-h">
      <div style="font-weight:800">Por seguridad, cambia tu contraseña</div>
    </div>
    <div class="modal-b">
      <p class="muted" style="margin-top:0">Este paso es obligatorio sólo la primera vez que ingresas.</p>
      <div class="row">
        <div>
          <div class="k">Nueva contraseña</div>
          <input id="newPwd" class="input" type="password" minlength="8" placeholder="Mínimo 8 caracteres">
        </div>
        <div>
          <div class="k">Confirmar contraseña</div>
          <input id="newPwd2" class="input" type="password" minlength="8" placeholder="Repite la contraseña">
        </div>
      </div>
      <div class="actions">
        <button class="btn danger" id="logoutNow">Salir sin cambiar</button>
        <button class="btn" id="savePwd">Guardar y continuar</button>
      </div>
    </div>
  </dialog>

  <!-- Supabase + Lógica -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
  /* === CONFIG === */
  const SUPABASE_URL = 'https://czvpehbubfrinutztnwh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY';
  const LOGIN_PATH = '/cliente-login.html';
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true} });

  /* === HELPERS === */
  const $ = s=>document.querySelector(s);
  function fmtQ(n){ try{ return new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ'}).format(n||0) }catch(e){ return `Q ${(Number(n)||0).toFixed(2)}` } }
  function setText(id,val){ const el=document.getElementById(id); if(el) el.textContent=(val ?? '—'); }
  function clampDate(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }

  // misma fecha del mes siguiente (si el mes no tiene ese día, cae al último día)
  function nextMonthSameDay(d){
    const x=clampDate(d);
    const target=new Date(x.getFullYear(), x.getMonth()+1, x.getDate());
    while(target.getMonth() !== (x.getMonth()+1)%12){ target.setDate(target.getDate()-1); }
    target.setHours(0,0,0,0);
    return target;
  }
  // ventana mensual que contiene "today"
  function currentWindow(joinedAt, today){
    let start=clampDate(joinedAt);
    let end=nextMonthSameDay(start);
    while(end <= today){ start = end; end = nextMonthSameDay(start); }
    return {start,end};
  }
  // viernes siguiente (o mismo día si ya es viernes)
  function nextFriday(date){
    const x=clampDate(date);
    const dow=x.getDay(); // 0 dom .. 6 sab
    const add=(5 - dow + 7) % 7; // 5 = viernes
    const f=new Date(x); f.setDate(x.getDate()+add); f.setHours(0,0,0,0); return f;
  }
  // ¿está d en [a,b)?
  function inRange(d,a,b){ return d>=a && d<b; }
  // cuenta viernes en rango (por si quieres usarlo)
  function countFridaysInRange(start,end){
    let f=nextFriday(start); if(f<start) f.setDate(f.getDate()+7);
    let c=0; while(f<end){ c++; f.setDate(f.getDate()+7); } return Math.max(c,4);
  }

  /* === CARGA CABECERA & RESULTADOS === */
  async function loadHeader(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ window.location.replace(LOGIN_PATH); return; }
    const uid=session.user.id;

    // Perfil + bandera de contraseña + cuenta
    const [{ data: prof }, { data: acc }] = await Promise.all([
      sb.from('profiles').select('full_name,email,must_change_password').eq('id',uid).single(),
      sb.from('accounts').select('id,plan,currency,capital,invest_months,interest_pct,joined_at').eq('user_id',uid).single()
    ]);

    // Forzar cambio de contraseña si corresponde
    const mustChange = !!(prof && prof.must_change_password === true);
    if(mustChange){ enforcePasswordChange(); }

    setText('valName', (prof?.full_name || prof?.email || session.user.email));

    if(!acc){
      setText('valAccountId','—'); setText('valPlan','—'); setText('valCurrency','—'); setText('valMonths','—');
      setText('valCapital',fmtQ(0)); setText('valPeriodInterest',fmtQ(0));
      paintWeeksEmpty(); return;
    }

    setText('valAccountId', acc.id||'—');
    setText('valPlan', acc.plan||'—');
    setText('valCurrency', acc.currency||'—');
    setText('valMonths', acc.invest_months ?? '—');
    setText('valCapital', fmtQ(acc.capital||0));

    const semPct = (acc.interest_pct||0)/100;
    const totalPeriodInterest = (acc.capital||0) * semPct * ((acc.invest_months||0)/6);
    setText('valPeriodInterest', fmtQ(totalPeriodInterest));

    paintCurrentMonth(acc);
  }

  function paintWeeksEmpty(){
    const tb = $('#weekBody'); tb.innerHTML = `<tr><td>—</td><td>—</td></tr>`;
    $('#weekSum').textContent = '—';
    $('#monthRange').textContent = '—';
    $('#monthNote').textContent = 'El período cierra el —.';
  }

  function paintWeekRow(date, amount, footer){
    const tb = $('#weekBody'); tb.innerHTML = '';
    if(date && amount!=null){
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${date.toLocaleDateString('es-GT')}</td><td>${fmtQ(amount)}</td>`;
      tb.appendChild(tr);
    } else {
      tb.innerHTML = `<tr><td>—</td><td>—</td></tr>`;
    }
    $('#weekSum').textContent = (footer===undefined? '—' : (footer===null? '—' : fmtQ(footer)));
  }

  function paintCurrentMonth(acc){
    const today=clampDate(new Date());
    const joined = acc?.joined_at ? clampDate(new Date(acc.joined_at)) : today;

    const {start,end} = currentWindow(joined, today);
    $('#monthRange').textContent = `${start.toLocaleDateString('es-GT')} — ${end.toLocaleDateString('es-GT')}`;
    $('#monthNote').textContent  = `El período cierra el ${end.toLocaleDateString('es-GT')}.`;

    const capital = Number(acc.capital||0);
    const semRate = Number(acc.interest_pct||0)/100;
    const monthlyInterest = capital * (semRate/6);

    // Si el mes YA cerró, sólo total mensual
    if(today >= end){
      paintWeekRow(null,null, monthlyInterest);
      return;
    }

    // Mostrar SIEMPRE el PRÓXIMO viernes dentro del período
    let f = nextFriday(today);
    if(f < start) f = nextFriday(start);
    if(!inRange(f, start, end)){
      // si el próximo viernes se pasa del fin, intenta el viernes anterior dentro del rango
      const prev = new Date(f); prev.setDate(f.getDate()-7);
      if(inRange(prev, start, end)){ f = prev; } else { paintWeekRow(null,null,'—'); return; }
    }

    const nWeeks = countFridaysInRange(start,end);
    const weekly = monthlyInterest / nWeeks;
    paintWeekRow(f, weekly, undefined); // footer em-dash hasta que cierre el mes
  }

  /* === SIMULADOR (6 meses, simple) === */
  function autoPlanAndRate(capital){
    if(capital >= 2000 && capital < 250000) return {name:'STANDARD (15% semestral)', rate:0.15};
    if(capital >= 250000)                return {name:'PLATINUM (20% semestral)', rate:0.20};
    return {name:'NO ELEGIBLE', rate:0};
  }
  function simulate(){
    const cap=Number($('#simCapital').value||0);
    const {name,rate}=autoPlanAndRate(cap);
    $('#simPlan').textContent=name;
    const months=6, monthlyInterest=cap*(rate/6), total=monthlyInterest*months;
    $('#simFinal').textContent=fmtQ(cap+total);
    $('#simSum').textContent=fmtQ(total);
    $('#simNote').textContent=`Plan: ${name}. Tasa semestral ${(rate*100).toFixed(0)}%. Tasa mensual ${(rate/6*100).toFixed(2)}%.`;
    const body=$('#simBody'); body.innerHTML='';
    for(let m=1;m<=months;m++){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${m}</td><td>${fmtQ(monthlyInterest)}</td>`; body.appendChild(tr); }
  }

  /* === RETIROS === */
  const dlg=$('#wdlg');
  let withdrawType='early';
  function selectType(t){
    withdrawType=t;
    $('#optEarly').style.borderColor = t==='early' ? 'rgba(94,161,255,.7)' : 'var(--outline)';
    $('#optHealth').style.borderColor= t==='health'? 'rgba(94,161,255,.7)' : 'var(--outline)';
  }
  function toggleSwitchAll(force){
    const sw=$('#switchAll'); const on=(typeof force==='boolean')? force : !sw.classList.contains('on');
    sw.classList.toggle('on',on); sw.setAttribute('aria-checked',String(on)); $('#wAmount').disabled=on;
  }
  async function sendWithdraw(){
    const { data:{ session } } = await sb.auth.getSession();
    if(!session){ window.location.replace(LOGIN_PATH); return; }
    const { data: acc } = await sb.from('accounts').select('capital,id').eq('user_id',session.user.id).single();
    const capital=Number(acc?.capital||0);
    const all=$('#switchAll').classList.contains('on');
    const amount=all? capital : Number($('#wAmount').value||0);
    const reason=($('#wReason').value||'').trim();
    if(!all){
      if(amount<=0){ alert('Ingrese un monto válido.'); return; }
      if(amount>capital){ alert('El monto no puede ser mayor al capital disponible.'); return; }
      const restante=capital-amount; if(restante<2000){ alert('Debe permanecer al menos Q 2,000 de capital (a menos que retire todo).'); return; }
    }
    if(reason.length<5){ alert('Describa brevemente el motivo.'); return; }
    const { error } = await sb.from('withdrawal_requests').insert({ request_type:withdrawType, amount:amount, reason:reason });
    if(error){ alert('No se pudo enviar la solicitud.\n'+(error.message||error)); return; }
    alert('Hemos recibido su solicitud; será atendida en un lapso no mayor a 24 horas hábiles.');
    dlg.close();
  }

  /* === CAMBIO DE CONTRASEÑA FORZADO === */
  const forceDlg = $('#forcePwdDlg');
  const blocker = $('#panelBlocker');

  function lockPanel(lock){
    blocker.classList.toggle('on', !!lock);
    // opcional: deshabilitar botones si quieres
    document.querySelectorAll('button,input,textarea,select').forEach(el=>{
      if(el.closest('#forcePwdDlg')) return; // no bloquear el modal
      el.disabled = !!lock;
    });
  }

  function enforcePasswordChange(){
    lockPanel(true);
    forceDlg.showModal();
  }

  async function saveNewPassword(){
    const p1 = ($('#newPwd').value||'').trim();
    const p2 = ($('#newPwd2').value||'').trim();
    if(p1.length < 8){ alert('La contraseña debe tener al menos 8 caracteres.'); return; }
    if(p1 !== p2){ alert('Las contraseñas no coinciden.'); return; }

    const { data:{ session }, error:gsErr } = await sb.auth.getSession();
    if(gsErr || !session){ alert('Sesión no válida.'); window.location.replace(LOGIN_PATH); return; }

    const up = await sb.auth.updateUser({ password: p1 });
    if(up.error){ alert('No se pudo actualizar la contraseña: ' + up.error.message); return; }

    // Quitar la obligación en profiles.must_change_password
    const upd = await sb.from('profiles').update({ must_change_password:false }).eq('id',session.user.id);
    if(upd.error){ 
      // si el campo no existe o falla, al menos permite continuar
      console.warn('No se pudo actualizar must_change_password:', upd.error.message);
    }
    forceDlg.close();
    lockPanel(false);
    alert('¡Contraseña actualizada! Bienvenido al panel.');
  }

  /* === INIT === */
  document.addEventListener('DOMContentLoaded', ()=>{
    $('#btnSignOut').addEventListener('click', async ()=>{ await sb.auth.signOut(); window.location.replace(LOGIN_PATH); });
    $('#btnOpenWithdraw').addEventListener('click', ()=> dlg.showModal());
    $('#xClose').addEventListener('click', ()=> dlg.close());
    $('#wCancel').addEventListener('click', ()=> dlg.close());
    $('#wSend').addEventListener('click', sendWithdraw);
    $('#optEarly').addEventListener('click', ()=>selectType('early'));
    $('#optHealth').addEventListener('click', ()=>selectType('health'));
    selectType('early');
    const sw=$('#switchAll'); sw.addEventListener('click', ()=>toggleSwitchAll()); sw.addEventListener('keydown',(e)=>{ if(e.key===' '||e.key==='Enter'){ e.preventDefault(); toggleSwitchAll(); } });
    $('#btnCalc').addEventListener('click', simulate);

    // Forzado de contraseña
    $('#savePwd').addEventListener('click', saveNewPassword);
    $('#logoutNow').addEventListener('click', async ()=>{ await sb.auth.signOut(); window.location.replace(LOGIN_PATH); });

    loadHeader();
  });
  </script>
</body>
</html>
