<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>FX | CAPITAL R.L. — Panel Cliente</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#121316;
      --panel-2:#16171b;
      --muted:#9aa0a6;
      --text:#f4f5f6;
      --accent:#3d68ff;
      --accent-2:#2b49b6;
      --ok:#1db954;
      --danger:#ff4747;
      --chip:#1e2026;
      --chip-text:#e3e6ea;
      --divider:#22232a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }
    .container{max-width:1140px;margin:20px auto 80px;padding:0 20px}
    header{
      display:flex;align-items:center;justify-content:space-between;margin:12px 0 22px 0;
    }
    .brand{
      display:flex;align-items:center;gap:14px;
    }
    .brand img{
      width:42px;height:42px;border-radius:10px;object-fit:cover;background:#111;box-shadow:var(--shadow)
    }
    .title{
      font-weight:800;letter-spacing:.3px;
      font-size: clamp(22px, 3vw + 10px, 40px);
      line-height:1.05
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      height:44px;padding:0 18px;border-radius:999px;border:1px solid #2b2d35;
      background:#fff;color:#111;font-weight:700;cursor:pointer;transition:.15s ease-in-out;
      box-shadow:var(--shadow)
    }
    .btn:hover{transform:translateY(-1px)}
    .btn-outline{background:transparent;color:var(--text);border-color:#3a3c44}
    .btn-full{width:100%}

    .card{
      background: radial-gradient(1200px 500px at -15% -30%, rgba(61,104,255,.12), transparent 35%) , var(--panel);
      border:1px solid #1b1c22;border-radius:var(--radius);box-shadow:var(--shadow);
      padding:22px 22px;
    }
    .card + .card{margin-top:22px}
    .card h3{margin:0 0 14px 0;font-size:22px;letter-spacing:.2px}
    .grid{
      display:grid;gap:18px;
      grid-template-columns: repeat(12,1fr);
    }
    .section{grid-column:1 / -1}

    .kv{
      display:flex;flex-direction:column;gap:8px;background:var(--panel-2);
      border:1px solid #1d1f26;border-radius:14px;padding:14px 16px;min-height:76px;
    }
    .kv small{color:var(--muted);opacity:.9}
    .chip{
      display:inline-flex;align-items:center;gap:8px;font-weight:600;
      background:var(--chip);color:var(--chip-text);padding:8px 12px;border-radius:999px;border:1px solid #2a2c35;
    }
    .muted{color:var(--muted)}
    .divider{height:1px;background:var(--divider);margin:16px 0}

    @media(min-width:900px){
      .col-3{grid-column: span 3}
      .col-4{grid-column: span 4}
      .col-6{grid-column: span 6}
      .col-8{grid-column: span 8}
      .col-9{grid-column: span 9}
      .col-12{grid-column: span 12}
    }
    @media(max-width:899px){
      .col-3,.col-4,.col-6,.col-8,.col-9,.col-12{grid-column:1 / -1}
    }

    /* Tabla simple */
    table{width:100%;border-collapse:collapse}
    th,td{padding:14px 12px;border-bottom:1px solid var(--divider)}
    th{color:#c9cdd5;text-align:left;font-weight:700}
    td{color:#e6e8ec}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.50);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(940px,92vw);background:linear-gradient(180deg,#14161b,#111216);border:1px solid #22242c;border-radius:20px;box-shadow:var(--shadow);padding:18px 18px 16px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:6px 6px 14px}
    .modal h4{margin:0;font-size:22px}
    .modal-close{height:36px;width:36px;border-radius:10px;display:inline-grid;place-items:center;background:#1a1c22;border:1px solid #2a2c34;color:#c7c9d0;cursor:pointer}
    .modal-grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
    .modal .pill{border:1px solid #2a2d35;border-radius:14px;padding:14px;cursor:pointer;background:#17191f}
    .pill.active{outline:2px solid var(--accent);outline-offset:-2px}
    .label{display:block;margin:10px 0 8px;color:#b8bcc6}
    input[type="text"],input[type="number"],textarea{
      width:100%;background:#0f1014;border:1px solid #2a2c34;border-radius:12px;
      height:44px;color:var(--text);padding:0 12px;font:inherit
    }
    textarea{min-height:140px;padding:12px;resize:vertical}
    .modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:12px}
    .note{color:#98a0aa;font-size:13px}

    /* Switch */
    .switch{
      display:inline-flex;align-items:center;gap:12px;user-select:none;cursor:pointer;margin-top:8px
    }
    .switch input{display:none}
    .track{
      width:52px;height:30px;background:#2a2c36;border:1px solid #3a3d48;border-radius:999px;position:relative;transition:.18s ease-in-out
    }
    .thumb{
      width:24px;height:24px;position:absolute;top:2px;left:2px;border-radius:50%;
      background:#cfd4dc;transition:.2s ease;box-shadow:0 1px 2px rgba(0,0,0,.35)
    }
    .switch input:checked + .track{background:var(--accent)}
    .switch input:checked + .track .thumb{left:26px;background:#fff}

    .btn-bar{display:flex;gap:12px;align-items:center;margin-top:10px}
    .btn-primary{background:var(--accent);border-color:var(--accent-2);color:#fff}
    .btn-primary:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <img src="logo.png" alt="FX | CAPITAL R.L." onerror="this.style.display='none'">
        <div class="title">FX | CAPITAL R.L. — Panel del Cliente</div>
      </div>
      <button id="btnLogout" class="btn btn-outline">Cerrar sesión</button>
    </header>

    <section class="card">
      <h3>Mi cuenta</h3>
      <div class="grid">
        <div class="kv col-4"><small>Nombre</small><div id="kv_name" class="chip muted">—</div></div>
        <div class="kv col-4"><small>Plan</small><div id="kv_plan" class="chip muted">—</div></div>
        <div class="kv col-4"><small>Moneda</small><div id="kv_currency" class="chip muted">—</div></div>

        <div class="kv col-4"><small>Cuenta (ID)</small><div id="kv_acct" class="chip muted">—</div></div>
        <div class="kv col-4"><small>Período (meses)</small><div id="kv_months" class="chip muted">—</div></div>
        <div class="kv col-4"><small>Interés total del período</small><div id="kv_period_int" class="chip">Q 0.00</div></div>

        <div class="kv col-12"><small>Capital</small><div id="kv_capital" class="chip" style="font-size:15px">Q 0.00</div></div>
      </div>
      <div style="margin-top:16px;display:flex;justify-content:flex-start">
        <button class="btn btn-outline" id="btnOpenWithdrawal">Solicitar retiro</button>
      </div>
    </section>

    <section class="card">
      <h3>Resultados del mes</h3>
      <div id="periodLabel" class="muted" style="margin-bottom:10px">—</div>
      <table>
        <thead><tr><th style="width:55%">Viernes</th><th>Interés semanal</th></tr></thead>
        <tbody id="weeklyRows"><tr><td class="muted">—</td><td class="muted">—</td></tr></tbody>
        <tfoot><tr><th>Total mes</th><th id="monthTotal" class="muted">—</th></tr></tfoot>
      </table>
      <div class="note" id="closeNote" style="margin-top:10px"></div>
    </section>

    <section class="card">
      <h3>Simulador de crecimiento</h3>
      <div class="muted" style="margin-top:-8px;margin-bottom:8px">
        Proyección con capitalización <b>no compuesta</b> (interés simple) por <b>6 meses</b>, según el plan asignado automáticamente por monto.
      </div>

      <div class="grid" style="margin-top:8px">
        <div class="col-6">
          <label class="label">Capital a simular (Q)</label>
          <input id="sim_amount" type="number" inputmode="numeric" placeholder="Ej. 40,000"/>
        </div>
        <div class="col-6">
          <label class="label">Plan asignado (auto)</label>
          <div id="sim_plan" class="kv" style="height:44px;display:flex;align-items:center">—</div>
        </div>
        <div class="col-12"><button id="btnSim" class="btn btn-primary">Calcular</button></div>
      </div>

      <div class="grid" style="margin-top:14px">
        <div class="kv col-4"><small>Capital inicial</small><div id="sim_cap_start" class="chip">Q 0.00</div></div>
        <div class="kv col-4"><small>Interés total acumulado</small><div id="sim_interest_total" class="chip">Q 0.00</div></div>
        <div class="kv col-4"><small>Capital final estimado</small><div id="sim_cap_final" class="chip">Q 0.00</div></div>
      </div>

      <div class="divider"></div>
      <h4 style="margin:0 0 8px 0">Interés generado por cada mes</h4>
      <table>
        <thead><tr><th>Mes</th><th>Interés del mes</th></tr></thead>
        <tbody id="sim_monthly_rows">
          <tr><td class="muted">1</td><td class="muted">Q 0.00</td></tr>
          <tr><td class="muted">2</td><td class="muted">Q 0.00</td></tr>
          <tr><td class="muted">3</td><td class="muted">Q 0.00</td></tr>
          <tr><td class="muted">4</td><td class="muted">Q 0.00</td></tr>
          <tr><td class="muted">5</td><td class="muted">Q 0.00</td></tr>
          <tr><td class="muted">6</td><td class="muted">Q 0.00</td></tr>
        </tbody>
      </table>
      <div class="note" id="sim_plan_note" style="margin-top:8px"></div>
    </section>
  </div>

  <!-- Modal retiro -->
  <div class="overlay" id="withdrawModal">
    <div class="modal">
      <div class="modal-head">
        <h4>Solicitud de retiro</h4>
        <button class="modal-close" id="closeWithdraw">✕</button>
      </div>

      <div class="modal-grid" style="margin-bottom:8px">
        <div>
          <div class="label">Seleccione el tipo de retiro</div>
          <div id="optEarly" class="pill active">
            <div style="color:#fff;font-weight:700">Antes de tiempo</div>
            <div class="muted">Aplicará una penalización del 10%.</div>
          </div>
        </div>
        <div>
          <div class="label" style="color:transparent">.</div>
          <div id="optHealth" class="pill">
            <div style="color:#fff;font-weight:700">Causas de salud</div>
            <div class="muted">Exento de penalización.</div>
          </div>
        </div>
      </div>

      <div class="modal-grid">
        <div>
          <label class="label">Monto a retirar (Q)</label>
          <input id="wd_amount" type="number" inputmode="numeric" placeholder="Ej. 5,000">
          <div class="note">Si el retiro es parcial, debe permanecer al menos Q 2,000.</div>

          <label class="switch" for="wd_all">
            <input id="wd_all" type="checkbox">
            <span class="track"><span class="thumb"></span></span>
            <span>Retirar todo mi capital</span>
          </label>
        </div>

        <div>
          <label class="label">Motivo</label>
          <textarea id="wd_reason" placeholder="Explique brevemente el motivo…"></textarea>
        </div>
      </div>

      <div class="btn-bar">
        <button class="btn btn-full btn-primary" id="btnSendWithdraw">Enviar solicitud</button>
        <button class="btn btn-outline" id="btnCancelWithdraw">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.46.1/dist/umd/supabase.js"></script>
  <script>
  // ================== CONFIG (ACTUALIZADO) ==================
  const SUPABASE_URL = "https://czvpehbubfrinutztnwh.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const fmtQ = n => 'Q ' + (Number(n||0)).toLocaleString('es-GT',{minimumFractionDigits:2, maximumFractionDigits:2});
  const byId = id => document.getElementById(id);

  let currentUser = null;
  let account = null;

  (async function init(){
    const { data: { session } } = await sb.auth.getSession();
    if(!session){ location.href = "cliente-login.html"; return; }
    currentUser = session.user;

    await loadOverview();
    await renderWeekly();
    setupUI();
  })();

  async function loadOverview(){
    const { data: prof } = await sb.from('profiles')
      .select('id, full_name')
      .eq('id', currentUser.id)
      .maybeSingle();

    const { data: acc } = await sb.from('accounts')
      .select('id, user_id, capital, currency, plan, invest_months, interest_pct, joined_at')
      .eq('user_id', currentUser.id)
      .maybeSingle();

    account = acc || { id: '—', capital: 0, currency: 'GTQ', plan: '—', invest_months: null, interest_pct: null, joined_at: null };

    byId('kv_name').textContent = prof?.full_name || currentUser.email || '—';
    byId('kv_plan').textContent = account.plan || '—';
    byId('kv_currency').textContent = account.currency || '—';
    byId('kv_acct').textContent = account.id || '—';
    byId('kv_months').textContent = account.invest_months ?? '—';
    byId('kv_capital').textContent = fmtQ(account.capital);

    const pct = (account.interest_pct ?? planPctFromCapital(account.capital));
    const totalPeriod = (account.capital||0) * (pct/100);
    byId('kv_period_int').textContent = fmtQ(totalPeriod);
  }

  function planPctFromCapital(capital){
    const cap = Number(capital||0);
    if(cap >= 250000) return 20;
    if(cap >= 2000) return 15;
    return 0;
  }

  async function renderWeekly(){
    const capital = Number(account?.capital||0);
    const pctSemi = (account?.interest_pct ?? planPctFromCapital(capital));
    const monthlyPct = pctSemi/6;

    let joined = account?.joined_at ? new Date(account.joined_at) : new Date();
    const now = new Date();
    let start = new Date(now.getFullYear(), now.getMonth(), joined.getDate());
    if (now < start) start = new Date(now.getFullYear(), now.getMonth()-1, joined.getDate());
    let end = new Date(start); end.setMonth(end.getMonth()+1);

    const fmtDate = d=>d.toLocaleDateString('es-GT',{day:'2-digit',month:'long',year:'numeric'});
    byId('periodLabel').textContent = `${fmtDate(start)} — ${fmtDate(end)}`;

    const weeks = buildFridaysBetween(start, end);
    const monthlyInterest = capital * (monthlyPct/100);
    const dayCounts = weeks.map(w => (Math.min(end, addDays(w,7)) - w)/(1000*3600*24));
    const totalDays = dayCounts.reduce((a,b)=>a+b,0);
    const portions = dayCounts.map(d => d/totalDays);
    const weekly = portions.map(p => monthlyInterest * p);

    const rows = byId('weeklyRows');
    rows.innerHTML = '';
    let shownTotal = 0;
    for(let i=0;i<weeks.length;i++){
      const inPastWeek = now >= weeks[i];
      if(!inPastWeek) break;
      shownTotal += weekly[i];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${fmtDate(weeks[i])}</td><td>${fmtQ(weekly[i])}</td>`;
      rows.appendChild(tr);
    }

    const monthClosed = now >= end;
    byId('monthTotal').textContent = monthClosed ? fmtQ(monthlyInterest) : '—';
    byId('closeNote').textContent = `El período cierra el ${fmtDate(end)}.`;
  }

  function addDays(d, n){const x=new Date(d); x.setDate(x.getDate()+n); return x;}
  function nextFriday(d){
    const x=new Date(d); const day=x.getDay(); const diff=(5-day+7)%7;
    x.setDate(x.getDate()+diff); return x;
  }
  function buildFridaysBetween(start,end){
    let f = nextFriday(start);
    const out=[];
    while(f<end){ out.push(new Date(f)); f.setDate(f.getDate()+7); }
    return out;
  }

  byId('btnSim').addEventListener('click', ()=>{
    const amt = Number(byId('sim_amount').value||0);
    const plan = autoPlan(amt);
    const pctSemi = plan.pct;
    const monthly = (pctSemi/6);
    const interest6 = amt * (pctSemi/100);
    const final = amt + interest6;

    byId('sim_plan').textContent = `${plan.name} (${pctSemi}% semestral)`;
    byId('sim_cap_start').textContent = fmtQ(amt);
    byId('sim_interest_total').textContent = fmtQ(interest6);
    byId('sim_cap_final').textContent = fmtQ(final);

    const body = byId('sim_monthly_rows');
    body.innerHTML = '';
    for(let i=1;i<=6;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i}</td><td>${fmtQ(amt*(monthly/100))}</td>`;
      body.appendChild(tr);
    }
    byId('sim_plan_note').textContent = `Plan: ${plan.name}. Tasa semestral ${pctSemi}% • Tasa mensual ${(monthly).toFixed(2)}%.`;
  });

  function autoPlan(amt){
    if(amt >= 250000) return { name:'PLATINUM', pct:20 };
    if(amt >= 2000) return { name:'STANDARD', pct:15 };
    return { name:'NO ELEGIBLE', pct:0 };
  }

  const overlay = byId('withdrawModal');
  byId('btnOpenWithdrawal').addEventListener('click', ()=>{
    setType('early');
    byId('wd_amount').value = '';
    byId('wd_reason').value = '';
    byId('wd_all').checked = false;
    overlay.style.display = 'flex';
  });
  byId('closeWithdraw').addEventListener('click', ()=> overlay.style.display='none');
  byId('btnCancelWithdraw').addEventListener('click', ()=> overlay.style.display='none');

  const pillEarly = byId('optEarly');
  const pillHealth = byId('optHealth');
  function setType(t){
    if(t==='early'){ pillEarly.classList.add('active'); pillHealth.classList.remove('active'); }
    else { pillHealth.classList.add('active'); pillEarly.classList.remove('active'); }
  }
  pillEarly.addEventListener('click', ()=> setType('early'));
  pillHealth.addEventListener('click', ()=> setType('health'));

  const wdAll = byId('wd_all');
  document.querySelector('label.switch').addEventListener('click', ()=>{ setTimeout(()=> validateAmount(), 0); });

  byId('wd_amount').addEventListener('input', validateAmount);
  wdAll.addEventListener('change', validateAmount);

  function validateAmount(){
    const all = wdAll.checked;
    const max = Number(account?.capital||0);
    let val = Number(byId('wd_amount').value||0);
    if(all){ byId('wd_amount').value = max; return true; }
    if(val > max){ val = max; byId('wd_amount').value = val; }
    if((max - val) < 2000){
      const allowed = Math.max(0, max - 2000);
      byId('wd_amount').value = allowed;
    }
    return true;
  }

  byId('btnSendWithdraw').addEventListener('click', async ()=>{
    const all = wdAll.checked;
    const amount = Number(byId('wd_amount').value||0);
    const reason = (byId('wd_reason').value||'').trim();
    const type = pillHealth.classList.contains('active') ? 'HEALTH' : 'EARLY';

    if(amount<=0){ alert('Ingrese un monto válido.'); return; }
    if(!all){
      const max = Number(account?.capital||0);
      if(amount>max){ alert('El monto no puede exceder su capital.'); return; }
      if((max-amount)<2000){ alert('Para retiros parciales debe permanecer al menos Q 2,000.'); return; }
    }

    const payload = { account_id: account?.id || null, amount, reason, type };
    const ins = await sb.from('withdrawal_requests').insert(payload).select('id').maybeSingle();
    if(ins.error){ alert('No se pudo enviar la solicitud: ' + ins.error.message); return; }

    try{
      await fetch('/functions/v1/notify-withdrawal', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ account_id: account?.id, user_email: currentUser?.email, user_name: byId('kv_name').textContent || '', amount, type, reason })
      });
    }catch(e){}

    overlay.style.display='none';
    alert('Hemos recibido su solicitud; será atendida en un lapso no mayor a 24 horas hábiles, de lunes a viernes, dentro del horario laboral establecido.');
  });

  byId('btnLogout').addEventListener('click', async ()=>{
    await sb.auth.signOut();
    location.href = 'cliente-login.html';
  });

  function setupUI(){}
  </script>
</body>
</html>
