<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. — Cliente</title>
<style>
:root{--bg:#000;--fg:#fff;--muted:#ffffffcc;--card:#0d0d0d;--border:#1a1a1a;}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
.container{max-width:1100px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
h1,h2,h3{margin:0 0 8px} p{margin:6px 0;color:var(--muted)}
label{display:block;margin:8px 0 4px}
input,select,textarea{width:100%;background:#000;color:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
button{background:#fff;color:#000;border:none;padding:12px 16px;border-radius:999px;font-weight:700;cursor:pointer}
table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border)} th{text-align:left;color:var(--muted)}
.row{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.grid-3{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.hero{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;margin-right:8px}
.hidden{display:none}
.center{display:flex;justify-content:center;align-items:center}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.icon{width:40px;height:40px;background:#000;border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center}
hr{border:0;border-top:1px solid var(--border);margin:12px 0}
small{color:var(--muted)}
</style>
</head>
<body>
<div class="container">

  <!-- Login -->
  <div id="unauth" class="card">
    <h1>Cliente — Iniciar sesión</h1>
    <form id="loginForm">
      <label>Email</label><input id="email" type="email" required>
      <label>Contraseña</label><input id="password" type="password" required>
      <div style="margin-top:12px"><button type="submit">Entrar</button></div>
      <p id="loginMsg"></p>
    </form>
  </div>

  <!-- App -->
  <div id="app" class="hidden">

    <div class="header">
      <h1>FX | CAPITAL R.L. — Panel Cliente</h1>
      <button onclick="logout()">Cerrar sesión</button>
    </div>

    <!-- Hero -->
    <div class="card">
      <div class="hero">
        <div>
          <div class="icon">
            <!-- Escudo -->
            <svg viewBox="0 0 24 24" width="22" height="22" fill="white" aria-hidden="true">
              <path d="M12 2l7 3v6c0 5-3.5 9-7 11-3.5-2-7-6-7-11V5l7-3z"/>
            </svg>
          </div>
          <h2>Seguridad</h2>
          <p>Máxima protección</p>
        </div>
        <div>
          <div class="icon">
            <!-- Flechas trading -->
            <svg viewBox="0 0 24 24" width="22" height="22" fill="white" aria-hidden="true">
              <path d="M4 14h3l2-3 3 5 2-3h6v2h-5l-3 4-3-5-1 2H4zM4 6h16v2H4z"/>
            </svg>
          </div>
          <h2>Rentabilidad</h2>
          <p>Hasta 25% interés semestral*</p>
        </div>
        <div>
          <div class="icon">
            <!-- Candado -->
            <svg viewBox="0 0 24 24" width="22" height="22" fill="white" aria-hidden="true">
              <path d="M12 1a5 5 0 00-5 5v3H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2v-8a2 2 0 00-2-2h-2V6a5 5 0 00-5-5zm-3 8V6a3 3 0 116 0v3H9z"/>
            </svg>
          </div>
          <h2>Control</h2>
          <p>Transparencia total</p>
        </div>
      </div>
      <small>*El porcentaje final depende de su plan.</small>
    </div>

    <!-- Resumen cuenta -->
    <div class="card">
      <h2>Mi cuenta</h2>
      <div class="grid-3">
        <div><span class="badge">Nombre</span><div id="c_name">—</div></div>
        <div><span class="badge">Plan</span><div id="c_plan">—</div></div>
        <div><span class="badge">Moneda</span><div id="c_currency">—</div></div>
        <div><span class="badge">Capital</span><div id="c_capital">—</div></div>
        <div><span class="badge">Cuenta (ID)</span><div id="c_account">—</div></div>
        <div><span class="badge">BLACK habilitado</span><div id="c_black">—</div></div>
      </div>
    </div>

    <!-- Resultados -->
    <div class="card">
      <h2>Resultados del mes</h2>
      <p id="monthLabel">—</p>
      <table>
        <thead><tr><th>Viernes</th><th>Interés semanal</th></tr></thead>
        <tbody id="weeks"></tbody>
        <tfoot>
          <tr><th>Total mes</th><th id="monthTotal">—</th></tr>
        </tfoot>
      </table>
    </div>

    <!-- Calculadora -->
    <div class="card">
      <h2>Calculadora de crecimiento</h2>
      <div class="row">
        <div><label>Capital (GTQ)</label><input id="calc_capital" type="number" min="0" placeholder="Ej. 50000"></div>
        <div><label>Plan asignado</label><input id="calc_plan" disabled></div>
        <div><label>Interés mensual estimado</label><input id="calc_monthly" disabled></div>
      </div>
      <div style="margin-top:10px"><button onclick="runCalculator()">Calcular</button></div>
      <small>El plan se asigna automáticamente por capital. BLACK solo aparece si fue habilitado por el Administrador.</small>
    </div>

    <!-- Retiros -->
    <div class="card">
      <h2>Solicitar retiro de capital</h2>
      <div class="row">
        <div>
          <label>Tipo de solicitud</label>
          <select id="w_type">
            <option value="EARLY">Retiro antes de tiempo (penalización 10%)</option>
            <option value="HEALTH">Causas de Salud (Sin penalización)</option>
          </select>
        </div>
        <div>
          <label>Monto a retirar (opcional)</label>
          <input id="w_amount" type="number" min="0" placeholder="Dejar vacío si es total">
        </div>
      </div>
      <label>Motivo</label>
      <textarea id="w_reason" rows="4" placeholder="Explique brevemente los motivos…"></textarea>
      <div style="margin-top:10px"><button onclick="sendWithdrawal()">Enviar solicitud</button> <span id="w_msg" style="color:var(--muted)"></span></div>
    </div>

  </div>
</div>

<script>
/*** CONFIG SUPABASE ***/
const PROJECT_URL = "https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE = PROJECT_URL + "/rest/v1";

function hdrJSON(){ return { apikey:ANON_KEY, Authorization:"Bearer "+(localStorage.token||""), "Content-Type":"application/json" }; }
function hdr(){ return { apikey:ANON_KEY, Authorization:"Bearer "+(localStorage.token||"") }; }
const GTZ = 'America/Guatemala';

const PLAN_RATES = { STANDARD: 0.15/6, PLATINUM: 0.20/6, BLACK: 0.25/6 }; // mensual estimado (15/20/25% semestral)

/*** LOGIN ***/
document.getElementById("loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const r = await fetch(`${PROJECT_URL}/auth/v1/token?grant_type=password`,{
    method:"POST", headers:{ apikey:ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ email, password })
  });
  const data = await r.json();
  if(!r.ok){ document.getElementById("loginMsg").textContent="Login inválido"; return; }
  localStorage.token = data.access_token; localStorage.uid = data.user.id;
  await init();
});

/*** APP ***/
function show(id,vis){ document.getElementById(id).classList[vis?"remove":"add"]("hidden"); }
function logout(){ localStorage.removeItem("token"); localStorage.removeItem("uid"); location.reload(); }

async function init(){
  if(!localStorage.token){ show("app",false); show("unauth",true); return; }
  show("unauth",false); show("app",true);
  await loadAccount();
  await buildMonthResults();
}

/*** DATA CUENTA ***/
let ACCOUNT=null, PROFILE=null;
async function loadAccount(){
  // profile
  const rp = await fetch(`${BASE}/profiles?id=eq.${localStorage.uid}&select=id,full_name`, { headers: hdr() });
  PROFILE = (await rp.json())[0] || null;

  // account (propia)
  const ra = await fetch(`${BASE}/accounts?user_id=eq.${localStorage.uid}&select=id,currency,principal_locked,plan,black_enabled`, { headers: hdr() });
  ACCOUNT = (await ra.json())[0] || null;

  // pintar
  document.getElementById("c_name").textContent     = PROFILE?.full_name || "—";
  document.getElementById("c_plan").textContent     = ACCOUNT?.plan || "—";
  document.getElementById("c_currency").textContent = ACCOUNT?.currency || "—";
  document.getElementById("c_capital").textContent  = money(ACCOUNT?.principal_locked||0, ACCOUNT?.currency||"GTQ");
  document.getElementById("c_account").textContent  = ACCOUNT?.id || "—";
  document.getElementById("c_black").textContent    = ACCOUNT?.black_enabled ? "Sí" : "No";
}

/*** RESULTADOS MENSUALES (VIERNES) ***/
function money(n,cur){ const fm = new Intl.NumberFormat('es-GT',{style:'currency',currency: cur==='USD'?'USD':'GTQ'}); return fm.format(n); }
function guateNow(){ return new Date(new Date().toLocaleString('en-US',{timeZone:GTZ})); }

function fridaysOfMonth(year, month0){ // month0: 0-11
  const days=[]; const d=new Date(Date.UTC(year,month0,1));
  while(d.getUTCMonth()===month0){
    const local = new Date(d.toLocaleString('en-US',{timeZone:GTZ}));
    if(local.getDay()===5) days.push(new Date(local));
    d.setUTCDate(d.getUTCDate()+1);
  }
  return days;
}

function randomParts(total, n){
  if(n<=0) return [];
  const xs = Array.from({length:n},()=>Math.random()+0.5); // sesgo leve
  const s = xs.reduce((a,b)=>a+b,0);
  return xs.map(v=> total*(v/s) );
}

async function buildMonthResults(){
  if(!ACCOUNT){ return; }
  const now = guateNow();
  const y = now.getFullYear(); const m0 = now.getMonth();
  const label = now.toLocaleString('es-GT',{timeZone:GTZ, month:'long', year:'numeric'});
  document.getElementById("monthLabel").textContent = label;

  const frs = fridaysOfMonth(y,m0);
  const monthlyRate = PLAN_RATES[ACCOUNT.plan] || 0;
  const monthlyInterest = (ACCOUNT.principal_locked||0) * monthlyRate;

  const parts = randomParts(monthlyInterest, frs.length);
  const tbody = document.getElementById("weeks"); tbody.innerHTML="";

  let shownTotal=0;
  frs.forEach((f,i)=>{
    // muestra siempre las semanas (hasta las futuras, como estimado)
    const amt = parts[i];
    shownTotal += amt;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${f.toLocaleDateString('es-GT',{timeZone:GTZ})}</td><td>${money(amt, ACCOUNT.currency)}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById("monthTotal").textContent = money(parts.reduce((a,b)=>a+b,0), ACCOUNT.currency);
}

/*** CALCULADORA (plan automático) ***/
function detectPlan(capital, blackEnabled){
  if(blackEnabled) return 'BLACK';
  if(capital>=250000) return 'PLATINUM';
  if(capital>=2000) return 'STANDARD';
  return 'STANDARD';
}
function runCalculator(){
  const cap = Number(document.getElementById("calc_capital").value||0);
  const plan = detectPlan(cap, ACCOUNT?.black_enabled);
  const monthly = cap * (PLAN_RATES[plan]||0);
  document.getElementById("calc_plan").value = plan;
  document.getElementById("calc_monthly").value = new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ'}).format(monthly);
}

/*** RETIROS ***/
async function sendWithdrawal(){
  if(!ACCOUNT){ return; }
  const type = document.getElementById("w_type").value; // EARLY | HEALTH
  const reason = document.getElementById("w_reason").value.trim();
  const amount = Number(document.getElementById("w_amount").value||0);
  const penalty = (type==='EARLY') ? 10 : 0;

  // 1) crear retiro
  const body = {
    account_id: ACCOUNT.id,
    kind: type,
    reason,
    penalty_pct: penalty,
    amount: amount>0?amount:null,
    status: 'PENDING'
  };
  const r1 = await fetch(`${BASE}/withdrawal_requests`, { method:'POST', headers: hdrJSON(), body: JSON.stringify(body) });
  if(!r1.ok){ document.getElementById("w_msg").textContent="Error creando solicitud"; return; }
  const [ret] = await r1.json();

  // 2) notificación admin
  const notif = {
    type: 'WITHDRAWAL_REQUEST',
    payload: { withdrawal_id: ret.id, account_id: ACCOUNT.id, kind: type, penalty_pct: penalty }
  };
  await fetch(`${BASE}/admin_notifications`, { method:'POST', headers: hdrJSON(), body: JSON.stringify(notif) });

  // 3) mensaje al cliente
  alert("Hemos recibido su solicitud; será atendida en un lapso no mayor a 24 horas hábiles, de lunes a viernes, dentro del horario laboral establecido.");
  document.getElementById("w_msg").textContent = "Solicitud enviada.";
  document.getElementById("w_reason").value = ""; document.getElementById("w_amount").value = "";
}

/*** ARRANQUE ***/
(async function start(){
  if(localStorage.token){ show("unauth",false); show("app",true); await init(); }
})();
</script>
</body>
</html>
