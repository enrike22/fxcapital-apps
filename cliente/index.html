<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. — Cliente</title>
<style>
:root { --bg:#000; --fg:#fff; --muted:#ffffffcc; --card:#0d0d0d; --border:#1a1a1a; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
.container{max-width:980px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
.row{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
h1,h2,h3{margin:0 0 8px}
label{display:block;margin:8px 0 4px}
input,select,textarea{width:100%;background:#000;color:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
button{background:#fff;color:#000;border:none;padding:12px 16px;border-radius:999px;font-weight:700;cursor:pointer}
table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border)} th{text-align:left;color:var(--muted)}
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;margin-right:8px}
.center{display:grid;place-items:center;min-height:40vh}
.hidden{display:none}
.icon{width:48px;height:48px;fill:#fff}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
a.link{color:#fff;text-decoration:underline}
</style>
</head>
<body>
<div class="container">

  <div id="unauth" class="card">
    <h1>Iniciar sesión</h1>
    <form id="loginForm">
      <label>Email</label>
      <input id="email" type="email" required>
      <label>Contraseña</label>
      <input id="password" type="password" required>
      <div style="margin-top:12px;display:flex;gap:8px;">
        <button type="submit">Entrar</button>
      </div>
      <p id="loginMsg" style="color:var(--muted);margin-top:8px"></p>
    </form>
  </div>

  <div id="app" class="hidden">
    <div class="header">
      <h1>FX | CAPITAL R.L. — Cliente</h1>
      <div>
        <span class="badge" id="badgePlan">Plan: —</span>
        <span class="badge" id="badgeRate">Tasa mensual: —</span>
        <button onclick="logout()">Cerrar sesión</button>
      </div>
    </div>

    <!-- Hero de 3 tarjetas -->
    <div class="row">
      <div class="card">
        <div style="display:flex;gap:12px;align-items:center">
          <!-- Escudo -->
          <svg class="icon" viewBox="0 0 24 24"><path d="M12 2l7 3v6c0 5-3.5 9.7-7 11-3.5-1.3-7-6-7-11V5l7-3z"/></svg>
          <div><h3>Seguridad</h3><div style="color:var(--muted)">Máxima protección</div></div>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;gap:12px;align-items:center">
          <!-- Flechas -->
          <svg class="icon" viewBox="0 0 24 24"><path d="M3 17h3v4H3v-4zm5-6h3v10H8V11zm5-4h3v14h-3V7zm5-4h3v18h-3V3z"/></svg>
          <div><h3>Rentabilidad</h3><div style="color:var(--muted)">hasta 25% interés semestral</div></div>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;gap:12px;align-items:center">
          <!-- Candado -->
          <svg class="icon" viewBox="0 0 24 24"><path d="M17 8V6a5 5 0 00-10 0v2H5v14h14V8h-2zm-8 0V6a3 3 0 016 0v2H9z"/></svg>
          <div><h3>Control</h3><div style="color:var(--muted)">Transparencia total</div></div>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div class="card">
      <h2>Resultados del mes</h2>
      <div id="summary" style="margin:8px 0;color:var(--muted)">—</div>
      <table>
        <thead><tr><th>Semana</th><th>Rango</th><th>Viernes</th><th>Ganancia semanal</th></tr></thead>
        <tbody id="weeks"></tbody>
      </table>
    </div>

    <!-- Calculadora -->
    <div class="card">
      <h2>Calculadora</h2>
      <div class="row" style="align-items:end">
        <div>
          <label>Capital</label>
          <input id="calcCapital" type="number" min="0" step="1" placeholder="Ej. 10000">
        </div>
        <div>
          <button onclick="simulate()">Calcular</button>
        </div>
      </div>
      <div id="calcSummary" style="margin-top:8px;color:var(--muted)">—</div>
      <table style="margin-top:8px">
        <thead><tr><th>Semana</th><th>Ganancia semanal</th></tr></thead>
        <tbody id="calcRows"></tbody>
      </table>
    </div>

    <!-- Retiro -->
    <div class="card">
      <h2>Solicitar retiro</h2>
      <div class="row">
        <div>
          <label>Tipo</label>
          <select id="withdrawKind">
            <option value="EARLY">Retiro antes de tiempo (10% penalización)</option>
            <option value="HEALTH">Causas de salud (sin penalización)</option>
          </select>
        </div>
        <div>
          <label>Motivo</label>
          <textarea id="withdrawReason" rows="3" placeholder="Explique brevemente..."></textarea>
        </div>
      </div>
      <div style="margin-top:8px"><button onclick="sendWithdrawal()">Enviar solicitud</button></div>
      <div id="withdrawMsg" style="margin-top:8px;color:var(--muted)"></div>
    </div>

  </div>
</div>

<script>
/*** 1) PON AQUÍ TUS DATOS DE SUPABASE ***/
const PROJECT_URL = "https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY;

/*** 2) HELPERS ***/
const BASE_RPC = PROJECT_URL + "/rest/v1/rpc";
function authHeaders() {
  return { apikey: ANON_KEY, Authorization: "Bearer " + (localStorage.token||""), "Content-Type":"application/json" };
}
function monthStart(){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  return `${y}-${m}-01`;
}
function show(el, visible){ el.classList[visible?"remove":"add"]("hidden"); }

/*** 3) LOGIN **/
const frm = document.getElementById("loginForm");
frm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const res = await fetch(`${PROJECT_URL}/auth/v1/token?grant_type=password`,{
    method:"POST",
    headers:{ apikey:ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ email, password })
  });
  const data = await res.json();
  if(!res.ok){ document.getElementById("loginMsg").textContent = "No se pudo iniciar sesión."; return; }
  localStorage.token = data.access_token;
  localStorage.uid   = data.user.id;
  init();
});

/*** 4) CARGA DE CUENTA + DASHBOARD ***/
let accountId = null, currentPlan = null, monthlyRate = null, principal = 0;

async function getMyAccount(){
  const uid = localStorage.uid;
  const url = `${PROJECT_URL}/rest/v1/v_admin_users?select=*&user_id=eq.${uid}`;
  const r = await fetch(url,{ headers:{ apikey:ANON_KEY, Authorization:"Bearer "+localStorage.token }});
  const rows = await r.json();
  return rows[0];
}

async function loadDashboard(){
  const body = { p_account: accountId, p_month: monthStart() };
  const r = await fetch(`${BASE_RPC}/get_client_dashboard`, { method:"POST", headers: authHeaders(), body: JSON.stringify(body) });
  const rows = await r.json();
  const weeks = document.getElementById("weeks");
  weeks.innerHTML = "";
  if(!Array.isArray(rows) || rows.length===0){ weeks.innerHTML = `<tr><td colspan="4">Sin datos</td></tr>`; return; }
  currentPlan = rows[0].plan; monthlyRate = rows[0].monthly_rate; principal = rows[0].principal;
  document.getElementById("badgePlan").textContent = "Plan: " + currentPlan;
  document.getElementById("badgeRate").textContent = "Tasa mensual: " + Math.round(monthlyRate*100) + "%";
  document.getElementById("summary").textContent = `Capital: Q${principal.toFixed(2)} — Ganancia mensual estimada: Q${rows[0].monthly_profit.toFixed(2)}`;

  for(const r0 of rows){
    const tr = document.createElement("tr");
    const range = `${r0.week_start} a ${r0.week_end}`;
    tr.innerHTML = `<td>${r0.week_no}</td><td>${range}</td><td>${r0.friday}</td><td>Q${r0.weekly_profit.toFixed(2)}</td>`;
    weeks.appendChild(tr);
  }
}

/*** 5) CALCULADORA ***/
async function simulate(){
  const cap = Number(document.getElementById("calcCapital").value||0);
  if(cap<=0){ document.getElementById("calcSummary").textContent="Ingresa un capital válido."; return; }
  const r = await fetch(`${BASE_RPC}/calculator_simulate`, { method:"POST", headers: authHeaders(), body: JSON.stringify({ p_capital: cap }) });
  const rows = await r.json();
  if(!rows.length){ document.getElementById("calcSummary").textContent="Sin resultado"; return; }
  const plan = rows[0].plan, rate = rows[0].monthly_rate, monthProfit = rows[0].month_profit;
  document.getElementById("calcSummary").textContent = `Plan: ${plan} — Tasa: ${Math.round(rate*100)}% — Ganancia mensual: Q${monthProfit.toFixed(2)}`;
  const tbody = document.getElementById("calcRows"); tbody.innerHTML = "";
  rows.forEach(x=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${x.week_no}</td><td>Q${x.weekly_profit.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

/*** 6) RETIRO ***/
async function sendWithdrawal(){
  const kind = document.getElementById("withdrawKind").value;
  const reason = document.getElementById("withdrawReason").value.trim();
  if(!reason){ document.getElementById("withdrawMsg").textContent="Escribe un motivo."; return; }
  const r = await fetch(`${BASE_RPC}/request_withdrawal`, { method:"POST", headers: authHeaders(), body: JSON.stringify({ p_account: accountId, p_kind: kind, p_reason: reason }) });
  if(r.ok){
    document.getElementById("withdrawMsg").textContent = 'Hemos recibido su solicitud; será atendida en un lapso no mayor a 24 horas hábiles, de lunes a viernes, dentro del horario laboral establecido.';
    document.getElementById("withdrawReason").value="";
  }else{
    document.getElementById("withdrawMsg").textContent = 'No se pudo enviar la solicitud.';
  }
}

/*** 7) INICIO / LOGOUT ***/
async function init(){
  if(localStorage.token){
    show(document.getElementById("unauth"), false);
    show(document.getElementById("app"), true);
    const u = await getMyAccount();
    if(!u){ document.getElementById("loginMsg").textContent="Tu cuenta no está configurada."; logout(); return; }
    accountId = u.account_id;
    await loadDashboard();
  }else{
    show(document.getElementById("app"), false);
    show(document.getElementById("unauth"), true);
  }
}
function logout(){ localStorage.removeItem("token"); localStorage.removeItem("uid"); location.reload(); }
init();
</script>
</body>
</html>
