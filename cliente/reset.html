<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FX | CAPITAL R.L. — Restablecer contraseña</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0b0d; --panel:#121318; --card:#17191d; --outline:rgba(255,255,255,.1);
    --txt:#f5f7fb; --muted:#9aa1ac; --danger:#ff5252; --shadow:0 18px 50px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--txt); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1200px 800px at 12% -25%, #1a1d24 0%, #0b0b0d 55%) fixed;
    display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .box{width:min(520px,96vw); background:linear-gradient(180deg,var(--panel) 0%, #0f1116 100%);
    border:1px solid var(--outline); border-radius:18px; padding:26px; box-shadow:var(--shadow)}
  h1{margin:0 0 6px 0; font-size:clamp(22px,4.5vw,26px)}
  .sub{color:var(--muted); margin-bottom:14px}
  .row{display:grid; gap:14px; grid-template-columns:1fr}
  .k{color:var(--muted); font-size:13px; margin-bottom:6px}
  .pwd-field{position:relative}
  .input{width:100%; background:#0f1116; border:1px solid var(--outline); color:var(--txt);
    padding:12px 14px; border-radius:12px; outline:none}
  .input:focus{border-color:#2b7cff}
  .eye-btn{
    position:absolute; right:8px; top:50%; transform:translateY(-50%);
    width:48px; height:48px; border-radius:14px; border:1px solid var(--outline);
    background:#0f1116; color:#fff; display:grid; place-items:center; cursor:pointer;
  }
  .eye-btn svg{width:28px; height:28px}
  .err{color:var(--danger); font-size:12px; margin-top:6px; display:none}
  .actions{display:flex; gap:10px; margin-top:18px}
  .btn{appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer}
  .btn.primary{background:#fff; color:#000; flex:1}
  .btn.secondary{background:#1f232b; color:#fff; border:1px solid var(--outline)}
  .note{color:var(--muted); font-size:12px; margin-top:10px; text-align:center}
  .ok{color:#86efac}
</style>
</head>
<body>
  <div class="box">
    <h1>Restablecer contraseña</h1>
    <div class="sub">Ingresa tu nueva contraseña y confírmala.</div>

    <div class="row">
      <div>
        <div class="k">Nueva contraseña</div>
        <div class="pwd-field">
          <input id="newPwd" class="input" type="password" minlength="8" placeholder="Mínimo 8 caracteres" aria-describedby="err1">
          <button type="button" id="eye1" class="eye-btn" aria-pressed="false" aria-label="Mostrar/ocultar"></button>
        </div>
        <div id="err1" class="err"></div>
      </div>
      <div>
        <div class="k">Confirmar contraseña</div>
        <div class="pwd-field">
          <input id="newPwd2" class="input" type="password" minlength="8" placeholder="Repite la contraseña" aria-describedby="err2">
          <button type="button" id="eye2" class="eye-btn" aria-pressed="false" aria-label="Mostrar/ocultar"></button>
        </div>
        <div id="err2" class="err"></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn secondary" id="backLogin">Volver al login</button>
      <button class="btn primary" id="saveBtn">Guardar nueva contraseña</button>
    </div>

    <div id="msg" class="note"></div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL = 'https://czvpehbubfrinutztnwh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY;
    const LOGIN_URL = location.origin + '/index.html'; // ajusta si tu login es otro archivo (p.ej. /login.html)

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    });

    // Ojos
    const eyeOn = `<svg viewBox="0 0 24 24" fill="none"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12Z" stroke="currentColor" stroke-width="1.8"/><circle cx="12" cy="12" r="3.5" stroke="currentColor" stroke-width="1.8"/></svg>`;
    const eyeOff= `<svg viewBox="0 0 24 24" fill="none"><path d="M3 3l18 18" stroke="currentColor" stroke-width="1.8"/><path d="M1 12s4-7 11-7c2.7 0 5 .9 6.9 2.1M23 12s-4 7-11 7c-2.7 0-5-.9-6.9-2.1" stroke="currentColor" stroke-width="1.8"/><path d="M9.9 9.9a3.5 3.5 0 004.2 4.2" stroke="currentColor" stroke-width="1.8"/></svg>`;
    function bindEye(inpId, btnId){
      const i = document.getElementById(inpId), b = document.getElementById(btnId);
      b.innerHTML = eyeOn;
      b.onclick = () => {
        const show = i.type === 'password';
        i.type = show ? 'text' : 'password';
        b.innerHTML = show ? eyeOff : eyeOn;
      };
    }
    bindEye('newPwd','eye1'); bindEye('newPwd2','eye2');

    function setErr(id, msg){ const el = document.getElementById(id); el.textContent = msg||''; el.style.display = msg ? 'block' : 'none'; }
    function validate(){
      const p1 = document.getElementById('newPwd').value.trim();
      const p2 = document.getElementById('newPwd2').value.trim();
      let ok = true;
      if(p1.length < 8){ setErr('err1','Mínimo 8 caracteres.'); ok=false; } else setErr('err1','');
      if(p2.length === 0){ setErr('err2','Confirme su contraseña.'); ok=false; }
      else if(p1 !== p2){ setErr('err2','Las contraseñas no coinciden.'); ok=false; } else setErr('err2','');
      return ok;
    }

    async function ensureRecoverySession(){
      // Cuando el usuario llega desde el email, Supabase coloca tokens en el hash (#access_token=...)
      // Con detectSessionInUrl:true, supabase-js intenta crear la sesión automáticamente.
      const { data:{ session } } = await sb.auth.getSession();
      return !!session;
    }

    async function saveNewPassword(){
      if(!validate()) return;
      const ok = await ensureRecoverySession();
      if(!ok){
        document.getElementById('msg').innerHTML = 'El enlace no es válido o expiró. Vuelve a solicitar el correo de recuperación.';
        return;
      }
      const newPwd = document.getElementById('newPwd').value.trim();
      const { error } = await sb.auth.updateUser({ password: newPwd });
      if(error){
        document.getElementById('msg').innerHTML = 'Error: ' + error.message;
        return;
      }
      document.getElementById('msg').innerHTML = '<span class="ok">¡Contraseña actualizada!</span> Redirigiendo al login…';
      setTimeout(()=>{ window.location.href = LOGIN_URL; }, 1200);
    }

    document.getElementById('saveBtn').addEventListener('click', saveNewPassword);
    document.getElementById('backLogin').addEventListener('click', ()=> window.location.href = LOGIN_URL);
  </script>
</body>
</html>
