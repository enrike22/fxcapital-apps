<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. ‚Äî Admin</title>
<style>
:root { --bg:#000; --fg:#fff; --muted:#ffffffcc; --card:#0d0d0d; --border:#1a1a1a; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
.container{max-width:1200px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
h1,h2,h3{margin:0 0 8px} label{display:block;margin:8px 0 4px}
input,select,textarea{width:100%;background:#000;color:#fff;border:1px solid var(--border);border-radius:12px;padding:10px 12px}
button{background:#fff;color:#000;border:none;padding:12px 16px;border-radius:999px;font-weight:700;cursor:pointer}
table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--border)} th{text-align:left;color:var(--muted)}
.row{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
.badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;margin-right:8px}
.hidden{display:none}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.inline{display:flex;gap:8px;align-items:center}
.small{font-size:12px;color:var(--muted)}
.nowrap{white-space:nowrap}
</style>
</head>
<body>
<div class="container">

  <div id="unauth" class="card">
    <h1>Admin ‚Äî Iniciar sesi√≥n</h1>
    <form id="loginForm">
      <label>Email</label><input id="email" type="email" required>
      <label>Contrase√±a</label><input id="password" type="password" required>
      <div style="margin-top:12px"><button type="submit">Entrar</button></div>
      <p id="loginMsg" class="small" style="margin-top:8px"></p>
    </form>
  </div>

  <div id="app" class="hidden">
    <div class="header">
      <h1>FX | CAPITAL R.L. ‚Äî Panel Admin</h1>
      <div><button onclick="logout()">Cerrar sesi√≥n</button></div>
    </div>

    <!-- Crear/Editar usuario -->
    <div class="card">
      <h2>Crear / Editar usuario</h2>
      <div class="row">
        <div><label>Email</label><input id="u_email" placeholder="cliente@demo.com"></div>
        <div><label>Nombre completo</label><input id="u_name" placeholder="Cliente Demo"></div>

        <div>
          <label>Contrase√±a (para el cliente)</label>
          <div class="inline">
            <input id="u_pass" type="password" placeholder="M√≠n. 8 caracteres">
            <button type="button" id="togglePass" title="Mostrar / ocultar">üëÅ</button>
          </div>
          <div class="small">Se usa para crear al cliente en Auth. No se guarda en tu base de datos.</div>
        </div>

        <div><label>Moneda</label>
          <select id="u_currency"><option>GTQ</option><option>USD</option></select>
        </div>
        <div><label>Capital inicial</label><input id="u_capital" type="number" min="0"></div>
        <div><label>Fecha ingreso</label><input id="u_joined" type="date"></div>
        <div><label>Plan</label>
          <select id="u_plan"><option>STANDARD</option><option>PLATINUM</option><option>BLACK</option></select>
        </div>

        <div><label>Banco</label><input id="u_bank_name" placeholder="Banco Industrial"></div>
        <div><label>No. de cuenta</label><input id="u_bank_account" placeholder="1234567890"></div>
      </div>

      <div style="margin-top:8px">
        <button onclick="saveUser()">Guardar</button>
        <span id="saveMsg" class="small" style="margin-left:8px"></span>
      </div>
    </div>

    <!-- Lista de clientes -->
    <div class="card">
      <h2>Clientes</h2>
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Plan</th>
            <th>Capital</th>
            <th class="nowrap">Banco</th>
            <th class="nowrap">No. cuenta</th>
            <th class="nowrap">Cuenta (ID)</th>
            <th>BLACK</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="users"></tbody>
      </table>
    </div>

    <!-- Solicitudes de retiro -->
    <div class="card">
      <h2>Solicitudes</h2>
      <div style="margin-bottom:8px"><button onclick="loadNotifs()">Refrescar</button></div>
      <table>
        <thead><tr><th>Fecha</th><th>Cuenta</th><th>Tipo</th><th>Penalizaci√≥n</th><th>Acciones</th></tr></thead>
        <tbody id="notifs"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/*** 1) TUS DATOS DE SUPABASE ***/
const PROJECT_URL = "https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE = PROJECT_URL + "/rest/v1";
const RPC  = BASE + "/rpc";

function headersJSON(){
  return { apikey: ANON_KEY, Authorization: "Bearer "+(localStorage.token||""), "Content-Type":"application/json" };
}

/*** 1.1 FUNCI√ìN EDGE: crear usuario en Auth si no existe (usa la contrase√±a del formulario) ***/
async function createAuthUserIfNeeded(email, password, fullName) {
  const url = "https://czvpehbubfrinutztnwh.functions.supabase.co/admin-create-user";
  const r = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      apikey: ANON_KEY,
      Authorization: "Bearer " + (localStorage.token || "")
    },
    body: JSON.stringify({ email, password, full_name: fullName })
  });
  return r; // 201=creado; si ya existe, la funci√≥n devuelve 400 y seguimos con el RPC
}

/*** LOGIN ***/
document.getElementById("loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const r = await fetch(`${PROJECT_URL}/auth/v1/token?grant_type=password`,{
    method:"POST", headers:{ apikey:ANON_KEY, "Content-Type":"application/json" },
    body: JSON.stringify({ email, password })
  });
  const data = await r.json();
  if(!r.ok){ document.getElementById("loginMsg").textContent="Login inv√°lido"; return; }
  localStorage.token = data.access_token; localStorage.uid = data.user.id;
  init();
});

function show(id,vis){ document.getElementById(id).classList[vis?"remove":"add"]("hidden"); }
function logout(){ localStorage.removeItem("token"); localStorage.removeItem("uid"); location.reload(); }

/*** LISTA USUARIOS ‚Äî ROBUSTA ***/
async function listUsers(){
  try {
    const url = `${BASE}/v_admin_users?select=full_name,email,plan,principal_locked,account_id,black_enabled,bank_name,bank_account,currency&order=created_at.desc`;
    const r = await fetch(url, { headers:{ apikey:ANON_KEY, Authorization:"Bearer "+(localStorage.token||"") } });

    if (!r.ok) {
      const text = await r.text();
      throw new Error(`v_admin_users error: ${text}`);
    }

    const rows = await r.json();
    if (!Array.isArray(rows)) {
      throw new Error(`v_admin_users no devolvi√≥ un array: ${JSON.stringify(rows)}`);
    }

    const tb = document.getElementById("users"); tb.innerHTML="";
    rows.forEach(x=>{
      const currency = x.currency || "GTQ";
      const capital  = Number(x.principal_locked ?? 0);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${x.full_name || '‚Äî'}</td>
        <td>${x.email || '‚Äî'}</td>
        <td>${x.plan || '‚Äî'}</td>
        <td>${capital.toLocaleString('es-GT',{style:'currency',currency})}</td>
        <td>${x.bank_name || '‚Äî'}</td>
        <td class="nowrap">${x.bank_account || '‚Äî'}</td>
        <td class="small">${x.account_id || '‚Äî'}</td>
        <td>${x.black_enabled ? 'S√≠' : 'No'}</td>
        <td>
          ${x.account_id ? `
            <button onclick="toggleBlack('${x.account_id}', true)">Enable BLACK</button>
            <button onclick="toggleBlack('${x.account_id}', false)">Disable BLACK</button>
          ` : '‚Äî'}
        </td>`;
      tb.appendChild(tr);
    });
  } catch (err) {
    console.error(err);
    alert(`No se pudo cargar la lista de clientes:\n${err.message || err}`);
    const tb = document.getElementById("users"); if (tb) tb.innerHTML = "";
  }
}

/*** CREAR / EDITAR ‚Äî con password, banco y cuenta; manejo de errores ***/
async function saveUser(){
  const email    = document.getElementById("u_email").value.trim();
  const fullName = document.getElementById("u_name").value.trim();
  const password = document.getElementById("u_pass").value;
  const currency = document.getElementById("u_currency").value;
  const capital  = Number(document.getElementById("u_capital").value||0);
  const joined   = document.getElementById("u_joined").value;
  const plan     = document.getElementById("u_plan").value;
  const bankName = document.getElementById("u_bank_name").value.trim();
  const bankAcct = document.getElementById("u_bank_account").value.trim();
  const msgEl    = document.getElementById("saveMsg");
  if (msgEl) msgEl.textContent = "‚Ä¶";

  try {
    if (!email) throw new Error("Email requerido");
    if (!fullName) throw new Error("Nombre requerido");
    if (!password || password.length < 8) throw new Error("Contrase√±a m√≠nima de 8 caracteres");

    // 1) Crear/asegurar usuario en Auth (si ya existe, esta llamada puede devolver error 400 y lo ignoramos)
    try { await createAuthUserIfNeeded(email, password, fullName); } catch (ee) { console.warn(ee); }

    // 2) Upsert de perfil + cuenta (RPC) ‚Äî con banco y cuenta
    const body = {
      p_email:         email,
      p_full_name:     fullName,
      p_currency:      currency,
      p_capital:       capital,
      p_joined_at:     joined,
      p_plan:          plan,
      p_bank_name:     bankName || null,
      p_bank_account:  bankAcct || null
    };

    const r = await fetch(`${RPC}/admin_upsert_user_with_account`, {
      method:"POST",
      headers: headersJSON(),
      body: JSON.stringify(body)
    });

    if (!r.ok) {
      const t = await r.text();
      throw new Error(t || "Error guardando (RPC)");
    }

    if (msgEl) msgEl.textContent = "Guardado";
    document.getElementById("u_pass").value = ""; // limpiar por seguridad
    await listUsers();

  } catch (e) {
    if (msgEl) msgEl.textContent = "Error";
    console.error(e);
    alert("No se pudo guardar: " + (e.message || e));
  }
}

/*** Mostrar/ocultar contrase√±a del formulario ***/
document.getElementById("togglePass").addEventListener("click", ()=>{
  const inp = document.getElementById("u_pass");
  inp.type = (inp.type === "password") ? "text" : "password";
});

/*** BLACK ON/OFF ***/
async function toggleBlack(accountId, enabled){
  try {
    const r = await fetch(`${RPC}/enable_black_for_account`, {
      method:"POST",
      headers: headersJSON(),
      body: JSON.stringify({ p_account: accountId, p_enabled: enabled })
    });
    if (!r.ok) {
      const t = await r.text(); throw new Error(t||"Error toggling BLACK");
    }
    await listUsers();
  } catch (e) {
    console.error(e); alert("No se pudo cambiar BLACK: "+(e.message||e));
  }
}

/*** NOTIFICACIONES (solicitudes) ***/
async function loadNotifs(){
  try {
    const r = await fetch(`${BASE}/admin_notifications?select=*&order=created_at.desc`, {
      headers:{ apikey:ANON_KEY, Authorization:"Bearer "+(localStorage.token||"") }
    });
    if (!r.ok) { const t = await r.text(); throw new Error(t); }
    const rows = await r.json();
    const tb = document.getElementById("notifs"); tb.innerHTML="";
    (Array.isArray(rows)?rows:[]).forEach(x=>{
      const p = x.payload || {};
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${new Date(x.created_at).toLocaleString()}</td>
        <td>${p.account_id||'‚Äî'}</td>
        <td>${p.kind||'‚Äî'}</td>
        <td>${(p.penalty_pct??0)}%</td>
        <td>
          <button onclick="setWithdrawal('${p.withdrawal_id}','APPROVED')">Aprobar</button>
          <button onclick="setWithdrawal('${p.withdrawal_id}','REJECTED')">Rechazar</button>
        </td>`;
      tb.appendChild(tr);
    });
  } catch (e) {
    console.error(e); alert("No se pudieron cargar notificaciones: "+(e.message||e));
  }
}

async function setWithdrawal(id, status){
  try {
    const r = await fetch(`${BASE}/withdrawal_requests?id=eq.${id}`, {
      method:"PATCH",
      headers:{ apikey:ANON_KEY, Authorization:"Bearer "+(localStorage.token||""), "Content-Type":"application/json", "Prefer":"return=representation" },
      body: JSON.stringify({ status })
    });
    if (!r.ok) { const t = await r.text(); throw new Error(t); }
    await loadNotifs();
  } catch (e) {
    console.error(e); alert("No se pudo actualizar: "+(e.message||e));
  }
}

/*** INIT ***/
async function init(){
  if(localStorage.token){ show("unauth",false); show("app",true); await listUsers(); await loadNotifs(); }
  else { show("app",false); show("unauth",true); }
}
init();
</script>
</body>
</html>
