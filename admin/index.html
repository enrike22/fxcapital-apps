<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. ‚Äî Admin</title>
<style>
:root{
  --bg:#0a0a0a; --fg:#f5f7fa; --muted:#cdd3da;
  --card:#0f1012; --border:#21262c; --shadow:0 14px 40px rgba(0,0,0,.5);
  --radius:18px; --chip:#15181d; --danger:#ff4d4f;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--fg);
  font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
  font-size:16px;
  -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
}
.container{max-width:1280px;margin:0 auto;padding:36px 22px}

.card{
  background:linear-gradient(180deg,var(--card),#101214);
  border:1px solid var(--border);border-radius:var(--radius);
  padding:26px 22px;box-shadow:var(--shadow);margin-bottom:24px
}
h1{margin:0 0 18px;font-size:28px;letter-spacing:.2px}
h2{margin:0 0 14px;font-size:20px;font-weight:700}
label{display:block;margin:10px 0 6px;color:var(--muted);font-size:14px}
input,select,textarea{
  width:100%;background:#0b0d0f;color:var(--fg);
  border:1px solid var(--border);border-radius:12px;padding:12px 12px;font-size:15px
}
button{
  background:#fff;color:#0b0c0e;border:none;padding:12px 18px;border-radius:999px;
  font-weight:800;cursor:pointer;font-size:15px
}
button.ghost{background:var(--chip);color:var(--fg);border:1px solid var(--border)}
button.danger{background:var(--danger);color:#fff}
.small{font-size:13px;color:var(--muted)}
.nowrap{white-space:nowrap}
.hidden{display:none}

.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
.inline{display:flex;gap:10px;align-items:center}
.row{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
hr.sep{border:0;border-top:1px solid var(--border);margin:14px 0}

.searchbar{position:relative;max-width:500px}
.searchbar input{padding-left:40px}
.searchbar svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.7;pointer-events:none}

.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:14px}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{
  padding:14px 16px;border-bottom:1px solid var(--border);vertical-align:middle;
  font-size:15px;
}
th{text-align:left;color:#d7dce2;background:#0f1114;position:sticky;top:0}
tbody tr:hover{background:#0e1116}

.chip{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-size:12px}

@media (min-width:1200px){
  .container{max-width:1320px}
}
</style>
</head>
<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <h1>FX | CAPITAL R.L. ‚Äî Panel Admin</h1>
    <div class="inline">
      <div class="searchbar">
        <input id="q" type="search" placeholder="Buscar (nombre, email, tel√©fono, plan, banco‚Ä¶)" aria-label="Buscar cliente">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#b9c0c8" stroke-width="2" stroke-linecap="round"/></svg>
      </div>
      <button id="logoutBtn" type="button" class="hidden">Cerrar sesi√≥n</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="unauth" class="card">
    <h2>Admin ‚Äî Iniciar sesi√≥n</h2>
    <form id="loginForm" class="row" style="grid-template-columns:1fr 1fr auto">
      <div><label>Email</label><input id="email" type="email" required></div>
      <div><label>Contrase√±a</label><input id="password" type="password" required></div>
      <div style="align-self:end"><button type="submit">Entrar</button></div>
      <div style="grid-column:1/-1"><p id="loginMsg" class="small" style="margin-top:4px"></p></div>
    </form>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">

    <!-- Crear/Editar -->
    <div class="card" id="formCard">
      <h2>Crear / Editar usuario</h2>
      <div class="row">
        <div>
          <label>Email</label>
          <input id="u_email" placeholder="cliente@demo.com">
          <div class="small">Para editar, escribe el email o usa <b>Editar</b> en la lista.</div>
        </div>

        <div><label>Nombre completo</label><input id="u_name" placeholder="Cliente Demo"></div>

        <div>
          <label>Tel√©fono (celular)</label>
          <input id="u_phone" type="tel" inputmode="tel" placeholder="+502 5555 5555">
          <div class="small">Formato libre. Ej.: +502 5555 5555</div>
        </div>

        <div>
          <label>Contrase√±a (para el cliente)</label>
          <div class="inline">
            <input id="u_pass" type="password" placeholder="M√≠n. 8 caracteres (vac√≠o = no cambia)">
            <button type="button" id="togglePass" class="ghost" title="Mostrar/ocultar">üëÅ</button>
          </div>
          <div class="small">Si dejas en blanco, <b>no</b> se cambia/crea en Auth.</div>
        </div>

        <div><label>Moneda</label>
          <select id="u_currency"><option>GTQ</option><option>USD</option></select>
        </div>
        <div><label>Capital inicial</label><input id="u_capital" type="number" min="0" step="0.01"></div>
        <div><label>Fecha ingreso</label><input id="u_joined" type="date"></div>
        <div><label>Plan</label>
          <select id="u_plan"><option>STANDARD</option><option>PLATINUM</option><option>BLACK</option></select>
        </div>

        <div>
          <label>Meses de inversi√≥n</label>
          <select id="u_months">
            <option>6</option><option selected>12</option><option>18</option><option>24</option>
            <option>30</option><option>36</option><option>42</option><option>48</option>
            <option>54</option><option>60</option>
          </select>
        </div>

        <div>
          <label>Tasa semestral (%)</label>
          <input id="u_rate" type="number" min="0" max="100" step="0.01" placeholder="Ej. 15, 20, 25">
          <div class="small">Se aplica cada 6 meses. Vac√≠o usa la del plan (15/20/25).</div>
        </div>

        <div><label>Banco</label><input id="u_bank_name" placeholder="Banco Industrial"></div>
        <div><label>No. de cuenta</label><input id="u_bank_account" placeholder="1234567890"></div>
        <div><label>Tipo de cuenta</label><input id="u_bank_account_type" placeholder="Ahorro / Monetaria / ‚Ä¶"></div>
      </div>

      <hr class="sep">

      <div class="inline" style="gap:12px">
        <button id="saveBtn" type="button">Guardar</button>
        <button id="clearBtn" type="button" class="ghost">Limpiar</button>
        <span id="saveMsg" class="small" style="margin-left:8px"></span>
      </div>
    </div>

    <!-- Lista -->
    <div class="card">
      <div class="header" style="margin:0 0 10px">
        <h2 style="margin:0">Clientes</h2>
        <button id="btnRefreshUsers" type="button" class="ghost">Refrescar lista</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Tel√©fono</th>
              <th class="nowrap">Fecha ingreso</th>
              <th>Plan</th>
              <th>Capital</th>
              <th>Banco</th>
              <th class="nowrap">No. cuenta</th>
              <th class="nowrap">Tipo de cuenta</th>
              <th>Meses</th>
              <th class="nowrap">Tasa %/6m</th>
              <th class="nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody id="users"></tbody>
        </table>
      </div>
    </div>

    <!-- Solicitudes -->
    <div class="card">
      <h2>Solicitudes</h2>
      <div style="margin-bottom:10px"><button id="btnRefreshNotifs" class="ghost">Refrescar</button></div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Fecha</th><th>Cuenta</th><th>Tipo</th><th>Penalizaci√≥n</th><th>Acciones</th></tr></thead>
          <tbody id="notifs"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
/*** SUPABASE CONFIG ***/
const PROJECT_URL = "https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE = PROJECT_URL + "/rest/v1";
const RPC  = BASE + "/rpc";

function headersJSON(){
  return { apikey: ANON_KEY, Authorization: "Bearer "+(localStorage.token||""), "Content-Type":"application/json", "Prefer":"return=representation" };
}

/*** HELPERS UI ***/
const $ = (id)=> document.getElementById(id);
const show = (el, v)=> el.classList.toggle('hidden', !v);
const fmtMoney = (n, ccy)=> { try{ return new Intl.NumberFormat('es-GT',{style:'currency',currency:ccy||'GTQ'}).format(Number(n||0)); }catch{ return `Q ${(Number(n||0)).toFixed(2)}`; } };
const fmtDate  = (s)=> s ? new Date(s).toLocaleDateString('es-GT') : '‚Äî';

/*** AUTH ***/
async function doLogin(e){
  e.preventDefault();
  const email = $("email").value.trim();
  const password = $("password").value;
  $("loginMsg").textContent = "";
  try{
    const r = await fetch(`${PROJECT_URL}/auth/v1/token?grant_type=password`,{
      method:"POST", headers:{ apikey:ANON_KEY, "Content-Type":"application/json" },
      body: JSON.stringify({ email, password })
    });
    const data = await r.json();
    if(!r.ok){ $("loginMsg").textContent = data?.error_description || "Login inv√°lido"; return; }
    localStorage.token = data.access_token; localStorage.uid = data.user.id;
    await initApp();
  }catch{ $("loginMsg").textContent = "Error de red"; }
}
function logout(){ localStorage.removeItem("token"); localStorage.removeItem("uid"); location.reload(); }

/*** Edge Functions auxiliares (crear usuario) ***/
async function createAuthUserIfNeeded(email, password, fullName) {
  if(!password) return { ok:true, status:204 };
  const url = "https://czvpehbubfrinutztnwh.functions.supabase.co/admin-create-user";
  return fetch(url, { method:"POST", headers:{ "Content-Type":"application/json", apikey:ANON_KEY, Authorization:"Bearer "+(localStorage.token||"") }, body: JSON.stringify({ email, password, full_name: fullName }) });
}

/*** LISTA USUARIOS (vista filtrada con fallback) - NO CACHE ***/
let CACHED = [];
const VIEW_PRIMARY = 'v_admin_users_filtered';
const VIEW_FALLBACK = 'v_admin_users';

async function listUsers(){
  let view = VIEW_PRIMARY;
  const ts = `_ts=${Date.now()}`;
  const sel = `user_id,full_name,email,phone,plan,currency,capital,account_id,bank_name,bank_account,bank_account_type,invest_months,interest_pct,joined_at`;
  let url = `${BASE}/${view}?select=${encodeURIComponent(sel)}&order=full_name.asc&${ts}`;

  const h = { apikey: ANON_KEY, Authorization: "Bearer "+localStorage.token, "Cache-Control":"no-cache" };
  let r = await fetch(url, { headers: h, cache: "no-store" });

  if (r.status === 404) {
    view = VIEW_FALLBACK;
    url = `${BASE}/${view}?select=${encodeURIComponent(sel)}&order=full_name.asc&${ts}`;
    r = await fetch(url, { headers: h, cache: "no-store" });
  }

  if (!r.ok) {
    const t = await r.text();
    if (/column .*phone.* does not exist|unknown column/i.test(t)) {
      const url2 = `${BASE}/${view}?select=${encodeURIComponent(sel.replace("email,phone","email"))}&order=full_name.asc&${ts}`;
      const r2 = await fetch(url2, { headers: h, cache: "no-store" });
      if (!r2.ok) { alert("No se pudo cargar la lista:\n"+(await r2.text())); return; }
      CACHED = await r2.json();
      await hydratePhonesFromProfiles(CACHED);
      renderUsers(CACHED);
      return;
    }
    alert("No se pudo cargar la lista:\n"+t);
    return;
  }

  CACHED = await r.json();
  const needsHydrate = !CACHED.some(x => x && typeof x.phone === "string" && x.phone.trim() !== "");
  if (needsHydrate) await hydratePhonesFromProfiles(CACHED);
  renderUsers(CACHED);
}

async function hydratePhonesFromProfiles(rows){
  try{
    const ids = rows.map(r=>r.user_id).filter(Boolean);
    if (!ids.length) return;
    const inList = '(' + ids.map(id => `"${String(id).replace(/"/g,'\\"')}"`).join(',') + ')';
    const r = await fetch(`${BASE}/profiles?id=in.${encodeURIComponent(inList)}&select=id,phone`, {
      headers:{ apikey: ANON_KEY, Authorization:"Bearer "+localStorage.token },
      cache: "no-store"
    });
    if (!r.ok) return;
    const profs = await r.json();
    const map = new Map(profs.map(p=>[p.id, p.phone]));
    rows.forEach(row=>{
      if (row && row.user_id && map.has(row.user_id)) row.phone = map.get(row.user_id) || null;
    });
  }catch{}
}

function renderUsers(rows){
  const tb = $("users"); tb.innerHTML = "";
  rows.forEach(x=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${x.full_name ?? '‚Äî'}</td>
      <td>${x.email ?? '‚Äî'}</td>
      <td>${x.phone ? x.phone : '‚Äî'}</td>
      <td class="nowrap">${fmtDate(x.joined_at)}</td>
      <td>${x.plan ?? '‚Äî'}</td>
      <td>${fmtMoney(x.capital, x.currency)}</td>
      <td>${x.bank_name ?? '‚Äî'}</td>
      <td class="nowrap">${x.bank_account ?? '‚Äî'}</td>
      <td class="nowrap">${x.bank_account_type ?? '‚Äî'}</td>
      <td>${x.invest_months ?? '‚Äî'}</td>
      <td>${x.interest_pct ?? '‚Äî'}</td>
      <td class="nowrap">
        <button class="ghost" onclick='editClient(${JSON.stringify(x)})'>Editar</button>
        <button class="danger" onclick='deleteClient(${JSON.stringify(x)})'>Eliminar</button>
      </td>`;
    tb.appendChild(tr);
  });
}

/*** BUSCAR ***/
$("q")?.addEventListener("input", (e)=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q){ renderUsers(CACHED); return; }
  const filt = CACHED.filter(x=>{
    return [x.full_name, x.email, x.phone, x.plan, x.bank_name, x.bank_account, x.bank_account_type]
      .filter(Boolean)
      .some(v => String(v).toLowerCase().includes(q));
  });
  renderUsers(filt);
});

/*** Editar: cargar datos ***/
async function editClient(x){
  $("u_email").value = x.email || "";
  $("u_name").value  = x.full_name || "";
  $("u_currency").value = x.currency || "GTQ";
  $("u_capital").value  = x.capital ?? "";
  $("u_joined").value   = x.joined_at ? new Date(x.joined_at).toISOString().slice(0,10) : "";
  $("u_plan").value     = x.plan || "STANDARD";
  $("u_months").value   = x.invest_months ?? "12";
  $("u_rate").value     = (x.interest_pct ?? "") === null ? "" : (x.interest_pct ?? "");
  $("u_bank_name").value   = x.bank_name ?? "";
  $("u_bank_account").value= x.bank_account ?? "";
  $("u_bank_account_type").value = x.bank_account_type ?? "";
  $("u_pass").value = "";

  if (typeof x.phone === "string") {
    $("u_phone").value = x.phone || "";
  } else if (x.user_id) {
    try{
      const r = await fetch(`${BASE}/profiles?id=eq.${encodeURIComponent(x.user_id)}&select=phone`, {
        headers:{ apikey: ANON_KEY, Authorization:"Bearer "+localStorage.token }
      });
      if (r.ok) {
        const rows = await r.json();
        $("u_phone").value = rows?.[0]?.phone || "";
      }
    }catch{ $("u_phone").value = ""; }
  } else {
    $("u_phone").value = "";
  }

  document.getElementById("formCard").scrollIntoView({behavior:"smooth",block:"start"});
}

/*** Guardar / Editar ***/
async function saveUser(){
  const email    = $("u_email").value.trim();
  const fullName = $("u_name").value.trim();
  const phone    = $("u_phone").value.trim();
  const password = $("u_pass").value;
  const currency = $("u_currency").value;
  const capital  = Number($("u_capital").value || 0);
  const joined   = $("u_joined").value || null;
  const plan     = $("u_plan").value;
  const months   = parseInt($("u_months").value, 10);
  const rateStr  = $("u_rate").value;
  const rate     = rateStr === "" ? null : Number(rateStr);
  const bankName = $("u_bank_name").value.trim();
  const bankAcct = $("u_bank_account").value.trim();
  const bankType = $("u_bank_account_type").value.trim();
  const msgEl    = $("saveMsg");
  if (msgEl) msgEl.textContent = "‚Ä¶";

  try {
    if (!email) throw new Error("Email requerido");
    if (!fullName) throw new Error("Nombre requerido");
    if (isNaN(capital) || capital < 0) throw new Error("Capital inv√°lido");

    const authRes = await createAuthUserIfNeeded(email, password, fullName);
    if(!authRes.ok && authRes.status !== 400){ throw new Error("No se pudo crear usuario Auth"); }

    const bodyNew = {
      p_email: email, p_full_name: fullName, p_currency: currency, p_capital: capital,
      p_joined_at: joined, p_plan: plan, p_bank_name: bankName || null, p_bank_account: bankAcct || null,
      p_invest_months: months, p_interest_pct: rate
    };

    let r = await fetch(`${RPC}/admin_upsert_user_with_account`, { method:"POST", headers: headersJSON(), body: JSON.stringify(bodyNew) });

    if (!r.ok) {
      const txt = await r.text();
      const isNoMatch = txt.includes("PGRST202") || txt.includes("Could not find the function");
      if (!isNoMatch) throw new Error(txt || "Error guardando");

      const bodyOld = {
        p_email: email, p_full_name: fullName, p_currency: currency, p_capital: capital,
        p_joined_at: joined, p_plan: plan, p_bank_name: bankName || null, p_bank_account: bankAcct || null
      };
      r = await fetch(`${RPC}/admin_upsert_user_with_account`, { method:"POST", headers: headersJSON(), body: JSON.stringify(bodyOld) });
      if (!r.ok) throw new Error(await r.text() || "Error guardando");

      try {
        const rV = await fetch(`${BASE}/v_admin_users?email=eq.${encodeURIComponent(email)}&select=account_id`, {headers: headersJSON()});
        if (rV.ok) {
          const rows = await rV.json();
          const accId = rows?.[0]?.account_id;
          if (accId) {
            await fetch(`${BASE}/accounts?id=eq.${accId}`, {
              method:"PATCH", headers: headersJSON(),
              body: JSON.stringify({ invest_months: months, interest_pct: rate })
            });
          }
        }
      } catch {}
    }

    // asegurar tipo de cuenta y tel√©fono
    try{
      const rV = await fetch(`${BASE}/v_admin_users?email=eq.${encodeURIComponent(email)}&select=account_id,user_id`, {headers: headersJSON()});
      const rows = rV.ok ? await rV.json() : [];
      const accId = rows?.[0]?.account_id;
      const uId   = rows?.[0]?.user_id;

      if (accId){
        await fetch(`${BASE}/accounts?id=eq.${accId}`, {
          method:"PATCH", headers: headersJSON(),
          body: JSON.stringify({ bank_account_type: bankType || null })
        });
      }

      if (uId){
        await fetch(`${BASE}/profiles?id=eq.${encodeURIComponent(uId)}`, {
          method:"PATCH", headers: headersJSON(),
          body: JSON.stringify({ phone: phone || null })
        });
      }
    }catch{}

    if (msgEl) msgEl.textContent = "Guardado";
    await listUsers();
  } catch (e) {
    if (msgEl) msgEl.textContent = "Error";
    alert("No se pudo guardar: " + (e.message || e));
  }
}

/*** BORRAR USUARIO: RPC -> Auth -> fallback manual, no-cache y UI optimista ***/
async function deleteClient(x){
  const msg = `¬øEliminar al cliente?\n\nNombre: ${x.full_name||'‚Äî'}\nEmail: ${x.email||'‚Äî'}`;
  if(!confirm(msg)) return;

  const jh = headersJSON();
  const ts = `_ts=${Date.now()}`;
  const mustOk = async (resp, label) => {
    if (!resp.ok) {
      const t = await resp.text().catch(()=> '');
      if (t.match(/Policies|RLS|permission|not authorized|violates row-level/mi)) {
        throw new Error(`Bloqueado por RLS/Permisos al ${label}. Asegura el RPC SECURITY DEFINER.`);
      }
      throw new Error(`Error al ${label}: ${t || resp.status}`);
    }
  };

  // 1) RPC primero (si existe versi√≥n con p_dry_run)
  let rpcTried = false;
  try{
    rpcTried = true;
    const r = await fetch(`${RPC}/admin_delete_user_cascade?${ts}`, {
      method:"POST", headers: jh, body: JSON.stringify({ p_email: x.email, p_dry_run: false })
    });
    if (r.status === 404) throw new Error("RPC no existe");
    await mustOk(r, "RPC admin_delete_user_cascade");
  }catch(e){
    // fallback manual
    await deleteClientManual(x, jh, mustOk);
  }

  // 2) Borrar en Auth (best-effort)
  try{
    await fetch("https://czvpehbubfrinutztnwh.functions.supabase.co/admin-delete-user", {
      method:"POST",
      headers:{ "Content-Type":"application/json", apikey: ANON_KEY, Authorization:"Bearer "+(localStorage.token||"") },
      body: JSON.stringify({ email: x.email })
    });
  }catch{}

  // 3) UI optimista + reconsulta sin cach√©
  CACHED = CACHED.filter(r => (r.email||"").toLowerCase() !== (x.email||"").toLowerCase());
  renderUsers(CACHED);
  await listUsers();

  alert("Cliente eliminado correctamente.");
}

async function deleteClientManual(x, jh, mustOk) {
  // asegurar IDs
  if (!x?.user_id || !x?.account_id) {
    const ts = `_ts=${Date.now()}`;
    const r = await fetch(`${BASE}/v_admin_users?email=eq.${encodeURIComponent(x.email)}&select=user_id,account_id&${ts}`, {
      headers: { apikey: ANON_KEY, Authorization: "Bearer "+localStorage.token, "Cache-Control":"no-cache" },
      cache: "no-store"
    });
    await mustOk(r, "consultar v_admin_users");
    const rows = await r.json();
    if (rows?.[0]) {
      x.user_id   = x.user_id   || rows[0].user_id;
      x.account_id= x.account_id|| rows[0].account_id;
    }
  }

  // hijos -> cuenta -> perfil
  if (x.account_id) {
    const delWr = await fetch(`${BASE}/withdrawal_requests?account_id=eq.${encodeURIComponent(x.account_id)}`, { method:"DELETE", headers: jh, cache:"no-store" });
    await mustOk(delWr, "eliminar withdrawal_requests");

    const delNoti = await fetch(`${BASE}/admin_notifications?payload->>account_id=eq.${encodeURIComponent(x.account_id)}`, { method:"DELETE", headers: jh, cache:"no-store" });
    await mustOk(delNoti, "eliminar admin_notifications");

    const delAcc = await fetch(`${BASE}/accounts?id=eq.${encodeURIComponent(x.account_id)}`, { method:"DELETE", headers: jh, cache:"no-store" });
    await mustOk(delAcc, "eliminar accounts");
  }

  if (x.user_id) {
    const delProf = await fetch(`${BASE}/profiles?id=eq.${encodeURIComponent(x.user_id)}`, { method:"DELETE", headers: jh, cache:"no-store" });
    if (!delProf.ok && delProf.status !== 404) await mustOk(delProf, "eliminar profiles");
  }
}

/*** NOTIFICACIONES ***/
async function loadNotifs(){
  const ts = `_ts=${Date.now()}`;
  const r = await fetch(`${BASE}/admin_notifications?select=*&order=created_at.desc&${ts}`, {
    headers:{ apikey: ANON_KEY, Authorization:"Bearer "+localStorage.token, "Cache-Control":"no-cache" },
    cache:"no-store"
  });
  const rows = await r.json();
  const tb = $("notifs"); tb.innerHTML="";
  rows.forEach(x=>{
    const p = x.payload || {};
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${new Date(x.created_at).toLocaleString()}</td>
      <td>${p.account_id||'‚Äî'}</td>
      <td>${p.kind||'‚Äî'}</td>
      <td>${(p.penalty_pct??0)}%</td>
      <td><span class="chip">‚Äî</span></td>`;
    tb.appendChild(tr);
  });
}

/*** INIT ***/
async function initApp(){
  if(localStorage.token){
    show($("unauth"), false);
    show($("app"), true);
    show($("logoutBtn"), true);
    await listUsers();
    await loadNotifs();
  }else{
    show($("app"), false);
    show($("logoutBtn"), false);
    show($("unauth"), true);
  }
}

/*** BINDINGS ***/
document.addEventListener("DOMContentLoaded", ()=>{
  $("loginForm").addEventListener("submit", doLogin);
  $("logoutBtn").addEventListener("click", logout);
  $("togglePass").addEventListener("click", ()=> {
    const inp = $("u_pass"); inp.type = (inp.type === "password") ? "text" : "password";
  });
  $("saveBtn").addEventListener("click", saveUser);
  $("clearBtn").addEventListener("click", clearForm);
  $("btnRefreshNotifs").addEventListener("click", loadNotifs);
  $("btnRefreshUsers").addEventListener("click", listUsers);
  initApp();
});
</script>
</body>
</html>
