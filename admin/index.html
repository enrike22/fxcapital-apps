<script>
async function saveUser(){
  const email    = document.getElementById("u_email").value.trim();
  const fullName = document.getElementById("u_name").value.trim();
  const password = document.getElementById("u_pass").value;
  const currency = document.getElementById("u_currency").value;
  const capital  = Number(document.getElementById("u_capital").value || 0);
  const joined   = document.getElementById("u_joined").value || null;
  const plan     = document.getElementById("u_plan").value;
  const months   = parseInt(document.getElementById("u_months").value, 10);
  const rateStr  = document.getElementById("u_rate").value;
  const rate     = rateStr === "" ? null : Number(rateStr);
  const bankName = document.getElementById("u_bank_name").value.trim();
  const bankAcct = document.getElementById("u_bank_account").value.trim();
  const msgEl    = document.getElementById("saveMsg");
  if (msgEl) msgEl.textContent = "…";

  try {
    if (!email) throw new Error("Email requerido");
    if (!fullName) throw new Error("Nombre requerido");
    if (!password || password.length < 8) throw new Error("Contraseña mínima de 8 caracteres");
    if (isNaN(capital) || capital < 0) throw new Error("Capital inválido");

    // 1) Crear/asegurar usuario en Auth
    await createAuthUserIfNeeded(email, password, fullName);

    // 2) Intento con firma NUEVA (incluye meses + tasa)
    const bodyNew = {
      p_email: email,
      p_full_name: fullName,
      p_currency: currency,
      p_capital: capital,
      p_joined_at: joined,
      p_plan: plan,
      p_bank_name: bankName || null,
      p_bank_account: bankAcct || null,
      p_invest_months: months,
      p_interest_pct: rate
    };

    let r = await fetch(`${RPC}/admin_upsert_user_with_account`, {
      method:"POST",
      headers: headersJSON(),
      body: JSON.stringify(bodyNew)
    });

    // 3) Si el RPC no tiene los parámetros nuevos, reintenta con la firma ANTIGUA
    if (!r.ok) {
      const txt = await r.text();
      const isNoMatch = txt.includes("PGRST202") || txt.includes("Could not find the function");
      if (!isNoMatch) throw new Error(txt || "Error guardando");

      const bodyOld = {
        p_email: email,
        p_full_name: fullName,
        p_currency: currency,
        p_capital: capital,
        p_joined_at: joined,
        p_plan: plan,
        p_bank_name: bankName || null,
        p_bank_account: bankAcct || null
      };

      r = await fetch(`${RPC}/admin_upsert_user_with_account`, {
        method:"POST",
        headers: headersJSON(),
        body: JSON.stringify(bodyOld)
      });
      if (!r.ok) throw new Error(await r.text() || "Error guardando");

      // 4) Fallback: actualizar invest_months e interest_pct con PATCH directo si existen las columnas
      try {
        // buscamos la cuenta recién creada/actualizada a través de la vista v_admin_users
        const rV = await fetch(
          `${BASE}/v_admin_users?email=eq.${encodeURIComponent(email)}&select=account_id`,
          { headers: headersJSON() }
        );
        if (rV.ok) {
          const rows = await rV.json();
          const accId = rows?.[0]?.account_id;
          if (accId) {
            await fetch(`${BASE}/accounts?id=eq.${accId}`, {
              method:"PATCH",
              headers: headersJSON(),
              body: JSON.stringify({
                invest_months: months,
                interest_pct: rate
              })
            });
          }
        }
      } catch (e) {
        console.warn("PATCH months/rate fallback:", e);
      }
    }

    if (msgEl) msgEl.textContent = "Guardado";
    document.getElementById("u_pass").value = ""; // limpiar por seguridad
    await listUsers();

  } catch (e) {
    if (msgEl) msgEl.textContent = "Error";
    alert("No se pudo guardar: " + (e.message || e));
  }
}
</script>
