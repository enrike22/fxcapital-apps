<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. ‚Äî Admin</title>
<link rel="icon" href="data:,">

<style>
/* ========= 3D PRO THEME ========= */
:root{
  --bg:#07080a;
  --fg:#f5f7fa;
  --muted:#c7cdd6;

  --card1:#0f1116;
  --card2:#0b0d11;

  --border:rgba(255,255,255,.08);
  --border2:rgba(255,255,255,.12);

  --shadow: 0 18px 60px rgba(0,0,0,.55);
  --shadow2: 0 10px 30px rgba(0,0,0,.45);

  --radius:18px;
  --radius2:14px;

  --chip:#121620;

  --danger:#ff4d4f;
  --ok:#2dd4bf;

  --glow: 0 0 0 3px rgba(255,255,255,.06), 0 0 40px rgba(255,255,255,.06);
  --glow2: 0 0 0 3px rgba(45,212,191,.15), 0 0 40px rgba(45,212,191,.10);

  --txtSoft: rgba(245,247,250,.86);
  --txtDim: rgba(245,247,250,.68);

  --grid: radial-gradient(circle at 25% 12%, rgba(255,255,255,.06), transparent 55%),
          radial-gradient(circle at 75% 18%, rgba(45,212,191,.08), transparent 60%),
          radial-gradient(circle at 50% 90%, rgba(255,255,255,.05), transparent 55%);

  /* KPI (del panel PRO) */
  --good:#21C07A;
  --warn:#E6C15A;
  --bad:#FF4D4F;
  --primary:#E6C15A;
  --primary2:#D8B65C;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 800px at 20% 0%, rgba(255,255,255,.06), transparent 60%),
    radial-gradient(900px 700px at 90% 20%, rgba(45,212,191,.08), transparent 55%),
    radial-gradient(900px 700px at 50% 100%, rgba(255,255,255,.05), transparent 60%),
    linear-gradient(180deg, var(--bg), #050508);
  color:var(--fg);
  font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial;
  font-size:16px;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

.container{
  max-width:1320px;
  margin:0 auto;
  padding:22px 22px 46px;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  margin-bottom:18px;
}

h1{
  margin:0;
  font-size:28px;
  letter-spacing:.2px;
  line-height:1.15;
  color:var(--fg);
  text-shadow: 0 1px 0 rgba(255,255,255,.05);
}

h2{
  margin:0 0 14px;
  font-size:20px;
  font-weight:800;
  letter-spacing:.2px;
  color:var(--fg);
}

.small{font-size:13px;color:var(--txtDim)}
.error{font-size:13px;color:var(--danger)}
.nowrap{white-space:nowrap}
.hidden{display:none !important}

/* ---- cards (3D) ---- */
.card{
  position:relative;
  overflow:hidden;
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), transparent 24%),
    linear-gradient(180deg, var(--card1), var(--card2));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:26px 22px;
  box-shadow: var(--shadow);
  margin-bottom:22px;
  transform: translateZ(0);
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.card:before{
  content:"";
  position:absolute;
  inset:-1px;
  background: var(--grid);
  opacity:.9;
  pointer-events:none;
  mask: linear-gradient(180deg, rgba(0,0,0,1), rgba(0,0,0,.55) 45%, rgba(0,0,0,0));
}
.card:after{
  content:"";
  position:absolute;
  inset:-120px;
  background:
    conic-gradient(from 180deg at 50% 50%, rgba(255,255,255,.14), transparent 40%, rgba(45,212,191,.10), transparent 70%, rgba(255,255,255,.10));
  opacity:.08;
  filter: blur(20px);
  transform: translate3d(0,0,0);
  pointer-events:none;
  animation: floatGlow 8s ease-in-out infinite;
}
@keyframes floatGlow{
  0%,100%{ transform: translate3d(0,0,0) rotate(0deg); }
  50%{ transform: translate3d(10px,-8px,0) rotate(10deg); }
}
.card:hover{
  transform: translateY(-2px);
  border-color: var(--border2);
  box-shadow: 0 22px 70px rgba(0,0,0,.6);
}

/* ---- inputs ---- */
label{
  display:block;
  margin:10px 0 6px;
  color:var(--txtDim);
  font-size:13px;
  letter-spacing:.2px;
}
input,select{
  width:100%;
  background: rgba(8,10,14,.9);
  color:var(--fg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px 12px;
  font-size:15px;
  outline:none;
  transition: box-shadow .15s ease, border-color .15s ease, transform .12s ease, background .15s ease;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
}
input::placeholder{ color: rgba(245,247,250,.35); }
input:focus,select:focus{
  border-color: rgba(45,212,191,.40);
  box-shadow: var(--glow2);
  background: rgba(10,12,16,.95);
}
input:hover,select:hover{
  border-color: rgba(255,255,255,.14);
}

/* ---- buttons ---- */
button{
  background: linear-gradient(180deg, #ffffff, #e9edf2);
  color:#0b0c0e;
  border:none;
  padding:12px 18px;
  border-radius:999px;
  font-weight:900;
  cursor:pointer;
  font-size:15px;
  box-shadow: 0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.55);
  transition: transform .14s ease, box-shadow .14s ease, filter .14s ease;
}
button:hover{
  transform: translateY(-1px);
  box-shadow: 0 18px 44px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.65);
  filter: brightness(1.02);
}
button:active{ transform: translateY(0px) scale(.99); }


.actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button.mini{padding:8px 12px;font-size:13px;border-radius:999px}
button.ghost{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  color:var(--fg);
  border:1px solid var(--border);
  box-shadow: 0 10px 26px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
}
button.ghost:hover{
  border-color: rgba(255,255,255,.14);
  box-shadow: 0 14px 36px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
}
button.danger{
  background: linear-gradient(180deg, #ff6b6c, #ff3f40);
  color:#fff;
  box-shadow: 0 14px 34px rgba(255,77,79,.20), 0 12px 30px rgba(0,0,0,.35);
}
button.danger:hover{
  box-shadow: 0 18px 44px rgba(255,77,79,.24), 0 16px 40px rgba(0,0,0,.45);
}
button.ok{
  background: linear-gradient(180deg, rgba(45,212,191,1), rgba(45,212,191,.75));
  color:#02110f;
  box-shadow: 0 14px 34px rgba(45,212,191,.18), 0 12px 30px rgba(0,0,0,.35);
}
button.ok:hover{
  box-shadow: 0 18px 44px rgba(45,212,191,.22), 0 16px 40px rgba(0,0,0,.45);
}

.inline{display:flex;gap:10px;align-items:center}
.row{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
hr.sep{border:0;border-top:1px solid rgba(255,255,255,.08);margin:14px 0}

/* ---- searchbar ---- */
.searchbar{position:relative;max-width:520px;min-width:280px}
.searchbar input{padding-left:40px}
.searchbar svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.75;pointer-events:none}

/* ---- tables ---- */
.table-wrap{
  overflow:auto;
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius2);
  background: rgba(0,0,0,.16);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.08);
  vertical-align:middle;
  font-size:15px;
  color: var(--txtSoft);
}
th{
  text-align:left;
  color: rgba(245,247,250,.92);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  position:sticky;
  top:0;
  z-index:2;
  backdrop-filter: blur(8px);
}
tbody tr{ transition: background .12s ease, transform .12s ease; }
tbody tr:hover{ background: rgba(255,255,255,.035); }

.chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.08);
  font-size:13px;
  color: rgba(245,247,250,.86);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
}
.dot{
  width:8px;height:8px;border-radius:99px;
  background: rgba(45,212,191,.9);
  box-shadow: 0 0 0 3px rgba(45,212,191,.12);
}
.dot.pending{ background: rgba(255,255,255,.75); box-shadow: 0 0 0 3px rgba(255,255,255,.10); }
.dot.scheduled{ background: rgba(253, 224, 71, .95); box-shadow: 0 0 0 3px rgba(253,224,71,.14); }
.dot.approved{ background: rgba(45,212,191,.9); }
.dot.rejected{ background: rgba(255,77,79,.95); box-shadow: 0 0 0 3px rgba(255,77,79,.12); }

@keyframes fadeUp{
  from{ opacity:0; transform: translateY(10px); }
  to{ opacity:1; transform: translateY(0); }
}
.container{ animation: fadeUp .32s ease both; }

.loading{opacity:.85;position:relative;}
.loading:after{
  content:"";
  width:10px;height:10px;border-radius:50%;
  border:2px solid rgba(255,255,255,.25);
  border-top-color: rgba(255,255,255,.8);
  display:inline-block;
  margin-left:10px;
  vertical-align:middle;
  animation: spin .8s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }

@media (max-width:680px){
  .header{flex-direction:column;align-items:flex-start}
  .searchbar{max-width:100%;min-width:0;width:100%}
}

/* ===== Modal ===== */
.modal-backdrop{
  position:fixed; inset:0;
  background: rgba(0,0,0,.62);
  backdrop-filter: blur(8px);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:9999;
}
.modal-backdrop.hidden{display:none !important}
.modal{
  width:min(900px, 100%);
  border-radius:22px;
  border:1px solid rgba(255,255,255,.10);
  box-shadow: 0 30px 90px rgba(0,0,0,.65);
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), transparent 22%),
    linear-gradient(180deg, var(--card1), var(--card2));
  position:relative;
  overflow:hidden;
}
.modal:before{
  content:"";
  position:absolute; inset:-1px;
  background: var(--grid);
  opacity:.85;
  pointer-events:none;
  mask: linear-gradient(180deg, rgba(0,0,0,1), rgba(0,0,0,.55) 45%, rgba(0,0,0,0));
}
.modal-inner{ position:relative; padding:20px 18px 18px; }
.modal-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
.modal-title h3{ margin:0; font-size:18px; letter-spacing:.2px; }
.modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; flex-wrap:wrap; }
.xbtn{
  background: transparent;
  border:1px solid rgba(255,255,255,.12);
  color: rgba(245,247,250,.9);
  padding:10px 12px;
  border-radius:999px;
  box-shadow:none;
}
.xbtn:hover{ border-color: rgba(255,255,255,.18); box-shadow: var(--shadow2); transform: translateY(-1px); }

.header-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

/* ===== Sticky Topbar + KPI (agregado, no rompe nada) ===== */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  gap:14px; padding:16px 16px;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.08);
  border-radius:22px;
  box-shadow:var(--shadow);
  position:sticky;top:12px;z-index:200;
  backdrop-filter: blur(10px);
  margin-bottom:14px;
}
.brand{display:flex;align-items:center;gap:12px;min-width:260px}
.logo{
  width:38px;height:38px;border-radius:12px;
  background: linear-gradient(180deg, rgba(230,193,90,.22), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.10);
  display:grid;place-items:center;
  font-weight:900;letter-spacing:.6px;
}
.brand .title{margin:0;font-size:16px;letter-spacing:.3px;font-weight:900}
.brand .sub{margin-top:3px;color:rgba(245,247,250,.68);font-size:12px}
.right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.search-pill{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:999px;
  background: rgba(0,0,0,.30);
  border:1px solid rgba(255,255,255,.08);
  min-width:320px;
}
.search-pill input{
  width:100%;
  border:0;outline:0;background:transparent;color:var(--fg);
  font-size:13px
}
.btn-pill{
  border:0;cursor:pointer;
  padding:10px 14px;border-radius:999px;
  background: rgba(255,255,255,.08);
  color:var(--fg);
  border:1px solid rgba(255,255,255,.10);
  box-shadow: 0 12px 30px rgba(0,0,0,.35);
  font-weight:900;font-size:13px;
}
.btn-pill:hover{filter:brightness(1.08)}
.btn-pill:active{transform:translateY(1px)}
.btn-pill.primary{
  background: linear-gradient(180deg, var(--primary), var(--primary2));
  color:#0B0D10;
  border-color: rgba(0,0,0,.25);
}
.btn-pill.danger{
  background: linear-gradient(180deg, rgba(255,77,79,.95), rgba(255,77,79,.75));
  color:#0B0D10;border-color: rgba(0,0,0,.25);
}
.kpis{
  display:grid; gap:12px;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  margin:12px 0 18px;
}
.kpi{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.08);
  border-radius: var(--radius);
  box-shadow:var(--shadow);
  padding:14px 16px;
}
.kpi .label{color:rgba(245,247,250,.68);font-size:12px}
.kpi .value{margin-top:6px;font-size:20px;font-weight:950;letter-spacing:.2px}
.kpi .hint{margin-top:4px;color:rgba(245,247,250,.68);font-size:12px}

.errorBox{
  margin:10px 0 0;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,77,79,.25);
  background: rgba(255,77,79,.08);
  color: rgba(245,247,250,.78);
  font-size:13px;
}
.errorBox.hidden{display:none !important}

@media (max-width: 900px){
  .kpis{grid-template-columns:1fr}
  .search-pill{min-width: 220px}
  .brand{min-width:unset}
}

/* ===== TOAST ===== */
#toastWrap{position:fixed;right:18px;bottom:18px;z-index:9999;display:flex;flex-direction:column;gap:10px;max-width:min(420px,calc(100vw - 36px));}
.toast{padding:12px 14px;border-radius:14px;background:rgba(18,18,20,.92);border:1px solid rgba(255,255,255,.12);box-shadow:0 18px 60px rgba(0,0,0,.55);backdrop-filter:blur(10px);color:#f6f7fb;font-weight:750;letter-spacing:.2px}
.toast.ok{border-color:rgba(0,255,180,.25)}
.toast.err{border-color:rgba(255,85,85,.25)}
.toast .sub{display:block;margin-top:4px;font-weight:650;opacity:.82;font-size:12.5px;line-height:1.35}

</style>

<!-- Supabase JS (CDN) agregado (no rompe el fetch existente, por si luego lo quieres usar) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
<div class="container">

  <!-- ‚úÖ TOPBAR PRO (agregado) -->
  <div class="topbar">
    <div class="brand">
      <div class="logo">FX</div>
      <div>
        <div class="title">FX | CAPITAL R.L. ‚Äî Panel Admin</div>
        <div class="sub" id="sessionMeta">Administrador ¬∑ Sesi√≥n no iniciada</div>
      </div>
    </div>

    <div class="right">
      <div class="search-pill" title="Buscar en clientes">
        <span style="opacity:.75">üîé</span>
        <!-- NOTA: este input es el MISMO id="q" que ya usabas; solo cambiamos el dise√±o -->
        <input id="q" type="search" placeholder="Buscar (nombre, email, tel√©fono, plan, banco‚Ä¶)" aria-label="Buscar cliente" autocomplete="off">
      </div>

      <button id="btnOpenResetGlobal" type="button" class="btn-pill hidden">Reset contrase√±a</button>
      <button id="logoutBtn" type="button" class="btn-pill danger hidden">Cerrar sesi√≥n</button>
    </div>
  </div>

  <!-- ‚úÖ KPIs (agregado) -->
  <div class="kpis" id="kpisWrap" class="hidden">
    <div class="kpi">
      <div class="label">Retiros pendientes</div>
      <div class="value" id="kpiWithdrawPending">‚Äî</div>
      <div class="hint" id="kpiWithdrawHint">Actualizado al cargar</div>
    </div>
    <div class="kpi">
      <div class="label">Recargas pendientes</div>
      <div class="value" id="kpiTopupsPending">‚Äî</div>
      <div class="hint">Pendientes / programadas</div>
    </div>
    <div class="kpi">
      <div class="label">Operaciones hoy</div>
      <div class="value" id="kpiOpsToday">‚Äî</div>
      <div class="hint">Retiros + recargas (√∫ltimas 24h)</div>
    </div>
  </div>

  <!-- Mensajes de error ‚Äúpremium‚Äù globales (agregado, no afecta l√≥gica) -->
  <div id="globalError" class="errorBox hidden"></div>

  <!-- LOGIN -->
  <div id="unauth" class="card">
    <h2>Admin ‚Äî Iniciar sesi√≥n</h2>
    <form id="loginForm" class="row" style="grid-template-columns:1fr 1fr auto">
      <div><label>Email</label><input id="email" type="email" required autocomplete="username"></div>
      <div><label>Contrase√±a</label><input id="password" type="password" required autocomplete="current-password"></div>
      <div style="align-self:end"><button type="submit">Entrar</button></div>
      <div style="grid-column:1/-1"><p id="loginMsg" class="small"></p></div>
    </form>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">

    <!-- SOLICITUDES DE RETIRO (pendientes) -->
    <div class="card">
      <div class="header" style="margin:0 0 10px">
        <h2 style="margin:0">Solicitudes de retiro</h2>
        <button id="btnRefreshWithdrawReqs" type="button" class="ghost">Refrescar</button>
      </div>

      <div class="table-wrap">
        <table>
         <thead>
          <tr>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Email</th>
            <th>Monto</th>
            <th>Banco</th>
            <th>No. cuenta</th>
            <th>Tipo cuenta</th>
            <th>Tipo banco</th>
            <th>Nota</th>
            <th>Acciones</th>
          </tr>
        </thead>
          <tbody id="withdrawReqs"></tbody>
        </table>
      </div>

      <p id="withdrawReqsMsg" class="small"></p>
    </div>

    <!-- TOPUPS -->
    <div class="card">
      <div class="header" style="margin:0 0 10px">
        <h2 style="margin:0">Recargas (pendientes / programadas)</h2>
        <button id="btnRefreshTopups" type="button" class="ghost">Refrescar</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Email</th>
              <th>Monto</th>
              <th>Banco</th>
               <th>No. cuenta</th>
               <th>Boleta</th>
              <th class="nowrap">Estado</th>
              <th class="nowrap">Efectiva</th>
              <th class="nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody id="topups"></tbody>
        </table>
      </div>

      <p class="small" style="margin-top:10px">
        ‚úÖ <b>Aprobar ahora</b> acredita el capital inmediatamente. <br>
        üìÜ <b>Programar</b> guarda una <b>effective_date</b> y el Cron DB acreditar√° a las <b>9:00 AM (GT)</b> del d√≠a programado.
      </p>
      <p id="topupsMsg" class="small"></p>
    </div>

    <!-- Crear/Editar -->
    <div class="card" id="formCard">
      <h2>Crear / Editar usuario</h2>

      <form id="userForm" class="row" onsubmit="return false;">
        <div>
          <label>Modo de intereses</label>
          <select id="u_interest_mode">
            <option value="monthly">Pagados mensualmente</option>
            <option value="compound">Acumulados (hasta finalizar meses)</option>
          </select>
          <div class="small">‚ÄúAcumulados‚Äù = no se marcan como pagados cada mes; se acumulan en saldo.</div>
        </div>
        <div>
          <label>Email</label>
          <input id="u_email" placeholder="cliente@demo.com" type="email" autocomplete="email">
          <div class="small">Para editar, escribe el email o usa <b>Editar</b> en la lista.</div>
        </div>

        <div>
          <label>Cuenta seleccionada</label>
          <div class="inline">
            <select id="u_account_sel"></select>
            <button type="button" id="btnAddAccount" class="ghost">+ Nueva cuenta</button>
          </div>
          <div class="small" id="u_accounts_hint">Selecciona qu√© cuenta deseas editar.</div>
          <input type="hidden" id="u_user_id">
          <input type="hidden" id="u_account_id">
        </div>


        <div><label>Nombre completo</label><input id="u_name" placeholder="Cliente Demo" autocomplete="name"></div>
        <div><label>Tel√©fono (celular)</label><input id="u_phone" type="tel" inputmode="tel" placeholder="+502 5555 5555" autocomplete="tel"></div>

        <div>
          <label>Contrase√±a (para el cliente)</label>
          <div class="inline">
            <input id="u_pass" type="password" placeholder="M√≠n. 8 caracteres (vac√≠o = no crea en Auth)" autocomplete="new-password">
            <button type="button" id="togglePass" class="ghost" title="Mostrar/ocultar">üëÅ</button>
          </div>
        </div>

        <div>
          <label>Moneda</label>
          <select id="u_currency"><option>GTQ</option><option>USD</option></select>
        </div>

        <div>
          <label>Capital inicial</label>
          <input id="u_capital" type="text" inputmode="decimal" placeholder="0.00" autocomplete="off">
        </div>

        <div><label>Fecha ingreso</label><input id="u_joined" type="date" autocomplete="off"></div>

        <div>
          <label>Plan</label>
          <select id="u_plan">
            <option value="STANDARD">Estandar-15%</option>
            <option value="PLATINUM">Platinum-20%</option>
            <option value="BLACK">Black-Tasa preferencial</option>
          </select>
        </div>

        <div>
          <label>Meses de inversi√≥n</label>
          <select id="u_months">
            <option>6</option><option selected>12</option><option>18</option><option>24</option>
            <option>30</option><option>36</option><option>42</option><option>48</option>
            <option>54</option><option>60</option>
          </select>
        </div>

        <div>
          <label>Tasa semestral (%)</label>
          <input id="u_rate" type="number" min="0" max="100" step="0.01" placeholder="Ej. 15, 20" autocomplete="off">
          <div id="rateError" class="error hidden">la tasa de inter√©s indicada con el plan indicado no coinciden</div>
          <div class="small">Para STANDARD debe ser 15. Para PLATINUM debe ser 20.</div>
        </div>

        <div><label>Banco</label><input id="u_bank_name" placeholder="Banco Industrial" autocomplete="organization"></div>
        <div><label>No. de cuenta</label><input id="u_bank_account" placeholder="1234567890" autocomplete="off"></div>
        <div><label>Tipo de cuenta</label><input id="u_bank_account_type" placeholder="Ahorro / Monetaria / ‚Ä¶" autocomplete="off"></div>
      </form>

      <hr class="sep">

      <div class="inline" style="gap:12px">
        <button id="saveBtn" type="button">Guardar</button>
        <button id="clearBtn" type="button" class="ghost">Limpiar</button>
        <span id="saveMsg" class="small" style="margin-left:8px"></span>
      </div>
    </div>

    <!-- RETIRAR CAPITAL -->
    <div class="card">
      <div class="header" style="margin:0 0 10px; align-items:flex-start">
        <div>
          <h2 style="margin:0">Retirar capital (Admin)</h2>
          <div class="small" style="margin-top:6px;opacity:.9">
            Crea un registro en <b>withdrawals</b> y descuenta del <b>capital actual</b>.
          </div>
        </div>

        <div class="inline" style="gap:10px">
          <button id="btnOpenWithdrawHistory" type="button" class="ghost">Historial de retiros</button>
        </div>
      </div>

      <div class="grid" style="display:grid;gap:12px;grid-template-columns:1fr 1fr">
        <div>
          <label>Cliente / Cuenta</label>
          <select id="wdAccount"></select>
          <div class="small" id="wdHint">‚Äî</div>
        </div>

        <div>
          <label>Monto a retirar</label>
          <input id="wdAmount" type="number" step="0.01" min="0" placeholder="Ej: 500.00" autocomplete="off">
        </div>

        <div>
          <label>Referencia (opcional)</label>
          <input id="wdRef" type="text" placeholder="Boleta / Banco / Nota corta" autocomplete="off">
        </div>

        <div>
          <label>Nota interna (opcional)</label>
          <input id="wdNote" type="text" placeholder="Motivo / solicitud / observaci√≥n" autocomplete="off">
        </div>
      </div>

      <div style="display:flex;gap:10px;align-items:center;margin-top:12px">
        <button id="btnWithdraw" class="danger" type="button">Retirar</button>
        <span id="wdMsg" class="small" style="opacity:.9"></span>
      </div>
    </div>

    <!-- Lista -->
    
    <!-- ACREDITAR CAPITAL (DIRECTO) -->
    <div class="card">
      <div class="header" style="margin:0 0 10px; align-items:flex-start">
        <div>
          <h2 style="margin:0">Acreditar capital (Admin)</h2>
          <div class="small" style="margin-top:6px;opacity:.9">
            Acredita capital <b>directamente</b> a una cuenta (sin editar cliente y sin recarga). Queda registro en el sistema.
          </div>
        </div>
      </div>

      <div class="grid" style="display:grid;gap:12px;grid-template-columns:1fr 1fr">
        <div>
          <label>Cliente / Cuenta</label>
          <select id="capAccount"></select>
          <div class="small" id="capHint">‚Äî</div>
        </div>

        <div>
          <label>Monto a acreditar</label>
          <input id="capAmount" type="number" step="0.01" min="0" placeholder="Ej: 1000.00">
        </div>

        <div>
          <label>Fecha efectiva</label>
          <input id="capDate" type="date">
          <div class="small">Sugerido: hoy. (Se usa para el c√°lculo/registro)</div>
        </div>

        <div>
          <label>Banco (opcional)</label>
          <input id="capBank" type="text" placeholder="Ej: Banrural">
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Nota interna (opcional)</label>
        <input id="capNote" type="text" placeholder="Motivo / referencia / observaci√≥n">
      </div>

      <div class="inline" style="margin-top:14px; gap:10px">
        <button id="btnAccreditCapital" type="button" class="primary">Acreditar</button>
        <div class="small" id="capMsg"></div>
      </div>
    </div>

<div class="card">
      <div class="header" style="margin:0 0 10px">
        <h2 style="margin:0">Clientes</h2>
        <button id="btnRefreshUsers" type="button" class="ghost">Refrescar lista</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Tel√©fono</th>
              <th class="nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody id="users"></tbody>
        </table>
      </div>

      <p class="small" style="margin-top:10px">
        <span class="chip"><span class="dot"></span>Modo ‚ÄúAcumulado‚Äù = se guarda en cuenta; ‚ÄúMensual‚Äù = se paga/marca cada mes.</span>
      </p>
      <p id="usersMsg" class="small" style="margin-top:6px"></p>
    

    <!-- CUENTAS DEL CLIENTE (nuevo: vista ordenada) -->
    <div class="card hidden" id="accountsCard">
      <div class="header" style="margin:0 0 10px">
        <div>
          <h2 id="accountsTitle" style="margin:0">Cuentas del cliente</h2>
          <div class="small" style="margin-top:6px;opacity:.9">Aqu√≠ puedes editar cada cuenta sin afectar a las dem√°s.</div>
        </div>
        <button type="button" class="ghost" onclick="closeClientAccounts()">Volver a clientes</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="nowrap">Cuenta</th>
              <th>Plan</th>
              <th>Capital</th>
              <th>Moneda</th>
              <th>Meses</th>
              <th>Tasa %/6m</th>
              <th>Modo</th>
              <th>Banco</th>
              <th class="nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody id="accountsBody"></tbody>
        </table>
      </div>
      <p class="small" style="margin-top:10px">Tip: usa <b>Editar</b> para cargar esa cuenta en el formulario y guarda. Solo se actualiza la cuenta seleccionada.</p>
    </div>

</div>

  </div><!-- /app -->
</div><!-- /container -->

<!-- ===== MODAL: PROGRAMAR TOPUP ===== -->
<div id="modalScheduleTopup" class="modal-backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-inner">
      <div class="modal-title">
        <h3>Programar acreditaci√≥n</h3>
        <button class="xbtn" type="button" onclick="closeScheduleTopupModal()">‚úï</button>
      </div>

      <div class="small" id="schedInfo">‚Äî</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Fecha efectiva (se acredita a las 9:00 AM GT)</label>
          <input id="schedDate" type="date" autocomplete="off">
          <div class="small">üîí No se permiten fechas pasadas.</div>
        </div>
        <div>
          <label>Nota (opcional)</label>
          <input id="schedNote" placeholder="Ej: Se acredita al inicio del ciclo" autocomplete="off">
        </div>
      </div>

      <hr class="sep">

      <div class="inline" style="justify-content:space-between; gap:12px">
        <div class="small" id="schedMsg"></div>
        <div class="modal-actions">
          <button class="ghost" type="button" onclick="closeScheduleTopupModal()">Cancelar</button>
          <button class="ok" type="button" id="btnDoSchedule">Programar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL: RESET PASSWORD ===== -->
<div id="modalReset" class="modal-backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-inner">
      <div class="modal-title">
        <h3>Forzar cambio de contrase√±a</h3>
        <button class="xbtn" type="button" onclick="closeResetModal()">‚úï</button>
      </div>

      <div class="small" id="resetClientInfo">‚Äî</div>

      <div class="row" style="margin-top:10px">
        <div id="resetPickWrap" class="hidden">
          <label>Seleccionar cliente</label>
          <select id="resetPick"></select>
          <div class="small">Elige el cliente al que le asignar√°s una contrase√±a temporal.</div>
        </div>

        <div>
          <label>Nueva contrase√±a</label>
          <input id="resetNewPass" type="text" placeholder="M√≠nimo 8 caracteres" autocomplete="new-password">
          <div class="small">Luego el cliente deber√° iniciar sesi√≥n y cambiarla en su modal obligatorio.</div>
        </div>
      </div>

      <hr class="sep">

      <div class="inline" style="justify-content:space-between; gap:12px">
        <div class="small" id="resetMsg"></div>
        <div class="modal-actions">
          <button class="ghost" type="button" onclick="closeResetModal()">Cancelar</button>
          <button class="ok" type="button" id="btnResetDo">Aplicar reset</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL: HISTORIAL DE RETIROS ===== -->
<div id="modalWithdrawHistory" class="modal-backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-inner">
      <div class="modal-title">
        <h3>Historial de retiros</h3>
        <button class="xbtn" type="button" onclick="closeWithdrawHistory()">‚úï</button>
      </div>

      <div class="small" id="wdhInfo">
        Aqu√≠ puedes imprimir/guardar en PDF y luego (si quieres) borrar lo mostrado.
      </div>

      <div class="inline" style="justify-content:space-between; margin-top:12px; gap:10px; flex-wrap:wrap">
        <div class="inline" style="gap:10px; flex-wrap:wrap">
          <button id="btnLoadWithdrawHistory" type="button" class="ghost">Refrescar historial</button>
          <button id="btnPrintWithdrawHistory" type="button">Imprimir / Guardar PDF</button>
          <button id="btnDeleteWithdrawalsShown" type="button" class="danger">Borrar historial mostrado</button>
        </div>
        <div class="small" id="wdhMsg">‚Äî</div>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table>
          <thead>
            <tr>
              <th class="nowrap">Fecha</th>
              <th>Cliente</th>
              <th>Email</th>
              <th>Monto</th>
              <th>Referencia</th>
              <th>Motivo / Nota</th>
            </tr>
          </thead>
          <tbody id="wdhBody"></tbody>
        </table>
      </div>

      <p class="small" style="margin-top:10px; opacity:.85">
        ‚ö†Ô∏è <b>‚ÄúBorrar historial mostrado‚Äù</b> elimina filas de la base de datos. √ösalo solo si ya guardaste el PDF.
      </p>
    </div>
  </div>
</div>

<!-- ===== MODAL: CONFIRMACI√ìN PRO (agregado) ===== -->
<div id="modalConfirm" class="modal-backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal" style="width:min(620px,100%)">
    <div class="modal-inner">
      <div class="modal-title">
        <h3 id="confirmTitle">Confirmaci√≥n</h3>
        <button class="xbtn" type="button" onclick="closeConfirm(false)">‚úï</button>
      </div>

      <div class="small" id="confirmMsg" style="color:rgba(245,247,250,.86);line-height:1.5">‚Äî</div>

      <hr class="sep">

      <div class="inline" style="justify-content:space-between; gap:12px">
        <div class="small" style="opacity:.8">Esta acci√≥n quedar√° registrada en el historial administrativo.</div>
        <div class="modal-actions">
          <button class="ghost" type="button" onclick="closeConfirm(false)">Cancelar</button>
          <button class="ok" type="button" id="confirmOkBtn">Confirmar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<script>
/*** SUPABASE CONFIG (CORRECTO) ***/
const PROJECT_URL = "https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
// Wrapper seguro para llamar RPC (POST /rest/v1/rpc/<fn>)
async function supabaseRpc(fn, body){
  const url = `${SUPABASE_URL}/rest/v1/rpc/${fn}`;
  const headers = {
    "Content-Type": "application/json",
    apikey: ANON_KEY,
    Authorization: `Bearer ${session?.access_token || accessToken || token || ""}`,
  };
  const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(body || {}) });
  const text = await r.text();
  let data = null;
  try{ data = text ? JSON.parse(text) : null; }catch(e){ data = text; }
  if(!r.ok) return { ok:false, error:data || {status:r.status}, data:null };
  return { ok:true, data, error:null };
}

const BASE = PROJECT_URL + "/rest/v1";
const RPC  = BASE + "/rpc";
const SUPABASE_URL = PROJECT_URL;
const SUPABASE_ANON_KEY = ANON_KEY;


function getToken(){
  const t = (localStorage.token || "").trim();
  // Debe verse como JWT (3 partes)
  if(!t || t === "null" || t === "undefined") return "";
  if(t.split(".").length !== 3) return "";
  return t;
}

function headersJSON(){
  const h = {
    apikey: ANON_KEY,
    "Content-Type":"application/json",
    "Prefer":"return=representation"
  };
  const token = getToken();
  if(token) h.Authorization = "Bearer " + token;
  return h;
}


async function mustOk(r, action){
  let raw = "";
  try{ raw = await r.text(); }catch{}
  let data = null;
  try{ data = raw ? JSON.parse(raw) : null; }catch{ data = null; }

  const msg = data?.message || data?.error_description || data?.error || raw || `Error al ${action}`;
  const err = new Error(msg);
  err.status = r.status;
  err.data = data;
  throw err;
}

/*** HELPERS UI ***/
const $ = (id)=> document.getElementById(id);
const show = (el, v)=> { if(!el) return; el.classList.toggle('hidden', !v); };
const fmtMoney = (n, ccy)=> { try{ return new Intl.NumberFormat('es-GT',{style:'currency',currency:ccy||'GTQ'}).format(Number(n||0)); }catch{ return `Q ${(Number(n||0)).toFixed(2)}`; } };
const fmtDate  = (s)=> s ? new Date(s).toLocaleDateString('es-GT') : '‚Äî';
const fmtDateTime = (s)=> s ? new Date(s).toLocaleString('es-GT') : '‚Äî';
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

function toast(msg, type="ok", sub=""){
  const wrap = $("toastWrap");
  if(!wrap) return alert(msg);
  const t = document.createElement("div");
  t.className = "toast " + (type==="err" ? "err" : "ok");
  t.innerHTML = `${escapeHtml(String(msg||""))}${sub ? `<span class="sub">${escapeHtml(String(sub||""))}</span>` : ""}`;
  wrap.appendChild(t);
  // auto-remove
  setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(6px)"; }, 2600);
  setTimeout(()=>{ t.remove(); }, 3200);
}

function setLoading(el, isLoading){ if(!el) return; el.classList.toggle("loading", !!isLoading); }
function safeText(el, txt){ if(el) el.textContent = String(txt ?? ""); }
function hAuth(){
  return {
    apikey: ANON_KEY,
    Authorization: "Bearer "+getToken(),
    "Content-Type": "application/json"
  };
}  
  
function clearGlobalError(){
  const box = $("globalError");
  if(!box) return;
  show(box, false);
  box.textContent = "";
}
function showGlobalError(title, err){
  const box = $("globalError");
  if(!box) return;
  show(box, true);
  box.innerHTML = `<div style="font-weight:900;color:#FFD0D0;margin-bottom:4px">${title}</div>
                   <div>Verifique permisos, sesi√≥n o configuraci√≥n del sistema e intente nuevamente.</div>`;
  console.error("[DEBUG]", err);
}

// Compatibilidad: algunas partes usan setGlobalError(...)
function setGlobalError(msg){
  const t = (msg && String(msg).trim()) ? String(msg) : "Error";
  showGlobalError(t, null);
}

/*** ‚úÖ KPI helper (fix: evita ReferenceError setKPI) ***/
function setKPI(id, value, hint){
  const el = document.getElementById(id);
  if(el) el.textContent = (value === null || value === undefined) ? "‚Äî" : String(value);
  const hintEl = document.getElementById(id + "Hint");
  if(hintEl && hint !== undefined) hintEl.textContent = String(hint);
}

/*** ‚úÖ validar sesi√≥n/token antes de cargar panel ***/
async function validateSession(){
  const token = (localStorage.token || "").trim();
  if(!token) return false;

  try{
    const r = await fetch(`${PROJECT_URL}/auth/v1/user`, {
      method: "GET",
      headers: { apikey: ANON_KEY, Authorization: "Bearer " + token }
    });

    // ‚úÖ Solo borrar token si realmente es inv√°lido/expirado
    if(r.status === 401 || r.status === 403){
      localStorage.removeItem("token");
      localStorage.removeItem("uid");
      return false;
    }

    if(!r.ok){
      // Otros errores (CORS/proxy/500) NO deben borrar sesi√≥n
      return false;
    }

    return true;
  }catch{
    // Error de red: no borrar token
    return false;
  }
}

/*** ‚úÖ Session meta (agregado) ***/
async function refreshSessionMeta(){
  const meta = $("sessionMeta");
  if(!meta) return;

  const token = localStorage.token;
  if(!token){
    meta.textContent = "Administrador ¬∑ Sesi√≥n no iniciada";
    return;
  }
  try{
    const r = await fetch(`${PROJECT_URL}/auth/v1/user`, {
      method: "GET",
      headers: { apikey: ANON_KEY, Authorization: "Bearer " + token }
    });
    if(!r.ok){
      meta.textContent = "Administrador ¬∑ Sesi√≥n no iniciada";
      return;
    }
    const u = await r.json().catch(()=>null);
    const email = u?.email || u?.user_metadata?.email || "admin";
    meta.textContent = `Administrador ¬∑ ${email} ¬∑ √öltima actualizaci√≥n: ${new Date().toLocaleTimeString("es-GT")}`;
  }catch(e){
    meta.textContent = `Administrador ¬∑ Sesi√≥n iniciada`;
    console.error(e);
  }
}

/*** ‚úÖ Modal Confirm PRO (agregado, y lo usamos en vez de confirm() cuando se pueda) ***/
let CONFIRM_RESOLVE = null;
function openConfirm({title, message, okText}){
  const m = $("modalConfirm");
  const t = $("confirmTitle");
  const msg = $("confirmMsg");
  const okBtn = $("confirmOkBtn");
  if(!m || !t || !msg || !okBtn){
    // fallback
    return Promise.resolve(window.confirm((title? (title+"\n\n"):"") + String(message||"")));
  }
  t.textContent = title || "Confirmaci√≥n";
  msg.innerHTML = message || "¬øConfirma esta acci√≥n?";
  okBtn.textContent = okText || "Confirmar";
  show(m, true);

  return new Promise((resolve)=>{
    CONFIRM_RESOLVE = resolve;
  });
}
function closeConfirm(result){
  const m = $("modalConfirm");
  if(m) show(m, false);
  if(CONFIRM_RESOLVE) CONFIRM_RESOLVE(!!result);
  CONFIRM_RESOLVE = null;
}
window.closeConfirm = closeConfirm;

// cerrar al click fuera
document.addEventListener("click", (e)=>{
  const m = $("modalConfirm");
  if(!m || m.classList.contains("hidden")) return;
  if(e.target === m) closeConfirm(false);
});

/*** ‚úÖ KPIs (agregado) ***/
async function refreshKPIs(){
  const kWrap = $("kpisWrap");
  const kW = $("kpiWithdrawPending");
  const kT = $("kpiTopupsPending");
  const kO = $("kpiOpsToday");
  const kWHint = $("kpiWithdrawHint");

  if(!kW || !kT || !kO) return;

  const h = {
    apikey: ANON_KEY,
    Authorization: "Bearer "+getToken(),
    "Cache-Control":"no-cache, no-store, must-revalidate",
    Pragma:"no-cache"
  };

  try{
    // withdrawals pending
    const rw = await fetch(`${BASE}/withdrawal_requests?select=id,status,created_at&limit=600`, { headers:h, cache:"no-store" });
    if(!rw.ok) throw new Error(await rw.text().catch(()=> "") || `HTTP ${rw.status}`);
    const wrows = await rw.json();

    const pendingW = (wrows||[]).filter(r=> String(r.status||"").toLowerCase()==="pending").length;
    kW.textContent = pendingW;
    if(kWHint) kWHint.textContent = `Actualizado: ${new Date().toLocaleTimeString("es-GT")}`;

    // topups pending + programadas (effective_date != null) aunque status sea pending
    const rt = await fetch(`${BASE}/topups?select=id,status,created_at,effective_date&limit=800`, { headers:h, cache:"no-store" });
    if(!rt.ok) throw new Error(await rt.text().catch(()=> "") || `HTTP ${rt.status}`);
    const trows = await rt.json();

    const pendingT = (trows||[]).filter(r=>{
      const s = String(r.status||"").toLowerCase();
      const scheduled = !!r.effective_date;
      return s==="pending" || scheduled;
    }).length;
    kT.textContent = pendingT;

    // ops 24h
    const since = Date.now() - 24*60*60*1000;
    const ops =
      (wrows||[]).filter(r=> r.created_at && (new Date(r.created_at).getTime() >= since)).length +
      (trows||[]).filter(r=> r.created_at && (new Date(r.created_at).getTime() >= since)).length;
    kO.textContent = ops;

    if(kWrap) show(kWrap, true);
  }catch(err){
    console.error("[KPI DEBUG]", err);
    kW.textContent = "‚Äî";
    kT.textContent = "‚Äî";
    kO.textContent = "‚Äî";
    if(kWrap) show(kWrap, true);
  }
}

/*** FORMATEO EN INPUT NUM√âRICO CON COMAS ***/
function formatCapitalString(raw){
  raw = String(raw ?? "").replace(/[^\d.]/g, "");
  const firstDot = raw.indexOf(".");
  if (firstDot !== -1){
    const head = raw.slice(0, firstDot+1);
    const tail = raw.slice(firstDot+1).replace(/\./g, "");
    raw = head + tail;
  }
  let [intPart, decPart] = raw.split(".");
  intPart = intPart ? intPart.replace(/^0+(?=\d)/, "") : "";
  if (intPart){ intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
  if (decPart !== undefined) decPart = decPart.slice(0, 2);
  return decPart !== undefined ? `${intPart || "0"}.${decPart}` : (intPart || "");
}
function parseCapitalFromInput(val){
  if (!val) return 0;
  const clean = String(val).replace(/,/g, "");
  const n = Number(clean);
  return Number.isFinite(n) ? n : 0;
}
function bindCapitalFormatter(inputEl){
  if(!inputEl) return;
  inputEl.addEventListener("input", () => {
    const pos = inputEl.selectionStart ?? inputEl.value.length;
    const before = inputEl.value;
    const rawNoCommas = before.replace(/,/g, "");
    inputEl.value = formatCapitalString(rawNoCommas);
    const diff = inputEl.value.length - before.length;
    const newPos = Math.max(0, pos + diff);
    const newPosSafe = Math.min(newPos, inputEl.value.length);
    const ss = inputEl.setSelectionRange;
    if (typeof ss === "function") ss.call(inputEl, newPosSafe, newPosSafe);
  });
  inputEl.addEventListener("blur", () => {
    if (!inputEl.value.replace(/[^\d]/g, "")) inputEl.value = "0";
  });
}
function setCapitalInputValue(n){
  const val = (n === null || n === undefined) ? "" : String(n);
  $("u_capital").value = formatCapitalString(val);
}
function todayISO(){ return new Date().toISOString().slice(0,10); }

/*** LOGIN ***/

/*** ADMIN CHECK (usa public.admin_users + rpc is_admin) ***/
async function rpcIsAdmin(){
  const r = await fetch(`${BASE}/rpc/is_admin`, {
    method:"POST",
    headers: hAuth(),
    body: "{}"
  });

  const raw = await r.text();
  if(!r.ok){
    // Diferenciamos entre "no existe" (404) vs permisos/sesi√≥n.
    throw new Error(`rpc/is_admin ${r.status}: ${raw.slice(0,200)}`);
  }

  // La RPC devuelve true/false (JSON) o a veces "true" como texto.
  try{
    const v = JSON.parse(raw);
    return !!v;
  }catch(e){
    return raw.trim() === "true";
  }
}

async function requireAdmin(){
  const ok = await rpcIsAdmin();
  if(!ok){
    // Limpia sesi√≥n para evitar estado raro
    localStorage.removeItem("token");
    localStorage.removeItem("uid");
    localStorage.removeItem("email");
    throw new Error("not_admin");
  }
}

async function doLogin(e){
  e.preventDefault();
  clearGlobalError();

  const email = $("email").value.trim();
  const password = $("password").value;

  $("loginMsg").textContent = "";
  setLoading($("loginForm"), true);

  try{
    const r = await fetch(`${PROJECT_URL}/auth/v1/token?grant_type=password`,{
      method:"POST",
      headers:{
        "apikey": ANON_KEY,
        "Content-Type":"application/json",
        "Accept":"application/json"
      },
      body: JSON.stringify({ email, password })
    });

    // A veces, si hay un error de proxy/hosting, puede venir HTML.
    // Leemos texto primero y luego intentamos JSON.
    const raw = await r.text();
    let data = null;
    try{ data = raw ? JSON.parse(raw) : null; }catch{ data = null; }

    if(!r.ok){
      const msg = data?.error_description || data?.error || (raw && raw.trim().startsWith("<") ? "Respuesta inv√°lida (HTML). Revisa PROJECT_URL/ANON_KEY y CORS." : "Login inv√°lido");
      $("loginMsg").textContent = msg;
      return;
    }
    if(!data?.access_token){
      $("loginMsg").textContent = "Login inv√°lido (sin token).";
      return;
    }

    localStorage.token = data.access_token;
    localStorage.uid = data.user?.id || "";

    await initApp();

  }catch(err){
    console.error(err);
    $("loginMsg").textContent = "Error de red";
  }finally{
    setLoading($("loginForm"), false);
  }
}
function logout(){
  localStorage.removeItem("token");
  localStorage.removeItem("uid");
  location.reload();
}

/*** Edge Functions auxiliares ***/
async function createAuthUserIfNeeded(email, password, fullName) {
  if(!password) return { ok:true, status:204, json: async()=>({}) };
  const url = "https://czvpehbubfrinutztnwh.functions.supabase.co/admin-create-user";
  return fetch(url, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization: "Bearer "+getToken()
    },
    body: JSON.stringify({ email, password, full_name: fullName })
  });
}
async function getAuthUserIdByEmail(email){
  try{
    const r = await fetch(`${RPC}/get_user_id_by_email`, {
      method:"POST",
      headers: headersJSON(),
      body: JSON.stringify({ p_email: email })
    });
    if(!r.ok) return null;
    const id = await r.json();
    return id || null;
  }catch{ return null; }
}

// ‚úÖ Alias por compatibilidad (evita errores por nombres antiguos)
async function getAuthedUserIdByEmail(email){
  return await getAuthUserIdByEmail(email);
}
async function getAuthUserByEmail(email){
  return await getAuthUserIdByEmail(email);
}

/*** LISTA CLIENTES ***/
let CACHED = [];
async function listUsers(){
  const msgEl = $("usersMsg");
  if(msgEl) msgEl.textContent = "";

  const h = {
    apikey: ANON_KEY,
    Authorization: "Bearer "+getToken(),
    "Cache-Control":"no-cache, no-store, must-revalidate",
    Pragma:"no-cache"
  };

  const sel = `user_id,full_name,email,phone,plan,currency,capital,account_id,bank_name,bank_account,bank_account_type,invest_months,interest_pct,joined_at,compound_interest`;

  try{
    let r = await fetch(`${BASE}/v_admin_users_filtered?select=${encodeURIComponent(sel)}&order=full_name.asc`, { headers:h, cache:"no-store" });

    if (r.ok) {
      CACHED = await r.json();
      if(msgEl) msgEl.textContent = `Clientes cargados: ${CACHED.length}`;
      renderUsers(CACHED);
      refreshResetPicker();
      refreshWithdrawPicker();
      return;
    }

    const t = await r.text().catch(()=> "");
    console.error("v_admin_users_filtered error:", r.status, t);
    if(msgEl) msgEl.textContent = `No se pudo cargar la vista (HTTP ${r.status}). Probando m√©todo alterno‚Ä¶`;

    CACHED = await loadUsersViaJoinFallback(h);
    if(msgEl) msgEl.textContent = `Clientes cargados (fallback): ${CACHED.length}`;
    renderUsers(CACHED);
    refreshResetPicker();
    refreshWithdrawPicker();

    if(r.status === 401 || r.status === 403){
      localStorage.removeItem("token");
      localStorage.removeItem("uid");
      await initApp();
    }
  }catch(e){
    console.error(e);
    if(msgEl) msgEl.textContent = "Error cargando clientes (revisa conexi√≥n, permisos o RLS).";
    CACHED = [];
    renderUsers(CACHED);
    refreshResetPicker();
    refreshWithdrawPicker();
  }
}

async function loadUsersViaJoinFallback(h){
  try{
    const [aRes, pRes] = await Promise.all([
      fetch(`${BASE}/accounts?select=id,user_id,currency,capital,plan,bank_name,bank_account,bank_account_type,invest_months,interest_pct,joined_at,compound_interest`, { headers:h, cache:"no-store" }),
      fetch(`${BASE}/profiles?select=id,full_name,email,phone,is_admin`, { headers:h, cache:"no-store" }),
    ]);

    const accounts = aRes.ok ? await aRes.json() : [];
    const profiles = pRes.ok ? await pRes.json() : [];
    const pmap = new Map(profiles.map(p => [p.id, p]));

    return accounts.map(a=>{
      const p = pmap.get(a.user_id) || {};
      if (p.is_admin) return null;
      return {
        user_id: p.id || a.user_id,
        full_name: p.full_name || null,
        email: p.email || null,
        phone: p.phone || null,
        account_id: a.id,
        currency: a.currency,
        capital: a.capital,
        plan: a.plan,
        bank_name: a.bank_name,
        bank_account: a.bank_account,
        bank_account_type: a.bank_account_type,
        invest_months: a.invest_months,
        interest_pct: a.interest_pct,
        joined_at: a.joined_at,
        compound_interest: a.compound_interest
      };
    }).filter(Boolean).sort((x,y)=> (x.full_name||'').localeCompare(y.full_name||'' ));
  }catch{
    return [];
  }
}

function renderUsers(rows){
  const tb = $("users");
  tb.innerHTML = "";

  if(!rows || !rows.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" class="small">No hay clientes para mostrar (o no se pudieron cargar).</td>`;
    tb.appendChild(tr);
    return;
  }

  // ‚úÖ Agrupar por cliente (1 fila por usuario) para un panel m√°s ordenado
  const map = new Map();
  rows.forEach(r=>{
    const uid = r.user_id || r.id;
    if(!uid) return;
    if(!map.has(uid)){
      map.set(uid, {
        user_id: uid,
        full_name: r.full_name ?? '‚Äî',
        email: r.email ?? '‚Äî',
        phone: r.phone ?? '‚Äî'
      });
    }
  });

  const list = Array.from(map.values()).sort((a,b)=> String(a.full_name||"").localeCompare(String(b.full_name||""), "es"));

  list.forEach(u=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(u.full_name ?? '‚Äî')}</td>
      <td>${escapeHtml(u.email ?? '‚Äî')}</td>
      <td>${escapeHtml(u.phone ?? '‚Äî')}</td>
      <td class="nowrap">
        <button class="ghost" onclick='openClientAccounts("${u.user_id}")'>Ver cuentas</button>
        <button class="ghost" onclick='openResetModal(${JSON.stringify({ user_id: u.user_id, email: u.email, full_name: u.full_name })})'>Reset contrase√±a</button>
      </td>`;
    tb.appendChild(tr);
  });
}

function openClientAccounts(userId){
  if(!isUUID(userId)) return alert("No pude identificar el cliente.");
  const rows = (CACHED||[]).filter(x=>String(x.user_id)===String(userId));
  const titleEl = $("accountsTitle");
  const wrap = $("accountsCard");
  const tb = $("accountsBody");

  if(titleEl){
    const n = rows[0]?.full_name || "Cliente";
    const em = rows[0]?.email ? ` ¬∑ ${rows[0].email}` : "";
    titleEl.textContent = `Cuentas de ${n}${em}`;
  }

  if(tb){
    tb.innerHTML = "";
    if(!rows.length){
      tb.innerHTML = `<tr><td colspan="9" class="small">Este cliente no tiene cuentas.</td></tr>`;
    }else{
      sortAccountsStable(rows).forEach((a, i)=>{
        const accId = (a.account_id || a.id || "");
        const noRaw = (a.account_no ?? (i+1));
        const no = getStableAccountNo(userId, accId, noRaw);const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="nowrap">Cuenta No. ${escapeHtml(String(no))}</td>
          <td>${escapeHtml(a.plan ?? '‚Äî')}</td>
          <td>${fmtMoney(a.capital, a.currency)}</td>
          <td>${escapeHtml(a.currency ?? 'GTQ')}</td>
          <td>${escapeHtml(String(a.invest_months ?? '‚Äî'))}</td>
          <td>${escapeHtml(String(a.interest_pct ?? '‚Äî'))}</td>
          <td>${a.compound_interest ? "Acumulado" : "Mensual"}</td>
          <td>${escapeHtml(a.bank_name ?? '‚Äî')}</td>
          <td class="nowrap">
            <button class="ghost" onclick='editClient(${JSON.stringify(a)})'>Editar</button>
            <button class="danger" onclick='deleteAccount(${JSON.stringify(a)})'>Eliminar cuenta</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }
  }

  // mostrar card
  if(wrap) wrap.classList.remove("hidden");
  $("formCard")?.scrollIntoView({behavior:"smooth", block:"start"});
}

function closeClientAccounts(){
  $("accountsCard")?.classList.add("hidden");
}

async function deleteAccount(acc){
  const accountId = String(acc?.account_id || acc?.id || "");
  if(!isUUID(accountId)) return alert("No se pudo identificar la cuenta (account_id).");

  const ok = await openConfirm({
    title: "Eliminar cuenta",
    html: `<div style="opacity:.9">Se eliminar√° solo esta cuenta del cliente (no elimina el login).<br><br><b>Si hay movimientos vinculados</b> (recargas/retiros), puede fallar por restricciones y tendr√°s que borrar esos movimientos primero.</div>`,
    okText: "S√≠, eliminar",
    cancelText: "Cancelar"
  });
  if(!ok) return;

  const jh = headersJSON();
  try{
    const r = await fetch(`${BASE}/accounts?id=eq.${encodeURIComponent(accountId)}`, {
      method: "DELETE",
      headers: jh
    });
    if(!r.ok){
      const tx = await r.text().catch(()=> "");
      throw new Error(`No se pudo eliminar (${r.status}). ${tx}`);
    }

    // limpiar cache y refrescar
    _accountsCacheByUser.clear?.();
    await listUsers();
    await refreshKPIs?.();
    alert("Cuenta eliminada.");
    // Si la cuenta eliminada era la seleccionada en el formulario, limpiar selecci√≥n
    const sel = $("u_account_sel");
    if(sel && sel.value === accountId){
      sel.value = "";
      $("u_account_id") && ($("u_account_id").value = "");
    }
  }catch(err){
    console.error(err);
    alert(String(err?.message || err));
  }
}

/*** BUSCAR (mismo id="q") ***/
$("q")?.addEventListener("input",(e)=>{
  const qv = e.target.value.trim().toLowerCase();
  if(!qv){ renderUsers(CACHED); return; }
  const filt = CACHED.filter(x=>[x.full_name,x.email,x.phone,x.plan,x.bank_name,x.bank_account,x.bank_account_type]
    .filter(Boolean).some(v=>String(v).toLowerCase().includes(qv)));
  renderUsers(filt);
});

/* ============================================================
   ‚úÖ RETIRAR CAPITAL (Admin)
   ============================================================ */

function refreshWithdrawPicker(){
  const sel = $("wdAccount");
  const hint = $("wdHint");
  const msg = $("wdMsg");
  if(!sel) return;

  if(msg) msg.textContent = "";
  sel.innerHTML = "";

  const rows = (CACHED||[]).filter(x=>x.account_id && (x.email || x.full_name));
  if(!rows.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay clientes cargados";
    sel.appendChild(opt);
    if(hint) hint.textContent = "‚Äî";
    return;
  }

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "Selecciona una cuenta";
  sel.appendChild(opt0);

  rows.forEach(x=>{
    const opt = document.createElement("option");
    opt.value = x.account_id;
    const name = (x.full_name || x.email || "‚Äî");
    opt.textContent = `${name} ‚Äî ${x.email || "‚Äî"} ‚Äî Capital: ${fmtMoney(x.capital, x.currency || "GTQ")}`;
    opt.dataset.capital = String(x.capital ?? 0);
    opt.dataset.currency = x.currency || "GTQ";
    opt.dataset.name = x.full_name || "";
    opt.dataset.email = x.email || "";
    opt.dataset.user_id = x.user_id || "";
    sel.appendChild(opt);
  });

  if(hint) hint.textContent = "Selecciona una cuenta para ver el capital y retirar.";

  // ‚úÖ Reutilizar el mismo listado para "Acreditar capital"
  const capSel = $("capAccount");
  if(capSel){
    capSel.innerHTML = sel.innerHTML;
    if(!capSel.value && capSel.options.length) capSel.selectedIndex = 0;
    updateCapHint();
  }

}


function updateCapHint(){
  const sel = $("capAccount");
  const hint = $("capHint");
  if(!sel || !hint) return;

  const opt = sel.options[sel.selectedIndex];
  if(!opt || !opt.value){
    hint.textContent = "‚Äî";
    return;
  }

  const cap = Number(opt.dataset.capital || 0);
  const cur = opt.dataset.currency || "GTQ";
  const name = opt.dataset.name || opt.dataset.email || "‚Äî";
  hint.textContent = `${name} ‚Äî Capital actual: ${fmtMoney(cap, cur)}. El monto acreditado se sumar√° al capital.`;
}

function updateWithdrawHint(){
  const sel = $("wdAccount");
  const hint = $("wdHint");
  if(!sel || !hint) return;

  const opt = sel.options[sel.selectedIndex];
  const name = opt?.dataset?.name || "";
  const email = opt?.dataset?.email || "";
  const cap = Number(opt?.dataset?.capital || 0);
  const ccy = opt?.dataset?.currency || "GTQ";

  if(!sel.value){
    hint.textContent = "‚Äî";
    return;
  }
  hint.innerHTML = `<b>${name || "Cliente"}</b> ‚Äî ${email || "‚Äî"}<br>Capital actual: <b>${fmtMoney(cap, ccy)}</b>`;
}

async function doWithdraw(){
  const msg = $("wdMsg");
  const sel = $("wdAccount");
  const amount = Number($("wdAmount")?.value || 0);
  const reference = ($("wdRef")?.value || "").trim() || null;
  const note = ($("wdNote")?.value || "").trim() || null;

  if(msg) msg.textContent = "";
  if(!sel?.value){
    if(msg) msg.textContent = "Selecciona una cuenta.";
    return;
  }
  if(!amount || amount <= 0){
    if(msg) msg.textContent = "Monto inv√°lido.";
    return;
  }

  const opt = sel.options[sel.selectedIndex];
  const cap = Number(opt?.dataset?.capital || 0);
  const ccy = opt?.dataset?.currency || "GTQ";
  const who = opt?.textContent?.split("‚Äî")?.[0]?.trim() || "cliente";

  if(amount > cap){
    if(msg) msg.textContent = `Fondos insuficientes. Capital actual: ${fmtMoney(cap, ccy)}`;
    return;
  }

  const ok = await openConfirm({
    title: "Confirmaci√≥n de retiro",
    message: `
      <div style="font-weight:950;margin-bottom:6px">¬øAplicar retiro de capital?</div>
      <div>Cliente: <b>${who}</b></div>
      <div>Monto: <b>${fmtMoney(amount, ccy)}</b></div>
      <div style="margin-top:8px;opacity:.9">Esto descuenta el capital actual y registra el movimiento.</div>
    `,
    okText: "Retirar"
  });
  if(!ok) return;

  const btn = $("btnWithdraw");
  if(btn){ btn.disabled = true; btn.textContent = "Procesando..."; }

  try{
    const r = await fetch(`${RPC}/withdraw_capital`,{
      method:"POST",
      headers: headersJSON(),
      body: JSON.stringify({
        p_account_id: sel.value,
        p_amount: amount,
        p_note: note,
        p_reference: reference
      })
    });

    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(t || `HTTP ${r.status}`);
    }

    let data = null;
    try{ data = await r.json(); }catch{ data = null; }
    const newCap = data?.[0]?.new_capital;

    if(msg) msg.textContent = `‚úÖ Retiro aplicado. Nuevo capital: ${fmtMoney(newCap ?? (cap-amount), ccy)}`;

    await listUsers();
    await refreshKPIs();

    if($("wdAmount")) $("wdAmount").value = "";
    if($("wdRef")) $("wdRef").value = "";
    if($("wdNote")) $("wdNote").value = "";
  }catch(e){
    console.error(e);
    if(msg) msg.textContent = `‚ùå Error: ${e.message || e}`;
    await openConfirm({
      title:"No se pudo retirar",
      message:`<div style="color:#FFD0D0;font-weight:950;margin-bottom:6px">Operaci√≥n no aplicada</div>
               <div>Detalle: <span style="opacity:.9">${String(e.message||e)}</span></div>`,
      okText:"Entendido"
    });
    closeConfirm(false);
  }finally{
    if(btn){ btn.disabled = false; btn.textContent = "Retirar"; }
  }
}


async function doAccreditCapital(){
  const msgEl = $("capMsg");
  if(msgEl) msgEl.textContent = "";

  try{
    const token = getToken();
    if(!token) throw new Error("Sesi√≥n expirada. Inicia sesi√≥n de nuevo.");

    const sel = $("capAccount");
    const account_id = String(sel?.value || "");
    if(!isUUID(account_id)) throw new Error("Selecciona una cuenta v√°lida.");

    const opt = sel.options[sel.selectedIndex];
    const user_id = String(opt?.dataset?.user_id || "");
    if(!isUUID(user_id)) throw new Error("No se pudo identificar el usuario de la cuenta.");

    const amount = Number($("capAmount")?.value || 0);
    if(!(amount > 0)) throw new Error("Monto inv√°lido.");

    const d = $("capDate")?.value || "";
    if(!d) throw new Error("Selecciona una fecha efectiva.");

    const bank = ($("capBank")?.value || "").trim() || null;

    // RPC existente en tu DB: public.admin_accredit_capital(p_account_id, p_user_id, p_amount, p_effective_date, p_bank_name)
    const r = await fetch(`${BASE}/rpc/admin_accredit_capital`, {
      method: "POST",
      headers: headersJSON(),
      body: JSON.stringify({
        p_account_id: account_id,
        p_user_id: user_id,
        p_amount: amount,
        p_effective_date: d,
        p_bank_name: bank
      })
    });

    if(!r.ok) await mustOk(r, "acreditar capital");

    if(msgEl) msgEl.textContent = "‚úÖ Capital acreditado.";
    // refrescar datos visibles
    await listUsers();
    refreshWithdrawPicker();
  }catch(err){
    console.error(err);
    if(msgEl) msgEl.textContent = "‚ùå " + (err?.message || "Error");
    alert("No se pudo acreditar: " + (err?.message || "Error"));
  }
}




/* ============================================================
   ‚úÖ HISTORIAL DE RETIROS (Modal + PDF + Borrar mostrado)
   ============================================================ */
let WDH_CACHE = [];

function openWithdrawHistory(){
  show($("modalWithdrawHistory"), true);
  loadWithdrawHistory();
}
function closeWithdrawHistory(){
  show($("modalWithdrawHistory"), false);
}

function resolveClientByAccountId(accountId){
  const x = (CACHED||[]).find(r => r.account_id === accountId);
  return {
    name: x?.full_name || "‚Äî",
    email: x?.email || "‚Äî",
    currency: x?.currency || "GTQ"
  };
}

async function loadWithdrawHistory(){
  

  // Fallback por si cambia el nombre del RPC (evita romper el panel)
  async function callWithdrawHistoryRPC(){
    const candidates = [
      "admin_list_withdrawals_history",
      "admin_list_withdrawals",
      "admin_list_withdrawals_guard"
    ];
    let lastErr = null;
    for(const fn of candidates){
      try{
        const out = await supabaseRpc(fn, {});
        if(out && out.ok) return out.data;
        lastErr = out?.error || lastErr;
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("No se encontr√≥ un RPC de historial de retiros");
  }

const msg = $("withdrawHistoryMsg");
  if(msg) msg.textContent = "";

  const h = {
    apikey: ANON_KEY,
    Authorization: "Bearer "+getToken(),
    "Cache-Control":"no-cache, no-store, must-revalidate",
    Pragma:"no-cache",
    "Content-Type":"application/json"
  };

  try{
    // ‚úÖ Admin: RPC Security Definer (evita problemas de RLS/joins)
    const rpcUrl = `${BASE}/rpc/admin_list_withdrawals_history`;
    const res = await fetch(rpcUrl, { method:"POST", headers:h, body: JSON.stringify({}) , cache:"no-store" });

    if(!res.ok){
      const t = await res.text();
      throw new Error(t || ("HTTP "+res.status));
    }

    const rows = await res.json();

    // Reusar helpers existentes para mapear cuenta‚Üíperfil
    const accIds = Array.from(new Set(rows.map(r => r.account_id).filter(Boolean)));
    const accMap = await loadAccountsByIds(accIds);        // Map account_id -> account row (incl user_id)
    const userIds = Array.from(new Set(Array.from(accMap.values()).map(a => a.user_id).filter(Boolean)));
    const profMap = await loadProfilesByIds(userIds);      // Map user_id -> profile

    renderWithdrawHistory(rows, accMap, profMap);
  }catch(err){
    console.error("loadWithdrawHistory error", err);
    if(msg) msg.textContent = `No se pudo cargar el historial. (${err.message||err})`;
    renderWithdrawHistory([], new Map(), new Map());
  }
}

function renderWithdrawHistory(){
  const body = $("wdhBody");
  if(!body) return;
  body.innerHTML = "";

  if(!WDH_CACHE.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="6" class="small">No hay retiros para mostrar.</td>`;
    body.appendChild(tr);
    return;
  }

  WDH_CACHE.forEach(w=>{
    const cli = resolveClientByAccountId(w.account_id || "");
    const ccy = cli.currency || "GTQ";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="nowrap">${fmtDateTime(w.created_at)}</td>
      <td>${cli.name}</td>
      <td>${cli.email}</td>
      <td>${fmtMoney(w.amount, ccy)}</td>
      <td>${(w.reference || "‚Äî")}</td>
      <td>${(w.note || "‚Äî")}</td>
    `;
    body.appendChild(tr);
  });
}

function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function printWithdrawalsPDF(){
  if(!WDH_CACHE.length){
    alert("No hay retiros cargados para imprimir.");
    return;
  }

  const rowsHtml = WDH_CACHE.map(w=>{
    const cli = resolveClientByAccountId(w.account_id || "");
    const ccy = cli.currency || "GTQ";
    return `
      <tr>
        <td>${fmtDateTime(w.created_at)}</td>
        <td>${escapeHtml(cli.name)}</td>
        <td>${escapeHtml(cli.email)}</td>
        <td>${escapeHtml(fmtMoney(w.amount, ccy))}</td>
        <td>${escapeHtml(w.reference || "‚Äî")}</td>
        <td>${escapeHtml(w.note || "‚Äî")}</td>
      </tr>
    `;
  }).join("");

  const html = `
  <!doctype html>
  <html>
  <head>
    <meta charset="utf-8">
    <title>Historial de retiros ‚Äî FX | CAPITAL R.L.</title>
    <style>
      body{font-family:Arial, sans-serif; padding:20px; color:#111;}
      h1{margin:0 0 8px; font-size:18px;}
      .meta{font-size:12px; color:#444; margin-bottom:12px;}
      table{width:100%; border-collapse:collapse; font-size:12px;}
      th,td{border:1px solid #ddd; padding:8px; vertical-align:top;}
      th{background:#f2f2f2; text-align:left;}
      @media print{ button{display:none} }
    
/* ===== TOAST ===== */
#toastWrap{position:fixed;right:18px;bottom:18px;z-index:9999;display:flex;flex-direction:column;gap:10px;max-width:min(420px,calc(100vw - 36px));}
.toast{padding:12px 14px;border-radius:14px;background:rgba(18,18,20,.92);border:1px solid rgba(255,255,255,.12);box-shadow:0 18px 60px rgba(0,0,0,.55);backdrop-filter:blur(10px);color:#f6f7fb;font-weight:750;letter-spacing:.2px}
.toast.ok{border-color:rgba(0,255,180,.25)}
.toast.err{border-color:rgba(255,85,85,.25)}
.toast .sub{display:block;margin-top:4px;font-weight:650;opacity:.82;font-size:12.5px;line-height:1.35}

</style>
  </head>
  <body>
    <h1>Historial de retiros ‚Äî FX | CAPITAL R.L.</h1>
    <div class="meta">Generado: ${new Date().toLocaleString("es-GT")}</div>
    <table>
      <thead>
        <tr>
          <th>Fecha</th><th>Cliente</th><th>Email</th><th>Monto</th><th>Referencia</th><th>Motivo / Nota</th>
        </tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    </table>
    <script>window.print();<\/script>
  </body>
  </html>
  `;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

async function deleteWithdrawalsShown(){
  if(!WDH_CACHE.length){
    alert("No hay filas mostradas para borrar.");
    return;
  }

  const ok = await openConfirm({
    title:"Borrar historial mostrado",
    message:`<div style="font-weight:950;color:#FFD0D0;margin-bottom:6px">¬øBorrar los retiros MOSTRADOS?</div>
             <div>Esto es permanente. (Recomendado: imprime/guarda PDF antes.)</div>`,
    okText:"Borrar"
  });
  if(!ok) return;

  const msg = $("wdhMsg");
  safeText(msg, "Borrando‚Ä¶");
  setLoading(msg, true);

  const ids = WDH_CACHE.map(x=>x.id).filter(Boolean);
  try{
    let ok2 = false;

    try{
      const r1 = await fetch(`${RPC}/admin_delete_withdrawals`,{
        method:"POST",
        headers: headersJSON(),
        body: JSON.stringify({ p_ids: ids })
      });
      if(r1.ok) ok2 = true;
    }catch{}

    if(!ok2){
      const idsCsv = ids.join(",");
      const r2 = await fetch(`${BASE}/withdrawals?id=in.(${idsCsv})`,{
        method:"DELETE",
        headers: headersJSON()
      });
      if(!r2.ok){
        const t = await r2.text().catch(()=> "");
        throw new Error(t || "No se pudo borrar (RLS o falta RPC).");
      }
    }

    alert("Historial borrado (mostrado).");
    await loadWithdrawHistory();
    await refreshKPIs();
  }catch(e){
    console.error(e);
    alert("No se pudo borrar: " + (e.message||e));
    safeText(msg, "Error al borrar.");
  }finally{
    setLoading(msg, false);
  }
}

/* ============================================================
   TOPUPS (PENDING + PROGRAMADAS por effective_date)
   ============================================================ */

function buildCachedMaps(){
  const byUserId = new Map();
  const byAccountId = new Map();
  (CACHED||[]).forEach(c=>{
    if(c?.user_id) byUserId.set(c.user_id, c);
    if(c?.account_id) byAccountId.set(c.account_id, c);
  });
  return { byUserId, byAccountId };
}

async function fetchAccountsUserIds(accountIds, h){
  if(!accountIds?.length) return new Map();
  const unique = [...new Set(accountIds.filter(Boolean))];
  const map = new Map();
  const url = `${BASE}/accounts?select=id,user_id&id=in.(${unique.join(",")})`;
  const r = await fetch(url, { headers:h, cache:"no-store" });
  if(!r.ok) return map;
  const rows = await r.json();
  rows.forEach(a=>{ if(a?.id && a?.user_id) map.set(a.id, a.user_id); });
  return map;
}

async function fetchProfiles(userIds, h){
  if(!userIds?.length) return new Map();
  const unique = [...new Set(userIds.filter(Boolean))];
  const url = `${BASE}/profiles?select=id,full_name,email&id=in.(${unique.join(",")})`;
  const r = await fetch(url, { headers:h, cache:"no-store" });
  if(!r.ok) return new Map();
  const profs = await r.json();
  return new Map(profs.map(p=>[p.id,p]));
}

async function listTopups(){
  const msgEl = $("topupsMsg");
  if(msgEl) msgEl.textContent = "";
  clearGlobalError();

  const h = {
    apikey: ANON_KEY,
    Authorization: "Bearer "+getToken(),
    "Cache-Control":"no-cache, no-store, must-revalidate",
    Pragma:"no-cache"
  };

  // ‚úÖ Workaround: solo traemos PENDING y marcamos ‚ÄúProgramada‚Äù si effective_date != null
  const sel = `id,amount,currency,status,bank_name,receipt_path,created_at,user_id,account_id,reference_code,provider,effective_date,scheduled_note`;
  const url = `${BASE}/topups?select=${encodeURIComponent(sel)}&status=eq.pending&order=created_at.desc`;

  const r = await fetch(url, { headers:h, cache:"no-store" });

  if(!r.ok){
    const t = await r.text().catch(()=> "");
    console.error("listTopups error:", r.status, t);
    if(msgEl) msgEl.textContent = "No se pudieron cargar recargas (revisa conexi√≥n o permisos).";
    showGlobalError("No se pudieron cargar recargas", t || r.status);
    if(r.status === 401 || r.status === 403){
      localStorage.removeItem("token");
      localStorage.removeItem("uid");
      await initApp();
    }
    return;
  }

  const rows = await r.json();

  const { byUserId, byAccountId } = buildCachedMaps();

  const directUserIds = rows.map(x=>x.user_id).filter(Boolean);
  const missingUidAccountIds = rows.filter(x=>!x.user_id && x.account_id).map(x=>x.account_id);

  const acctToUid = new Map();
  missingUidAccountIds.forEach(aid=>{
    const c = byAccountId.get(aid);
    if(c?.user_id) acctToUid.set(aid, c.user_id);
  });

  const stillMissing = missingUidAccountIds.filter(aid=> !acctToUid.get(aid));
  const acctToUidFromDb = await fetchAccountsUserIds(stillMissing, h);
  acctToUidFromDb.forEach((uid, aid)=> acctToUid.set(aid, uid));

  const resolvedUserIds = rows.map(x=>{
    if(x.user_id) return x.user_id;
    if(x.account_id && acctToUid.get(x.account_id)) return acctToUid.get(x.account_id);
    return null;
  }).filter(Boolean);

  const allUserIds = [...new Set([...directUserIds, ...resolvedUserIds])];

  let profMap = new Map();
  try{ profMap = await fetchProfiles(allUserIds, h); }catch{ profMap = new Map(); }

  renderTopups(rows, profMap, byUserId, byAccountId, acctToUid);

  if(msgEl) msgEl.textContent = `Recargas: ${rows.length} (pending + programadas por fecha)`;

  await refreshKPIs();
  await refreshSessionMeta();
}

function statusChip(status, effectiveDate){
  const isScheduled = !!effectiveDate;
  const s = String(status||"").toLowerCase();

  if(isScheduled){
    return `<span class="chip"><span class="dot scheduled"></span>Programada</span>`;
  }

  const dotClass = (s==="pending")?"pending":(s==="approved")?"approved":(s==="rejected")?"rejected":"pending";
  const label = (s==="pending")?"Pendiente":(s==="approved")?"Aprobada":(s==="rejected")?"Rechazada":(status||"‚Äî");
  return `<span class="chip"><span class="dot ${dotClass}"></span>${label}</span>`;
}

function nextCycleStartISO(joinedAt){
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  if(!joinedAt){
    return new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString().slice(0,10);
  }

  const j = new Date(joinedAt);
  const day = j.getDate();

  const clampDate = (y,m,d)=>{
    const last = new Date(y, m+1, 0).getDate();
    const dd = Math.min(d, last);
    return new Date(y,m,dd);
  };

  let cand = clampDate(today.getFullYear(), today.getMonth(), day);

  if (today >= cand){
    const y = today.getFullYear();
    const m = today.getMonth()+1;
    cand = clampDate(y + Math.floor(m/12), (m%12), day);
  }

  return cand.toISOString().slice(0,10);
}

function renderTopups(rows, profMap, cachedByUserId, cachedByAccountId, acctToUid){
  const tb = $("topups");
  if(!tb) return;
  tb.innerHTML = "";

  const BUCKET = "topup-receipts";

  rows.forEach(x=>{
    const inferredUid = x.user_id || (x.account_id ? acctToUid.get(x.account_id) : null);

    const p = (inferredUid && profMap && profMap.get(inferredUid)) ? profMap.get(inferredUid) : null;
    const c1 = (inferredUid && cachedByUserId && cachedByUserId.get(inferredUid)) ? cachedByUserId.get(inferredUid) : null;
    const c2 = (x.account_id && cachedByAccountId && cachedByAccountId.get(x.account_id)) ? cachedByAccountId.get(x.account_id) : null;

    const name = (p?.full_name || c1?.full_name || c2?.full_name || "‚Äî");
    const email = (p?.email || c1?.email || c2?.email || "‚Äî");

    const date = x.created_at ? new Date(x.created_at).toLocaleString('es-GT') : "‚Äî";
    const amt  = fmtMoney(x.amount, x.currency || "GTQ");
    const bank = x.bank_name || "‚Äî";

    // No. de cuenta (multicuentas)
    let accountNo = "‚Äî";
    if(c2){
      const lab = c2.account_no_label || c2.account_label;
      if(lab) accountNo = lab;
      else if(c2.account_no !== null && c2.account_no !== undefined) accountNo = `Cuenta No. ${c2.account_no}`;
    }
    if(accountNo==="‚Äî" && x.account_id){
      accountNo = `‚Äî (${String(x.account_id).slice(-6)})`;
    }

    const receipt = x.receipt_path
      ? `<button class="ghost" type="button"
            onclick="openReceipt('${BUCKET}','${String(x.receipt_path).replace(/'/g,"\\'")}')">
            Ver boleta
         </button>`
      : "‚Äî";

    const eff = x.effective_date ? x.effective_date : "‚Äî";
    const joined = c1?.joined_at || c2?.joined_at || null;
    const defNextCycle = nextCycleStartISO(joined);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="nowrap">${date}</td>
      <td>${name}</td>
      <td>${email}</td>
      <td>${amt}</td>
      <td>${bank}</td>
      <td>${accountNo}</td>
      <td>${receipt}</td>
      <td class="nowrap">${statusChip(x.status, x.effective_date)}</td>
      <td class="nowrap">${eff}</td>
      <td class="nowrap">
        <button class="ok" onclick="approveTopup('${x.id}')">Aprobar ahora</button>
        <button class="ghost" onclick='openScheduleTopupModal(${JSON.stringify({
          id:x.id,
          amount:x.amount,
          currency:x.currency,
          status:x.status,
          effective_date:x.effective_date,
          user_id: inferredUid,
          account_id:x.account_id,
          name, email,
          default_date: defNextCycle
        })})'>Programar</button>
        ${x.effective_date ? `<button class="ghost" onclick="unscheduleTopup('${x.id}')">Quitar programaci√≥n</button>` : ``}
        <button class="danger" onclick="rejectTopupPrompt('${x.id}')">Rechazar</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  if(!rows.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="10" class="small">No hay recargas pendientes.</td>`;
    tb.appendChild(tr);
  }
}

async function openReceipt(bucket, path){
  try{
    const r = await fetch(`${PROJECT_URL}/functions/v1/admin-signed-receipt`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
          Authorization: "Bearer "+getToken()
      },
      body: JSON.stringify({ bucket, path })
    });

    if(!r.ok){
      console.error(await r.text().catch(()=> ""));
      alert("No se pudo abrir la boleta.");
      return;
    }

    const { signedUrl } = await r.json();
    window.open(signedUrl, "_blank");
  }catch(e){
    console.error(e);
    alert("Error al abrir la boleta.");
  }
}

/*** ‚úÖ Aprobar ahora + ‚úÖ borrar boleta del Storage + limpiar receipt_path ***/
async function approveTopup(topupId){
  const ok = await openConfirm({
    title:"Confirmaci√≥n de recarga",
    message:`<div style="font-weight:950;margin-bottom:6px">¬øAprobar ahora?</div>
             <div>Esto sumar√° el monto al capital del cliente inmediatamente.</div>
             <div style="margin-top:8px;opacity:.9">Luego se intentar√° borrar la boleta para que no ocupe espacio.</div>`,
    okText:"Aprobar"
  });
  if(!ok) return;

  let receiptPath = null;
  try{
    const r0 = await fetch(`${BASE}/topups?select=receipt_path&id=eq.${encodeURIComponent(topupId)}&limit=1`, {
      headers: {
        apikey: ANON_KEY,
        Authorization: "Bearer "+getToken(),
        "Cache-Control":"no-cache, no-store, must-revalidate",
        Pragma:"no-cache"
      },
      cache:"no-store"
    });
    if(r0.ok){
      const rows = await r0.json();
      receiptPath = rows?.[0]?.receipt_path || null;
    }
  }catch{}

  const r = await fetch(`${RPC}/approve_topup`, {
    method:"POST",
    headers: hAuth(),
    body: JSON.stringify({ p_topup_id: topupId })
  });

  if(!r.ok){
    console.error(await r.text().catch(()=> ""));
    showGlobalError("No se pudo aprobar la recarga", await r.text().catch(()=> ""));
    alert("No se pudo aprobar la recarga.");
    return;
  }

  if(receiptPath){
    try{
      const del = await fetch(`${PROJECT_URL}/functions/v1/admin-delete-receipt`,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
              Authorization: "Bearer "+getToken()
        },
        body: JSON.stringify({
          bucket: "topup-receipts",
          path: receiptPath
        })
      });

      await fetch(`${BASE}/topups?id=eq.${encodeURIComponent(topupId)}`,{
        method:"PATCH",
        headers: headersJSON(),
        body: JSON.stringify({ receipt_path: null })
      });

      if(!del.ok){
        console.warn("admin-delete-receipt no respondi√≥ OK:", await del.text().catch(()=> ""));
      }
    }catch(e){
      console.warn("No se pudo borrar boleta/limpiar receipt_path:", e);
      try{
        await fetch(`${BASE}/topups?id=eq.${encodeURIComponent(topupId)}`,{
          method:"PATCH",
          headers: headersJSON(),
          body: JSON.stringify({ receipt_path: null })
        });
      }catch{}
    }
  }

  alert("Recarga aprobada y capital acreditado.");
  await listTopups();
  await listUsers();
  await refreshKPIs();
}

function rejectTopupPrompt(topupId){
  const reason = prompt("Motivo del rechazo (opcional):") || "";
  rejectTopup(topupId, reason);
}
async function rejectTopup(topupId, reason){
  const ok = await openConfirm({
    title:"Rechazar recarga",
    message:`<div style="font-weight:950;color:#FFD0D0;margin-bottom:6px">¬øRechazar esta recarga?</div>
             <div style="opacity:.9">Motivo (opcional): <b>${escapeHtml(reason||"‚Äî")}</b></div>`,
    okText:"Rechazar"
  });
  if(!ok) return;

  const r = await fetch(`${RPC}/reject_topup`, {
    method:"POST",
    headers: headersJSON(),
    body: JSON.stringify({ p_topup_id: topupId, p_reason: reason })
  });

  if(!r.ok){
    console.error(await r.text().catch(()=> ""));
    alert("No se pudo rechazar la recarga.");
    return;
  }

  alert("Recarga rechazada.");
  await listTopups();
  await refreshKPIs();
}

// ‚úÖ Workaround: quitar programaci√≥n = effective_date NULL, scheduled_note NULL
async function unscheduleTopup(topupId){
  const ok = await openConfirm({
    title:"Quitar programaci√≥n",
    message:`<div style="font-weight:950;margin-bottom:6px">¬øQuitar programaci√≥n?</div>
             <div style="opacity:.9">Volver√° a estado Pendiente.</div>`,
    okText:"Quitar"
  });
  if(!ok) return;

  const r = await fetch(`${BASE}/topups?id=eq.${encodeURIComponent(topupId)}`,{
    method:"PATCH",
    headers: headersJSON(),
    body: JSON.stringify({ effective_date: null, scheduled_note: null })
  });

  if(!r.ok){
    console.error(await r.text().catch(()=> ""));
    alert("No se pudo quitar la programaci√≥n.");
    return;
  }

  alert("Programaci√≥n eliminada. La recarga volvi√≥ a Pendiente.");
  await listTopups();
  await refreshKPIs();
}

/* ============================================================
   MODAL PROGRAMAR TOPUP (workaround seguro)
   ============================================================ */
let SCHED_CTX = null;

function openScheduleTopupModal(ctx){
  SCHED_CTX = ctx;

  $("schedInfo").innerHTML =
    `<b>${ctx.name||'‚Äî'}</b> ‚Äî ${ctx.email||'‚Äî'}<br>`+
    `Monto: <b>${fmtMoney(ctx.amount, ctx.currency||'GTQ')}</b><br>`+
    `Regla: Se acreditar√° autom√°ticamente a las <b>9:00 AM (Guatemala)</b> del d√≠a efectivo.`;

  const d = ctx.effective_date || ctx.default_date || todayISO();
  $("schedDate").value = d;
  $("schedNote").value = ctx.scheduled_note || "";
  $("schedMsg").textContent = "";

  show($("modalScheduleTopup"), true);
}

function closeScheduleTopupModal(){
  show($("modalScheduleTopup"), false);
  SCHED_CTX = null;
}

async function doScheduleTopup(){
  if(!SCHED_CTX) return;

  const date = $("schedDate").value;
  const note = ($("schedNote").value || "").trim();

  if(!date){
    $("schedMsg").textContent = "Fecha requerida.";
    return;
  }

  const today = todayISO();
  if(date < today){
    $("schedMsg").textContent = "No se permiten fechas pasadas.";
    return;
  }

  const ok = await openConfirm({
    title:"Programar acreditaci√≥n",
    message:`<div style="font-weight:950;margin-bottom:6px">¬øProgramar esta recarga?</div>
             <div>Fecha efectiva: <b>${date}</b></div>
             <div style="margin-top:8px;opacity:.9">Se acreditar√° a las <b>9:00 AM (GT)</b> de ese d√≠a.</div>`,
    okText:"Programar"
  });
  if(!ok) return;

  $("schedMsg").textContent = "Programando‚Ä¶";
  setLoading($("schedMsg"), true);

  try{
    // ‚úÖ Workaround: solo actualiza campos de programaci√≥n, NO cambia status
    const r = await fetch(`${BASE}/topups?id=eq.${encodeURIComponent(SCHED_CTX.id)}`,{
      method:"PATCH",
      headers: headersJSON(),
      body: JSON.stringify({
        effective_date: date,
        scheduled_note: note || null
      })
    });

    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(t || "No se pudo programar.");
    }

    $("schedMsg").textContent = "Listo.";
    closeScheduleTopupModal();
    alert("Recarga programada correctamente.");
    await listTopups();
    await refreshKPIs();

  }catch(e){
    console.error(e);
    $("schedMsg").textContent = "Error.";
    alert("No se pudo programar: " + (e.message||e));
  }finally{
    setLoading($("schedMsg"), false);
  }
}

/*** ‚úÖ Helpers para evitar ReferenceError (perfiles + render de retiros) ***/
function isUUID(v){
  return typeof v==="string" && /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(v.trim());
}

function normAccountRow(a, idx){
  a = a || {};
  const account_id = (a.account_id || a.id || a.accountId || a.account_uuid || a.account_uuid_id || "").toString();
  const account_no = (a.account_no ?? a.account_number ?? a.no ?? (idx+1));
  return {
    ...a,
    account_id,
    account_no,
    // normalizar campos usados en UI
    currency: a.currency || a.curr || a.moneda || a.ccy || "GTQ",
    capital:  (a.capital ?? a.current_capital ?? a.saldo ?? a.balance ?? a.capital_actual),
    joined_at: (a.joined_at || a.join_date || a.start_date || a.fecha_ingreso),
    plan: (a.plan || a.plan_code || a.plan_name || "STANDARD"),
    bank_name: (a.bank_name || a.bank || a.banco || ""),
    bank_account: (a.bank_account || a.account_number_bank || a.no_cuenta || ""),
    bank_account_type: (a.bank_account_type || a.tipo_cuenta || a.account_type_bank || a.bank_type || "")
  };
}


async function loadProfilesByIds(ids){
  const map = new Map();
  if(!ids || !ids.length) return map;
  const h = {
    apikey: ANON_KEY,
    Authorization: "Bearer "+getToken(),
    "Cache-Control":"no-cache, no-store, must-revalidate",
    Pragma:"no-cache"
  };
  const chunkSize = 80;
  for(let i=0;i<ids.length;i+=chunkSize){
    const chunk = ids.slice(i, i+chunkSize).filter(Boolean);
    if(!chunk.length) continue;
    const inList = "in.(" + chunk.join(",") + ")";
    const url = `${BASE}/profiles?select=id,full_name,email&id=${inList}`;
    const r = await fetch(url, { headers:h, cache:"no-store" });
    if(!r.ok){
      // si falla, devolvemos lo que tengamos (no rompemos la UI)
      console.error("loadProfilesByIds", r.status, await r.text().catch(()=> ""));
      continue;
    }
    const rows = await r.json().catch(()=>[]);
    (rows||[]).forEach(p=> map.set(p.id, p));
  }
  return map;
}

function renderWithdrawRequests(rows, profileMap){
  const body = $("withdrawReqs");
  if(!body) return;
  body.innerHTML = "";

  (rows||[]).forEach(r=>{
    // Fallback por compatibilidad
    const p = profileMap?.get?.(r.profile_id) || {};

    const clientName  = r.client_full_name || p.full_name || "‚Äî";
    const clientEmail = r.client_email || p.email || "‚Äî";

    const bankName   = r.account_bank_name || r.bank_name || "‚Äî";
    const bankAcc    = r.account_bank_account || r.bank_account || "‚Äî";
    const bankAccTyp = r.account_bank_account_type || r.bank_account_type || "‚Äî";

    const accountNo   = r.account_no ?? "‚Äî";
    const accountType = r.account_type ?? "‚Äî";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.created_at ? new Date(r.created_at).toLocaleString("es-GT") : "‚Äî"}</td>
      <td>${escapeHtml(clientName)}</td>
      <td>${escapeHtml(clientEmail)}</td>
      <td>${fmtMoney(r.amount, r.currency || "GTQ")}</td>
      <td>${escapeHtml(bankName)}</td>
      <td>${escapeHtml(String(accountNo))}</td>
      <td>${escapeHtml(accountType)}</td>
      <td>${escapeHtml(bankAccTyp)}</td>
      <td>${escapeHtml(r.note || "‚Äî")}</td>
      <td class="nowrap">
        ${(() => {
          const st = String(r.status || "").toUpperCase().trim();
          const isPending = (!st) || st.startsWith("PEND") || st==="REQUESTED";
          if(!isPending) return "‚Äî";
          return `<div class="actions">
            <button class="mini ok" onclick="approveWithdrawUI('${r.id}')">Aprobar</button>
            <button class="mini danger" onclick="rejectWithdrawUI('${r.id}')">Rechazar</button>
          </div>`;
        })()}
      </td>
    `;
    body.appendChild(tr);
  });
}

async function listWithdrawRequests(){
  const msgEl = $("withdrawReqsMsg");
  if(msgEl) msgEl.textContent = "";

  const h = {
    apikey: ANON_KEY,
    Authorization: "Bearer "+getToken(),
    "Cache-Control":"no-cache, no-store, must-revalidate",
    Pragma:"no-cache"
  };

  try{
    // ‚úÖ Leer desde la VIEW (ya trae cliente/email/no.cuenta/banco)
    const sel = [
      "id","created_at","status","amount","currency",
      "bank_name","bank_account","bank_account_type",
      "note","account_id",
      // campos enriquecidos por la view:
      "client_full_name","client_email",
      "account_no","account_type",
      "account_bank_name","account_bank_account","account_bank_account_type"
    ].join(",");

    const url = `${BASE}/v_admin_withdrawal_requests?select=${encodeURIComponent(sel)}&status=eq.PENDING&order=created_at.desc`;

    const res = await fetch(url, { headers:h, cache:"no-store" });
    if(!res.ok){
      const t = await res.text();
      throw new Error(t || ("HTTP "+res.status));
    }

    const rows = await res.json();

    // ‚úÖ Ya no necesitamos loadProfilesByIds()
    renderWithdrawRequests(rows, new Map());

    // KPI
    const pending = rows.length;
    setKPI("kpiWithdrawPending", pending);
    setKPI("kpiOpsToday", pending + (Number($("kpiTopupsPending")?.dataset?.value||0)));

  }catch(err){
    console.error("listWithdrawRequests error", err);
    if(msgEl) msgEl.textContent = "No se pudieron cargar solicitudes de retiro (verifica permisos/sesi√≥n).";
    renderWithdrawRequests([], new Map());
  }
}


async function approveWithdrawReq(id){
  const h = hAuth();

  // 1) Obtener solicitud para saber account_id y amount
  const q = `${BASE}/withdrawal_requests?select=${encodeURIComponent("id,account_id,amount,status")}&id=eq.${id}&limit=1`;
  const r0 = await fetch(q, { headers: h });
  if(!r0.ok) throw new Error(await r0.text());
  const rows = await r0.json();
  const req = rows?.[0];
  if(!req) throw new Error("Solicitud no encontrada");
  const status = String(req.status||"").toUpperCase();
  if(status !== "PENDING") return;

  // 2) Ejecutar el retiro (RPC)
  const r1 = await fetch(`${BASE}/rpc/withdraw_capital`, {
    method:"POST",
    headers: h,
    body: JSON.stringify({ p_account_id: req.account_id, p_amount: Number(req.amount) })
  });
  if(!r1.ok) throw new Error(await r1.text());

  // 3) Marcar como APPROVED + auditor√≠a
  const r2 = await fetch(`${BASE}/withdrawal_requests?id=eq.${id}`, {
    method:"PATCH",
    headers: h,
    body: JSON.stringify({
      status: "APPROVED",
      reviewed_by: localStorage.uid || null,
      reviewed_at: new Date().toISOString()
    })
  });
  if(!r2.ok) throw new Error(await r2.text());
}

async function rejectWithdrawReq(id, reason){
  const h = hAuth();

  const r2 = await fetch(`${BASE}/withdrawal_requests?id=eq.${id}`, {
    method:"PATCH",
    headers: h,
    body: JSON.stringify({
      status: "REJECTED",
      reviewed_by: localStorage.uid || null,
      reviewed_at: new Date().toISOString(),
      note: String(reason || "")
    })
  });
  if(!r2.ok) throw new Error(await r2.text());
}

// === Aliases usados por la UI de "Solicitudes de retiro" ===
// (El render usa approveWithdraw/openRejectWithdraw; estas funciones delegan a approveWithdrawReq/rejectWithdrawReq)
async function approveWithdraw(withdrawId){
  return await approveWithdrawReq(withdrawId);
}

async function approveWithdrawUI(id){
  // Bloqueo simple para evitar doble click
  const btns = document.querySelectorAll(`button[onclick="approveWithdrawUI('${id}')"]`);
  btns.forEach(b=>b.disabled=true);
  try{
    await approveWithdrawReq(id);
    toast("Retiro aprobado exitosamente", "ok");
    await listWithdrawRequests();
  }catch(e){
    console.error(e);
    toast("No se pudo aprobar el retiro", "err", (e?.message||"").slice(0,180));
  }finally{
    btns.forEach(b=>b.disabled=false);
  }
}

async function rejectWithdrawUI(id){
  const reason = prompt("Motivo de rechazo (opcional):", "");
  if(reason === null) return;
  const btns = document.querySelectorAll(`button[onclick="rejectWithdrawUI('${id}')"]`);
  btns.forEach(b=>b.disabled=true);
  try{
    await rejectWithdrawReq(id, reason || null);
    toast("Retiro rechazado exitosamente", "ok");
    await listWithdrawRequests();
  }catch(e){
    console.error(e);
    toast("No se pudo rechazar el retiro", "err", (e?.message||"").slice(0,180));
  }finally{
    btns.forEach(b=>b.disabled=false);
  }
}

function openRejectWithdraw(withdrawId){
  const reason = prompt("Motivo de rechazo (opcional):", "");
  // Si el usuario cancela, no hacemos nada
  if(reason === null) return;
  return rejectWithdrawReq(withdrawId, reason || null);
}



/*** Editar ***/

let _accountsCacheByUser = new Map(); // user_id -> array of accounts

async function fetchAccountsByUser(userId){
  if(!userId) return [];
  if(_accountsCacheByUser.has(userId)) return _accountsCacheByUser.get(userId);

  // ‚úÖ LEE cuentas directamente de la tabla accounts para traer SIEMPRE el plan real y el tipo de cuenta real
  const sel = [
    "id","user_id","account_no","plan","currency","capital","initial_capital",
    "invest_months","interest_pct","joined_at","compound_interest",
    "bank_name","bank_account","bank_account_type","created_at"
  ].join(",");

  const url = `${BASE}/accounts?select=${encodeURIComponent(sel)}&user_id=eq.${encodeURIComponent(userId)}&order=account_no.asc.nullslast&order=created_at.asc`;
  const r = await fetch(url, { headers: headersJSON() });
  if(!r.ok) await mustOk(r, "cargar cuentas");
  const rows = await r.json().catch(()=>[]);

  _accountsCacheByUser.set(userId, rows||[]);
  return rows||[];
}

function fillAccountFields(a){
  if(!a) return;
  $("u_account_id").value = (a.account_id || a.id || "");
  $("u_currency").value = a.currency || "GTQ";
  setCapitalInputValue(a.capital);
  $("u_joined").value   = a.joined_at ? String(a.joined_at).slice(0,10) : "";
  $("u_plan").value = (a.plan ?? a.account_plan ?? $("u_plan").value ?? "STANDARD");
  $("u_months").value   = a.invest_months ?? "12";
  $("u_rate").value     = (a.interest_pct ?? "") === null ? "" : (a.interest_pct ?? "");
  $("u_bank_name").value   = a.bank_name ?? "";
  $("u_bank_account").value= a.bank_account ?? "";
  $("u_bank_account_type").value = a.bank_account_type ?? "";
  $("u_interest_mode").value = a.compound_interest ? "compound" : "monthly";
  validateRatePlan();
}

async function loadAccountsUI(userId, preferredAccountId){
  $("u_user_id").value = userId || "";
  const sel = $("u_account_sel");
  if(!sel) return;
  sel.innerHTML = "";
  const accs = await fetchAccountsByUser(userId);
  // ‚úÖ orden estable para que 'Cuenta No. X' nunca cambie
  const ordered = sortAccountsStable(accs);

  $("u_accounts_hint").textContent = ordered.length ? `Este cliente tiene ${ordered.length} cuenta(s).` : "Este cliente no tiene cuentas a√∫n.";
  ordered.forEach((a, i)=>{
    const opt = document.createElement("option");
    const accId = (a.account_id || a.id || "");
    const noRaw = (a.account_no ?? (i+1));
    const no = getStableAccountNo(userId, accId, noRaw);
    opt.value = accId;
    opt.textContent = `Cuenta No. ${no}`;
    sel.appendChild(opt);
  });
  // elegir
  let chosen = ordered[0] || null;
  if(preferredAccountId){
    const f = ordered.find(x=>(x.account_id||x.id)===preferredAccountId);
    if(f) chosen = f;
  }
  if(chosen){
    sel.value = (chosen.account_id || chosen.id || "");
    fillAccountFields(chosen);
    // ‚úÖ corregir tipo de cuenta si el RPC no lo trae o viene contaminado
    ensureBankAccountType((chosen.account_id || chosen.id || "")).catch(()=>{});
  }else{
    $("u_account_id").value = "";
  }
}

document.addEventListener("change", (e)=>{
  if(e.target && e.target.id==="u_account_sel"){
    const uid = $("u_user_id").value;
    const accs = _accountsCacheByUser.get(uid) || [];
    const a = accs.find(x=>(x.account_id||x.id)===e.target.value);
    fillAccountFields(a);
  }
});

async function addNewAccountForCurrentUser(){
  const uid = ($("u_user_id")?.value || "").trim();
  if(!isUUID(uid)) return alert("Primero selecciona un cliente (UUID v√°lido).");
  let sourceAccountId = ($("u_account_sel")?.value || $("u_account_id")?.value || "").trim();
  if(!isUUID(sourceAccountId)) sourceAccountId = null;
  const btn = $("btnAddAccount");
  if(btn) btn.disabled = true;
  try{
    const r = await fetch(`${RPC}/admin_create_additional_account`, {
      method:"POST",
      headers: headersJSON(),
      body: JSON.stringify({ p_user_id: uid, p_source_account_id: sourceAccountId })
    });
    if(!r.ok) throw new Error(await r.text() || "No se pudo crear la cuenta adicional");
    const out = await r.json().catch(()=>null);
    // limpiar cache y recargar
    _accountsCacheByUser.delete(uid);
    await loadAccountsUI(uid, out?.account_id || out || null);
    await listUsers(); // refrescar lista principal
  }catch(err){
    console.error(err);
    alert(String(err?.message || err));
  }finally{
    if(btn) btn.disabled = false;
  }
}
document.addEventListener("click", (e)=>{
  if(e.target && e.target.id==="btnAddAccount"){
    e.preventDefault();
    addNewAccountForCurrentUser();
  }
});


function editClient(x){
  $("u_user_id").value = x.user_id || "";
  $("u_email").value = x.email || "";
  
  loadAccountsUI(x.user_id || "", x.account_id || null).catch(console.error);
$("u_name").value  = x.full_name || "";
  $("u_phone").value = x.phone || "";
  $("u_currency").value = x.currency || "GTQ";
  setCapitalInputValue(x.capital);
  $("u_joined").value   = x.joined_at ? new Date(x.joined_at).toISOString().slice(0,10) : "";
  $("u_plan").value     = x.plan || "STANDARD";
  $("u_interest_mode").value = x.compound_interest ? "compound" : "monthly";
  $("u_months").value   = x.invest_months ?? "12";
  $("u_rate").value     = (x.interest_pct ?? "") === null ? "" : (x.interest_pct ?? "");
  $("u_bank_name").value   = x.bank_name ?? "";
  $("u_bank_account").value= x.bank_account ?? "";
  $("u_bank_account_type").value = x.bank_account_type ?? "";
  $("u_pass").value = "";
  validateRatePlan();
  document.getElementById("formCard").scrollIntoView({behavior:"smooth",block:"start"});
}


/*** === FIX multicuentas: nombre estable "Cuenta No. X" + tipo de cuenta correcto === ***/
function _acctMapKey(uid){ return `acctLabelMap:${uid}`; }

function getStableAccountNo(uid, accountId, fallbackNo){
  const key = _acctMapKey(uid);
  let map = {};
  try{ map = JSON.parse(localStorage.getItem(key) || "{}") || {}; }catch(_){ map = {}; }

  if(accountId && map[accountId]) return map[accountId];

  // asignar uno nuevo (si no existe)
  const used = new Set(Object.values(map).map(n=>Number(n)).filter(n=>Number.isFinite(n) && n>0));
  let n = Number(fallbackNo);
  if(!Number.isFinite(n) || n<=0) n = 1;
  while(used.has(n)) n++;
  if(accountId){
    map[accountId] = n;
    try{ localStorage.setItem(key, JSON.stringify(map)); }catch(_){}
  }
  return n;
}

function sortAccountsStable(arr){
  return (arr||[]).slice().sort((a,b)=>{
    const na = Number(a.account_no || 0);
    const nb = Number(b.account_no || 0);
    if(na && nb && na!==nb) return na-nb;
    if(na && !nb) return -1;
    if(!na && nb) return 1;

    const da = a.joined_at ? new Date(a.joined_at).getTime() : 0;
    const db = b.joined_at ? new Date(b.joined_at).getTime() : 0;
    if(da && db && da!==db) return da-db;

    const ca = a.created_at ? new Date(a.created_at).getTime() : 0;
    const cb = b.created_at ? new Date(b.created_at).getTime() : 0;
    if(ca && cb && ca!==cb) return ca-cb;

    return String(a.account_id||a.id||"").localeCompare(String(b.account_id||b.id||""));
  });
}

async function ensureBankAccountType(accountId){
  // Nunca "borra" el valor existente. Solo corrige si viene contaminado o falta.
  const el = $("u_bank_account_type");
  if(!el) return;

  const current = String(el.value || "").trim();
  const upper = current.toUpperCase();

  if(!accountId || !isUUID(accountId)) return;

  // Si ya hay un valor normal (ej. Ahorro/Monetaria/Cr√©dito), no tocarlo.
  if(current && !["STANDARD","PLATINUM","BLACK"].includes(upper)) return;

  try{
    const sel = "id,bank_account_type,account_no";
    const r = await fetch(`${BASE}/accounts?select=${encodeURIComponent(sel)}&id=eq.${encodeURIComponent(accountId)}&limit=1`, {
      headers: headersJSON()
    });
    if(!r.ok) return;
    const rows = await r.json().catch(()=>[]);
    const row = rows && rows[0] ? rows[0] : null;

    // Solo sobreescribir si la DB trae un valor real
    const dbVal = row && row.bank_account_type != null ? String(row.bank_account_type || "").trim() : "";
    if(dbVal){
      el.value = dbVal;
    }else{
      // Si la DB no tiene nada, mantenemos lo que el usuario ya ten√≠a (aunque sea vac√≠o)
      // y NO colocamos "STANDARD" ni nada.
      if(["STANDARD","PLATINUM","BLACK"].includes(upper)) el.value = "";
    }

    // Si existe account_no en DB, tambi√©n lo fijamos en UI/cach√©
    const uid = ($("u_user_id")?.value || "").trim();
    if(uid && row && row.account_no){
      const key = _acctMapKey(uid);
      let map = {};
      try{ map = JSON.parse(localStorage.getItem(key) || "{}") || {}; }catch(_){ map = {}; }
      map[accountId] = Number(row.account_no);
      try{ localStorage.setItem(key, JSON.stringify(map)); }catch(_){}
    }
  }catch(e){
    console.warn("ensureBankAccountType error", e);
  }
}


/*** Validaci√≥n Plan vs Tasa ***/
function validateRatePlan(){
  const plan = $("u_plan").value;
  const rateStr = $("u_rate").value;
  const rate = rateStr === "" ? null : Number(rateStr);
  const err = $("rateError");

  if(rate === null){
    if(plan === "STANDARD") $("u_rate").value = 15;
    if(plan === "PLATINUM") $("u_rate").value = 20;
  }

  const finalRate = Number($("u_rate").value || NaN);
  let isValid = true;
  if(plan === "STANDARD") isValid = (finalRate === 15);
  else if(plan === "PLATINUM") isValid = (finalRate === 20);
  else if(plan === "BLACK") isValid = true;

  show(err, !isValid);
  return isValid;
}
$("u_plan").addEventListener("change", validateRatePlan);
$("u_rate").addEventListener("input", validateRatePlan);

/*** Guardar ***/
async function saveUser(){
  const msgEl = $("saveMsg");
  if(msgEl) msgEl.textContent = "";

  // ----- leer formulario
  const email    = ($("u_email")?.value || "").trim().toLowerCase();
  const fullName = ($("u_name")?.value || "").trim();
  const phone    = ($("u_phone")?.value || "").trim();
  const password = ($("u_pass")?.value || ""); // solo al CREAR
  const plan     = ($("u_plan")?.value || "").trim();
  const currency = ($("u_currency")?.value || "GTQ").trim();
  const capital  = parseCapitalFromInput($("u_capital")?.value || "");
  const joined   = $("u_joined")?.value || null;
  const months   = parseInt(($("u_months")?.value || "0"), 10) || 0;
  const rateStr  = ($("u_rate")?.value || "").trim();
  const rate     = (rateStr === "" ? null : Number(rateStr));
  const bankName = ($("u_bank_name")?.value || "").trim();
  const bankAcct = ($("u_bank_account")?.value || "").trim();
  const bankType = ($("u_bank_account_type")?.value || "").trim();
  const interestMode = ($("u_interest_mode")?.value || "monthly");
  const compound = (interestMode === "compound");

  // ids ocultos (si ya estamos editando)
  let uid = ($("u_user_id")?.value || "").trim();
  let accountId = ($("u_account_id")?.value || "").trim();

  // Validaciones m√≠nimas
  if(!email) return alert("Email requerido");
  if(!fullName) return alert("Nombre requerido");
  if(months < 0) return alert("Meses inv√°lidos");
  if(rate !== null && (isNaN(rate) || rate < 0)) return alert("Inter√©s inv√°lido");
  if(capital < 0) return alert("Capital inv√°lido");

  // Si no tenemos uid, intentamos resolverlo desde la lista ya cargada
  if(!uid){
    const found = (CACHED||[]).find(x => (x.email||"").toLowerCase() === email);
    if(found?.user_id) uid = String(found.user_id);
    // si viene una cuenta en el selector, √∫sala
    if(found?.account_id) accountId = String(found.account_id);
  }

  // ----- CASO A: usuario NUEVO (no existe)
  if(!uid){
    if(!password || password.length < 8){
      return alert("Para crear un cliente nuevo debes poner una contrase√±a (m√≠nimo 8 caracteres).");
    }

    // Creamos Auth user + profile + (opcional) primera cuenta v√≠a Edge Function (service_role)
    const payload = {
      email,
      password,
      full_name: fullName,
      phone: phone || null,
      plan: plan || null,
      account: {
        currency: currency || "GTQ",
        capital,
        interest_pct: rate ?? 0,
        invest_months: months,
        joined_at: joined,
        bank_name: bankName || null,
        bank_account: bankAcct || null,
        bank_account_type: bankType || null,
        compound_interest: compound
      }
    };

    const r = await fetch(`${SUPABASE_URL}/functions/v1/admin-create-user`, {
      method: "POST",
      headers: hAuth(),
      body: JSON.stringify(payload)
    });

    if(!r.ok){
      // si token expir√≥, forzamos re-login
      const raw = await r.text().catch(()=> "");
      if(raw.includes("JWT expired") || r.status === 401){
        logout?.();
        throw new Error("Tu sesi√≥n expir√≥. Inicia sesi√≥n de nuevo.");
      }
      throw new Error(raw || `Error creando usuario (${r.status})`);
    }

    const out = await r.json().catch(()=> ({}));
    if(!out?.ok || !out?.user_id){
      throw new Error(out?.error || "No se pudo crear el usuario");
    }

    if(msgEl) msgEl.textContent = "Cliente creado";
    _accountsCacheByUser.delete(out.user_id);
    await listUsers();
    await refreshKPIs();
    // limpiar password en UI
    if($("u_pass")) $("u_pass").value = "";
    return;
  }

  // ----- CASO B: usuario EXISTENTE (actualizar perfil + cuenta seleccionada)
  try{
    // 0) Asegurar accountId (si no viene, tomarlo del selector)
    if(!accountId){
      const sel = $("u_account_sel");
      if(sel && sel.value) accountId = sel.value;
    }
    if(!isUUID(accountId)){
      return alert("Seleccione una cuenta v√°lida (u_account_sel) antes de guardar.");
    }

    // (1) ‚úÖ Actualizar SOLO perfil (sin tocar cuentas)
    const rProf = await fetch(`${BASE}/profiles?id=eq.${encodeURIComponent(uid)}`, {
      method:"PATCH",
      headers: headersJSON(),
      body: JSON.stringify({
        email: email,
        full_name: fullName,
        phone: phone || null
      })
    });
    if(!rProf.ok) await mustOk(rProf, "actualizar perfil");

    // (2) ‚úÖ Actualizar SOLO la cuenta seleccionada (no afecta las otras)
    const patchAccount = {
      currency: currency || "GTQ",
      capital: capital,
      joined_at: joined,
      plan: plan || null,
      invest_months: months,
      interest_pct: rate,
      bank_name: bankName || null,
      bank_account: bankAcct || null,
      bank_account_type: bankType || null,
      compound_interest: compound
    };

    const rAcc = await fetch(`${BASE}/accounts?id=eq.${encodeURIComponent(accountId)}`, {
      method:"PATCH",
      headers: headersJSON(),
      body: JSON.stringify(patchAccount)
    });
    if(!rAcc.ok) await mustOk(rAcc, "actualizar cuenta seleccionada");

    if(msgEl) msgEl.textContent = "Guardado";
    _accountsCacheByUser.delete(uid);
    await listUsers();
    await refreshKPIs();

    if($("u_pass")) $("u_pass").value = "";
    return;
  } catch(err){
    console.error(err);
    const msg = String(err?.message || err);
    if(msgEl) msgEl.textContent = msg;
    if(msg.includes("JWT expired")){
      logout?.();
      alert("Tu sesi√≥n expir√≥. Inicia sesi√≥n de nuevo.");
    }
  }
}


async function deleteClientFull(x){
  // ‚ö†Ô∏è Elimina PERFIL + TODAS LAS CUENTAS (acci√≥n destructiva)
  const uid = (x && x.user_id) ? String(x.user_id) : "";
  if(!isUUID(uid)) return alert("UUID de usuario inv√°lido.");
  const ok = await openConfirm({
    title:"Eliminar cliente COMPLETO",
    html:`<div style="color:#FFD0D0;margin-bottom:6px"><b>Esto eliminar√° el cliente y TODAS sus cuentas.</b></div>
          <div style="opacity:.9">Se borrar√° el perfil y todo el historial asociado.</div>`,
    okText:"S√≠, eliminar TODO",
    cancelText:"Cancelar"
  });
  if(!ok) return;

  const jh = headersJSON();
  try{
    // borrar todo lo asociado al user_id
    await safeDelete(`${BASE}/topups?user_id=eq.${encodeURIComponent(uid)}`, jh);
    await safeDelete(`${BASE}/withdrawal_requests?user_id=eq.${encodeURIComponent(uid)}`, jh);
    await safeDelete(`${BASE}/accounts?user_id=eq.${encodeURIComponent(uid)}`, jh);
    await safeDelete(`${BASE}/profiles?id=eq.${encodeURIComponent(uid)}`, jh);

    _accountsCacheByUser.delete(uid);
    await listUsers();
    await refreshKPIs();
    alert("Cliente eliminado completamente.");
  }catch(err){
    console.error(err);
    alert(String(err?.message || err));
  }
}

// helper: delete pero ignora 404
async function safeDelete(url, headers){
  const r = await fetch(url, { method:"DELETE", headers });
  if(r.status === 404) return;
  if(!r.ok) await mustOk(r, "eliminar");
}


/* ============================================================
   RESET PASSWORD (CLIENTES)
   ============================================================ */
let RESET_CTX = null;

function refreshResetPicker(){
  const sel = $("resetPick");
  if(!sel) return;

  sel.innerHTML = "";
  const rows = (CACHED||[]).filter(x=>x.email && x.user_id);

  if(!rows.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay clientes cargados";
    sel.appendChild(opt);
    return;
  }

  rows.forEach(x=>{
    const opt = document.createElement("option");
    opt.value = x.user_id;
    opt.textContent = `${x.full_name || x.email} ‚Äî ${x.email}`;
    opt.dataset.email = x.email || "";
    sel.appendChild(opt);
  });

  if(RESET_CTX?.user_id){
    sel.value = RESET_CTX.user_id;
  } else {
    sel.value = rows[0].user_id;
  }

  syncResetCtxFromPicker();
}

function syncResetCtxFromPicker(){
  const sel = $("resetPick");
  if(!sel) return;

  const uid = sel.value;
  const x = (CACHED||[]).find(r=>r.user_id === uid);
  if(x){
    RESET_CTX = x;
    setResetInfoFromCtx();
  }
}

function setResetInfoFromCtx(){
  const c = RESET_CTX || {};
  $("resetClientInfo").innerHTML =
    `<b>${c.full_name||'‚Äî'}</b> ‚Äî ${c.email||'‚Äî'}<br>`+
    `Al aplicar, se asigna contrase√±a y se fuerza modal de cambio en el panel del cliente.`;
}

function openResetModal(client=null){
  if(client && client.email){
    RESET_CTX = client;
    show($("resetPickWrap"), false);
    setResetInfoFromCtx();
  }else{
    RESET_CTX = null;
    show($("resetPickWrap"), true);
    refreshResetPicker();
  }

  $("resetNewPass").value = "";
  $("resetMsg").textContent = "";
  show($("modalReset"), true);
}

function closeResetModal(){
  show($("modalReset"), false);
  RESET_CTX = null;
}

async function doResetPassword(){
  if(!$("resetPickWrap")?.classList.contains("hidden")){
    syncResetCtxFromPicker();
  }

  if(!RESET_CTX){
    $("resetMsg").textContent = "Seleccione un cliente.";
    return;
  }

  const newPass = ($("resetNewPass").value || "").trim();
  if(newPass.length < 8){
    $("resetMsg").textContent = "La contrase√±a debe tener m√≠nimo 8 caracteres.";
    return;
  }
  if(!RESET_CTX.email){
    $("resetMsg").textContent = "Falta email del cliente.";
    return;
  }

  const ok = await openConfirm({
    title:"Restablecer contrase√±a",
    message:`<div style="font-weight:950;margin-bottom:6px">¬øAsignar nueva contrase√±a?</div>
             <div>Cliente: <b>${escapeHtml(RESET_CTX.email)}</b></div>
             <div style="margin-top:8px;opacity:.9">Esto activar√° el modal obligatorio en el panel cliente.</div>`,
    okText:"Aplicar"
  });
  if(!ok) return;

  $("resetMsg").textContent = "Aplicando reset‚Ä¶";
  setLoading($("resetMsg"), true);

  try{
    const url = `${PROJECT_URL}/functions/v1/admin-reset-password`;
    const r = await fetch(url,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
          Authorization: "Bearer "+getToken()
      },
      body: JSON.stringify({
        email: RESET_CTX.email,
        new_password: newPass
      })
    });

    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(t || "No se pudo resetear (Edge Function admin-reset-password).");
    }

    if(RESET_CTX.user_id){
      const pr = await fetch(`${BASE}/profiles?id=eq.${encodeURIComponent(RESET_CTX.user_id)}`,{
        method:"PATCH",
        headers: headersJSON(),
        body: JSON.stringify({
          must_change_password: true,
          must_change_password_at: new Date().toISOString()
        })
      });

      if(!pr.ok){
        console.warn("No se pudo marcar must_change_password en profiles:", await pr.text().catch(()=> ""));
      }
    }

    $("resetMsg").textContent = "Listo.";
    closeResetModal();
    alert("Contrase√±a restablecida. El cliente deber√° iniciar sesi√≥n y cambiarla.");

  }catch(e){
    console.error(e);
    $("resetMsg").textContent = "Error.";
    alert("No se pudo restablecer: " + (e.message||e));
  }finally{
    setLoading($("resetMsg"), false);
  }
}

/*** INIT ***/
async function initApp(){
  clearGlobalError();

  const ok = await validateSession();

  if(ok){
    try{
      await requireAdmin();
    }catch(e){
      setGlobalError("Tu usuario no es admin (no est√° en admin_users).\nAgrega tu UUID en la tabla admin_users y vuelve a iniciar sesi√≥n.");
      await logout();
      return;
    }
    show($("unauth"), false);
    show($("app"), true);
    show($("logoutBtn"), true);
    show($("btnOpenResetGlobal"), true);
    show($("kpisWrap"), true);

    await refreshSessionMeta();
    await listUsers();
    await listTopups();
    await listWithdrawRequests();
    await refreshKPIs();

    refreshWithdrawPicker();
    updateWithdrawHint();
  }else{
    show($("app"), false);
    show($("logoutBtn"), false);
    show($("btnOpenResetGlobal"), false);
    show($("kpisWrap"), false);
    show($("unauth"), true);
    await refreshSessionMeta();
  }
}

/*** BINDINGS ***/
document.addEventListener("DOMContentLoaded", ()=>{
  $("loginForm").addEventListener("submit", doLogin);
  $("logoutBtn").addEventListener("click", logout);
  $("btnRefreshWithdrawReqs")?.addEventListener("click", listWithdrawRequests);

  $("togglePass").addEventListener("click", ()=> {
    const inp = $("u_pass");
    inp.type = (inp.type === "password") ? "text" : "password";
  });

  $("saveBtn").addEventListener("click", saveUser);

  $("clearBtn").addEventListener("click", ()=>{
    ["u_email","u_name","u_phone","u_pass","u_capital","u_joined","u_rate","u_bank_name","u_bank_account","u_bank_account_type"].forEach(id=>$(id).value="");
    $("u_currency").value="GTQ";
    $("u_plan").value="STANDARD";
    $("u_months").value="12";
    $("u_interest_mode").value="monthly";
    $("saveMsg").textContent="";
    validateRatePlan();
  });

  $("btnRefreshUsers").addEventListener("click", async ()=>{ await listUsers(); await refreshKPIs(); });
  $("btnRefreshTopups")?.addEventListener("click", async ()=>{ await listTopups(); await refreshKPIs(); });

  bindCapitalFormatter($("u_capital"));

  $("btnResetDo").addEventListener("click", doResetPassword);
  $("btnOpenResetGlobal").addEventListener("click", ()=> openResetModal(null));
  $("resetPick")?.addEventListener("change", syncResetCtxFromPicker);

  $("btnDoSchedule")?.addEventListener("click", doScheduleTopup);

  $("modalScheduleTopup")?.addEventListener("click", (e)=>{ if(e.target === $("modalScheduleTopup")) closeScheduleTopupModal(); });
  $("modalReset")?.addEventListener("click", (e)=>{ if(e.target === $("modalReset")) closeResetModal(); });
  $("modalWithdrawHistory")?.addEventListener("click", (e)=>{ if(e.target === $("modalWithdrawHistory")) closeWithdrawHistory(); });

  $("wdAccount")?.addEventListener("change", updateWithdrawHint);
  $("btnWithdraw")?.addEventListener("click", doWithdraw);

  $("btnOpenWithdrawHistory")?.addEventListener("click", openWithdrawHistory);
  $("btnLoadWithdrawHistory")?.addEventListener("click", loadWithdrawHistory);
  $("btnPrintWithdrawHistory")?.addEventListener("click", printWithdrawalsPDF);
  $("btnDeleteWithdrawalsShown")?.addEventListener("click", deleteWithdrawalsShown);

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      try{ closeResetModal(); }catch{}
      try{ closeScheduleTopupModal(); }catch{}
      try{ closeWithdrawHistory(); }catch{}
      try{ closeConfirm(false); }catch{}
    }
  });

  // bot√≥n confirmar del modal confirm
  $("confirmOkBtn")?.addEventListener("click", ()=> closeConfirm(true));

  initApp();
});

/*** FX DEBUG HARNESS (captura TODOS los errores + requests) ***/
(function(){
  const store = [];
  const push = (type, payload) => {
    store.push({ts:new Date().toISOString(), type, ...payload});
    try{ localStorage.fx_debug_log = JSON.stringify(store.slice(-800)); }catch(e){}
  };

  // 1) Errores JS
  window.addEventListener('error', (e)=>{
    push('js_error', {message: e.message, filename: e.filename, lineno: e.lineno, colno: e.colno, stack: (e.error && e.error.stack) || null});
  });
  window.addEventListener('unhandledrejection', (e)=>{
    const r = e.reason;
    push('unhandled_rejection', {message: (r && (r.message||r.error_description||r.error)) || String(r), stack: r && r.stack});
  });

  // 2) console.*
  ['error','warn','log'].forEach((k)=>{
    const orig = console[k].bind(console);
    console[k] = (...args)=>{
      push('console_'+k, {args: args.map(a=>{ try{return (typeof a==='string')?a:JSON.stringify(a);}catch(e){return String(a);} })});
      orig(...args);
    };
  });

  // 3) fetch
  const origFetch = window.fetch.bind(window);
  window.fetch = async (input, init={})=>{
    const url = (typeof input === 'string') ? input : (input && input.url);
    const method = (init && init.method) || 'GET';
    const headers = (init && init.headers) || {};
    const body = init && init.body;
    const t0 = performance.now();
    try{
      const res = await origFetch(input, init);
      const t1 = performance.now();
      let text = '';
      try { text = await res.clone().text(); } catch(e){}
      push('fetch', {url, method, status: res.status, ms: Math.round(t1-t0), req_headers: headers, req_body: body, res_text: text.slice(0,2000)});
      return res;
    }catch(err){
      const t1 = performance.now();
      push('fetch_error', {url, method, ms: Math.round(t1-t0), message: err && err.message, stack: err && err.stack});
      throw err;
    }
  };

  // API para descargar
  window.FX_DEBUG = {
    get(){ try{return JSON.parse(localStorage.fx_debug_log||'[]');}catch(e){return store;} },
    clear(){ localStorage.removeItem('fx_debug_log'); store.length=0; },
    download(){
      const blob = new Blob([JSON.stringify(window.FX_DEBUG.get(), null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'fx_admin_debug_log.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
    }
  };

  // Atajo: Ctrl+Shift+D descarga
  window.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.shiftKey && (e.key==='D' || e.key==='d')){
      e.preventDefault();
      window.FX_DEBUG.download();
      alert('Log descargado: fx_admin_debug_log.json');
    }
  
  // Acreditar capital (directo)
  $("capAccount")?.addEventListener("change", updateCapHint);
  $("btnAccreditCapital")?.addEventListener("click", doAccreditCapital);
  const capDate = $("capDate");
  if(capDate && !capDate.value){
    const today = new Date();
    capDate.value = today.toISOString().slice(0,10);
  }

});
})();

</script>
</body>
</html
// Compat: algunas versiones llamaban getAuthUserByEmail()
async function getAuthUserByEmail(email){
  const id = await getAuthedUserIdByEmail(email);
  return id ? { id } : null;
}
>

