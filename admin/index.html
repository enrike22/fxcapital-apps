<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FX | CAPITAL R.L. ‚Äî Admin</title>

<style>
/* ========= 3D PRO THEME ========= */
:root{
  --bg:#07080a;
  --fg:#f5f7fa;
  --muted:#c7cdd6;

  --card1:#0f1116;
  --card2:#0b0d11;

  --border:rgba(255,255,255,.08);
  --border2:rgba(255,255,255,.12);

  --shadow: 0 18px 60px rgba(0,0,0,.55);
  --shadow2: 0 10px 30px rgba(0,0,0,.45);

  --radius:18px;
  --radius2:14px;

  --chip:#121620;

  --danger:#ff4d4f;
  --ok:#2dd4bf;

  --glow: 0 0 0 3px rgba(255,255,255,.06), 0 0 40px rgba(255,255,255,.06);
  --glow2: 0 0 0 3px rgba(45,212,191,.15), 0 0 40px rgba(45,212,191,.10);

  --txtSoft: rgba(245,247,250,.86);
  --txtDim: rgba(245,247,250,.68);

  --grid: radial-gradient(circle at 25% 12%, rgba(255,255,255,.06), transparent 55%),
          radial-gradient(circle at 75% 18%, rgba(45,212,191,.08), transparent 60%),
          radial-gradient(circle at 50% 90%, rgba(255,255,255,.05), transparent 55%);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 800px at 20% 0%, rgba(255,255,255,.06), transparent 60%),
    radial-gradient(900px 700px at 90% 20%, rgba(45,212,191,.08), transparent 55%),
    radial-gradient(900px 700px at 50% 100%, rgba(255,255,255,.05), transparent 60%),
    linear-gradient(180deg, var(--bg), #050508);
  color:var(--fg);
  font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Arial;
  font-size:16px;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

.container{
  max-width:1320px;
  margin:0 auto;
  padding:34px 22px 46px;
}

.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  margin-bottom:18px;
}

h1{
  margin:0;
  font-size:28px;
  letter-spacing:.2px;
  line-height:1.15;
  color:var(--fg);
  text-shadow: 0 1px 0 rgba(255,255,255,.05);
}

h2{
  margin:0 0 14px;
  font-size:20px;
  font-weight:800;
  letter-spacing:.2px;
  color:var(--fg);
}

.small{font-size:13px;color:var(--txtDim)}
.error{font-size:13px;color:var(--danger)}
.nowrap{white-space:nowrap}
.hidden{display:none !important}

/* ---- cards (3D) ---- */
.card{
  position:relative;
  overflow:hidden;
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), transparent 24%),
    linear-gradient(180deg, var(--card1), var(--card2));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:26px 22px;
  box-shadow: var(--shadow);
  margin-bottom:22px;
  transform: translateZ(0);
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.card:before{
  content:"";
  position:absolute;
  inset:-1px;
  background: var(--grid);
  opacity:.9;
  pointer-events:none;
  mask: linear-gradient(180deg, rgba(0,0,0,1), rgba(0,0,0,.55) 45%, rgba(0,0,0,0));
}
.card:after{
  content:"";
  position:absolute;
  inset:-120px;
  background:
    conic-gradient(from 180deg at 50% 50%, rgba(255,255,255,.14), transparent 40%, rgba(45,212,191,.10), transparent 70%, rgba(255,255,255,.10));
  opacity:.08;
  filter: blur(20px);
  transform: translate3d(0,0,0);
  pointer-events:none;
  animation: floatGlow 8s ease-in-out infinite;
}
@keyframes floatGlow{
  0%,100%{ transform: translate3d(0,0,0) rotate(0deg); }
  50%{ transform: translate3d(10px,-8px,0) rotate(10deg); }
}
.card:hover{
  transform: translateY(-2px);
  border-color: var(--border2);
  box-shadow: 0 22px 70px rgba(0,0,0,.6);
}

/* ---- inputs ---- */
label{
  display:block;
  margin:10px 0 6px;
  color:var(--txtDim);
  font-size:13px;
  letter-spacing:.2px;
}
input,select{
  width:100%;
  background: rgba(8,10,14,.9);
  color:var(--fg);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px 12px;
  font-size:15px;
  outline:none;
  transition: box-shadow .15s ease, border-color .15s ease, transform .12s ease, background .15s ease;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
}
input::placeholder{ color: rgba(245,247,250,.35); }
input:focus,select:focus{
  border-color: rgba(45,212,191,.40);
  box-shadow: var(--glow2);
  background: rgba(10,12,16,.95);
}
input:hover,select:hover{
  border-color: rgba(255,255,255,.14);
}

/* ---- buttons ---- */
button{
  background: linear-gradient(180deg, #ffffff, #e9edf2);
  color:#0b0c0e;
  border:none;
  padding:12px 18px;
  border-radius:999px;
  font-weight:900;
  cursor:pointer;
  font-size:15px;
  box-shadow: 0 12px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.55);
  transition: transform .14s ease, box-shadow .14s ease, filter .14s ease;
}
button:hover{
  transform: translateY(-1px);
  box-shadow: 0 18px 44px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.65);
  filter: brightness(1.02);
}
button:active{ transform: translateY(0px) scale(.99); }

button.ghost{
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  color:var(--fg);
  border:1px solid var(--border);
  box-shadow: 0 10px 26px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
}
button.ghost:hover{
  border-color: rgba(255,255,255,.14);
  box-shadow: 0 14px 36px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
}
button.danger{
  background: linear-gradient(180deg, #ff6b6c, #ff3f40);
  color:#fff;
  box-shadow: 0 14px 34px rgba(255,77,79,.20), 0 12px 30px rgba(0,0,0,.35);
}
button.danger:hover{
  box-shadow: 0 18px 44px rgba(255,77,79,.24), 0 16px 40px rgba(0,0,0,.45);
}
button.ok{
  background: linear-gradient(180deg, rgba(45,212,191,1), rgba(45,212,191,.75));
  color:#02110f;
  box-shadow: 0 14px 34px rgba(45,212,191,.18), 0 12px 30px rgba(0,0,0,.35);
}
button.ok:hover{
  box-shadow: 0 18px 44px rgba(45,212,191,.22), 0 16px 40px rgba(0,0,0,.45);
}

.inline{display:flex;gap:10px;align-items:center}
.row{display:grid;gap:18px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
hr.sep{border:0;border-top:1px solid rgba(255,255,255,.08);margin:14px 0}

/* ---- searchbar ---- */
.searchbar{position:relative;max-width:520px;min-width:280px}
.searchbar input{padding-left:40px}
.searchbar svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.75;pointer-events:none}

/* ---- tables ---- */
.table-wrap{
  overflow:auto;
  border:1px solid rgba(255,255,255,.08);
  border-radius:var(--radius2);
  background: rgba(0,0,0,.16);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.08);
  vertical-align:middle;
  font-size:15px;
  color: var(--txtSoft);
}
th{
  text-align:left;
  color: rgba(245,247,250,.92);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  position:sticky;
  top:0;
  z-index:2;
  backdrop-filter: blur(8px);
}
tbody tr{ transition: background .12s ease, transform .12s ease; }
tbody tr:hover{ background: rgba(255,255,255,.035); }

.chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  background: rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.08);
  font-size:13px;
  color: rgba(245,247,250,.86);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
}
.dot{
  width:8px;height:8px;border-radius:99px;
  background: rgba(45,212,191,.9);
  box-shadow: 0 0 0 3px rgba(45,212,191,.12);
}
.dot.pending{ background: rgba(255,255,255,.75); box-shadow: 0 0 0 3px rgba(255,255,255,.10); }
.dot.scheduled{ background: rgba(253, 224, 71, .95); box-shadow: 0 0 0 3px rgba(253,224,71,.14); }
.dot.approved{ background: rgba(45,212,191,.9); }
.dot.rejected{ background: rgba(255,77,79,.95); }

@keyframes fadeUp{
  from{ opacity:0; transform: translateY(10px); }
  to{ opacity:1; transform: translateY(0); }
}
.container{ animation: fadeUp .32s ease both; }

.loading{opacity:.85;position:relative;}
.loading:after{
  content:"";
  width:10px;height:10px;border-radius:50%;
  border:2px solid rgba(255,255,255,.25);
  border-top-color: rgba(255,255,255,.8);
  display:inline-block;
  margin-left:10px;
  vertical-align:middle;
  animation: spin .8s linear infinite;
}
@keyframes spin{ to{ transform: rotate(360deg); } }

@media (max-width:680px){
  .header{flex-direction:column;align-items:flex-start}
  .searchbar{max-width:100%;min-width:0;width:100%}
}

/* ===== Modal ===== */
.modal-backdrop{
  position:fixed; inset:0;
  background: rgba(0,0,0,.62);
  backdrop-filter: blur(8px);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
  z-index:9999;
}
.modal-backdrop.hidden{display:none !important}
.modal{
  width:min(720px, 100%);
  border-radius:22px;
  border:1px solid rgba(255,255,255,.10);
  box-shadow: 0 30px 90px rgba(0,0,0,.65);
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), transparent 22%),
    linear-gradient(180deg, var(--card1), var(--card2));
  position:relative;
  overflow:hidden;
}
.modal:before{
  content:"";
  position:absolute; inset:-1px;
  background: var(--grid);
  opacity:.85;
  pointer-events:none;
  mask: linear-gradient(180deg, rgba(0,0,0,1), rgba(0,0,0,.55) 45%, rgba(0,0,0,0));
}
.modal-inner{ position:relative; padding:20px 18px 18px; }
.modal-title{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
.modal-title h3{ margin:0; font-size:18px; letter-spacing:.2px; }
.modal-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:14px; }
.xbtn{
  background: transparent;
  border:1px solid rgba(255,255,255,.12);
  color: rgba(245,247,250,.9);
  padding:10px 12px;
  border-radius:999px;
  box-shadow:none;
}
.xbtn:hover{ border-color: rgba(255,255,255,.18); box-shadow: var(--shadow2); transform: translateY(-1px); }

.header-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
</style>
</head>

<body>
<div class="container">

  <div class="header">
    <h1>FX | CAPITAL R.L. ‚Äî Panel Admin</h1>

    <div class="header-actions">
      <div class="searchbar">
        <input id="q" type="search" placeholder="Buscar (nombre, email, tel√©fono, plan, banco‚Ä¶)" aria-label="Buscar cliente">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="#b9c0c8" stroke-width="2" stroke-linecap="round"/></svg>
      </div>

      <button id="btnOpenResetGlobal" type="button" class="ghost hidden">Reset contrase√±a</button>
      <button id="logoutBtn" type="button" class="hidden">Cerrar sesi√≥n</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="unauth" class="card">
    <h2>Admin ‚Äî Iniciar sesi√≥n</h2>
    <form id="loginForm" class="row" style="grid-template-columns:1fr 1fr auto">
      <div><label>Email</label><input id="email" type="email" required></div>
      <div><label>Contrase√±a</label><input id="password" type="password" required></div>
      <div style="align-self:end"><button type="submit">Entrar</button></div>
      <div style="grid-column:1/-1"><p id="loginMsg" class="small"></p></div>
    </form>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">

    <!-- TOPUPS -->
    <div class="card">
      <div class="header" style="margin:0 0 10px">
        <h2 style="margin:0">Recargas (pendientes / programadas)</h2>
        <button id="btnRefreshTopups" type="button" class="ghost">Refrescar</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Email</th>
              <th>Monto</th>
              <th>Banco</th>
              <th>Boleta</th>
              <th class="nowrap">Estado</th>
              <th class="nowrap">Efectiva</th>
              <th class="nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody id="topups"></tbody>
        </table>
      </div>

      <p class="small" style="margin-top:10px">
        ‚úÖ <b>Aprobar ahora</b> acredita el capital inmediatamente. <br>
        üìÜ <b>Programar</b> guarda una <b>effective_date</b> y el Cron DB acreditar√° a las <b>9:00 AM (GT)</b> del d√≠a programado.
      </p>
      <p id="topupsMsg" class="small"></p>
    </div>

    <!-- Crear/Editar -->
    <div class="card" id="formCard">
      <h2>Crear / Editar usuario</h2>

      <div class="row">
        <div>
          <label>Modo de intereses</label>
          <select id="u_interest_mode">
            <option value="monthly">Pagados mensualmente</option>
            <option value="compound">Acumulados (hasta finalizar meses)</option>
          </select>
          <div class="small">‚ÄúAcumulados‚Äù = no se marcan como pagados cada mes; se acumulan en saldo.</div>
        </div>
        <div>
          <label>Email</label>
          <input id="u_email" placeholder="cliente@demo.com">
          <div class="small">Para editar, escribe el email o usa <b>Editar</b> en la lista.</div>
        </div>

        <div><label>Nombre completo</label><input id="u_name" placeholder="Cliente Demo"></div>
        <div><label>Tel√©fono (celular)</label><input id="u_phone" type="tel" inputmode="tel" placeholder="+502 5555 5555"></div>

        <div>
          <label>Contrase√±a (para el cliente)</label>
          <div class="inline">
            <input id="u_pass" type="password" placeholder="M√≠n. 8 caracteres (vac√≠o = no crea en Auth)">
            <button type="button" id="togglePass" class="ghost" title="Mostrar/ocultar">üëÅ</button>
          </div>
        </div>

        <div>
          <label>Moneda</label>
          <select id="u_currency"><option>GTQ</option><option>USD</option></select>
        </div>

        <div>
          <label>Capital inicial</label>
          <input id="u_capital" type="text" inputmode="decimal" placeholder="0.00">
        </div>

        <div><label>Fecha ingreso</label><input id="u_joined" type="date"></div>

        <div>
          <label>Plan</label>
          <select id="u_plan">
            <option value="STANDARD">Estandar-15%</option>
            <option value="PLATINUM">Platinum-20%</option>
            <option value="BLACK">Black-Tasa preferencial</option>
          </select>
        </div>

        <div>
          <label>Meses de inversi√≥n</label>
          <select id="u_months">
            <option>6</option><option selected>12</option><option>18</option><option>24</option>
            <option>30</option><option>36</option><option>42</option><option>48</option>
            <option>54</option><option>60</option>
          </select>
        </div>

        <div>
          <label>Tasa semestral (%)</label>
          <input id="u_rate" type="number" min="0" max="100" step="0.01" placeholder="Ej. 15, 20">
          <div id="rateError" class="error hidden">la tasa de inter√©s indicada con el plan indicado no coinciden</div>
          <div class="small">Para STANDARD debe ser 15. Para PLATINUM debe ser 20.</div>
        </div>

        <div><label>Banco</label><input id="u_bank_name" placeholder="Banco Industrial"></div>
        <div><label>No. de cuenta</label><input id="u_bank_account" placeholder="1234567890"></div>
        <div><label>Tipo de cuenta</label><input id="u_bank_account_type" placeholder="Ahorro / Monetaria / ‚Ä¶"></div>
      </div>

      <hr class="sep">

      <div class="inline" style="gap:12px">
        <button id="saveBtn" type="button">Guardar</button>
        <button id="clearBtn" type="button" class="ghost">Limpiar</button>
        <span id="saveMsg" class="small" style="margin-left:8px"></span>
      </div>
    </div>

    <!-- Lista -->
    <div class="card">
      <div class="header" style="margin:0 0 10px">
        <h2 style="margin:0">Clientes</h2>
        <button id="btnRefreshUsers" type="button" class="ghost">Refrescar lista</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Tel√©fono</th>
              <th class="nowrap">Fecha ingreso</th>
              <th>Plan</th>
              <th>Capital</th>
              <th>Banco</th>
              <th class="nowrap">No. cuenta</th>
              <th class="nowrap">Tipo de cuenta</th>
              <th>Meses</th>
              <th class="nowrap">Tasa %/6m</th>
              <th>Modo</th>
              <th class="nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody id="users"></tbody>
        </table>
      </div>

      <p class="small" style="margin-top:10px">
        <span class="chip"><span class="dot"></span>Modo ‚ÄúAcumulado‚Äù = se guarda en cuenta; ‚ÄúMensual‚Äù = se paga/marca cada mes.</span>
      </p>
      <p id="usersMsg" class="small" style="margin-top:6px"></p>
    </div>

  </div>
</div>

<!-- ===== MODAL: PROGRAMAR TOPUP ===== -->
<div id="modalScheduleTopup" class="modal-backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-inner">
      <div class="modal-title">
        <h3>Programar acreditaci√≥n</h3>
        <button class="xbtn" type="button" onclick="closeScheduleTopupModal()">‚úï</button>
      </div>

      <div class="small" id="schedInfo">‚Äî</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Fecha efectiva (se acredita a las 9:00 AM GT)</label>
          <input id="schedDate" type="date">
          <div class="small">üîí No se permiten fechas pasadas.</div>
        </div>
        <div>
          <label>Nota (opcional)</label>
          <input id="schedNote" placeholder="Ej: Se acredita al inicio del ciclo">
        </div>
      </div>

      <hr class="sep">

      <div class="inline" style="justify-content:space-between; gap:12px">
        <div class="small" id="schedMsg"></div>
        <div class="modal-actions">
          <button class="ghost" type="button" onclick="closeScheduleTopupModal()">Cancelar</button>
          <button class="ok" type="button" id="btnDoSchedule">Programar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODAL: RESET PASSWORD ===== -->
<div id="modalReset" class="modal-backdrop hidden" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modal-inner">
      <div class="modal-title">
        <h3>Forzar cambio de contrase√±a</h3>
        <button class="xbtn" type="button" onclick="closeResetModal()">‚úï</button>
      </div>

      <div class="small" id="resetClientInfo">‚Äî</div>

      <div class="row" style="margin-top:10px">
        <div id="resetPickWrap" class="hidden">
          <label>Seleccionar cliente</label>
          <select id="resetPick"></select>
          <div class="small">Elige el cliente al que le asignar√°s una contrase√±a temporal.</div>
        </div>

        <div>
          <label>Nueva contrase√±a</label>
          <input id="resetNewPass" type="text" placeholder="M√≠nimo 8 caracteres">
          <div class="small">Luego el cliente deber√° iniciar sesi√≥n y cambiarla en su modal obligatorio.</div>
        </div>
      </div>

      <hr class="sep">

      <div class="inline" style="justify-content:space-between; gap:12px">
        <div class="small" id="resetMsg"></div>
        <div class="modal-actions">
          <button class="ghost" type="button" onclick="closeResetModal()">Cancelar</button>
          <button class="ok" type="button" id="btnResetDo">Aplicar reset</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/*** SUPABASE CONFIG (CORRECTO) ***/
const PROJECT_URL = "https://czvpehbubfrinutztnwh.supabase.co";
const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6dnBlaGJ1YmZyaW51dHp0bndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzU1MTIsImV4cCI6MjA3NDQxMTUxMn0.m07fP_x2_q8MyjZWcy1xbV-Te841Vv0NNaFKq4GDSsY";
const BASE = PROJECT_URL + "/rest/v1";
const RPC  = BASE + "/rpc";

function headersJSON(){
  return {
    apikey: ANON_KEY,
    Authorization: "Bearer " + (localStorage.token || ""),
    "Content-Type":"application/json",
    "Prefer":"return=representation"
  };
}

/*** HELPERS UI ***/
const $ = (id)=> document.getElementById(id);
const show = (el, v)=> el.classList.toggle('hidden', !v);
const fmtMoney = (n, ccy)=> { try{ return new Intl.NumberFormat('es-GT',{style:'currency',currency:ccy||'GTQ'}).format(Number(n||0)); }catch{ return `Q ${(Number(n||0)).toFixed(2)}`; } };
const fmtDate  = (s)=> s ? new Date(s).toLocaleDateString('es-GT') : '‚Äî';
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
function setLoading(el, isLoading){ if(!el) return; el.classList.toggle("loading", !!isLoading); }

/*** ‚úÖ validar sesi√≥n/token antes de cargar panel ***/
async function validateSession(){
  const token = localStorage.token;
  if(!token) return false;
  try{
    const r = await fetch(`${PROJECT_URL}/auth/v1/user`, {
      method: "GET",
      headers: { apikey: ANON_KEY, Authorization: "Bearer " + token }
    });
    if(!r.ok){
      localStorage.removeItem("token");
      localStorage.removeItem("uid");
      return false;
    }
    return true;
  }catch{ return false; }
}

/*** FORMATEO EN INPUT NUM√âRICO CON COMAS ***/
function formatCapitalString(raw){
  raw = String(raw ?? "").replace(/[^\d.]/g, "");
  const firstDot = raw.indexOf(".");
  if (firstDot !== -1){
    const head = raw.slice(0, firstDot+1);
    const tail = raw.slice(firstDot+1).replace(/\./g, "");
    raw = head + tail;
  }
  let [intPart, decPart] = raw.split(".");
  intPart = intPart ? intPart.replace(/^0+(?=\d)/, "") : "";
  if (intPart){ intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
  if (decPart !== undefined) decPart = decPart.slice(0, 2);
  return decPart !== undefined ? `${intPart || "0"}.${decPart}` : (intPart || "");
}
function parseCapitalFromInput(val){
  if (!val) return 0;
  const clean = String(val).replace(/,/g, "");
  const n = Number(clean);
  return Number.isFinite(n) ? n : 0;
}
function bindCapitalFormatter(inputEl){
  if(!inputEl) return;
  inputEl.addEventListener("input", () => {
    const pos = inputEl.selectionStart ?? inputEl.value.length;
    const before = inputEl.value;
    const rawNoCommas = before.replace(/,/g, "");
    inputEl.value = formatCapitalString(rawNoCommas);
    const diff = inputEl.value.length - before.length;
    const newPos = Math.max(0, pos + diff);
    inputEl.setSelectionRange?.(newPos, newPos);
  });
  inputEl.addEventListener("blur", () => {
    if (!inputEl.value.replace(/[^\d]/g, "")) inputEl.value = "0";
  });
}
function setCapitalInputValue(n){
  const val = (n === null || n === undefined) ? "" : String(n);
  $("u_capital").value = formatCapitalString(val);
}
function todayISO(){ return new Date().toISOString().slice(0,10); }

/*** LOGIN ***/
async function doLogin(e){
  e.preventDefault();
  const email = $("email").value.trim();
  const password = $("password").value;

  $("loginMsg").textContent = "";
  setLoading($("loginForm"), true);

  try{
    const r = await fetch(`${PROJECT_URL}/auth/v1/token?grant_type=password`,{
      method:"POST",
      headers:{
        apikey: ANON_KEY,
        Authorization: "Bearer " + ANON_KEY,
        "Content-Type":"application/json"
      },
      body: JSON.stringify({ email, password })
    });

    let data = null;
    try{ data = await r.json(); }catch{ data = null; }

    if(!r.ok){
      $("loginMsg").textContent = data?.error_description || data?.error || "Login inv√°lido";
      return;
    }
    if(!data?.access_token){
      $("loginMsg").textContent = "Login inv√°lido (sin token).";
      return;
    }

    localStorage.token = data.access_token;
    localStorage.uid = data.user?.id || "";
    await initApp();

  }catch(err){
    console.error(err);
    $("loginMsg").textContent = "Error de red";
  }finally{
    setLoading($("loginForm"), false);
  }
}
function logout(){
  localStorage.removeItem("token");
  localStorage.removeItem("uid");
  location.reload();
}

/*** Edge Functions auxiliares ***/
async function createAuthUserIfNeeded(email, password, fullName) {
  if(!password) return { ok:true, status:204, json: async()=>({}) };
  const url = "https://czvpehbubfrinutztnwh.functions.supabase.co/admin-create-user";
  return fetch(url, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      apikey:ANON_KEY,
      Authorization:"Bearer "+(localStorage.token||"")
    },
    body: JSON.stringify({ email, password, full_name: fullName })
  });
}
async function getAuthUserIdByEmail(email){
  try{
    const r = await fetch(`${RPC}/get_user_id_by_email`, {
      method:"POST",
      headers: headersJSON(),
      body: JSON.stringify({ p_email: email })
    });
    if(!r.ok) return null;
    const id = await r.json();
    return id || null;
  }catch{ return null; }
}

/*** LISTA ***/
let CACHED = [];
async function listUsers(){
  const msgEl = $("usersMsg");
  if(msgEl) msgEl.textContent = "";

  const h = {
    apikey: ANON_KEY,
    Authorization: "Bearer "+localStorage.token,
    "Cache-Control":"no-cache, no-store, must-revalidate",
    Pragma:"no-cache"
  };

  const sel = `user_id,full_name,email,phone,plan,currency,capital,account_id,bank_name,bank_account,bank_account_type,invest_months,interest_pct,joined_at,compound_interest`;

  try{
    let r = await fetch(`${BASE}/v_admin_users_filtered?select=${encodeURIComponent(sel)}&order=full_name.asc`, { headers:h, cache:"no-store" });

    if (r.ok) {
      CACHED = await r.json();
      if(msgEl) msgEl.textContent = `Clientes cargados: ${CACHED.length}`;
      renderUsers(CACHED);
      refreshResetPicker();
      return;
    }

    const t = await r.text().catch(()=> "");
    console.error("v_admin_users_filtered error:", r.status, t);
    if(msgEl) msgEl.textContent = `No se pudo cargar la vista (HTTP ${r.status}). Probando m√©todo alterno‚Ä¶`;

    CACHED = await loadUsersViaJoinFallback(h);
    if(msgEl) msgEl.textContent = `Clientes cargados (fallback): ${CACHED.length}`;
    renderUsers(CACHED);
    refreshResetPicker();

    if(r.status === 401 || r.status === 403){
      localStorage.removeItem("token");
      localStorage.removeItem("uid");
      await initApp();
    }
  }catch(e){
    console.error(e);
    if(msgEl) msgEl.textContent = "Error cargando clientes (revisa conexi√≥n, permisos o RLS).";
    CACHED = [];
    renderUsers(CACHED);
  }
}

async function loadUsersViaJoinFallback(h){
  try{
    const [aRes, pRes] = await Promise.all([
      fetch(`${BASE}/accounts?select=id,user_id,currency,capital,plan,bank_name,bank_account,bank_account_type,invest_months,interest_pct,joined_at,compound_interest`, { headers:h, cache:"no-store" }),
      fetch(`${BASE}/profiles?select=id,full_name,email,phone,is_admin`, { headers:h, cache:"no-store" }),
    ]);

    const accounts = aRes.ok ? await aRes.json() : [];
    const profiles = pRes.ok ? await pRes.json() : [];
    const pmap = new Map(profiles.map(p => [p.id, p]));

    return accounts.map(a=>{
      const p = pmap.get(a.user_id) || {};
      if (p.is_admin) return null;
      return {
        user_id: p.id || a.user_id,
        full_name: p.full_name || null,
        email: p.email || null,
        phone: p.phone || null,
        account_id: a.id,
        currency: a.currency,
        capital: a.capital,
        plan: a.plan,
        bank_name: a.bank_name,
        bank_account: a.bank_account,
        bank_account_type: a.bank_account_type,
        invest_months: a.invest_months,
        interest_pct: a.interest_pct,
        joined_at: a.joined_at,
        compound_interest: a.compound_interest
      };
    }).filter(Boolean).sort((x,y)=> (x.full_name||'').localeCompare(y.full_name||'' ));
  }catch{
    return [];
  }
}

function renderUsers(rows){
  const tb = $("users");
  tb.innerHTML = "";

  if(!rows || !rows.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="13" class="small">No hay clientes para mostrar (o no se pudieron cargar).</td>`;
    tb.appendChild(tr);
    return;
  }

  rows.forEach(x=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${x.full_name ?? '‚Äî'}</td>
      <td>${x.email ?? '‚Äî'}</td>
      <td>${x.phone || '‚Äî'}</td>
      <td class="nowrap">${fmtDate(x.joined_at)}</td>
      <td>${x.plan ?? '‚Äî'}</td>
      <td>${fmtMoney(x.capital, x.currency)}</td>
      <td>${x.bank_name ?? '‚Äî'}</td>
      <td class="nowrap">${x.bank_account ?? '‚Äî'}</td>
      <td class="nowrap">${x.bank_account_type ?? '‚Äî'}</td>
      <td>${x.invest_months ?? '‚Äî'}</td>
      <td>${x.interest_pct ?? '‚Äî'}</td>
      <td>${x.compound_interest ? "Acumulado" : "Mensual"}</td>
      <td class="nowrap">
        <button class="ghost" onclick='editClient(${JSON.stringify(x)})'>Editar</button>
        <button class="ghost" onclick='openResetModal(${JSON.stringify(x)})'>Reset contrase√±a</button>
        <button class="danger" onclick='deleteClient(${JSON.stringify(x)})'>Eliminar</button>
      </td>`;
    tb.appendChild(tr);
  });
}

/*** BUSCAR ***/
$("q")?.addEventListener("input",(e)=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q){ renderUsers(CACHED); return; }
  const filt = CACHED.filter(x=>[x.full_name,x.email,x.phone,x.plan,x.bank_name,x.bank_account,x.bank_account_type]
    .filter(Boolean).some(v=>String(v).toLowerCase().includes(q)));
  renderUsers(filt);
});

/* ============================================================
   TOPUPS (PENDING + SCHEDULED) + PROGRAMAR
   ============================================================ */

function buildCachedMaps(){
  const byUserId = new Map();
  const byAccountId = new Map();
  (CACHED||[]).forEach(c=>{
    if(c?.user_id) byUserId.set(c.user_id, c);
    if(c?.account_id) byAccountId.set(c.account_id, c);
  });
  return { byUserId, byAccountId };
}

async function fetchAccountsUserIds(accountIds, h){
  if(!accountIds?.length) return new Map();
  const unique = [...new Set(accountIds.filter(Boolean))];
  const map = new Map();
  const url = `${BASE}/accounts?select=id,user_id&id=in.(${unique.join(",")})`;
  const r = await fetch(url, { headers:h, cache:"no-store" });
  if(!r.ok) return map;
  const rows = await r.json();
  rows.forEach(a=>{ if(a?.id && a?.user_id) map.set(a.id, a.user_id); });
  return map;
}

async function fetchProfiles(userIds, h){
  if(!userIds?.length) return new Map();
  const unique = [...new Set(userIds.filter(Boolean))];
  const url = `${BASE}/profiles?select=id,full_name,email&id=in.(${unique.join(",")})`;
  const r = await fetch(url, { headers:h, cache:"no-store" });
  if(!r.ok) return new Map();
  const profs = await r.json();
  return new Map(profs.map(p=>[p.id,p]));
}

async function listTopups(){
  const msgEl = $("topupsMsg");
  if(msgEl) msgEl.textContent = "";

  const h = {
    apikey: ANON_KEY,
    Authorization: "Bearer "+localStorage.token,
    "Cache-Control":"no-cache, no-store, must-revalidate",
    Pragma:"no-cache"
  };

  // ‚úÖ incluir pending y scheduled
  const sel = `id,amount,currency,status,bank_name,receipt_path,created_at,user_id,account_id,reference_code,provider,effective_date,scheduled_note`;
  const url = `${BASE}/topups?select=${encodeURIComponent(sel)}&status=in.(pending,scheduled)&order=created_at.desc`;

  const r = await fetch(url, { headers:h, cache:"no-store" });

  if(!r.ok){
    const t = await r.text().catch(()=> "");
    console.error("listTopups error:", r.status, t);
    if(msgEl) msgEl.textContent = "No se pudieron cargar recargas (revisa conexi√≥n o permisos).";
    if(r.status === 401 || r.status === 403){
      localStorage.removeItem("token");
      localStorage.removeItem("uid");
      await initApp();
    }
    return;
  }

  const rows = await r.json();

  const { byUserId, byAccountId } = buildCachedMaps();

  const directUserIds = rows.map(x=>x.user_id).filter(Boolean);
  const missingUidAccountIds = rows.filter(x=>!x.user_id && x.account_id).map(x=>x.account_id);

  const acctToUid = new Map();
  missingUidAccountIds.forEach(aid=>{
    const c = byAccountId.get(aid);
    if(c?.user_id) acctToUid.set(aid, c.user_id);
  });

  const stillMissing = missingUidAccountIds.filter(aid=> !acctToUid.get(aid));
  const acctToUidFromDb = await fetchAccountsUserIds(stillMissing, h);
  acctToUidFromDb.forEach((uid, aid)=> acctToUid.set(aid, uid));

  const resolvedUserIds = rows.map(x=>{
    if(x.user_id) return x.user_id;
    if(x.account_id && acctToUid.get(x.account_id)) return acctToUid.get(x.account_id);
    return null;
  }).filter(Boolean);

  const allUserIds = [...new Set([...directUserIds, ...resolvedUserIds])];

  let profMap = new Map();
  try{ profMap = await fetchProfiles(allUserIds, h); }catch{ profMap = new Map(); }

  renderTopups(rows, profMap, byUserId, byAccountId, acctToUid);

  if(msgEl) msgEl.textContent = `Recargas: ${rows.length} (pending + scheduled)`;
}

function statusChip(status){
  const s = String(status||"").toLowerCase();
  const dotClass = (s==="pending")?"pending":(s==="scheduled")?"scheduled":(s==="approved")?"approved":(s==="rejected")?"rejected":"pending";
  const label = (s==="pending")?"Pendiente":(s==="scheduled")?"Programada":(s==="approved")?"Aprobada":(s==="rejected")?"Rechazada":(status||"‚Äî");
  return `<span class="chip"><span class="dot ${dotClass}"></span>${label}</span>`;
}

/** ‚úÖ Calcula ‚Äúinicio del siguiente ciclo‚Äù seg√∫n joined_at (d√≠a del mes) */
function nextCycleStartISO(joinedAt){
  // si no hay joinedAt, proponemos ma√±ana (o hoy)
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  if(!joinedAt){
    // por seguridad, proponemos hoy (pero el RPC bloquear√° si fuese pasado)
    return new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString().slice(0,10);
  }

  const j = new Date(joinedAt);
  const day = j.getDate(); // d√≠a del mes del ciclo

  // helper: clamp al √∫ltimo d√≠a del mes
  const clampDate = (y,m,d)=>{
    const last = new Date(y, m+1, 0).getDate();
    const dd = Math.min(d, last);
    return new Date(y,m,dd);
  };

  // candidate en mes actual
  let cand = clampDate(today.getFullYear(), today.getMonth(), day);

  // si hoy ya pas√≥ o es el mismo d√≠a (y t√∫ quieres que sea ‚Äúsiguiente ciclo‚Äù),
  // nos vamos al siguiente mes
  if (today >= cand){
    const y = today.getFullYear();
    const m = today.getMonth()+1;
    cand = clampDate(y + Math.floor(m/12), (m%12), day);
  }

  return cand.toISOString().slice(0,10);
}

function renderTopups(rows, profMap, cachedByUserId, cachedByAccountId, acctToUid){
  const tb = $("topups");
  if(!tb) return;
  tb.innerHTML = "";

  const BUCKET = "topup-receipts";

  rows.forEach(x=>{
    const inferredUid = x.user_id || (x.account_id ? acctToUid.get(x.account_id) : null);

    const p = (inferredUid && profMap && profMap.get(inferredUid)) ? profMap.get(inferredUid) : null;
    const c1 = (inferredUid && cachedByUserId && cachedByUserId.get(inferredUid)) ? cachedByUserId.get(inferredUid) : null;
    const c2 = (x.account_id && cachedByAccountId && cachedByAccountId.get(x.account_id)) ? cachedByAccountId.get(x.account_id) : null;

    const name = (p?.full_name || c1?.full_name || c2?.full_name || "‚Äî");
    const email = (p?.email || c1?.email || c2?.email || "‚Äî");

    const date = x.created_at ? new Date(x.created_at).toLocaleString('es-GT') : "‚Äî";
    const amt  = fmtMoney(x.amount, x.currency || "GTQ");
    const bank = x.bank_name || "‚Äî";

    const receipt = x.receipt_path
      ? `<button class="ghost" type="button"
            onclick="openReceipt('${BUCKET}','${String(x.receipt_path).replace(/'/g,"\\'")}')">
            Ver boleta
         </button>`
      : "‚Äî";

    const st = String(x.status||"pending").toLowerCase();
    const eff = x.effective_date ? x.effective_date : "‚Äî";

    // Para default de programaci√≥n: usar joined_at del cliente (si lo tenemos)
    const joined = c1?.joined_at || c2?.joined_at || null;
    const defNextCycle = nextCycleStartISO(joined);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="nowrap">${date}</td>
      <td>${name}</td>
      <td>${email}</td>
      <td>${amt}</td>
      <td>${bank}</td>
      <td>${receipt}</td>
      <td class="nowrap">${statusChip(st)}</td>
      <td class="nowrap">${eff}</td>
      <td class="nowrap">
        <button class="ok" onclick="approveTopup('${x.id}')">Aprobar ahora</button>
        <button class="ghost" onclick='openScheduleTopupModal(${JSON.stringify({
          id:x.id,
          amount:x.amount,
          currency:x.currency,
          status:x.status,
          effective_date:x.effective_date,
          user_id: inferredUid,
          account_id:x.account_id,
          name, email,
          default_date: defNextCycle
        })})'>Programar</button>
        ${st==="scheduled" ? `<button class="ghost" onclick="unscheduleTopup('${x.id}')">Quitar programaci√≥n</button>` : ``}
        <button class="danger" onclick="rejectTopupPrompt('${x.id}')">Rechazar</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  if(!rows.length){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="9" class="small">No hay recargas pending/scheduled.</td>`;
    tb.appendChild(tr);
  }
}

/*** ‚úÖ Aprobar ahora (NO CAMBIADO) ***/
async function approveTopup(topupId){
  if(!confirm("¬øAprobar ahora?\n\nEsto sumar√° el monto al capital del cliente inmediatamente.")) return;

  const r = await fetch(`${RPC}/approve_topup`, {
    method:"POST",
    headers: headersJSON(),
    body: JSON.stringify({ p_topup_id: topupId })
  });

  if(!r.ok){
    console.error(await r.text().catch(()=> ""));
    alert("No se pudo aprobar la recarga.");
    return;
  }

  alert("Recarga aprobada y capital acreditado.");
  await listTopups();
  await listUsers();
}

function rejectTopupPrompt(topupId){
  const reason = prompt("Motivo del rechazo (opcional):") || "";
  rejectTopup(topupId, reason);
}
async function rejectTopup(topupId, reason){
  if(!confirm("¬øRechazar esta recarga?")) return;

  const r = await fetch(`${RPC}/reject_topup`, {
    method:"POST",
    headers: headersJSON(),
    body: JSON.stringify({ p_topup_id: topupId, p_reason: reason })
  });

  if(!r.ok){
    console.error(await r.text().catch(()=> ""));
    alert("No se pudo rechazar la recarga.");
    return;
  }

  alert("Recarga rechazada.");
  await listTopups();
}

async function unscheduleTopup(topupId){
  if(!confirm("¬øQuitar programaci√≥n?\n\nVolver√° a estado Pendiente.")) return;

  const r = await fetch(`${RPC}/unschedule_topup`,{
    method:"POST",
    headers: headersJSON(),
    body: JSON.stringify({ p_topup_id: topupId })
  });

  if(!r.ok){
    console.error(await r.text().catch(()=> ""));
    alert("No se pudo quitar la programaci√≥n.");
    return;
  }

  alert("Programaci√≥n eliminada. La recarga volvi√≥ a Pendiente.");
  await listTopups();
}

async function openReceipt(bucket, path){
  try{
    const r = await fetch(`${PROJECT_URL}/functions/v1/admin-signed-receipt`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        apikey: ANON_KEY,
        Authorization: "Bearer " + (localStorage.token || "")
      },
      body: JSON.stringify({ bucket, path })
    });

    if(!r.ok){
      console.error(await r.text().catch(()=> ""));
      alert("No se pudo abrir la boleta.");
      return;
    }

    const { signedUrl } = await r.json();
    window.open(signedUrl, "_blank");
  }catch(e){
    console.error(e);
    alert("Error al abrir la boleta.");
  }
}

/* ============================================================
   MODAL PROGRAMAR TOPUP
   ============================================================ */
let SCHED_CTX = null;

function openScheduleTopupModal(ctx){
  SCHED_CTX = ctx;

  $("schedInfo").innerHTML =
    `<b>${ctx.name||'‚Äî'}</b> ‚Äî ${ctx.email||'‚Äî'}<br>`+
    `Monto: <b>${fmtMoney(ctx.amount, ctx.currency||'GTQ')}</b><br>`+
    `Regla: Se acreditar√° autom√°ticamente a las <b>9:00 AM (Guatemala)</b> del d√≠a efectivo.`;

  // default: inicio del siguiente ciclo seg√∫n joined_at
  const d = ctx.effective_date || ctx.default_date || todayISO();
  $("schedDate").value = d;
  $("schedNote").value = "";
  $("schedMsg").textContent = "";

  show($("modalScheduleTopup"), true);
}

function closeScheduleTopupModal(){
  show($("modalScheduleTopup"), false);
  SCHED_CTX = null;
}

async function doScheduleTopup(){
  if(!SCHED_CTX) return;

  const date = $("schedDate").value;
  const note = ($("schedNote").value || "").trim();

  if(!date){
    $("schedMsg").textContent = "Fecha requerida.";
    return;
  }

  // UI warning (la DB tambi√©n lo bloquea)
  const today = todayISO();
  if(date < today){
    $("schedMsg").textContent = "No se permiten fechas pasadas.";
    return;
  }

  if(!confirm(`¬øProgramar esta recarga?\n\nFecha efectiva: ${date}\n\nSe acreditar√° a las 9:00 AM (GT) de ese d√≠a.`)) return;

  $("schedMsg").textContent = "Programando‚Ä¶";
  setLoading($("schedMsg"), true);

  try{
    const r = await fetch(`${RPC}/schedule_topup`,{
      method:"POST",
      headers: headersJSON(),
      body: JSON.stringify({
        p_topup_id: SCHED_CTX.id,
        p_effective_date: date,
        p_note: note || null
      })
    });

    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(t || "No se pudo programar.");
    }

    $("schedMsg").textContent = "Listo.";
    closeScheduleTopupModal();
    alert("Recarga programada correctamente.");
    await listTopups();

  }catch(e){
    console.error(e);
    $("schedMsg").textContent = "Error.";
    alert("No se pudo programar: " + (e.message||e));
  }finally{
    setLoading($("schedMsg"), false);
  }
}

/*** Editar ***/
function editClient(x){
  $("u_email").value = x.email || "";
  $("u_name").value  = x.full_name || "";
  $("u_phone").value = x.phone || "";
  $("u_currency").value = x.currency || "GTQ";
  setCapitalInputValue(x.capital);
  $("u_joined").value   = x.joined_at ? new Date(x.joined_at).toISOString().slice(0,10) : "";
  $("u_plan").value     = x.plan || "STANDARD";
  $("u_interest_mode").value = x.compound_interest ? "compound" : "monthly";
  $("u_months").value   = x.invest_months ?? "12";
  $("u_rate").value     = (x.interest_pct ?? "") === null ? "" : (x.interest_pct ?? "");
  $("u_bank_name").value   = x.bank_name ?? "";
  $("u_bank_account").value= x.bank_account ?? "";
  $("u_bank_account_type").value = x.bank_account_type ?? "";
  $("u_pass").value = "";
  validateRatePlan();
  document.getElementById("formCard").scrollIntoView({behavior:"smooth",block:"start"});
}

/*** Validaci√≥n Plan vs Tasa ***/
function validateRatePlan(){
  const plan = $("u_plan").value;
  const rateStr = $("u_rate").value;
  const rate = rateStr === "" ? null : Number(rateStr);
  const err = $("rateError");

  if(rate === null){
    if(plan === "STANDARD") $("u_rate").value = 15;
    if(plan === "PLATINUM") $("u_rate").value = 20;
  }

  const finalRate = Number($("u_rate").value || NaN);
  let isValid = true;
  if(plan === "STANDARD") isValid = (finalRate === 15);
  else if(plan === "PLATINUM") isValid = (finalRate === 20);
  else if(plan === "BLACK") isValid = true;

  show(err, !isValid);
  return isValid;
}
$("u_plan").addEventListener("change", validateRatePlan);
$("u_rate").addEventListener("input", validateRatePlan);

/*** Guardar ***/
async function saveUser(){
  const email    = $("u_email").value.trim();
  const fullName = $("u_name").value.trim();
  const phone    = $("u_phone").value.trim();
  const password = $("u_pass").value;
  const currency = $("u_currency").value;
  const capital  = parseCapitalFromInput($("u_capital").value);
  const joined   = $("u_joined").value || null;
  const plan     = $("u_plan").value;
  const months   = parseInt($("u_months").value, 10);
  const rateStr  = $("u_rate").value;
  const rate     = rateStr === "" ? null : Number(rateStr);
  const bankName = $("u_bank_name").value.trim();
  const bankAcct = $("u_bank_account").value.trim();
  const bankType = $("u_bank_account_type").value.trim();
  const msgEl    = $("saveMsg");

  msgEl.textContent = "Guardando‚Ä¶";
  setLoading(msgEl, true);

  try{
    if(!email) throw new Error("Email requerido");
    if(!fullName) throw new Error("Nombre requerido");
    if(isNaN(capital)||capital<0) throw new Error("Capital inv√°lido");
    if(!validateRatePlan()) throw new Error("La tasa no coincide con el plan.");

    let uid = await getAuthUserIdByEmail(email);

    if (!uid && password){
      const rCreate = await createAuthUserIfNeeded(email, password, fullName);
      if(!rCreate.ok) throw new Error("No se pudo crear en Auth (revisa whitelist/secrets).");
      try{ uid = (await rCreate.json()).id || null; }catch{}
      if(!uid){
        for(let i=0;i<5 && !uid;i++){
          await sleep(400);
          uid = await getAuthUserIdByEmail(email);
        }
      }
    }

    if(!uid && !password) throw new Error("El usuario no existe en Auth. Ingresa una contrase√±a para crearlo.");

    const body = {
      p_email: email,
      p_full_name: fullName,
      p_currency: currency,
      p_capital: capital,
      p_joined_at: joined,
      p_plan: plan,
      p_bank_name: bankName || null,
      p_bank_account: bankAcct || null,
      p_invest_months: months,
      p_interest_pct: rate,
      p_phone: phone || null,
      p_bank_account_type: bankType || null
    };

    const r = await fetch(`${RPC}/admin_upsert_user_with_account`, {
      method:"POST",
      headers: headersJSON(),
      body: JSON.stringify(body)
    });
    if(!r.ok) throw new Error(await r.text() || "Error guardando");

    const mode = $("u_interest_mode").value;
    const compound = (mode === "compound");
    const uidForAccount = uid || await getAuthUserIdByEmail(email);

    if(uidForAccount){
      const pr = await fetch(`${BASE}/accounts?user_id=eq.${encodeURIComponent(uidForAccount)}`, {
        method: "PATCH",
        headers: headersJSON(),
        body: JSON.stringify({ compound_interest: compound })
      });
      if(!pr.ok){
        console.error(await pr.text().catch(()=> ""));
        throw new Error("Se guard√≥ el usuario, pero no se pudo actualizar el modo de inter√©s.");
      }
    }

    msgEl.textContent = "Guardado";
    await listUsers();
  }catch(e){
    msgEl.textContent = "Error";
    alert("No se pudo guardar: " + (e.message||e));
  }finally{
    setLoading(msgEl, false);
  }
}

/*** Eliminar (tu l√≥gica original) ***/
async function deleteClient(x){
  const msg = `¬øEliminar al cliente?\n\nNombre: ${x.full_name||'‚Äî'}\nEmail: ${x.email||'‚Äî'}`;
  if(!confirm(msg)) return;

  const jh = headersJSON();
  const mustOk = async (resp, label) => {
    if (!resp.ok) throw new Error(`Error al ${label}: ${(await resp.text().catch(()=>'')) || resp.status}`);
  };

  if (!x.user_id || !x.account_id){
    const r = await fetch(`${BASE}/v_admin_users_filtered?email=eq.${encodeURIComponent(x.email)}&select=user_id,account_id`, { headers: jh, cache:"no-store" });
    if (r.ok){
      const rows = await r.json();
      x.user_id = x.user_id || rows?.[0]?.user_id;
      x.account_id = x.account_id || rows?.[0]?.account_id;
    }
  }

  try{
    const r = await fetch(`${RPC}/admin_delete_user_cascade`, {
      method:"POST",
      headers: jh,
      body: JSON.stringify({ p_email: x.email, p_dry_run: false })
    });
    if (r.status !== 404) await mustOk(r, "RPC admin_delete_user_cascade");
    else throw new Error("sin RPC");
  }catch{
    if (x.account_id) {
      await mustOk(await fetch(`${BASE}/withdrawal_requests?account_id=eq.${encodeURIComponent(x.account_id)}`, { method:"DELETE", headers: jh }), "eliminar withdrawal_requests");
      await mustOk(await fetch(`${BASE}/admin_notifications?payload->>account_id=eq.${encodeURIComponent(x.account_id)}`, { method:"DELETE", headers: jh }), "eliminar admin_notifications");
      await mustOk(await fetch(`${BASE}/accounts?id=eq.${encodeURIComponent(x.account_id)}`, { method:"DELETE", headers: jh }), "eliminar accounts");
    }
    if (x.user_id) {
      const rP = await fetch(`${BASE}/profiles?id=eq.${encodeURIComponent(x.user_id)}`, { method:"DELETE", headers: jh });
      if (!rP.ok && rP.status !== 404) await mustOk(rP, "eliminar profiles");
    }
  }

  try{
    let uid = x.user_id || await getAuthUserIdByEmail(x.email);
    await fetch("https://czvpehbubfrinutztnwh.functions.supabase.co/admin-delete-user", {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        apikey: ANON_KEY,
        Authorization:"Bearer "+(localStorage.token||"")
      },
      body: JSON.stringify({ user_id: uid || null, email: x.email || null })
    });
  }catch{}

  CACHED = CACHED.filter(r => (r.email||"").toLowerCase() !== (x.email||"").toLowerCase());
  renderUsers(CACHED);
  await listUsers();
  alert("Cliente eliminado correctamente.");
}

/* ============================================================
   RESET PASSWORD (CLIENTES)
   ============================================================ */
let RESET_CTX = null;

function refreshResetPicker(){
  const sel = $("resetPick");
  if(!sel) return;

  sel.innerHTML = "";
  const rows = (CACHED||[]).filter(x=>x.email && x.user_id);

  if(!rows.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay clientes cargados";
    sel.appendChild(opt);
    return;
  }

  rows.forEach(x=>{
    const opt = document.createElement("option");
    opt.value = x.user_id;
    opt.textContent = `${x.full_name || x.email} ‚Äî ${x.email}`;
    opt.dataset.email = x.email || "";
    sel.appendChild(opt);
  });

  if(RESET_CTX?.user_id){
    sel.value = RESET_CTX.user_id;
  } else {
    sel.value = rows[0].user_id;
  }

  syncResetCtxFromPicker();
}

function syncResetCtxFromPicker(){
  const sel = $("resetPick");
  if(!sel) return;

  const uid = sel.value;
  const x = (CACHED||[]).find(r=>r.user_id === uid);
  if(x){
    RESET_CTX = x;
    setResetInfoFromCtx();
  }
}

function setResetInfoFromCtx(){
  const c = RESET_CTX || {};
  $("resetClientInfo").innerHTML =
    `<b>${c.full_name||'‚Äî'}</b> ‚Äî ${c.email||'‚Äî'}<br>`+
    `Al aplicar, se asigna contrase√±a y se fuerza modal de cambio en el panel del cliente.`;
}

function openResetModal(client=null){
  if(client && client.email){
    RESET_CTX = client;
    show($("resetPickWrap"), false);
    setResetInfoFromCtx();
  }else{
    RESET_CTX = null;
    show($("resetPickWrap"), true);
    refreshResetPicker();
  }

  $("resetNewPass").value = "";
  $("resetMsg").textContent = "";
  show($("modalReset"), true);
}

function closeResetModal(){
  show($("modalReset"), false);
  RESET_CTX = null;
}

async function doResetPassword(){
  if(!$("resetPickWrap")?.classList.contains("hidden")){
    syncResetCtxFromPicker();
  }

  if(!RESET_CTX){
    $("resetMsg").textContent = "Seleccione un cliente.";
    return;
  }

  const newPass = ($("resetNewPass").value || "").trim();
  if(newPass.length < 8){
    $("resetMsg").textContent = "La contrase√±a debe tener m√≠nimo 8 caracteres.";
    return;
  }
  if(!RESET_CTX.email){
    $("resetMsg").textContent = "Falta email del cliente.";
    return;
  }

  if(!confirm(`¬øAsignar nueva contrase√±a a ${RESET_CTX.email}?\n\nEsto activar√° el modal obligatorio en el panel cliente.`)) return;

  $("resetMsg").textContent = "Aplicando reset‚Ä¶";
  setLoading($("resetMsg"), true);

  try{
    const url = `${PROJECT_URL}/functions/v1/admin-reset-password`;
    const r = await fetch(url,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        apikey: ANON_KEY,
        Authorization:"Bearer " + (localStorage.token||"")
      },
      body: JSON.stringify({
        email: RESET_CTX.email,
        new_password: newPass
      })
    });

    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(t || "No se pudo resetear (Edge Function admin-reset-password).");
    }

    if(RESET_CTX.user_id){
      const pr = await fetch(`${BASE}/profiles?id=eq.${encodeURIComponent(RESET_CTX.user_id)}`,{
        method:"PATCH",
        headers: headersJSON(),
        body: JSON.stringify({
          must_change_password: true,
          must_change_password_at: new Date().toISOString()
        })
      });

      if(!pr.ok){
        console.warn("No se pudo marcar must_change_password en profiles:", await pr.text().catch(()=> ""));
      }
    }

    $("resetMsg").textContent = "Listo.";
    closeResetModal();
    alert("Contrase√±a restablecida. El cliente deber√° iniciar sesi√≥n y cambiarla.");

  }catch(e){
    console.error(e);
    $("resetMsg").textContent = "Error.";
    alert("No se pudo restablecer: " + (e.message||e));
  }finally{
    setLoading($("resetMsg"), false);
  }
}

/*** INIT ***/
async function initApp(){
  const ok = await validateSession();

  if(ok){
    show($("unauth"), false);
    show($("app"), true);
    show($("logoutBtn"), true);
    show($("btnOpenResetGlobal"), true);

    await listUsers();
    await listTopups();
  }else{
    show($("app"), false);
    show($("logoutBtn"), false);
    show($("btnOpenResetGlobal"), false);
    show($("unauth"), true);
  }
}

/*** BINDINGS ***/
document.addEventListener("DOMContentLoaded", ()=>{
  $("loginForm").addEventListener("submit", doLogin);
  $("logoutBtn").addEventListener("click", logout);

  $("togglePass").addEventListener("click", ()=> {
    const inp = $("u_pass");
    inp.type = (inp.type === "password") ? "text" : "password";
  });

  $("saveBtn").addEventListener("click", saveUser);

  $("clearBtn").addEventListener("click", ()=>{
    ["u_email","u_name","u_phone","u_pass","u_capital","u_joined","u_rate","u_bank_name","u_bank_account","u_bank_account_type"].forEach(id=>$(id).value="");
    $("u_currency").value="GTQ";
    $("u_plan").value="STANDARD";
    $("u_months").value="12";
    $("u_interest_mode").value="monthly";
    $("saveMsg").textContent="";
    validateRatePlan();
  });

  $("btnRefreshUsers").addEventListener("click", async ()=>{ await listUsers(); });
  $("btnRefreshTopups")?.addEventListener("click", async ()=>{ await listTopups(); });

  bindCapitalFormatter($("u_capital"));

  $("btnResetDo").addEventListener("click", doResetPassword);
  $("btnOpenResetGlobal").addEventListener("click", ()=> openResetModal(null));
  $("resetPick")?.addEventListener("change", syncResetCtxFromPicker);

  $("btnDoSchedule")?.addEventListener("click", doScheduleTopup);

  $("modalScheduleTopup")?.addEventListener("click", (e)=>{ if(e.target === $("modalScheduleTopup")) closeScheduleTopupModal(); });
  $("modalReset")?.addEventListener("click", (e)=>{ if(e.target === $("modalReset")) closeResetModal(); });

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      try{ closeResetModal(); }catch{}
      try{ closeScheduleTopupModal(); }catch{}
    }
  });

  initApp();
});
</script>
</body>
</html>
